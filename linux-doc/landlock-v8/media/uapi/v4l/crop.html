

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.13. Image Cropping, Insertion and Scaling &mdash; The Linux Kernel 4.16.0-rc1+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="The Linux Kernel 4.16.0-rc1+ documentation" href="../../../index.html"/>
        <link rel="up" title="1. Common API Elements" href="common.html"/>
        <link rel="next" title="1.14. API for cropping, composing and scaling" href="selection-api.html"/>
        <link rel="prev" title="1.12. Single- and multi-planar APIs" href="planar-apis.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.16.0-rc1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/license-rules.html">Linux kernel licensing rules</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Linux Media Subsystem Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../media_uapi.html">Linux Media Infrastructure userspace API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="v4l2.html">Part I - Video for Linux API</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="common.html">1. Common API Elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="pixfmt.html">2. Image Formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="io.html">3. Input/Output</a></li>
<li class="toctree-l4"><a class="reference internal" href="devices.html">4. Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="libv4l.html">5. Libv4l Userspace Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="compat.html">6. Changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="user-func.html">7. Function Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-defs.html">8. Common definitions for V4L2 and V4L2 subdev interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="videodev.html">9. Video For Linux Two Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="capture-example.html">10. Video Capture Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2grab-example.html">11. Video Grabber example using libv4l</a></li>
<li class="toctree-l4"><a class="reference internal" href="biblio.html">12. References</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-and-copyright">Revision and Copyright</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-history">Revision History</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dvb/dvbapi.html">Part II - Digital TV API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rc/remote_controllers.html">Part III - Remote Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mediactl/media-controller.html">Part IV - Media Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cec/cec-api.html">Part V - Consumer Electronics Control API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gen-errors.html">Generic Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdl-appendix.html">GNU Free Documentation License</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../media_kapi.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dvb-drivers/index.html">Linux Digital TV driver-specific documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../v4l-drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cec-drivers/index.html">CEC driver-specific documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Linux Filesystems API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/ja_JP/index.html">Japanese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Linux Media Subsystem Documentation</a> &raquo;</li>
        
          <li><a href="../../media_uapi.html">Linux Media Infrastructure userspace API</a> &raquo;</li>
        
          <li><a href="v4l2.html">Part I - Video for Linux API</a> &raquo;</li>
        
          <li><a href="common.html">1. Common API Elements</a> &raquo;</li>
        
      <li>1.13. Image Cropping, Insertion and Scaling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/media/uapi/v4l/crop.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="image-cropping-insertion-and-scaling">
<span id="crop"></span><h1>1.13. Image Cropping, Insertion and Scaling<a class="headerlink" href="#image-cropping-insertion-and-scaling" title="Permalink to this headline">¶</a></h1>
<p>Some video capture devices can sample a subsection of the picture and
shrink or enlarge it to an image of arbitrary size. We call these
abilities cropping and scaling. Some video output devices can scale an
image up or down and insert it at an arbitrary scan line and horizontal
offset into a video signal.</p>
<p>Applications can use the following API to select an area in the video
signal, query the default area and the hardware limits.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Despite their name, the <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a>,
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a> ioctls apply to input as well as output devices.</p>
</div>
<p>Scaling requires a source and a target. On a video capture or overlay
device the source is the video signal, and the cropping ioctls determine
the area actually sampled. The target are images read by the application
or overlaid onto the graphics screen. Their size (and position for an
overlay) is negotiated with the <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_G_FMT</span></a>
and <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_S_FMT</span></a> ioctls.</p>
<p>On a video output device the source are the images passed in by the
application, and their size is again negotiated with the
<a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_G_FMT</span></a> and <a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_S_FMT</span></a>
ioctls, or may be encoded in a compressed video stream. The target is
the video signal, and the cropping ioctls determine the area where the
images are inserted.</p>
<p>Source and target rectangles are defined even if the device does not
support scaling or the <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a> ioctls. Their size (and position
where applicable) will be fixed in this case.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">All capture and output devices must support the
<a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> ioctl such that applications
can determine if scaling takes place.</p>
</div>
<div class="section" id="cropping-structures">
<h2>1.13.1. Cropping Structures<a class="headerlink" href="#cropping-structures" title="Permalink to this headline">¶</a></h2>
<div class="figure align-center" id="id1">
<img alt="crop.svg" src="../../../_images/crop.svg" /><p class="caption"><span class="caption-text">Image Cropping, Insertion and Scaling</span></p>
<div class="legend">
The cropping, insertion and scaling process</div>
</div>
<p>For capture devices the coordinates of the top left corner, width and
height of the area which can be sampled is given by the <code class="docutils literal"><span class="pre">bounds</span></code>
substructure of the struct <a class="reference internal" href="vidioc-cropcap.html#c.v4l2_cropcap" title="v4l2_cropcap"><code class="xref c c-type docutils literal"><span class="pre">v4l2_cropcap</span></code></a> returned
by the <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> ioctl. To support a wide
range of hardware this specification does not define an origin or units.
However by convention drivers should horizontally count unscaled samples
relative to 0H (the leading edge of the horizontal sync pulse, see
<a class="reference internal" href="dev-raw-vbi.html#vbi-hsync"><span class="std std-ref">Figure 4.1. Line synchronization</span></a>). Vertically ITU-R line numbers of the first field
(see ITU R-525 line numbering for <a class="reference internal" href="dev-raw-vbi.html#vbi-525"><span class="std std-ref">525 lines</span></a> and for
<a class="reference internal" href="dev-raw-vbi.html#vbi-625"><span class="std std-ref">625 lines</span></a>), multiplied by two if the driver
can capture both fields.</p>
<p>The top left corner, width and height of the source rectangle, that is
the area actually sampled, is given by struct
<a class="reference internal" href="vidioc-g-crop.html#c.v4l2_crop" title="v4l2_crop"><code class="xref c c-type docutils literal"><span class="pre">v4l2_crop</span></code></a> using the same coordinate system as
struct <a class="reference internal" href="vidioc-cropcap.html#c.v4l2_cropcap" title="v4l2_cropcap"><code class="xref c c-type docutils literal"><span class="pre">v4l2_cropcap</span></code></a>. Applications can use the
<a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_G_CROP</span></a> and <a class="reference internal" href="vidioc-g-crop.html#vidioc-g-crop"><span class="std std-ref">VIDIOC_S_CROP</span></a>
ioctls to get and set this rectangle. It must lie completely within the
capture boundaries and the driver may further adjust the requested size
and/or position according to hardware limitations.</p>
<p>Each capture device has a default source rectangle, given by the
<code class="docutils literal"><span class="pre">defrect</span></code> substructure of struct
<a class="reference internal" href="vidioc-cropcap.html#c.v4l2_cropcap" title="v4l2_cropcap"><code class="xref c c-type docutils literal"><span class="pre">v4l2_cropcap</span></code></a>. The center of this rectangle
shall align with the center of the active picture area of the video
signal, and cover what the driver writer considers the complete picture.
Drivers shall reset the source rectangle to the default when the driver
is first loaded, but not later.</p>
<p>For output devices these structures and ioctls are used accordingly,
defining the <em>target</em> rectangle where the images will be inserted into
the video signal.</p>
</div>
<div class="section" id="scaling-adjustments">
<h2>1.13.2. Scaling Adjustments<a class="headerlink" href="#scaling-adjustments" title="Permalink to this headline">¶</a></h2>
<p>Video hardware can have various cropping, insertion and scaling
limitations. It may only scale up or down, support only discrete scaling
factors, or have different scaling abilities in horizontal and vertical
direction. Also it may not support scaling at all. At the same time the
struct <a class="reference internal" href="vidioc-g-crop.html#c.v4l2_crop" title="v4l2_crop"><code class="xref c c-type docutils literal"><span class="pre">v4l2_crop</span></code></a> rectangle may have to be aligned,
and both the source and target rectangles may have arbitrary upper and
lower size limits. In particular the maximum <code class="docutils literal"><span class="pre">width</span></code> and <code class="docutils literal"><span class="pre">height</span></code> in
struct <a class="reference internal" href="vidioc-g-crop.html#c.v4l2_crop" title="v4l2_crop"><code class="xref c c-type docutils literal"><span class="pre">v4l2_crop</span></code></a> may be smaller than the struct
<a class="reference internal" href="vidioc-cropcap.html#c.v4l2_cropcap" title="v4l2_cropcap"><code class="xref c c-type docutils literal"><span class="pre">v4l2_cropcap</span></code></a>. <code class="docutils literal"><span class="pre">bounds</span></code> area. Therefore, as
usual, drivers are expected to adjust the requested parameters and
return the actual values selected.</p>
<p>Applications can change the source or the target rectangle first, as
they may prefer a particular image size or a certain area in the video
signal. If the driver has to adjust both to satisfy hardware
limitations, the last requested rectangle shall take priority, and the
driver should preferably adjust the opposite one. The
<a class="reference internal" href="vidioc-g-fmt.html#vidioc-g-fmt"><span class="std std-ref">VIDIOC_TRY_FMT</span></a> ioctl however shall not change
the driver state and therefore only adjust the requested rectangle.</p>
<p>Suppose scaling on a video capture device is restricted to a factor 1:1
or 2:1 in either direction and the target image size must be a multiple
of 16 × 16 pixels. The source cropping rectangle is set to defaults,
which are also the upper limit in this example, of 640 × 400 pixels at
offset 0, 0. An application requests an image size of 300 × 225 pixels,
assuming video will be scaled down from the “full picture” accordingly.
The driver sets the image size to the closest possible values 304 × 224,
then chooses the cropping rectangle closest to the requested size, that
is 608 × 224 (224 × 2:1 would exceed the limit 400). The offset 0, 0 is
still valid, thus unmodified. Given the default cropping rectangle
reported by <a class="reference internal" href="vidioc-cropcap.html#vidioc-cropcap"><span class="std std-ref">VIDIOC_CROPCAP</span></a> the application can
easily propose another offset to center the cropping rectangle.</p>
<p>Now the application may insist on covering an area using a picture
aspect ratio closer to the original request, so it asks for a cropping
rectangle of 608 × 456 pixels. The present scaling factors limit
cropping to 640 × 384, so the driver returns the cropping size 608 × 384
and adjusts the image size to closest possible 304 × 192.</p>
</div>
<div class="section" id="examples">
<h2>1.13.3. Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>Source and target rectangles shall remain unchanged across closing and
reopening a device, such that piping data into or out of a device will
work without special preparations. More advanced applications should
ensure the parameters are suitable before starting I/O.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">On the next two examples, a video capture device is assumed;
change <code class="docutils literal"><span class="pre">V4L2_BUF_TYPE_VIDEO_CAPTURE</span></code> for other types of device.</p>
</div>
</div>
<div class="section" id="example-resetting-the-cropping-parameters">
<h2>1.13.4. Example: Resetting the cropping parameters<a class="headerlink" href="#example-resetting-the-cropping-parameters" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">crop</span><span class="p">;</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_CROPCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">crop</span><span class="p">));</span>
<span class="n">crop</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>

<span class="cm">/* Ignore if cropping is not supported (EINVAL). */</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_S_CROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_S_CROP&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="example-simple-downscaling">
<h2>1.13.5. Example: Simple downscaling<a class="headerlink" href="#example-simple-downscaling" title="Permalink to this headline">¶</a></h2>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="n">format</span><span class="p">;</span>

<span class="n">reset_cropping_parameters</span> <span class="p">();</span>

<span class="cm">/* Scale down to 1/4 size of full picture. */</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">format</span><span class="p">));</span> <span class="cm">/* defaults */</span>

<span class="n">format</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_S_FMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_S_FORMAT&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* We could check the actual image size now, the actual scaling factor</span>
<span class="cm">   or if the driver can scale at all. */</span>
</pre></div>
</div>
</div>
<div class="section" id="example-selecting-an-output-area">
<h2>1.13.6. Example: Selecting an output area<a class="headerlink" href="#example-selecting-an-output-area" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example assumes an output device.</p>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">crop</span><span class="p">;</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_CROPCAP</span><span class="p">;,</span> <span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">crop</span><span class="p">));</span>

<span class="n">crop</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>

<span class="cm">/* Scale the width and height to 50 % of their original size</span>
<span class="cm">   and center the output. */</span>

<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">+=</span> <span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">+=</span> <span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

<span class="cm">/* Ignore if cropping is not supported (EINVAL). */</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_S_CROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="p">)</span>
    <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_S_CROP&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="example-current-scaling-factor-and-pixel-aspect">
<h2>1.13.7. Example: Current scaling factor and pixel aspect<a class="headerlink" href="#example-current-scaling-factor-and-pixel-aspect" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This example assumes a video capture device.</p>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="n">cropcap</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">crop</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="n">format</span><span class="p">;</span>
<span class="kt">double</span> <span class="n">hscale</span><span class="p">,</span> <span class="n">vscale</span><span class="p">;</span>
<span class="kt">double</span> <span class="n">aspect</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">dwidth</span><span class="p">,</span> <span class="n">dheight</span><span class="p">;</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cropcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">cropcap</span><span class="p">));</span>
<span class="n">cropcap</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_CROPCAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cropcap</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_CROPCAP&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">crop</span><span class="p">));</span>
<span class="n">crop</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_G_CROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_G_CROP&quot;</span><span class="p">);</span>
        <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* Cropping not supported. */</span>
    <span class="n">crop</span><span class="p">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">memset</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">format</span><span class="p">));</span>
<span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">ioctl</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">VIDIOC_G_FMT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">perror</span> <span class="p">(</span><span class="s">&quot;VIDIOC_G_FMT&quot;</span><span class="p">);</span>
    <span class="n">exit</span> <span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The scaling applied by the driver. */</span>

<span class="n">hscale</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
<span class="n">vscale</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

<span class="n">aspect</span> <span class="o">=</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">/</span>
     <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">cropcap</span><span class="p">.</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
<span class="n">aspect</span> <span class="o">=</span> <span class="n">aspect</span> <span class="o">*</span> <span class="n">hscale</span> <span class="o">/</span> <span class="n">vscale</span><span class="p">;</span>

<span class="cm">/* Devices following ITU-R BT.601 do not capture</span>
<span class="cm">   square pixels. For playback on a computer monitor</span>
<span class="cm">   we should scale the images to this size. */</span>

<span class="n">dwidth</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">aspect</span><span class="p">;</span>
<span class="n">dheight</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="selection-api.html" class="btn btn-neutral float-right" title="1.14. API for cropping, composing and scaling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="planar-apis.html" class="btn btn-neutral" title="1.12. Single- and multi-planar APIs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'4.16.0-rc1+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>