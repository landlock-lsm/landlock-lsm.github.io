

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>RPC Cache &mdash; The Linux Kernel 5.10.0-rc3+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="rpcsec_gss support for kernel RPC servers" href="rpc-server-gss.html" />
    <link rel="prev" title="Reference counting in pnfs" href="pnfs.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Filesystems in the Linux kernel</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#core-vfs-documentation">Core VFS documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#filesystem-support-layers">Filesystem support layers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#filesystems">Filesystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../9p.html">v9fs: Plan 9 Resource Sharing for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../adfs.html">Acorn Disc Filing System - ADFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../affs.html">Overview of Amiga Filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../afs.html">kAFS: AFS FILESYSTEM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autofs.html">autofs - how it works</a></li>
<li class="toctree-l3"><a class="reference internal" href="../autofs-mount-control.html">Miscellaneous Device control operations for the autofs kernel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../befs.html">BeOS filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../bfs.html">BFS Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../btrfs.html">BTRFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cifs/cifsroot.html">Mounting root file system via SMB (cifs.ko)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ceph.html">Ceph Distributed File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../coda.html">Coda Kernel-Venus Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../configfs.html">Configfs - Userspace-driven Kernel Object Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cramfs.html">Cramfs - cram a filesystem onto a small ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../debugfs.html">DebugFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dlmfs.html">DLMFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ecryptfs.html">eCryptfs: A stacked cryptographic filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../efivarfs.html">efivarfs - a (U)EFI variable filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../erofs.html">Enhanced Read-Only File System - EROFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext2.html">The Second Extended Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext2.html#options">Options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext2.html#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext2.html#references">References</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ext3.html">Ext3 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../f2fs.html">WHAT IS Flash-Friendly File System (F2FS)?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gfs2.html">Global File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gfs2-uevents.html">uevents and GFS2</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gfs2-glocks.html">Glock internal locking rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hfs.html">Macintosh HFS Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hfsplus.html">Macintosh HFSPlus Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="../hpfs.html">Read/Write HPFS 2.09</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fuse.html">FUSE</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fuse-io.html">Fuse I/O Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../inotify.html">Inotify - A Powerful yet Simple File Change Notification System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../isofs.html">ISO9660 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nilfs2.html">NILFS2</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">NFS</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="pnfs.html">Reference counting in pnfs</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">RPC Cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="rpc-server-gss.html">rpcsec_gss support for kernel RPC servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="nfs41-server.html">NFSv4.1 Server Implementation</a></li>
<li class="toctree-l4"><a class="reference internal" href="knfsd-stats.html">Kernel NFS Server Statistics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../ntfs.html">The Linux NTFS filesystem driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ocfs2.html">OCFS2 filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ocfs2-online-filecheck.html">OCFS2 file system - online file check</a></li>
<li class="toctree-l3"><a class="reference internal" href="../omfs.html">Optimized MPEG Filesystem (OMFS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orangefs.html">ORANGEFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../overlayfs.html">Overlay Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../proc.html">The /proc Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../qnx6.html">The QNX6 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ramfs-rootfs-initramfs.html">Ramfs, rootfs and initramfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../relay.html">relay interface (formerly relayfs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../romfs.html">ROMFS - ROM File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../spufs/index.html">SPU Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../squashfs.html">Squashfs 4.0 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sysfs.html">sysfs - _The_ filesystem for exporting kernel objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sysv-fs.html">SystemV Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tmpfs.html">Tmpfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ubifs.html">UBI File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ubifs-authentication.html">UBIFS Authentication Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="../udf.html">UDF file system</a></li>
<li class="toctree-l3"><a class="reference internal" href="../virtiofs.html">virtiofs: virtio-fs host&lt;-&gt;guest shared file system</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vfat.html">VFAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xfs-delayed-logging-design.html">XFS Delayed Logging Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="../xfs-self-describing-metadata.html">XFS Self Describing Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="../zonefs.html">ZoneFS - Zone filesystem for Zoned block devices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Filesystems in the Linux kernel</a> &raquo;</li>
        
          <li><a href="index.html">NFS</a> &raquo;</li>
        
      <li>RPC Cache</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/filesystems/nfs/rpc-cache.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="rpc-cache">
<h1>RPC Cache<a class="headerlink" href="#rpc-cache" title="Permalink to this headline">¶</a></h1>
<p>This document gives a brief introduction to the caching
mechanisms in the sunrpc layer that is used, in particular,
for NFS authentication.</p>
<div class="section" id="caches">
<h2>Caches<a class="headerlink" href="#caches" title="Permalink to this headline">¶</a></h2>
<p>The caching replaces the old exports table and allows for
a wide variety of values to be caches.</p>
<p>There are a number of caches that are similar in structure though
quite possibly very different in content and use.  There is a corpus
of common code for managing these caches.</p>
<p>Examples of caches that are likely to be needed are:</p>
<blockquote>
<div><ul class="simple">
<li><p>mapping from IP address to client name</p></li>
<li><p>mapping from client name and filesystem to export options</p></li>
<li><p>mapping from UID to list of GIDs, to work around NFS’s limitation
of 16 gids.</p></li>
<li><p>mappings between local UID/GID and remote UID/GID for sites that
do not have uniform uid assignment</p></li>
<li><p>mapping from network identify to public key for crypto authentication.</p></li>
</ul>
</div></blockquote>
<p>The common code handles such things as:</p>
<blockquote>
<div><ul class="simple">
<li><p>general cache lookup with correct locking</p></li>
<li><p>supporting ‘NEGATIVE’ as well as positive entries</p></li>
<li><p>allowing an EXPIRED time on cache items, and removing
items after they expire, and are no longer in-use.</p></li>
<li><p>making requests to user-space to fill in cache entries</p></li>
<li><p>allowing user-space to directly set entries in the cache</p></li>
<li><p>delaying RPC requests that depend on as-yet incomplete
cache entries, and replaying those requests when the cache entry
is complete.</p></li>
<li><p>clean out old entries as they expire.</p></li>
</ul>
</div></blockquote>
<div class="section" id="creating-a-cache">
<h3>Creating a Cache<a class="headerlink" href="#creating-a-cache" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>A cache needs a datum to store.  This is in the form of a
structure definition that must contain a struct cache_head
as an element, usually the first.
It will also contain a key and some content.
Each cache element is reference counted and contains
expiry and update times for use in cache management.</p></li>
<li><p>A cache needs a “cache_detail” structure that
describes the cache.  This stores the hash table, some
parameters for cache management, and some operations detailing how
to work with particular cache items.</p>
<p>The operations are:</p>
<blockquote>
<div><dl class="simple">
<dt>struct cache_head *alloc(void)</dt><dd><p>This simply allocates appropriate memory and returns
a pointer to the cache_detail embedded within the
structure</p>
</dd>
<dt>void cache_put(struct kref *)</dt><dd><p>This is called when the last reference to an item is
dropped.  The pointer passed is to the ‘ref’ field
in the cache_head.  cache_put should release any
references create by ‘cache_init’ and, if CACHE_VALID
is set, any references created by cache_update.
It should then release the memory allocated by
‘alloc’.</p>
</dd>
<dt>int match(struct cache_head *orig, struct cache_head *new)</dt><dd><p>test if the keys in the two structures match.  Return
1 if they do, 0 if they don’t.</p>
</dd>
<dt>void init(struct cache_head *orig, struct cache_head *new)</dt><dd><p>Set the ‘key’ fields in ‘new’ from ‘orig’.  This may
include taking references to shared objects.</p>
</dd>
<dt>void update(struct cache_head *orig, struct cache_head *new)</dt><dd><p>Set the ‘content’ fileds in ‘new’ from ‘orig’.</p>
</dd>
<dt>int cache_show(struct seq_file *m, struct cache_detail *cd, struct cache_head *h)</dt><dd><p>Optional.  Used to provide a /proc file that lists the
contents of a cache.  This should show one item,
usually on just one line.</p>
</dd>
<dt>int cache_request(struct cache_detail *cd, struct cache_head *h, char **bpp, int *blen)</dt><dd><p>Format a request to be send to user-space for an item
to be instantiated.  *bpp is a buffer of size *blen.
bpp should be moved forward over the encoded message,
and  *blen should be reduced to show how much free
space remains.  Return 0 on success or &lt;0 if not
enough room or other problem.</p>
</dd>
<dt>int cache_parse(struct cache_detail *cd, char *buf, int len)</dt><dd><p>A message from user space has arrived to fill out a
cache entry.  It is in ‘buf’ of length ‘len’.
cache_parse should parse this, find the item in the
cache with sunrpc_cache_lookup_rcu, and update the item
with sunrpc_cache_update.</p>
</dd>
</dl>
</div></blockquote>
</li>
<li><p>A cache needs to be registered using cache_register().  This
includes it on a list of caches that will be regularly
cleaned to discard old data.</p></li>
</ul>
</div>
<div class="section" id="using-a-cache">
<h3>Using a cache<a class="headerlink" href="#using-a-cache" title="Permalink to this headline">¶</a></h3>
<p>To find a value in a cache, call sunrpc_cache_lookup_rcu passing a pointer
to the cache_head in a sample item with the ‘key’ fields filled in.
This will be passed to -&gt;match to identify the target entry.  If no
entry is found, a new entry will be create, added to the cache, and
marked as not containing valid data.</p>
<p>The item returned is typically passed to cache_check which will check
if the data is valid, and may initiate an up-call to get fresh data.
cache_check will return -ENOENT in the entry is negative or if an up
call is needed but not possible, -EAGAIN if an upcall is pending,
or 0 if the data is valid;</p>
<p>cache_check can be passed a “struct cache_req*”.  This structure is
typically embedded in the actual request and can be used to create a
deferred copy of the request (struct cache_deferred_req).  This is
done when the found cache item is not uptodate, but the is reason to
believe that userspace might provide information soon.  When the cache
item does become valid, the deferred copy of the request will be
revisited (-&gt;revisit).  It is expected that this method will
reschedule the request for processing.</p>
<p>The value returned by sunrpc_cache_lookup_rcu can also be passed to
sunrpc_cache_update to set the content for the item.  A second item is
passed which should hold the content.  If the item found by _lookup
has valid data, then it is discarded and a new item is created.  This
saves any user of an item from worrying about content changing while
it is being inspected.  If the item found by _lookup does not contain
valid data, then the content is copied across and CACHE_VALID is set.</p>
</div>
<div class="section" id="populating-a-cache">
<h3>Populating a cache<a class="headerlink" href="#populating-a-cache" title="Permalink to this headline">¶</a></h3>
<p>Each cache has a name, and when the cache is registered, a directory
with that name is created in /proc/net/rpc</p>
<p>This directory contains a file called ‘channel’ which is a channel
for communicating between kernel and user for populating the cache.
This directory may later contain other files of interacting
with the cache.</p>
<p>The ‘channel’ works a bit like a datagram socket. Each ‘write’ is
passed as a whole to the cache for parsing and interpretation.
Each cache can treat the write requests differently, but it is
expected that a message written will contain:</p>
<blockquote>
<div><ul class="simple">
<li><p>a key</p></li>
<li><p>an expiry time</p></li>
<li><p>a content.</p></li>
</ul>
</div></blockquote>
<p>with the intention that an item in the cache with the give key
should be create or updated to have the given content, and the
expiry time should be set on that item.</p>
<p>Reading from a channel is a bit more interesting.  When a cache
lookup fails, or when it succeeds but finds an entry that may soon
expire, a request is lodged for that cache item to be updated by
user-space.  These requests appear in the channel file.</p>
<p>Successive reads will return successive requests.
If there are no more requests to return, read will return EOF, but a
select or poll for read will block waiting for another request to be
added.</p>
<p>Thus a user-space helper is likely to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>open the channel.
  select for readable
  read a request
  write a response
loop.
</pre></div>
</div>
<p>If it dies and needs to be restarted, any requests that have not been
answered will still appear in the file and will be read by the new
instance of the helper.</p>
<p>Each cache should define a “cache_parse” method which takes a message
written from user-space and processes it.  It should return an error
(which propagates back to the write syscall) or 0.</p>
<p>Each cache should also define a “cache_request” method which
takes a cache item and encodes a request into the buffer
provided.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a cache has no active readers on the channel, and has had not
active readers for more than 60 seconds, further requests will not be
added to the channel but instead all lookups that do not find a valid
entry will fail.  This is partly for backward compatibility: The
previous nfs exports table was deemed to be authoritative and a
failed lookup meant a definite ‘no’.</p>
</div>
</div>
<div class="section" id="request-response-format">
<h3>request/response format<a class="headerlink" href="#request-response-format" title="Permalink to this headline">¶</a></h3>
<p>While each cache is free to use its own format for requests
and responses over channel, the following is recommended as
appropriate and support routines are available to help:
Each request or response record should be printable ASCII
with precisely one newline character which should be at the end.
Fields within the record should be separated by spaces, normally one.
If spaces, newlines, or nul characters are needed in a field they
much be quoted.  two mechanisms are available:</p>
<ul class="simple">
<li><p>If a field begins ‘x’ then it must contain an even number of
hex digits, and pairs of these digits provide the bytes in the
field.</p></li>
<li><p>otherwise a in the field must be followed by 3 octal digits
which give the code for a byte.  Other characters are treated
as them selves.  At the very least, space, newline, nul, and
‘' must be quoted in this way.</p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rpc-server-gss.html" class="btn btn-neutral float-right" title="rpcsec_gss support for kernel RPC servers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pnfs.html" class="btn btn-neutral float-left" title="Reference counting in pnfs" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>