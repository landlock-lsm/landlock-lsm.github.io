

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>4.5.2. Memory-to-Memory Stateful Video Encoder Interface &mdash; The Linux Kernel 5.11.0-rc4+ documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="4.5.3. Memory-to-memory Stateless Video Decoder Interface" href="dev-stateless-decoder.html" />
    <link rel="prev" title="4.5.1. Memory-to-Memory Stateful Video Decoder Interface" href="dev-decoder.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.11.0-rc4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">The Linux kernel user-space API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unshare.html">unshare system call</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accelerators/ocxl.html">OpenCAPI (Open Coherent Accelerator Processor Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iommu.html">IOMMU Userspace API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux Media Infrastructure userspace API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="v4l2.html">Part I - Video for Linux API</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="common.html">1. Common API Elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="pixfmt.html">2. Image Formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="io.html">3. Input/Output</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="devices.html">4. Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="libv4l.html">5. Libv4l Userspace Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="compat.html">6. Changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="user-func.html">7. Function Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-defs.html">8. Common definitions for V4L2 and V4L2 subdev interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="videodev.html">9. Video For Linux Two Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="capture-example.html">10. Video Capture Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2grab-example.html">11. Video Grabber example using libv4l</a></li>
<li class="toctree-l4"><a class="reference internal" href="biblio.html">12. References</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-and-copyright">Revision and Copyright</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-history">Revision History</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dvb/dvbapi.html">Part II - Digital TV API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rc/remote_controllers.html">Part III - Remote Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mediactl/media-controller.html">Part IV - Media Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cec/cec-api.html">Part V - Consumer Electronics Control API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gen-errors.html">Generic Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdl-appendix.html">GNU Free Documentation License</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">The Linux kernel user-space API guide</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Media Infrastructure userspace API</a> &raquo;</li>
        
          <li><a href="v4l2.html">Part I - Video for Linux API</a> &raquo;</li>
        
          <li><a href="devices.html"><span class="section-number">4. </span>Interfaces</a> &raquo;</li>
        
          <li><a href="dev-mem2mem.html"><span class="section-number">4.5. </span>Video Memory-To-Memory Interface</a> &raquo;</li>
        
      <li><span class="section-number">4.5.2. </span>Memory-to-Memory Stateful Video Encoder Interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/userspace-api/media/v4l/dev-encoder.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-to-memory-stateful-video-encoder-interface">
<span id="encoder"></span><h1><span class="section-number">4.5.2. </span>Memory-to-Memory Stateful Video Encoder Interface<a class="headerlink" href="#memory-to-memory-stateful-video-encoder-interface" title="Permalink to this headline">¶</a></h1>
<p>A stateful video encoder takes raw video frames in display order and encodes
them into a bytestream. It generates complete chunks of the bytestream, including
all metadata, headers, etc. The resulting bytestream does not require any
further post-processing by the client.</p>
<p>Performing software stream processing, header generation etc. in the driver
in order to support this interface is strongly discouraged. In case such
operations are needed, use of the Stateless Video Encoder Interface (in
development) is strongly advised.</p>
<div class="section" id="conventions-and-notations-used-in-this-document">
<h2><span class="section-number">4.5.2.1. </span>Conventions and Notations Used in This Document<a class="headerlink" href="#conventions-and-notations-used-in-this-document" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>The general V4L2 API rules apply if not specified in this document
otherwise.</p></li>
<li><p>The meaning of words “must”, “may”, “should”, etc. is as per <a class="reference external" href="https://tools.ietf.org/html/rfc2119">RFC
2119</a>.</p></li>
<li><p>All steps not marked “optional” are required.</p></li>
<li><p><code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_G_EXT_CTRLS()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_EXT_CTRLS()</span></code> may be used
interchangeably with <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_G_CTRL()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_CTRL()</span></code>,
unless specified otherwise.</p></li>
<li><p>Single-planar API (see <a class="reference internal" href="planar-apis.html#planar-apis"><span class="std std-ref">Single- and multi-planar APIs</span></a>) and applicable structures may be
used interchangeably with multi-planar API, unless specified otherwise,
depending on encoder capabilities and following the general V4L2 guidelines.</p></li>
<li><p>i = [a..b]: sequence of integers from a to b, inclusive, i.e. i =
[0..2]: i = 0, 1, 2.</p></li>
<li><p>Given an <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer A, then A’ represents a buffer on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>
queue containing data that resulted from processing buffer A.</p></li>
</ol>
</div>
<div class="section" id="glossary">
<h2><span class="section-number">4.5.2.2. </span>Glossary<a class="headerlink" href="#glossary" title="Permalink to this headline">¶</a></h2>
<p>Refer to <a class="reference internal" href="dev-decoder.html#decoder-glossary"><span class="std std-ref">Glossary</span></a>.</p>
</div>
<div class="section" id="state-machine">
<h2><span class="section-number">4.5.2.3. </span>State Machine<a class="headerlink" href="#state-machine" title="Permalink to this headline">¶</a></h2>
<div class="figure align-default" id="id1">
<img alt="DOT digraph of encoder state machine" src="../../../_images/DOT-275b1704cf2edc6a718dbaa14f6209ea7856c685.svg" /><p class="caption"><span class="caption-text">Encoder State Machine</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="querying-capabilities">
<h2><span class="section-number">4.5.2.4. </span>Querying Capabilities<a class="headerlink" href="#querying-capabilities" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>To enumerate the set of coded formats supported by the encoder, the
client may call <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FMT()</span></code> on <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p>
<ul class="simple">
<li><p>The full set of supported formats will be returned, regardless of the
format set on <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p></li>
</ul>
</li>
<li><p>To enumerate the set of supported raw formats, the client may call
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FMT()</span></code> on <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
<ul class="simple">
<li><p>Only the formats supported for the format currently active on <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>
will be returned.</p></li>
<li><p>In order to enumerate raw formats supported by a given coded format,
the client must first set that coded format on <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> and then
enumerate the formats on <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p></li>
</ul>
</li>
<li><p>The client may use <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMESIZES()</span></code> to detect supported
resolutions for a given format, passing the desired pixel format in
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_frmsizeenum</span></code> <code class="docutils literal notranslate"><span class="pre">pixel_format</span></code>.</p>
<ul class="simple">
<li><p>Values returned by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMESIZES()</span></code> for a coded pixel
format will include all possible coded resolutions supported by the
encoder for the given coded pixel format.</p></li>
<li><p>Values returned by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMESIZES()</span></code> for a raw pixel format
will include all possible frame buffer resolutions supported by the
encoder for the given raw pixel format and coded format currently set on
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p></li>
</ul>
</li>
<li><p>The client may use <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMEINTERVALS()</span></code> to detect supported
frame intervals for a given format and resolution, passing the desired pixel
format in <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_frmsizeenum</span></code> <code class="docutils literal notranslate"><span class="pre">pixel_format</span></code> and the resolution
in <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_frmsizeenum</span></code> <code class="docutils literal notranslate"><span class="pre">width</span></code> and <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_frmsizeenum</span></code>
<code class="docutils literal notranslate"><span class="pre">height</span></code>.</p>
<ul class="simple">
<li><p>Values returned by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMEINTERVALS()</span></code> for a coded pixel
format and coded resolution will include all possible frame intervals
supported by the encoder for the given coded pixel format and resolution.</p></li>
<li><p>Values returned by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMEINTERVALS()</span></code> for a raw pixel
format and resolution will include all possible frame intervals supported
by the encoder for the given raw pixel format and resolution and for the
coded format, coded resolution and coded frame interval currently set on
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p></li>
<li><p>Support for <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMEINTERVALS()</span></code> is optional. If it is
not implemented, then there are no special restrictions other than the
limits of the codec itself.</p></li>
</ul>
</li>
<li><p>Supported profiles and levels for the coded format currently set on
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>, if applicable, may be queried using their respective controls
via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_QUERYCTRL()</span></code>.</p></li>
<li><p>Any additional encoder capabilities may be discovered by querying
their respective controls.</p></li>
</ol>
</div>
<div class="section" id="initialization">
<h2><span class="section-number">4.5.2.5. </span>Initialization<a class="headerlink" href="#initialization" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Set the coded format on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_FMT()</span></code>.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pixelformat</span></code></dt><dd><p>the coded format to be produced.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sizeimage</span></code></dt><dd><p>desired size of <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers; the encoder may adjust it to
match hardware requirements.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">width</span></code>, <code class="docutils literal notranslate"><span class="pre">height</span></code></dt><dd><p>ignored (read-only).</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">sizeimage</span></code></dt><dd><p>adjusted size of <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">width</span></code>, <code class="docutils literal notranslate"><span class="pre">height</span></code></dt><dd><p>the coded size selected by the encoder based on current state, e.g.
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format, selection rectangles, etc. (read-only).</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Changing the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> format may change the currently set <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>
format. How the new <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format is determined is up to the encoder
and the client must ensure it matches its needs afterwards.</p>
</div>
</li>
<li><p><strong>Optional.</strong> Enumerate supported <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> formats (raw formats for
source) for the selected coded format via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FMT()</span></code>.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">pixelformat</span></code></dt><dd><p>raw format supported for the coded format currently selected on
the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
</ul>
</li>
<li><p>Set the raw source format on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_FMT()</span></code>.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pixelformat</span></code></dt><dd><p>raw format of the source.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">width</span></code>, <code class="docutils literal notranslate"><span class="pre">height</span></code></dt><dd><p>source resolution.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">width</span></code>, <code class="docutils literal notranslate"><span class="pre">height</span></code></dt><dd><p>may be adjusted to match encoder minimums, maximums and alignment
requirements, as required by the currently selected formats, as
reported by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENUM_FRAMESIZES()</span></code>.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p>Setting the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format will reset the selection rectangles to their
default values, based on the new resolution, as described in the next
step.</p></li>
</ul>
</li>
<li><p>Set the raw frame interval on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_PARM()</span></code>. This also sets the coded frame interval on the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue to the same value.</p>
<ul>
<li><p>** Required fields:**</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parm.output</span></code></dt><dd><p>set all fields except <code class="docutils literal notranslate"><span class="pre">parm.output.timeperframe</span></code> to 0.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parm.output.timeperframe</span></code></dt><dd><p>the desired frame interval; the encoder may adjust it to
match hardware requirements.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">parm.output.timeperframe</span></code></dt><dd><p>the adjusted frame interval.</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Changing the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> frame interval <em>also</em> sets the framerate that
the encoder uses to encode the video. So setting the frame interval
to 1/24 (or 24 frames per second) will produce a coded video stream
that can be played back at that speed. The frame interval for the
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue is just a hint, the application may provide raw
frames at a different rate. It can be used by the driver to help
schedule multiple encoders running in parallel.</p>
<p>In the next step the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> frame interval can optionally be
changed to a different value. This is useful for off-line encoding
were the coded frame interval can be different from the rate at
which raw frames are supplied.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code class="docutils literal notranslate"><span class="pre">timeperframe</span></code> deals with <em>frames</em>, not fields. So for interlaced
formats this is the time per two fields, since a frame consists of
a top and a bottom field.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is due to historical reasons that changing the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> frame
interval also changes the coded frame interval on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>
queue. Ideally these would be independent settings, but that would
break the existing API.</p>
</div>
</li>
<li><p><strong>Optional</strong> Set the coded frame interval on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_PARM()</span></code>. This is only necessary if the coded frame
interval is different from the raw frame interval, which is typically
the case for off-line encoding. Support for this feature is signalled
by the <a class="reference internal" href="vidioc-enum-fmt.html#fmtdesc-flags"><span class="std std-ref">V4L2_FMT_FLAG_ENC_CAP_FRAME_INTERVAL</span></a> format flag.</p>
<ul>
<li><p>** Required fields:**</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parm.capture</span></code></dt><dd><p>set all fields except <code class="docutils literal notranslate"><span class="pre">parm.capture.timeperframe</span></code> to 0.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parm.capture.timeperframe</span></code></dt><dd><p>the desired coded frame interval; the encoder may adjust it to
match hardware requirements.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">parm.capture.timeperframe</span></code></dt><dd><p>the adjusted frame interval.</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Changing the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> frame interval sets the framerate for the
coded video. It does <em>not</em> set the rate at which buffers arrive on the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue, that depends on how fast the encoder is and how
fast raw frames are queued on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code class="docutils literal notranslate"><span class="pre">timeperframe</span></code> deals with <em>frames</em>, not fields. So for interlaced
formats this is the time per two fields, since a frame consists of
a top and a bottom field.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Not all drivers support this functionality, in that case just set
the desired coded frame interval for the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue.</p>
<p>However, drivers that can schedule multiple encoders based on the
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> frame interval must support this optional feature.</p>
</div>
</li>
<li><p><strong>Optional.</strong> Set the visible resolution for the stream metadata via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_SELECTION()</span></code> on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue if it is desired
to be different than the full OUTPUT resolution.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">target</span></code></dt><dd><p>set to <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">r.left</span></code>, <code class="docutils literal notranslate"><span class="pre">r.top</span></code>, <code class="docutils literal notranslate"><span class="pre">r.width</span></code>, <code class="docutils literal notranslate"><span class="pre">r.height</span></code></dt><dd><p>visible rectangle; this must fit within the <cite>V4L2_SEL_TGT_CROP_BOUNDS</cite>
rectangle and may be subject to adjustment to match codec and
hardware constraints.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">r.left</span></code>, <code class="docutils literal notranslate"><span class="pre">r.top</span></code>, <code class="docutils literal notranslate"><span class="pre">r.width</span></code>, <code class="docutils literal notranslate"><span class="pre">r.height</span></code></dt><dd><p>visible rectangle adjusted by the encoder.</p>
</dd>
</dl>
</li>
<li><p>The following selection targets are supported on <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP_BOUNDS</span></code></dt><dd><p>equal to the full source frame, matching the active <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>
format.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP_DEFAULT</span></code></dt><dd><p>equal to <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP_BOUNDS</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP</span></code></dt><dd><p>rectangle within the source buffer to be encoded into the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> stream; defaults to <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_CROP_DEFAULT</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A common use case for this selection target is encoding a source
video with a resolution that is not a multiple of a macroblock,
e.g.  the common 1920x1080 resolution may require the source
buffers to be aligned to 1920x1088 for codecs with 16x16 macroblock
size. To avoid encoding the padding, the client needs to explicitly
configure this selection target to 1920x1080.</p>
</div>
</dd>
</dl>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The encoder may adjust the crop/compose rectangles to the nearest
supported ones to meet codec and hardware requirements. The client needs
to check the adjusted rectangle returned by <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_SELECTION()</span></code>.</p>
</div>
</li>
<li><p>Allocate buffers for both <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> and <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_REQBUFS()</span></code>. This may be performed in any order.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>requested number of buffers to allocate; greater than zero.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> or
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>actual number of buffers allocated.</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The actual number of allocated buffers may differ from the <code class="docutils literal notranslate"><span class="pre">count</span></code>
given. The client must check the updated value of <code class="docutils literal notranslate"><span class="pre">count</span></code> after the
call returns.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To allocate more than the minimum number of OUTPUT buffers (for pipeline
depth), the client may query the <code class="docutils literal notranslate"><span class="pre">V4L2_CID_MIN_BUFFERS_FOR_OUTPUT</span></code>
control to get the minimum number of buffers required, and pass the
obtained value plus the number of additional buffers needed in the
<code class="docutils literal notranslate"><span class="pre">count</span></code> field to <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_REQBUFS()</span></code>.</p>
</div>
<p>Alternatively, <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_CREATE_BUFS()</span></code> can be used to have more
control over buffer allocation.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>requested number of buffers to allocate; greater than zero.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>a <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_TYPE_*</span></code> enum appropriate for <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>.</p>
</dd>
<dt>other fields</dt><dd><p>follow standard semantics.</p>
</dd>
</dl>
</li>
<li><p><strong>Return fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>adjusted to the number of allocated buffers.</p>
</dd>
</dl>
</li>
</ul>
</li>
<li><p>Begin streaming on both <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> and <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queues via
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMON()</span></code>. This may be performed in any order. The actual
encoding process starts when both queues start streaming.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the client stops the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue during the encode process and then
restarts it again, the encoder will begin generating a stream independent
from the stream generated before the stop. The exact constraints depend
on the coded format, but may include the following implications:</p>
<ul class="simple">
<li><p>encoded frames produced after the restart must not reference any
frames produced before the stop, e.g. no long term references for
H.264/HEVC,</p></li>
<li><p>any headers that must be included in a standalone stream must be
produced again, e.g. SPS and PPS for H.264/HEVC.</p></li>
</ul>
</div>
</div>
<div class="section" id="encoding">
<h2><span class="section-number">4.5.2.6. </span>Encoding<a class="headerlink" href="#encoding" title="Permalink to this headline">¶</a></h2>
<p>This state is reached after the <cite>Initialization</cite> sequence finishes
successfully.  In this state, the client queues and dequeues buffers to both
queues via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_QBUF()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_DQBUF()</span></code>, following the
standard semantics.</p>
<p>The content of encoded <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers depends on the active coded pixel
format and may be affected by codec-specific extended controls, as stated
in the documentation of each format.</p>
<p>Both queues operate independently, following standard behavior of V4L2 buffer
queues and memory-to-memory devices. In addition, the order of encoded frames
dequeued from the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue may differ from the order of queuing raw
frames to the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue, due to properties of the selected coded format,
e.g. frame reordering.</p>
<p>The client must not assume any direct relationship between <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> and
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers and any specific timing of buffers becoming
available to dequeue. Specifically:</p>
<ul class="simple">
<li><p>a buffer queued to <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> may result in more than one buffer produced on
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> (for example, if returning an encoded frame allowed the encoder
to return a frame that preceded it in display, but succeeded it in the decode
order; however, there may be other reasons for this as well),</p></li>
<li><p>a buffer queued to <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> may result in a buffer being produced on
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> later into encode process, and/or after processing further
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers, or be returned out of order, e.g. if display
reordering is used,</p></li>
<li><p>buffers may become available on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue without additional
buffers queued to <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> (e.g. during drain or <code class="docutils literal notranslate"><span class="pre">EOS</span></code>), because of the
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers queued in the past whose encoding results are only
available at later time, due to specifics of the encoding process,</p></li>
<li><p>buffers queued to <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> may not become available to dequeue instantly
after being encoded into a corresponding <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer, e.g. if the
encoder needs to use the frame as a reference for encoding further frames.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To allow matching encoded <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers with <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers they
originated from, the client can set the <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> field of the
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_buffer</span></code> struct when queuing an <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer. The
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer(s), which resulted from encoding that <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer
will have their <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> field set to the same value when dequeued.</p>
<p>In addition to the straightforward case of one <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer producing
one <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer, the following cases are defined:</p>
<ul class="simple">
<li><p>one <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer generates multiple <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers: the same
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> timestamp will be copied to multiple <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers,</p></li>
<li><p>the encoding order differs from the presentation order (i.e. the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers are out-of-order compared to the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers):
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> timestamps will not retain the order of <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> timestamps.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To let the client distinguish between frame types (keyframes, intermediate
frames; the exact list of types depends on the coded format), the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers will have corresponding flag bits set in their
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_buffer</span></code> struct when dequeued. See the documentation of
<code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_buffer</span></code> and each coded pixel format for exact list of flags
and their meanings.</p>
</div>
<p>Should an encoding error occur, it will be reported to the client with the level
of details depending on the encoder capabilities. Specifically:</p>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer (if any) that contains the results of the failed encode
operation will be returned with the <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_ERROR</span></code> flag set,</p></li>
<li><p>if the encoder is able to precisely report the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer(s) that triggered
the error, such buffer(s) will be returned with the <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_ERROR</span></code> flag
set.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If a <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer is too small then it is just returned with the
<code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_ERROR</span></code> flag set. More work is needed to detect that this
error occurred because the buffer was too small, and to provide support to
free existing buffers that were too small.</p>
</div>
<p>In case of a fatal failure that does not allow the encoding to continue, any
further operations on corresponding encoder file handle will return the -EIO
error code. The client may close the file handle and open a new one, or
alternatively reinitialize the instance by stopping streaming on both queues,
releasing all buffers and performing the Initialization sequence again.</p>
</div>
<div class="section" id="encoding-parameter-changes">
<h2><span class="section-number">4.5.2.7. </span>Encoding Parameter Changes<a class="headerlink" href="#encoding-parameter-changes" title="Permalink to this headline">¶</a></h2>
<p>The client is allowed to use <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_S_CTRL()</span></code> to change encoder
parameters at any time. The availability of parameters is encoder-specific
and the client must query the encoder to find the set of available controls.</p>
<p>The ability to change each parameter during encoding is encoder-specific, as
per the standard semantics of the V4L2 control interface. The client may
attempt to set a control during encoding and if the operation fails with the
-EBUSY error code, the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue needs to be stopped for the
configuration change to be allowed. To do this, it may follow the <cite>Drain</cite>
sequence to avoid losing the already queued/encoded frames.</p>
<p>The timing of parameter updates is encoder-specific, as per the standard
semantics of the V4L2 control interface. If the client needs to apply the
parameters exactly at specific frame, using the Request API
(<a class="reference internal" href="../mediactl/request-api.html#media-request-api"><span class="std std-ref">Request API</span></a>) should be considered, if supported by the encoder.</p>
</div>
<div class="section" id="drain">
<h2><span class="section-number">4.5.2.8. </span>Drain<a class="headerlink" href="#drain" title="Permalink to this headline">¶</a></h2>
<p>To ensure that all the queued <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers have been processed and the
related <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers are given to the client, the client must follow the
drain sequence described below. After the drain sequence ends, the client has
received all encoded frames for all <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers queued before the
sequence was started.</p>
<ol class="arabic">
<li><p>Begin the drain sequence by issuing <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENCODER_CMD()</span></code>.</p>
<ul>
<li><p><strong>Required fields:</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">cmd</span></code></dt><dd><p>set to <code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt><dd><p>set to 0.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pts</span></code></dt><dd><p>set to 0.</p>
</dd>
</dl>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The sequence can be only initiated if both <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> and <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>
queues are streaming. For compatibility reasons, the call to
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENCODER_CMD()</span></code> will not fail even if any of the queues is
not streaming, but at the same time it will not initiate the <cite>Drain</cite>
sequence and so the steps described below would not be applicable.</p>
</div>
</li>
<li><p>Any <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers queued by the client before the
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_ENCODER_CMD()</span></code> was issued will be processed and encoded as
normal. The client must continue to handle both queues independently,
similarly to normal encode operation. This includes:</p>
<ul>
<li><p>queuing and dequeuing <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers, until a buffer marked with the
<code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code> flag is dequeued,</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The last buffer may be empty (with <code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_buffer</span></code>
<code class="docutils literal notranslate"><span class="pre">bytesused</span></code> = 0) and in that case it must be ignored by the client,
as it does not contain an encoded frame.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any attempt to dequeue more <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers beyond the buffer
marked with <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code> will result in a -EPIPE error from
<code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_DQBUF()</span></code>.</p>
</div>
</li>
<li><p>dequeuing processed <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers, until all the buffers queued
before the <code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code> command are dequeued,</p></li>
<li><p>dequeuing the <code class="docutils literal notranslate"><span class="pre">V4L2_EVENT_EOS</span></code> event, if the client subscribes to it.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For backwards compatibility, the encoder will signal a <code class="docutils literal notranslate"><span class="pre">V4L2_EVENT_EOS</span></code>
event when the last frame has been encoded and all frames are ready to be
dequeued. It is deprecated behavior and the client must not rely on it.
The <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code> buffer flag should be used instead.</p>
</div>
</li>
<li><p>Once all <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers queued before the <code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code> call are
dequeued and the last <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer is dequeued, the encoder is stopped
and it will accept, but not process any newly queued <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffers
until the client issues any of the following operations:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_START</span></code> - the encoder will not be reset and will resume
operation normally, with all the state from before the drain,</p></li>
<li><p>a pair of <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMON()</span></code> on the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue - the encoder will be reset (see the <cite>Reset</cite> sequence)
and then resume encoding,</p></li>
<li><p>a pair of <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMON()</span></code> on the
<code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue - the encoder will resume operation normally, however any
source frames queued to the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue between <code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code>
and <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> will be discarded.</p></li>
</ul>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Once the drain sequence is initiated, the client needs to drive it to
completion, as described by the steps above, unless it aborts the process by
issuing <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> on any of the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> or <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code>
queues.  The client is not allowed to issue <code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_START</span></code> or
<code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code> again while the drain sequence is in progress and they
will fail with -EBUSY error code if attempted.</p>
<p>For reference, handling of various corner cases is described below:</p>
<ul class="simple">
<li><p>In case of no buffer in the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue at the time the
<code class="docutils literal notranslate"><span class="pre">V4L2_ENC_CMD_STOP</span></code> command was issued, the drain sequence completes
immediately and the encoder returns an empty <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer with the
<code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code> flag set.</p></li>
<li><p>In case of no buffer in the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue at the time the drain
sequence completes, the next time the client queues a <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer
it is returned at once as an empty buffer with the <code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code>
flag set.</p></li>
<li><p>If <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> is called on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue in the
middle of the drain sequence, the drain sequence is canceled and all
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers are implicitly returned to the client.</p></li>
<li><p>If <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code> is called on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue in the
middle of the drain sequence, the drain sequence completes immediately and
next <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffer will be returned empty with the
<code class="docutils literal notranslate"><span class="pre">V4L2_BUF_FLAG_LAST</span></code> flag set.</p></li>
</ul>
<p>Although not mandatory, the availability of encoder commands may be queried
using <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_TRY_ENCODER_CMD()</span></code>.</p>
</div>
</div>
<div class="section" id="reset">
<h2><span class="section-number">4.5.2.9. </span>Reset<a class="headerlink" href="#reset" title="Permalink to this headline">¶</a></h2>
<p>The client may want to request the encoder to reinitialize the encoding, so
that the following stream data becomes independent from the stream data
generated before. Depending on the coded format, that may imply that:</p>
<ul class="simple">
<li><p>encoded frames produced after the restart must not reference any frames
produced before the stop, e.g. no long term references for H.264/HEVC,</p></li>
<li><p>any headers that must be included in a standalone stream must be produced
again, e.g. SPS and PPS for H.264/HEVC.</p></li>
</ul>
<p>This can be achieved by performing the reset sequence.</p>
<ol class="arabic simple">
<li><p>Perform the <cite>Drain</cite> sequence to ensure all the in-flight encoding finishes
and respective buffers are dequeued.</p></li>
<li><p>Stop streaming on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMOFF()</span></code>. This
will return all currently queued <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers to the client, without
valid frame data.</p></li>
<li><p>Start streaming on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue via <code class="xref c c-func docutils literal notranslate"><span class="pre">VIDIOC_STREAMON()</span></code> and
continue with regular encoding sequence. The encoded frames produced into
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> buffers from now on will contain a standalone stream that can be
decoded without the need for frames encoded before the reset sequence,
starting at the first <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> buffer queued after issuing the
<cite>V4L2_ENC_CMD_STOP</cite> of the <cite>Drain</cite> sequence.</p></li>
</ol>
<p>This sequence may be also used to change encoding parameters for encoders
without the ability to change the parameters on the fly.</p>
</div>
<div class="section" id="commit-points">
<h2><span class="section-number">4.5.2.10. </span>Commit Points<a class="headerlink" href="#commit-points" title="Permalink to this headline">¶</a></h2>
<p>Setting formats and allocating buffers triggers changes in the behavior of the
encoder.</p>
<ol class="arabic simple">
<li><p>Setting the format on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue may change the set of formats
supported/advertised on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue. In particular, it also means
that the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format may be reset and the client must not rely on the
previously set format being preserved.</p></li>
<li><p>Enumerating formats on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue always returns only formats
supported for the current <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> format.</p></li>
<li><p>Setting the format on the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue does not change the list of
formats available on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue. An attempt to set the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code>
format that is not supported for the currently selected <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> format
will result in the encoder adjusting the requested <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format to a
supported one.</p></li>
<li><p>Enumerating formats on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue always returns the full set of
supported coded formats, irrespective of the current <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> format.</p></li>
<li><p>While buffers are allocated on any of the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> or <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queues,
the client must not change the format on the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue. Drivers will
return the -EBUSY error code for any such format change attempt.</p></li>
</ol>
<p>To summarize, setting formats and allocation must always start with the
<code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue and the <code class="docutils literal notranslate"><span class="pre">CAPTURE</span></code> queue is the master that governs the
set of supported formats for the <code class="docutils literal notranslate"><span class="pre">OUTPUT</span></code> queue.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="dev-stateless-decoder.html" class="btn btn-neutral float-right" title="4.5.3. Memory-to-memory Stateless Video Decoder Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dev-decoder.html" class="btn btn-neutral float-left" title="4.5.1. Memory-to-Memory Stateful Video Decoder Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>