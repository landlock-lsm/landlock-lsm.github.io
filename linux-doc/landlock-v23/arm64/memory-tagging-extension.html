

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Memory Tagging Extension (MTE) in AArch64 Linux &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Perf Event Attributes" href="perf.html" />
    <link rel="prev" title="Memory Layout on AArch64 Linux" href="memory.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">ARM64 Architecture</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="acpi_object_usage.html">ACPI Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="amu.html">Activity Monitors Unit (AMU) extension in AArch64 Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="arm-acpi.html">ACPI on ARMv8 Servers</a></li>
<li class="toctree-l2"><a class="reference internal" href="booting.html">Booting AArch64 Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="cpu-feature-registers.html">ARM64 CPU Feature Registers</a></li>
<li class="toctree-l2"><a class="reference internal" href="elf_hwcaps.html">ARM64 ELF hwcaps</a></li>
<li class="toctree-l2"><a class="reference internal" href="hugetlbpage.html">HugeTLBpage on ARM64</a></li>
<li class="toctree-l2"><a class="reference internal" href="legacy_instructions.html">Legacy instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html">Memory Layout on AArch64 Linux</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Memory Tagging Extension (MTE) in AArch64 Linux</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#userspace-support">Userspace Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#prot-mte">PROT_MTE</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tag-check-faults">Tag Check Faults</a></li>
<li class="toctree-l4"><a class="reference internal" href="#excluding-tags-in-the-irg-addg-and-subg-instructions">Excluding Tags in the <code class="docutils literal notranslate"><span class="pre">IRG</span></code>, <code class="docutils literal notranslate"><span class="pre">ADDG</span></code> and <code class="docutils literal notranslate"><span class="pre">SUBG</span></code> instructions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initial-process-state">Initial process state</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-ptrace-interface">The <code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> interface</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#example-of-correct-usage">Example of correct usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="perf.html">Perf Event Attributes</a></li>
<li class="toctree-l2"><a class="reference internal" href="pointer-authentication.html">Pointer authentication in AArch64 Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="silicon-errata.html">Silicon Errata and Software Workarounds</a></li>
<li class="toctree-l2"><a class="reference internal" href="sve.html">Scalable Vector Extension support for AArch64 Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="tagged-address-abi.html">AArch64 TAGGED ADDRESS ABI</a></li>
<li class="toctree-l2"><a class="reference internal" href="tagged-pointers.html">Tagged virtual addresses in AArch64 Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">ARM64 Architecture</a> &raquo;</li>
        
      <li>Memory Tagging Extension (MTE) in AArch64 Linux</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/arm64/memory-tagging-extension.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="memory-tagging-extension-mte-in-aarch64-linux">
<h1>Memory Tagging Extension (MTE) in AArch64 Linux<a class="headerlink" href="#memory-tagging-extension-mte-in-aarch64-linux" title="Permalink to this headline">¶</a></h1>
<dl class="simple">
<dt>Authors: Vincenzo Frascino &lt;<a class="reference external" href="mailto:vincenzo&#46;frascino&#37;&#52;&#48;arm&#46;com">vincenzo<span>&#46;</span>frascino<span>&#64;</span>arm<span>&#46;</span>com</a>&gt;</dt><dd><p>Catalin Marinas &lt;<a class="reference external" href="mailto:catalin&#46;marinas&#37;&#52;&#48;arm&#46;com">catalin<span>&#46;</span>marinas<span>&#64;</span>arm<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<p>Date: 2020-02-25</p>
<p>This document describes the provision of the Memory Tagging Extension
functionality in AArch64 Linux.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>ARMv8.5 based processors introduce the Memory Tagging Extension (MTE)
feature. MTE is built on top of the ARMv8.0 virtual address tagging TBI
(Top Byte Ignore) feature and allows software to access a 4-bit
allocation tag for each 16-byte granule in the physical address space.
Such memory range must be mapped with the Normal-Tagged memory
attribute. A logical tag is derived from bits 59-56 of the virtual
address used for the memory access. A CPU with MTE enabled will compare
the logical tag against the allocation tag and potentially raise an
exception on mismatch, subject to system registers configuration.</p>
</div>
<div class="section" id="userspace-support">
<h2>Userspace Support<a class="headerlink" href="#userspace-support" title="Permalink to this headline">¶</a></h2>
<p>When <code class="docutils literal notranslate"><span class="pre">CONFIG_ARM64_MTE</span></code> is selected and Memory Tagging Extension is
supported by the hardware, the kernel advertises the feature to
userspace via <code class="docutils literal notranslate"><span class="pre">HWCAP2_MTE</span></code>.</p>
<div class="section" id="prot-mte">
<h3>PROT_MTE<a class="headerlink" href="#prot-mte" title="Permalink to this headline">¶</a></h3>
<p>To access the allocation tags, a user process must enable the Tagged
memory attribute on an address range using a new <code class="docutils literal notranslate"><span class="pre">prot</span></code> flag for
<code class="docutils literal notranslate"><span class="pre">mmap()</span></code> and <code class="docutils literal notranslate"><span class="pre">mprotect()</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> - Pages allow access to the MTE allocation tags.</p>
<p>The allocation tag is set to 0 when such pages are first mapped in the
user address space and preserved on copy-on-write. <code class="docutils literal notranslate"><span class="pre">MAP_SHARED</span></code> is
supported and the allocation tags can be shared between processes.</p>
<p><strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> is only supported on <code class="docutils literal notranslate"><span class="pre">MAP_ANONYMOUS</span></code> and
RAM-based file mappings (<code class="docutils literal notranslate"><span class="pre">tmpfs</span></code>, <code class="docutils literal notranslate"><span class="pre">memfd</span></code>). Passing it to other
types of mapping will result in <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> returned by these system
calls.</p>
<p><strong>Note</strong>: The <code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> flag (and corresponding memory type) cannot
be cleared by <code class="docutils literal notranslate"><span class="pre">mprotect()</span></code>.</p>
<p><strong>Note</strong>: <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> memory ranges with <code class="docutils literal notranslate"><span class="pre">MADV_DONTNEED</span></code> and
<code class="docutils literal notranslate"><span class="pre">MADV_FREE</span></code> may have the allocation tags cleared (set to 0) at any
point after the system call.</p>
</div>
<div class="section" id="tag-check-faults">
<h3>Tag Check Faults<a class="headerlink" href="#tag-check-faults" title="Permalink to this headline">¶</a></h3>
<p>When <code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> is enabled on an address range and a mismatch between
the logical and allocation tags occurs on access, there are three
configurable behaviours:</p>
<ul class="simple">
<li><p><em>Ignore</em> - This is the default mode. The CPU (and kernel) ignores the
tag check fault.</p></li>
<li><p><em>Synchronous</em> - The kernel raises a <code class="docutils literal notranslate"><span class="pre">SIGSEGV</span></code> synchronously, with
<code class="docutils literal notranslate"><span class="pre">.si_code</span> <span class="pre">=</span> <span class="pre">SEGV_MTESERR</span></code> and <code class="docutils literal notranslate"><span class="pre">.si_addr</span> <span class="pre">=</span> <span class="pre">&lt;fault-address&gt;</span></code>. The
memory access is not performed. If <code class="docutils literal notranslate"><span class="pre">SIGSEGV</span></code> is ignored or blocked
by the offending thread, the containing process is terminated with a
<code class="docutils literal notranslate"><span class="pre">coredump</span></code>.</p></li>
<li><p><em>Asynchronous</em> - The kernel raises a <code class="docutils literal notranslate"><span class="pre">SIGSEGV</span></code>, in the offending
thread, asynchronously following one or multiple tag check faults,
with <code class="docutils literal notranslate"><span class="pre">.si_code</span> <span class="pre">=</span> <span class="pre">SEGV_MTEAERR</span></code> and <code class="docutils literal notranslate"><span class="pre">.si_addr</span> <span class="pre">=</span> <span class="pre">0</span></code> (the faulting
address is unknown).</p></li>
</ul>
<p>The user can select the above modes, per thread, using the
<code class="docutils literal notranslate"><span class="pre">prctl(PR_SET_TAGGED_ADDR_CTRL,</span> <span class="pre">flags,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0)</span></code> system call where
<code class="docutils literal notranslate"><span class="pre">flags</span></code> contain one of the following values in the <code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_MASK</span></code>
bit-field:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_NONE</span></code>  - <em>Ignore</em> tag check faults</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_SYNC</span></code>  - <em>Synchronous</em> tag check fault mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_ASYNC</span></code> - <em>Asynchronous</em> tag check fault mode</p></li>
</ul>
<p>The current tag check fault mode can be read using the
<code class="docutils literal notranslate"><span class="pre">prctl(PR_GET_TAGGED_ADDR_CTRL,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0)</span></code> system call.</p>
<p>Tag checking can also be disabled for a user thread by setting the
<code class="docutils literal notranslate"><span class="pre">PSTATE.TCO</span></code> bit with <code class="docutils literal notranslate"><span class="pre">MSR</span> <span class="pre">TCO,</span> <span class="pre">#1</span></code>.</p>
<p><strong>Note</strong>: Signal handlers are always invoked with <code class="docutils literal notranslate"><span class="pre">PSTATE.TCO</span> <span class="pre">=</span> <span class="pre">0</span></code>,
irrespective of the interrupted context. <code class="docutils literal notranslate"><span class="pre">PSTATE.TCO</span></code> is restored on
<code class="docutils literal notranslate"><span class="pre">sigreturn()</span></code>.</p>
<p><strong>Note</strong>: There are no <em>match-all</em> logical tags available for user
applications.</p>
<p><strong>Note</strong>: Kernel accesses to the user address space (e.g. <code class="docutils literal notranslate"><span class="pre">read()</span></code>
system call) are not checked if the user thread tag checking mode is
<code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_NONE</span></code> or <code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_ASYNC</span></code>. If the tag checking mode is
<code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_SYNC</span></code>, the kernel makes a best effort to check its user
address accesses, however it cannot always guarantee it. Kernel accesses
to user addresses are always performed with an effective <code class="docutils literal notranslate"><span class="pre">PSTATE.TCO</span></code>
value of zero, regardless of the user configuration.</p>
</div>
<div class="section" id="excluding-tags-in-the-irg-addg-and-subg-instructions">
<h3>Excluding Tags in the <code class="docutils literal notranslate"><span class="pre">IRG</span></code>, <code class="docutils literal notranslate"><span class="pre">ADDG</span></code> and <code class="docutils literal notranslate"><span class="pre">SUBG</span></code> instructions<a class="headerlink" href="#excluding-tags-in-the-irg-addg-and-subg-instructions" title="Permalink to this headline">¶</a></h3>
<p>The architecture allows excluding certain tags to be randomly generated
via the <code class="docutils literal notranslate"><span class="pre">GCR_EL1.Exclude</span></code> register bit-field. By default, Linux
excludes all tags other than 0. A user thread can enable specific tags
in the randomly generated set using the <code class="docutils literal notranslate"><span class="pre">prctl(PR_SET_TAGGED_ADDR_CTRL,</span>
<span class="pre">flags,</span> <span class="pre">0,</span> <span class="pre">0,</span> <span class="pre">0)</span></code> system call where <code class="docutils literal notranslate"><span class="pre">flags</span></code> contains the tags bitmap
in the <code class="docutils literal notranslate"><span class="pre">PR_MTE_TAG_MASK</span></code> bit-field.</p>
<p><strong>Note</strong>: The hardware uses an exclude mask but the <code class="docutils literal notranslate"><span class="pre">prctl()</span></code>
interface provides an include mask. An include mask of <code class="docutils literal notranslate"><span class="pre">0</span></code> (exclusion
mask <code class="docutils literal notranslate"><span class="pre">0xffff</span></code>) results in the CPU always generating tag <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div>
<div class="section" id="initial-process-state">
<h3>Initial process state<a class="headerlink" href="#initial-process-state" title="Permalink to this headline">¶</a></h3>
<p>On <code class="docutils literal notranslate"><span class="pre">execve()</span></code>, the new process has the following configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">PR_TAGGED_ADDR_ENABLE</span></code> set to 0 (disabled)</p></li>
<li><p>Tag checking mode set to <code class="docutils literal notranslate"><span class="pre">PR_MTE_TCF_NONE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PR_MTE_TAG_MASK</span></code> set to 0 (all tags excluded)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PSTATE.TCO</span></code> set to 0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> not set on any of the initial memory maps</p></li>
</ul>
<p>On <code class="docutils literal notranslate"><span class="pre">fork()</span></code>, the new process inherits the parent’s configuration and
memory map attributes with the exception of the <code class="docutils literal notranslate"><span class="pre">madvise()</span></code> ranges
with <code class="docutils literal notranslate"><span class="pre">MADV_WIPEONFORK</span></code> which will have the data and tags cleared (set
to 0).</p>
</div>
<div class="section" id="the-ptrace-interface">
<h3>The <code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> interface<a class="headerlink" href="#the-ptrace-interface" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">PTRACE_PEEKMTETAGS</span></code> and <code class="docutils literal notranslate"><span class="pre">PTRACE_POKEMTETAGS</span></code> allow a tracer to read
the tags from or set the tags to a tracee’s address space. The
<code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> system call is invoked as <code class="docutils literal notranslate"><span class="pre">ptrace(request,</span> <span class="pre">pid,</span> <span class="pre">addr,</span>
<span class="pre">data)</span></code> where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">request</span></code> - one of <code class="docutils literal notranslate"><span class="pre">PTRACE_PEEKMTETAGS</span></code> or <code class="docutils literal notranslate"><span class="pre">PTRACE_POKEMTETAGS</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pid</span></code> - the tracee’s PID.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">addr</span></code> - address in the tracee’s address space.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> - pointer to a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iovec</span></code> where <code class="docutils literal notranslate"><span class="pre">iov_base</span></code> points to
a buffer of <code class="docutils literal notranslate"><span class="pre">iov_len</span></code> length in the tracer’s address space.</p></li>
</ul>
<p>The tags in the tracer’s <code class="docutils literal notranslate"><span class="pre">iov_base</span></code> buffer are represented as one
4-bit tag per byte and correspond to a 16-byte MTE tag granule in the
tracee’s address space.</p>
<p><strong>Note</strong>: If <code class="docutils literal notranslate"><span class="pre">addr</span></code> is not aligned to a 16-byte granule, the kernel
will use the corresponding aligned address.</p>
<p><code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> return value:</p>
<ul class="simple">
<li><p>0 - tags were copied, the tracer’s <code class="docutils literal notranslate"><span class="pre">iov_len</span></code> was updated to the
number of tags transferred. This may be smaller than the requested
<code class="docutils literal notranslate"><span class="pre">iov_len</span></code> if the requested address range in the tracee’s or the
tracer’s space cannot be accessed or does not have valid tags.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-EPERM</span></code> - the specified process cannot be traced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-EIO</span></code> - the tracee’s address range cannot be accessed (e.g. invalid
address) and no tags copied. <code class="docutils literal notranslate"><span class="pre">iov_len</span></code> not updated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-EFAULT</span></code> - fault on accessing the tracer’s memory (<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iovec</span></code>
or <code class="docutils literal notranslate"><span class="pre">iov_base</span></code> buffer) and no tags copied. <code class="docutils literal notranslate"><span class="pre">iov_len</span></code> not updated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-EOPNOTSUPP</span></code> - the tracee’s address does not have valid tags (never
mapped with the <code class="docutils literal notranslate"><span class="pre">PROT_MTE</span></code> flag). <code class="docutils literal notranslate"><span class="pre">iov_len</span></code> not updated.</p></li>
</ul>
<p><strong>Note</strong>: There are no transient errors for the requests above, so user
programs should not retry in case of a non-zero system call return.</p>
<p><code class="docutils literal notranslate"><span class="pre">PTRACE_GETREGSET</span></code> and <code class="docutils literal notranslate"><span class="pre">PTRACE_SETREGSET</span></code> with <code class="docutils literal notranslate"><span class="pre">addr</span> <span class="pre">==</span>
<span class="pre">``NT_ARM_TAGGED_ADDR_CTRL</span></code> allow <code class="docutils literal notranslate"><span class="pre">ptrace()</span></code> access to the tagged
address ABI control and MTE configuration of a process as per the
<code class="docutils literal notranslate"><span class="pre">prctl()</span></code> options described in
<a class="reference internal" href="tagged-address-abi.html"><span class="doc">AArch64 TAGGED ADDRESS ABI</span></a> and above. The corresponding
<code class="docutils literal notranslate"><span class="pre">regset</span></code> is 1 element of 8 bytes (<code class="docutils literal notranslate"><span class="pre">sizeof(long))</span></code>).</p>
</div>
</div>
<div class="section" id="example-of-correct-usage">
<h2>Example of correct usage<a class="headerlink" href="#example-of-correct-usage" title="Permalink to this headline">¶</a></h2>
<p><em>MTE Example code</em></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> * To be compiled with -march=armv8.5-a+memtag</span>
<span class="cm"> */</span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/auxv.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * From arch/arm64/include/uapi/asm/hwcap.h</span>
<span class="cm"> */</span>
<span class="cp">#define HWCAP2_MTE              (1 &lt;&lt; 18)</span>

<span class="cm">/*</span>
<span class="cm"> * From arch/arm64/include/uapi/asm/mman.h</span>
<span class="cm"> */</span>
<span class="cp">#define PROT_MTE                 0x20</span>

<span class="cm">/*</span>
<span class="cm"> * From include/uapi/linux/prctl.h</span>
<span class="cm"> */</span>
<span class="cp">#define PR_SET_TAGGED_ADDR_CTRL 55</span>
<span class="cp">#define PR_GET_TAGGED_ADDR_CTRL 56</span>
<span class="cp"># define PR_TAGGED_ADDR_ENABLE  (1UL &lt;&lt; 0)</span>
<span class="cp"># define PR_MTE_TCF_SHIFT       1</span>
<span class="cp"># define PR_MTE_TCF_NONE        (0UL &lt;&lt; PR_MTE_TCF_SHIFT)</span>
<span class="cp"># define PR_MTE_TCF_SYNC        (1UL &lt;&lt; PR_MTE_TCF_SHIFT)</span>
<span class="cp"># define PR_MTE_TCF_ASYNC       (2UL &lt;&lt; PR_MTE_TCF_SHIFT)</span>
<span class="cp"># define PR_MTE_TCF_MASK        (3UL &lt;&lt; PR_MTE_TCF_SHIFT)</span>
<span class="cp"># define PR_MTE_TAG_SHIFT       3</span>
<span class="cp"># define PR_MTE_TAG_MASK        (0xffffUL &lt;&lt; PR_MTE_TAG_SHIFT)</span>

<span class="cm">/*</span>
<span class="cm"> * Insert a random logical tag into the given pointer.</span>
<span class="cm"> */</span>
<span class="cp">#define insert_random_tag(ptr) ({                       \</span>
<span class="cp">        uint64_t __val;                                 \</span>
<span class="cp">        asm(&quot;irg %0, %1&quot; : &quot;=r&quot; (__val) : &quot;r&quot; (ptr));   \</span>
<span class="cp">        __val;                                          \</span>
<span class="cp">})</span>

<span class="cm">/*</span>
<span class="cm"> * Set the allocation tag on the destination address.</span>
<span class="cm"> */</span>
<span class="cp">#define set_tag(tagged_addr) do {                                      \</span>
<span class="cp">        asm volatile(&quot;stg %0, [%0]&quot; : : &quot;r&quot; (tagged_addr) : &quot;memory&quot;); \</span>
<span class="cp">} while (0)</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page_sz</span> <span class="o">=</span> <span class="n">sysconf</span><span class="p">(</span><span class="n">_SC_PAGESIZE</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hwcap2</span> <span class="o">=</span> <span class="n">getauxval</span><span class="p">(</span><span class="n">AT_HWCAP2</span><span class="p">);</span>

        <span class="cm">/* check if MTE is present */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hwcap2</span> <span class="o">&amp;</span> <span class="n">HWCAP2_MTE</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * Enable the tagged address ABI, synchronous MTE tag check faults and</span>
<span class="cm">         * allow all non-zero tags in the randomly generated set.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_TAGGED_ADDR_CTRL</span><span class="p">,</span>
                  <span class="n">PR_TAGGED_ADDR_ENABLE</span> <span class="o">|</span> <span class="n">PR_MTE_TCF_SYNC</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xfffe</span> <span class="o">&lt;&lt;</span> <span class="n">PR_MTE_TAG_SHIFT</span><span class="p">),</span>
                  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&quot;prctl() failed&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">page_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span>
                 <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span> <span class="mi">-1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&quot;mmap() failed&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * Enable MTE on the above anonymous mmap. The flag could be passed</span>
<span class="cm">         * directly to mmap() and skip this step.</span>
<span class="cm">         */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mprotect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">page_sz</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_MTE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">perror</span><span class="p">(</span><span class="s">&quot;mprotect() failed&quot;</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* access with the default tag (0) */</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;a[0] = %hhu a[1] = %hhu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="cm">/* set the logical and allocation tags */</span>
        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">insert_random_tag</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
        <span class="n">set_tag</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">);</span>

        <span class="cm">/* non-zero tag access */</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;a[0] = %hhu a[1] = %hhu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

        <span class="cm">/*</span>
<span class="cm">         * If MTE is enabled correctly the next instruction will generate an</span>
<span class="cm">         * exception.</span>
<span class="cm">         */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Expecting SIGSEGV...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdd</span><span class="p">;</span>

        <span class="cm">/* this should not be printed in the PR_MTE_TCF_SYNC mode */</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;...haven&#39;t got one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="perf.html" class="btn btn-neutral float-right" title="Perf Event Attributes" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="memory.html" class="btn btn-neutral float-left" title="Memory Layout on AArch64 Linux" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>