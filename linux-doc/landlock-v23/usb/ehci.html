

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>EHCI driver &mdash; The Linux Kernel  documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How FunctionFS works" href="functionfs.html" />
    <link rel="prev" title="DWC3 driver" href="dwc3.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">USB support</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="acm.html">Linux ACM driver v0.16</a></li>
<li class="toctree-l2"><a class="reference internal" href="authorization.html">Authorizing (or not) your USB devices to connect to the system</a></li>
<li class="toctree-l2"><a class="reference internal" href="chipidea.html">ChipIdea Highspeed Dual Role Controller Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="dwc3.html">DWC3 driver</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">EHCI driver</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#functionality">Functionality</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#transfer-types">Transfer Types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#driver-behavior">Driver Behavior</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#use-by">Use by</a></li>
<li class="toctree-l3"><a class="reference internal" href="#performance">Performance</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hardware-performance">Hardware Performance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#software-performance">Software Performance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="functionfs.html">How FunctionFS works</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_configfs.html">Linux USB gadget configured through configfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_hid.html">Linux USB HID gadget driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_multi.html">Multifunction Composite Gadget</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_printer.html">Linux USB Printer Gadget Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget_serial.html">Linux Gadget Serial Driver v2.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="gadget-testing.html">Gadget Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="iuu_phoenix.html">Infinity Usb Unlimited Readme</a></li>
<li class="toctree-l2"><a class="reference internal" href="mass-storage.html">Mass Storage Gadget (MSG)</a></li>
<li class="toctree-l2"><a class="reference internal" href="misc_usbsevseg.html">USB 7-Segment Numeric Display</a></li>
<li class="toctree-l2"><a class="reference internal" href="mtouchusb.html">mtouchusb driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="ohci.html">OHCI</a></li>
<li class="toctree-l2"><a class="reference internal" href="raw-gadget.html">USB Raw Gadget</a></li>
<li class="toctree-l2"><a class="reference internal" href="usbip_protocol.html">USB/IP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="usbmon.html">usbmon</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-serial.html">USB serial</a></li>
<li class="toctree-l2"><a class="reference internal" href="usb-help.html">USB references</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html">Linux CDC ACM inf</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#linux-inf">Linux inf</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#usb-devfs-drop-permissions-source">USB devfs drop permissions source</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html#credits">Credits</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">USB support</a> &raquo;</li>
        
      <li>EHCI driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/usb/ehci.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="ehci-driver">
<h1>EHCI driver<a class="headerlink" href="#ehci-driver" title="Permalink to this headline">¶</a></h1>
<p>27-Dec-2002</p>
<p>The EHCI driver is used to talk to high speed USB 2.0 devices using
USB 2.0-capable host controller hardware.  The USB 2.0 standard is
compatible with the USB 1.1 standard. It defines three transfer speeds:</p>
<blockquote>
<div><ul class="simple">
<li><p>“High Speed” 480 Mbit/sec (60 MByte/sec)</p></li>
<li><p>“Full Speed” 12 Mbit/sec (1.5 MByte/sec)</p></li>
<li><p>“Low Speed” 1.5 Mbit/sec</p></li>
</ul>
</div></blockquote>
<p>USB 1.1 only addressed full speed and low speed.  High speed devices
can be used on USB 1.1 systems, but they slow down to USB 1.1 speeds.</p>
<p>USB 1.1 devices may also be used on USB 2.0 systems.  When plugged
into an EHCI controller, they are given to a USB 1.1 “companion”
controller, which is a OHCI or UHCI controller as normally used with
such devices.  When USB 1.1 devices plug into USB 2.0 hubs, they
interact with the EHCI controller through a “Transaction Translator”
(TT) in the hub, which turns low or full speed transactions into
high speed “split transactions” that don’t waste transfer bandwidth.</p>
<p>At this writing, this driver has been seen to work with implementations
of EHCI from (in alphabetical order):  Intel, NEC, Philips, and VIA.
Other EHCI implementations are becoming available from other vendors;
you should expect this driver to work with them too.</p>
<p>While usb-storage devices have been available since mid-2001 (working
quite speedily on the 2.4 version of this driver), hubs have only
been available since late 2001, and other kinds of high speed devices
appear to be on hold until more systems come with USB 2.0 built-in.
Such new systems have been available since early 2002, and became much
more typical in the second half of 2002.</p>
<p>Note that USB 2.0 support involves more than just EHCI.  It requires
other changes to the Linux-USB core APIs, including the hub driver,
but those changes haven’t needed to really change the basic “usbcore”
APIs exposed to USB device drivers.</p>
<ul class="simple">
<li><p>David Brownell
&lt;<a class="reference external" href="mailto:dbrownell&#37;&#52;&#48;users&#46;sourceforge&#46;net">dbrownell<span>&#64;</span>users<span>&#46;</span>sourceforge<span>&#46;</span>net</a>&gt;</p></li>
</ul>
<div class="section" id="functionality">
<h2>Functionality<a class="headerlink" href="#functionality" title="Permalink to this headline">¶</a></h2>
<p>This driver is regularly tested on x86 hardware, and has also been
used on PPC hardware so big/little endianness issues should be gone.
It’s believed to do all the right PCI magic so that I/O works even on
systems with interesting DMA mapping issues.</p>
<div class="section" id="transfer-types">
<h3>Transfer Types<a class="headerlink" href="#transfer-types" title="Permalink to this headline">¶</a></h3>
<p>At this writing the driver should comfortably handle all control, bulk,
and interrupt transfers, including requests to USB 1.1 devices through
transaction translators (TTs) in USB 2.0 hubs.  But you may find bugs.</p>
<p>High Speed Isochronous (ISO) transfer support is also functional, but
at this writing no Linux drivers have been using that support.</p>
<p>Full Speed Isochronous transfer support, through transaction translators,
is not yet available.  Note that split transaction support for ISO
transfers can’t share much code with the code for high speed ISO transfers,
since EHCI represents these with a different data structure.  So for now,
most USB audio and video devices can’t be connected to high speed buses.</p>
</div>
<div class="section" id="driver-behavior">
<h3>Driver Behavior<a class="headerlink" href="#driver-behavior" title="Permalink to this headline">¶</a></h3>
<p>Transfers of all types can be queued.  This means that control transfers
from a driver on one interface (or through usbfs) won’t interfere with
ones from another driver, and that interrupt transfers can use periods
of one frame without risking data loss due to interrupt processing costs.</p>
<p>The EHCI root hub code hands off USB 1.1 devices to its companion
controller.  This driver doesn’t need to know anything about those
drivers; a OHCI or UHCI driver that works already doesn’t need to change
just because the EHCI driver is also present.</p>
<p>There are some issues with power management; suspend/resume doesn’t
behave quite right at the moment.</p>
<p>Also, some shortcuts have been taken with the scheduling periodic
transactions (interrupt and isochronous transfers).  These place some
limits on the number of periodic transactions that can be scheduled,
and prevent use of polling intervals of less than one frame.</p>
</div>
</div>
<div class="section" id="use-by">
<h2>Use by<a class="headerlink" href="#use-by" title="Permalink to this headline">¶</a></h2>
<p>Assuming you have an EHCI controller (on a PCI card or motherboard)
and have compiled this driver as a module, load this like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># modprobe ehci-hcd
</pre></div>
</div>
<p>and remove it by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># rmmod ehci-hcd
</pre></div>
</div>
<p>You should also have a driver for a “companion controller”, such as
“ohci-hcd”  or “uhci-hcd”.  In case of any trouble with the EHCI driver,
remove its module and then the driver for that companion controller will
take over (at lower speed) all the devices that were previously handled
by the EHCI driver.</p>
<p>Module parameters (pass to “modprobe”) include:</p>
<blockquote>
<div><dl class="simple">
<dt>log2_irq_thresh (default 0):</dt><dd><p>Log2 of default interrupt delay, in microframes.  The default
value is 0, indicating 1 microframe (125 usec).  Maximum value
is 6, indicating 2^6 = 64 microframes.  This controls how often
the EHCI controller can issue interrupts.</p>
</dd>
</dl>
</div></blockquote>
<p>If you’re using this driver on a 2.5 kernel, and you’ve enabled USB
debugging support, you’ll see three files in the “sysfs” directory for
any EHCI controller:</p>
<blockquote>
<div><dl class="simple">
<dt>“async”</dt><dd><p>dumps the asynchronous schedule, used for control
and bulk transfers.  Shows each active qh and the qtds
pending, usually one qtd per urb.  (Look at it with
usb-storage doing disk I/O; watch the request queues!)</p>
</dd>
<dt>“periodic”</dt><dd><p>dumps the periodic schedule, used for interrupt
and isochronous transfers.  Doesn’t show qtds.</p>
</dd>
<dt>“registers”</dt><dd><p>show controller register state, and</p>
</dd>
</dl>
</div></blockquote>
<p>The contents of those files can help identify driver problems.</p>
<p>Device drivers shouldn’t care whether they’re running over EHCI or not,
but they may want to check for “usb_device-&gt;speed == USB_SPEED_HIGH”.
High speed devices can do things that full speed (or low speed) ones
can’t, such as “high bandwidth” periodic (interrupt or ISO) transfers.
Also, some values in device descriptors (such as polling intervals for
periodic transfers) use different encodings when operating at high speed.</p>
<p>However, do make a point of testing device drivers through USB 2.0 hubs.
Those hubs report some failures, such as disconnections, differently when
transaction translators are in use; some drivers have been seen to behave
badly when they see different faults than OHCI or UHCI report.</p>
</div>
<div class="section" id="performance">
<h2>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h2>
<p>USB 2.0 throughput is gated by two main factors:  how fast the host
controller can process requests, and how fast devices can respond to
them.  The 480 Mbit/sec “raw transfer rate” is obeyed by all devices,
but aggregate throughput is also affected by issues like delays between
individual high speed packets, driver intelligence, and of course the
overall system load.  Latency is also a performance concern.</p>
<p>Bulk transfers are most often used where throughput is an issue.  It’s
good to keep in mind that bulk transfers are always in 512 byte packets,
and at most 13 of those fit into one USB 2.0 microframe.  Eight USB 2.0
microframes fit in a USB 1.1 frame; a microframe is 1 msec/8 = 125 usec.</p>
<p>So more than 50 MByte/sec is available for bulk transfers, when both
hardware and device driver software allow it.  Periodic transfer modes
(isochronous and interrupt) allow the larger packet sizes which let you
approach the quoted 480 MBit/sec transfer rate.</p>
<div class="section" id="hardware-performance">
<h3>Hardware Performance<a class="headerlink" href="#hardware-performance" title="Permalink to this headline">¶</a></h3>
<p>At this writing, individual USB 2.0 devices tend to max out at around
20 MByte/sec transfer rates.  This is of course subject to change;
and some devices now go faster, while others go slower.</p>
<p>The first NEC implementation of EHCI seems to have a hardware bottleneck
at around 28 MByte/sec aggregate transfer rate.  While this is clearly
enough for a single device at 20 MByte/sec, putting three such devices
onto one bus does not get you 60 MByte/sec.  The issue appears to be
that the controller hardware won’t do concurrent USB and PCI access,
so that it’s only trying six (or maybe seven) USB transactions each
microframe rather than thirteen.  (Seems like a reasonable trade off
for a product that beat all the others to market by over a year!)</p>
<p>It’s expected that newer implementations will better this, throwing
more silicon real estate at the problem so that new motherboard chip
sets will get closer to that 60 MByte/sec target.  That includes an
updated implementation from NEC, as well as other vendors’ silicon.</p>
<p>There’s a minimum latency of one microframe (125 usec) for the host
to receive interrupts from the EHCI controller indicating completion
of requests.  That latency is tunable; there’s a module option.  By
default ehci-hcd driver uses the minimum latency, which means that if
you issue a control or bulk request you can often expect to learn that
it completed in less than 250 usec (depending on transfer size).</p>
</div>
<div class="section" id="software-performance">
<h3>Software Performance<a class="headerlink" href="#software-performance" title="Permalink to this headline">¶</a></h3>
<p>To get even 20 MByte/sec transfer rates, Linux-USB device drivers will
need to keep the EHCI queue full.  That means issuing large requests,
or using bulk queuing if a series of small requests needs to be issued.
When drivers don’t do that, their performance results will show it.</p>
<p>In typical situations, a <a class="reference internal" href="../driver-api/usb/usb.html#c.usb_bulk_msg" title="usb_bulk_msg"><code class="xref c c-func docutils literal notranslate"><span class="pre">usb_bulk_msg()</span></code></a> loop writing out 4 KB chunks is
going to waste more than half the USB 2.0 bandwidth.  Delays between the
I/O completion and the driver issuing the next request will take longer
than the I/O.  If that same loop used 16 KB chunks, it’d be better; a
sequence of 128 KB chunks would waste a lot less.</p>
<p>But rather than depending on such large I/O buffers to make synchronous
I/O be efficient, it’s better to just queue up several (bulk) requests
to the HC, and wait for them all to complete (or be canceled on error).
Such URB queuing should work with all the USB 1.1 HC drivers too.</p>
<p>In the Linux 2.5 kernels, new usb_sg_*() api calls have been defined; they
queue all the buffers from a scatterlist.  They also use scatterlist DMA
mapping (which might apply an IOMMU) and IRQ reduction, all of which will
help make high speed transfers run as fast as they can.</p>
<dl class="simple">
<dt>TBD:</dt><dd><p>Interrupt and ISO transfer performance issues.  Those periodic
transfers are fully scheduled, so the main issue is likely to be how
to trigger “high bandwidth” modes.</p>
</dd>
<dt>TBD:</dt><dd><p>More than standard 80% periodic bandwidth allocation is possible
through sysfs uframe_periodic_max parameter. Describe that.</p>
</dd>
</dl>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="functionfs.html" class="btn btn-neutral float-right" title="How FunctionFS works" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="dwc3.html" class="btn btn-neutral float-left" title="DWC3 driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>