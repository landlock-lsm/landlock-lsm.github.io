

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Thin provisioning &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Device-mapper “unstriped” target" href="unstriped.html" />
    <link rel="prev" title="dm-switch" href="switch.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.4.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux kernel user’s and administrator’s guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../README.html">Linux kernel release 5.x &lt;http://kernel.org/&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-parameters.html">The kernel’s command-line parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devices.html">Linux allocated devices (4.x+ version)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysctl/index.html">Documentation for /proc/sys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hw-vuln/index.html">Hardware vulnerabilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reporting-bugs.html">Reporting bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security-bugs.html">Security bugs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bug-hunting.html">Bug hunting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bug-bisect.html">Bisecting a bug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tainted-kernels.html">Tainted kernels</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ramoops.html">Ramoops oops/panic logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dynamic-debug-howto.html">Dynamic debug</a></li>
<li class="toctree-l2"><a class="reference internal" href="../init.html">Explaining the dreaded “No init found.” boot hang message</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kdump/index.html">Documentation for Kdump - The kexec-based Crash Dumping Solution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf/index.html">Performance monitor support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysfs-rules.html">Rules on how to access information in sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../initrd.html">Using the initial RAM disk (initrd)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cgroup-v2.html">Control Group v2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cgroup-v1/index.html">Control Groups version 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serial-console.html">Linux Serial Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../braille-console.html">Linux Braille Console</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parport.html">Parport</a></li>
<li class="toctree-l2"><a class="reference internal" href="../md.html">RAID arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../module-signing.html">Kernel module signing facility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rapidio.html">RapidIO Subsystem Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysrq.html">Linux Magic System Request Key Hacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../unicode.html">Unicode support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vga-softcursor.html">Software cursor for VGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binfmt-misc.html">Kernel Support for miscellaneous (your favourite) Binary Formats v1.1</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mono.html">Mono(tm) Binary Kernel Support for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../java.html">Java(tm) Binary Kernel Support for Linux v1.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ras.html">Reliability, Availability and Serviceability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../bcache.html">A block layer cache (bcache)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../blockdev/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ext4.html">ext4 General Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../binderfs.html">The Android binderfs Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cifs/index.html">CIFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xfs.html">The SGI XFS Filesystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../jfs.html">IBM’s Journaled File System (JFS) for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ufs.html">Using UFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thunderbolt.html">Thunderbolt</a></li>
<li class="toctree-l2"><a class="reference internal" href="../LSM/index.html">Linux Security Module Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mm/index.html">Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../namespaces/index.html">Namespaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../perf-security.html">Perf Events and tool security</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../aoe/index.html">ATA over Ethernet (AoE)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../btmrvl.html">btmrvl driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clearing-warn-once.html">Clearing WARN_ONCE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cpu-load.html">CPU load</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cputopology.html">How CPU topology info is exported via sysfs</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Device Mapper</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="cache-policies.html">Guidance for writing policies</a></li>
<li class="toctree-l3"><a class="reference internal" href="cache.html">Cache</a></li>
<li class="toctree-l3"><a class="reference internal" href="delay.html">dm-delay</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-crypt.html">dm-crypt</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-flakey.html">dm-flakey</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-init.html">Early creation of mapped devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-integrity.html">dm-integrity</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-io.html">dm-io</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-log.html">Device-Mapper Logging</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-queue-length.html">dm-queue-length</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-raid.html">dm-raid</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-service-time.html">dm-service-time</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-uevent.html">device-mapper uevent</a></li>
<li class="toctree-l3"><a class="reference internal" href="dm-zoned.html">dm-zoned</a></li>
<li class="toctree-l3"><a class="reference internal" href="era.html">dm-era</a></li>
<li class="toctree-l3"><a class="reference internal" href="kcopyd.html">kcopyd</a></li>
<li class="toctree-l3"><a class="reference internal" href="linear.html">dm-linear</a></li>
<li class="toctree-l3"><a class="reference internal" href="log-writes.html">dm-log-writes</a></li>
<li class="toctree-l3"><a class="reference internal" href="persistent-data.html">Persistent data</a></li>
<li class="toctree-l3"><a class="reference internal" href="snapshot.html">Device-mapper snapshot support</a></li>
<li class="toctree-l3"><a class="reference internal" href="statistics.html">DM statistics</a></li>
<li class="toctree-l3"><a class="reference internal" href="striped.html">dm-stripe</a></li>
<li class="toctree-l3"><a class="reference internal" href="switch.html">dm-switch</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Thin provisioning</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cookbook">Cookbook</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reference">Reference</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="unstriped.html">Device-mapper “unstriped” target</a></li>
<li class="toctree-l3"><a class="reference internal" href="verity.html">dm-verity</a></li>
<li class="toctree-l3"><a class="reference internal" href="writecache.html">Writecache target</a></li>
<li class="toctree-l3"><a class="reference internal" href="zero.html">dm-zero</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../efi-stub.html">The EFI Boot Stub</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio/index.html">gpio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../highuid.html">Notes on the change from 16-bit UIDs to 32-bit UIDs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hw_random.html">Linux support for random number generator in i8xx chipsets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iostats.html">I/O statistics fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="../kernel-per-CPU-kthreads.html">Reducing OS jitter due to per-cpu kthreads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../laptops/index.html">Laptop Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auxdisplay/index.html">Auxiliary Display Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lcd-panel-cgram.html">Parallel port LCD/Keypad Panel support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ldm.html">LDM - Logical Disk Manager (Dynamic Disks)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lockup-watchdogs.html">Softlockup detector and hardlockup detector (aka nmi_watchdog)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../numastat.html">Numa policy hit/miss statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pnp.html">Linux Plug and Play Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rtc.html">Real Time Clock (RTC) Drivers for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../svga.html">Video Mode Selection Support 2.13</a></li>
<li class="toctree-l2"><a class="reference internal" href="../wimax/index.html">WiMAX subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../video-output.html">Video Output Switcher Control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ioctl/index.html">IOCTLs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">The Linux kernel user’s and administrator’s guide</a> &raquo;</li>
        
          <li><a href="index.html">Device Mapper</a> &raquo;</li>
        
      <li>Thin provisioning</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/admin-guide/device-mapper/thin-provisioning.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="thin-provisioning">
<h1>Thin provisioning<a class="headerlink" href="#thin-provisioning" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This document describes a collection of device-mapper targets that
between them implement thin-provisioning and snapshots.</p>
<p>The main highlight of this implementation, compared to the previous
implementation of snapshots, is that it allows many virtual devices to
be stored on the same data volume.  This simplifies administration and
allows the sharing of data between volumes, thus reducing disk usage.</p>
<p>Another significant feature is support for an arbitrary depth of
recursive snapshots (snapshots of snapshots of snapshots …).  The
previous implementation of snapshots did this by chaining together
lookup tables, and so performance was O(depth).  This new
implementation uses a single data structure to avoid this degradation
with depth.  Fragmentation may still be an issue, however, in some
scenarios.</p>
<p>Metadata is stored on a separate device from data, giving the
administrator some freedom, for example to:</p>
<ul class="simple">
<li>Improve metadata resilience by storing metadata on a mirrored volume
but data on a non-mirrored one.</li>
<li>Improve performance by storing the metadata on SSD.</li>
</ul>
</div>
<div class="section" id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>These targets are considered safe for production use.  But different use
cases will have different performance characteristics, for example due
to fragmentation of the data volume.</p>
<p>If you find this software is not performing as expected please mail
<a class="reference external" href="mailto:dm-devel&#37;&#52;&#48;redhat&#46;com">dm-devel<span>&#64;</span>redhat<span>&#46;</span>com</a> with details and we’ll try our best to improve
things for you.</p>
<p>Userspace tools for checking and repairing the metadata have been fully
developed and are available as ‘thin_check’ and ‘thin_repair’.  The name
of the package that provides these utilities varies by distribution (on
a Red Hat distribution it is named ‘device-mapper-persistent-data’).</p>
</div>
<div class="section" id="cookbook">
<h2>Cookbook<a class="headerlink" href="#cookbook" title="Permalink to this headline">¶</a></h2>
<p>This section describes some quick recipes for using thin provisioning.
They use the dmsetup program to control the device-mapper driver
directly.  End users will be advised to use a higher-level volume
manager such as LVM2 once support has been added.</p>
<div class="section" id="pool-device">
<h3>Pool device<a class="headerlink" href="#pool-device" title="Permalink to this headline">¶</a></h3>
<p>The pool device ties together the metadata volume and the data volume.
It maps I/O linearly to the data volume and updates the metadata via
two mechanisms:</p>
<ul class="simple">
<li>Function calls from the thin targets</li>
<li>Device-mapper ‘messages’ from userspace which control the creation of new
virtual devices amongst other things.</li>
</ul>
</div>
<div class="section" id="setting-up-a-fresh-pool-device">
<h3>Setting up a fresh pool device<a class="headerlink" href="#setting-up-a-fresh-pool-device" title="Permalink to this headline">¶</a></h3>
<p>Setting up a pool device requires a valid metadata device, and a
data device.  If you do not have an existing metadata device you can
make one by zeroing the first 4k to indicate empty metadata.</p>
<blockquote>
<div>dd if=/dev/zero of=$metadata_dev bs=4096 count=1</div></blockquote>
<p>The amount of metadata you need will vary according to how many blocks
are shared between thin devices (i.e. through snapshots).  If you have
less sharing than average you’ll need a larger-than-average metadata device.</p>
<p>As a guide, we suggest you calculate the number of bytes to use in the
metadata device as 48 * $data_dev_size / $data_block_size but round it up
to 2MB if the answer is smaller.  If you’re creating large numbers of
snapshots which are recording large amounts of change, you may find you
need to increase this.</p>
<p>The largest size supported is 16GB: If the device is larger,
a warning will be issued and the excess space will not be used.</p>
</div>
<div class="section" id="reloading-a-pool-table">
<h3>Reloading a pool table<a class="headerlink" href="#reloading-a-pool-table" title="Permalink to this headline">¶</a></h3>
<p>You may reload a pool’s table, indeed this is how the pool is resized
if it runs out of space.  (N.B. While specifying a different metadata
device when reloading is not forbidden at the moment, things will go
wrong if it does not route I/O to exactly the same on-disk location as
previously.)</p>
</div>
<div class="section" id="using-an-existing-pool-device">
<h3>Using an existing pool device<a class="headerlink" href="#using-an-existing-pool-device" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create pool \
    --table &quot;0 20971520 thin-pool $metadata_dev $data_dev \
             $data_block_size $low_water_mark&quot;
</pre></div>
</div>
<p>$data_block_size gives the smallest unit of disk space that can be
allocated at a time expressed in units of 512-byte sectors.
$data_block_size must be between 128 (64KB) and 2097152 (1GB) and a
multiple of 128 (64KB).  $data_block_size cannot be changed after the
thin-pool is created.  People primarily interested in thin provisioning
may want to use a value such as 1024 (512KB).  People doing lots of
snapshotting may want a smaller value such as 128 (64KB).  If you are
not zeroing newly-allocated data, a larger $data_block_size in the
region of 256000 (128MB) is suggested.</p>
<p>$low_water_mark is expressed in blocks of size $data_block_size.  If
free space on the data device drops below this level then a dm event
will be triggered which a userspace daemon should catch allowing it to
extend the pool device.  Only one such event will be sent.</p>
<p>No special event is triggered if a just resumed device’s free space is below
the low water mark. However, resuming a device always triggers an
event; a userspace daemon should verify that free space exceeds the low
water mark when handling this event.</p>
<p>A low water mark for the metadata device is maintained in the kernel and
will trigger a dm event if free space on the metadata device drops below
it.</p>
</div>
<div class="section" id="updating-on-disk-metadata">
<h3>Updating on-disk metadata<a class="headerlink" href="#updating-on-disk-metadata" title="Permalink to this headline">¶</a></h3>
<p>On-disk metadata is committed every time a FLUSH or FUA bio is written.
If no such requests are made then commits will occur every second.  This
means the thin-provisioning target behaves like a physical disk that has
a volatile write cache.  If power is lost you may lose some recent
writes.  The metadata should always be consistent in spite of any crash.</p>
<p>If data space is exhausted the pool will either error or queue IO
according to the configuration (see: error_if_no_space).  If metadata
space is exhausted or a metadata operation fails: the pool will error IO
until the pool is taken offline and repair is performed to 1) fix any
potential inconsistencies and 2) clear the flag that imposes repair.
Once the pool’s metadata device is repaired it may be resized, which
will allow the pool to return to normal operation.  Note that if a pool
is flagged as needing repair, the pool’s data and metadata devices
cannot be resized until repair is performed.  It should also be noted
that when the pool’s metadata space is exhausted the current metadata
transaction is aborted.  Given that the pool will cache IO whose
completion may have already been acknowledged to upper IO layers
(e.g. filesystem) it is strongly suggested that consistency checks
(e.g. fsck) be performed on those layers when repair of the pool is
required.</p>
</div>
<div class="section" id="id1">
<h3>Thin provisioning<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ol class="lowerroman simple">
<li>Creating a new thinly-provisioned volume.</li>
</ol>
<blockquote>
<div><p>To create a new thinly- provisioned volume you must send a message to an
active pool device, /dev/mapper/pool in this example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message /dev/mapper/pool 0 &quot;create_thin 0&quot;
</pre></div>
</div>
<p>Here ‘0’ is an identifier for the volume, a 24-bit number.  It’s up
to the caller to allocate and manage these identifiers.  If the
identifier is already in use, the message will fail with -EEXIST.</p>
</div></blockquote>
<ol class="lowerroman simple" start="2">
<li>Using a thinly-provisioned volume.</li>
</ol>
<blockquote>
<div><p>Thinly-provisioned volumes are activated using the ‘thin’ target:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create thin --table &quot;0 2097152 thin /dev/mapper/pool 0&quot;
</pre></div>
</div>
<p>The last parameter is the identifier for the thinp device.</p>
</div></blockquote>
</div>
<div class="section" id="internal-snapshots">
<h3>Internal snapshots<a class="headerlink" href="#internal-snapshots" title="Permalink to this headline">¶</a></h3>
<ol class="lowerroman simple">
<li>Creating an internal snapshot.</li>
</ol>
<blockquote>
<div><p>Snapshots are created with another message to the pool.</p>
<p>N.B.  If the origin device that you wish to snapshot is active, you
must suspend it before creating the snapshot to avoid corruption.
This is NOT enforced at the moment, so please be careful!</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup suspend /dev/mapper/thin
dmsetup message /dev/mapper/pool 0 &quot;create_snap 1 0&quot;
dmsetup resume /dev/mapper/thin
</pre></div>
</div>
<p>Here ‘1’ is the identifier for the volume, a 24-bit number.  ‘0’ is the
identifier for the origin device.</p>
</div></blockquote>
<ol class="lowerroman simple" start="2">
<li>Using an internal snapshot.</li>
</ol>
<blockquote>
<div><p>Once created, the user doesn’t have to worry about any connection
between the origin and the snapshot.  Indeed the snapshot is no
different from any other thinly-provisioned device and can be
snapshotted itself via the same method.  It’s perfectly legal to
have only one of them active, and there’s no ordering requirement on
activating or removing them both.  (This differs from conventional
device-mapper snapshots.)</p>
<p>Activate it exactly the same way as any other thinly-provisioned volume:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create snap --table &quot;0 2097152 thin /dev/mapper/pool 1&quot;
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="external-snapshots">
<h3>External snapshots<a class="headerlink" href="#external-snapshots" title="Permalink to this headline">¶</a></h3>
<p>You can use an external <strong>read only</strong> device as an origin for a
thinly-provisioned volume.  Any read to an unprovisioned area of the
thin device will be passed through to the origin.  Writes trigger
the allocation of new blocks as usual.</p>
<p>One use case for this is VM hosts that want to run guests on
thinly-provisioned volumes but have the base image on another device
(possibly shared between many VMs).</p>
<p>You must not write to the origin device if you use this technique!
Of course, you may write to the thin device and take internal snapshots
of the thin volume.</p>
<ol class="lowerroman simple">
<li>Creating a snapshot of an external device</li>
</ol>
<blockquote>
<div><p>This is the same as creating a thin device.
You don’t mention the origin at this stage.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup message /dev/mapper/pool 0 &quot;create_thin 0&quot;
</pre></div>
</div>
</div></blockquote>
<ol class="lowerroman simple" start="2">
<li>Using a snapshot of an external device.</li>
</ol>
<blockquote>
<div><p>Append an extra parameter to the thin target specifying the origin:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup create snap --table &quot;0 2097152 thin /dev/mapper/pool 0 /dev/image&quot;
</pre></div>
</div>
<p>N.B. All descendants (internal snapshots) of this snapshot require the
same extra origin parameter.</p>
</div></blockquote>
</div>
<div class="section" id="deactivation">
<h3>Deactivation<a class="headerlink" href="#deactivation" title="Permalink to this headline">¶</a></h3>
<p>All devices using a pool must be deactivated before the pool itself
can be.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dmsetup remove thin
dmsetup remove snap
dmsetup remove pool
</pre></div>
</div>
</div>
</div>
<div class="section" id="reference">
<h2>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h2>
<div class="section" id="thin-pool-target">
<h3>‘thin-pool’ target<a class="headerlink" href="#thin-pool-target" title="Permalink to this headline">¶</a></h3>
<ol class="lowerroman">
<li><p class="first">Constructor</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>thin-pool &lt;metadata dev&gt; &lt;data dev&gt; &lt;data block size (sectors)&gt; \
          &lt;low water mark (blocks)&gt; [&lt;number of feature args&gt; [&lt;arg&gt;]*]
</pre></div>
</div>
<p>Optional feature arguments:</p>
<blockquote>
<div><dl class="docutils">
<dt>skip_block_zeroing:</dt>
<dd><p class="first last">Skip the zeroing of newly-provisioned blocks.</p>
</dd>
<dt>ignore_discard:</dt>
<dd><p class="first last">Disable discard support.</p>
</dd>
<dt>no_discard_passdown:</dt>
<dd><p class="first last">Don’t pass discards down to the underlying
data device, but just remove the mapping.</p>
</dd>
<dt>read_only:</dt>
<dd><p class="first last">Don’t allow any changes to be made to the pool
metadata.  This mode is only available after the
thin-pool has been created and first used in full
read/write mode.  It cannot be specified on initial
thin-pool creation.</p>
</dd>
<dt>error_if_no_space:</dt>
<dd><p class="first last">Error IOs, instead of queueing, if no space.</p>
</dd>
</dl>
</div></blockquote>
<p>Data block size must be between 64KB (128 sectors) and 1GB
(2097152 sectors) inclusive.</p>
</div></blockquote>
</li>
<li><p class="first">Status</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&lt;transaction id&gt; &lt;used metadata blocks&gt;/&lt;total metadata blocks&gt;
&lt;used data blocks&gt;/&lt;total data blocks&gt; &lt;held metadata root&gt;
ro|rw|out_of_data_space [no_]discard_passdown [error|queue]_if_no_space
needs_check|- metadata_low_watermark
</pre></div>
</div>
<dl class="docutils">
<dt>transaction id:</dt>
<dd><p class="first last">A 64-bit number used by userspace to help synchronise with metadata
from volume managers.</p>
</dd>
<dt>used data blocks / total data blocks</dt>
<dd><p class="first last">If the number of free blocks drops below the pool’s low water mark a
dm event will be sent to userspace.  This event is edge-triggered and
it will occur only once after each resume so volume manager writers
should register for the event and then check the target’s status.</p>
</dd>
<dt>held metadata root:</dt>
<dd><p class="first last">The location, in blocks, of the metadata root that has been
‘held’ for userspace read access.  ‘-‘ indicates there is no
held root.</p>
</dd>
<dt>discard_passdown|no_discard_passdown</dt>
<dd><p class="first last">Whether or not discards are actually being passed down to the
underlying device.  When this is enabled when loading the table,
it can get disabled if the underlying device doesn’t support it.</p>
</dd>
<dt>ro|rw|out_of_data_space</dt>
<dd><p class="first">If the pool encounters certain types of device failures it will
drop into a read-only metadata mode in which no changes to
the pool metadata (like allocating new blocks) are permitted.</p>
<p class="last">In serious cases where even a read-only mode is deemed unsafe
no further I/O will be permitted and the status will just
contain the string ‘Fail’.  The userspace recovery tools
should then be used.</p>
</dd>
<dt>error_if_no_space|queue_if_no_space</dt>
<dd><p class="first last">If the pool runs out of data or metadata space, the pool will
either queue or error the IO destined to the data device.  The
default is to queue the IO until more space is added or the
‘no_space_timeout’ expires.  The ‘no_space_timeout’ dm-thin-pool
module parameter can be used to change this timeout – it
defaults to 60 seconds but may be disabled using a value of 0.</p>
</dd>
<dt>needs_check</dt>
<dd><p class="first last">A metadata operation has failed, resulting in the needs_check
flag being set in the metadata’s superblock.  The metadata
device must be deactivated and checked/repaired before the
thin-pool can be made fully operational again.  ‘-‘ indicates
needs_check is not set.</p>
</dd>
<dt>metadata_low_watermark:</dt>
<dd><p class="first last">Value of metadata low watermark in blocks.  The kernel sets this
value internally but userspace needs to know this value to
determine if an event was caused by crossing this threshold.</p>
</dd>
</dl>
</li>
<li><p class="first">Messages</p>
</li>
</ol>
<blockquote>
<div><dl class="docutils">
<dt>create_thin &lt;dev id&gt;</dt>
<dd>Create a new thinly-provisioned device.
&lt;dev id&gt; is an arbitrary unique 24-bit identifier chosen by
the caller.</dd>
<dt>create_snap &lt;dev id&gt; &lt;origin id&gt;</dt>
<dd>Create a new snapshot of another thinly-provisioned device.
&lt;dev id&gt; is an arbitrary unique 24-bit identifier chosen by
the caller.
&lt;origin id&gt; is the identifier of the thinly-provisioned device
of which the new device will be a snapshot.</dd>
<dt>delete &lt;dev id&gt;</dt>
<dd>Deletes a thin device.  Irreversible.</dd>
<dt>set_transaction_id &lt;current id&gt; &lt;new id&gt;</dt>
<dd>Userland volume managers, such as LVM, need a way to
synchronise their external metadata with the internal metadata of the
pool target.  The thin-pool target offers to store an
arbitrary 64-bit transaction id and return it on the target’s
status line.  To avoid races you must provide what you think
the current transaction id is when you change it with this
compare-and-swap message.</dd>
<dt>reserve_metadata_snap</dt>
<dd>Reserve a copy of the data mapping btree for use by userland.
This allows userland to inspect the mappings as they were when
this message was executed.  Use the pool’s status command to
get the root block associated with the metadata snapshot.</dd>
<dt>release_metadata_snap</dt>
<dd>Release a previously reserved copy of the data mapping btree.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="thin-target">
<h3>‘thin’ target<a class="headerlink" href="#thin-target" title="Permalink to this headline">¶</a></h3>
<ol class="lowerroman">
<li><p class="first">Constructor</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>thin &lt;pool dev&gt; &lt;dev id&gt; [&lt;external origin dev&gt;]
</pre></div>
</div>
<dl class="docutils">
<dt>pool dev:</dt>
<dd><p class="first last">the thin-pool device, e.g. /dev/mapper/my_pool or 253:0</p>
</dd>
<dt>dev id:</dt>
<dd><p class="first last">the internal device identifier of the device to be
activated.</p>
</dd>
<dt>external origin dev:</dt>
<dd><p class="first last">an optional block device outside the pool to be treated as a
read-only snapshot origin: reads to unprovisioned areas of the
thin target will be mapped to this device.</p>
</dd>
</dl>
</div></blockquote>
</li>
</ol>
<p>The pool doesn’t store any size against the thin devices.  If you
load a thin target that is smaller than you’ve been using previously,
then you’ll have no access to blocks mapped beyond the end.  If you
load a target that is bigger than before, then extra blocks will be
provisioned as and when needed.</p>
<ol class="lowerroman" start="2">
<li><p class="first">Status</p>
<dl class="docutils">
<dt>&lt;nr mapped sectors&gt; &lt;highest mapped sector&gt;</dt>
<dd><p class="first last">If the pool has encountered device errors and failed, the status
will just contain the string ‘Fail’.  The userspace recovery
tools should then be used.</p>
</dd>
</dl>
<p>In the case where &lt;nr mapped sectors&gt; is 0, there is no highest
mapped sector and the value of &lt;highest mapped sector&gt; is unspecified.</p>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="unstriped.html" class="btn btn-neutral float-right" title="Device-mapper “unstriped” target" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="switch.html" class="btn btn-neutral float-left" title="dm-switch" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>