

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Unreliable Guide To Hacking The Linux Kernel &mdash; The Linux Kernel 5.10.0-rc1+ documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Unreliable Guide To Locking" href="locking.html" />
    <link rel="prev" title="Kernel Hacking Guides" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Kernel Hacking Guides</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Unreliable Guide To Hacking The Linux Kernel</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-players">The Players</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#user-context">User Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hardware-interrupts-hard-irqs">Hardware Interrupts (Hard IRQs)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#software-interrupt-context-softirqs-and-tasklets">Software Interrupt Context: Softirqs and Tasklets</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#some-basic-rules">Some Basic Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ioctls-not-writing-a-new-system-call">ioctls: Not writing a new system call</a></li>
<li class="toctree-l3"><a class="reference internal" href="#recipes-for-deadlock">Recipes for Deadlock</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-routines">Common Routines</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#copy-to-user-copy-from-user-get-user-put-user"><code class="xref c c-func docutils literal notranslate"><span class="pre">copy_to_user()</span></code> / <code class="xref c c-func docutils literal notranslate"><span class="pre">copy_from_user()</span></code> / <code class="xref c c-func docutils literal notranslate"><span class="pre">get_user()</span></code> / <code class="xref c c-func docutils literal notranslate"><span class="pre">put_user()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#kmalloc-kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">kfree()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#current"><code class="xref c c-func docutils literal notranslate"><span class="pre">current()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#mdelay-udelay"><code class="xref c c-func docutils literal notranslate"><span class="pre">mdelay()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">udelay()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu-to-be32-be32-to-cpu-cpu-to-le32-le32-to-cpu"><code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_be32()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">be32_to_cpu()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_le32()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">le32_to_cpu()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-irq-save-local-irq-restore"><code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_save()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_restore()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#local-bh-disable-local-bh-enable"><code class="xref c c-func docutils literal notranslate"><span class="pre">local_bh_disable()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">local_bh_enable()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#smp-processor-id"><code class="xref c c-func docutils literal notranslate"><span class="pre">smp_processor_id()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#init-exit-initdata"><code class="docutils literal notranslate"><span class="pre">__init</span></code>/<code class="docutils literal notranslate"><span class="pre">__exit</span></code>/<code class="docutils literal notranslate"><span class="pre">__initdata</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#initcall-module-init"><code class="xref c c-func docutils literal notranslate"><span class="pre">__initcall()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#module-exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_exit()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#try-module-get-module-put"><code class="xref c c-func docutils literal notranslate"><span class="pre">try_module_get()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">module_put()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#wait-queues-include-linux-wait-h">Wait Queues <code class="docutils literal notranslate"><span class="pre">include/linux/wait.h</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="#declaring">Declaring</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queuing">Queuing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#waking-up-queued-tasks">Waking Up Queued Tasks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#atomic-operations">Atomic Operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#symbols">Symbols</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#export-symbol"><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#export-symbol-gpl"><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_GPL()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#export-symbol-ns"><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_NS()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#export-symbol-ns-gpl"><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_NS_GPL()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#routines-and-conventions">Routines and Conventions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#double-linked-lists-include-linux-list-h">Double-linked lists <code class="docutils literal notranslate"><span class="pre">include/linux/list.h</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#return-conventions">Return Conventions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#breaking-compilation">Breaking Compilation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#initializing-structure-members">Initializing structure members</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gnu-extensions">GNU Extensions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c">C++</a></li>
<li class="toctree-l4"><a class="reference internal" href="#if">#if</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#putting-your-stuff-in-the-kernel">Putting Your Stuff in the Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#kernel-cantrips">Kernel Cantrips</a></li>
<li class="toctree-l3"><a class="reference internal" href="#thanks">Thanks</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="locking.html">Unreliable Guide To Locking</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Kernel Hacking Guides</a> &raquo;</li>
        
      <li>Unreliable Guide To Hacking The Linux Kernel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/kernel-hacking/hacking.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="unreliable-guide-to-hacking-the-linux-kernel">
<span id="kernel-hacking-hack"></span><h1>Unreliable Guide To Hacking The Linux Kernel<a class="headerlink" href="#unreliable-guide-to-hacking-the-linux-kernel" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Rusty Russell</p>
</dd>
</dl>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Welcome, gentle reader, to Rusty’s Remarkably Unreliable Guide to Linux
Kernel Hacking. This document describes the common routines and general
requirements for kernel code: its goal is to serve as a primer for Linux
kernel development for experienced C programmers. I avoid implementation
details: that’s what the code is for, and I ignore whole tracts of
useful routines.</p>
<p>Before you read this, please understand that I never wanted to write
this document, being grossly under-qualified, but I always wanted to
read it, and this was the only way. I hope it will grow into a
compendium of best practice, common starting points and random
information.</p>
</div>
<div class="section" id="the-players">
<h2>The Players<a class="headerlink" href="#the-players" title="Permalink to this headline">¶</a></h2>
<p>At any time each of the CPUs in a system can be:</p>
<ul class="simple">
<li><p>not associated with any process, serving a hardware interrupt;</p></li>
<li><p>not associated with any process, serving a softirq or tasklet;</p></li>
<li><p>running in kernel space, associated with a process (user context);</p></li>
<li><p>running a process in user space.</p></li>
</ul>
<p>There is an ordering between these. The bottom two can preempt each
other, but above that is a strict hierarchy: each can only be preempted
by the ones above it. For example, while a softirq is running on a CPU,
no other softirq will preempt it, but a hardware interrupt can. However,
any other CPUs in the system execute independently.</p>
<p>We’ll see a number of ways that the user context can block interrupts,
to become truly non-preemptable.</p>
<div class="section" id="user-context">
<h3>User Context<a class="headerlink" href="#user-context" title="Permalink to this headline">¶</a></h3>
<p>User context is when you are coming in from a system call or other trap:
like userspace, you can be preempted by more important tasks and by
interrupts. You can sleep, by calling <code class="xref c c-func docutils literal notranslate"><span class="pre">schedule()</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You are always in user context on module load and unload, and on
operations on the block device layer.</p>
</div>
<p>In user context, the <code class="docutils literal notranslate"><span class="pre">current</span></code> pointer (indicating the task we are
currently executing) is valid, and <code class="xref c c-func docutils literal notranslate"><span class="pre">in_interrupt()</span></code>
(<code class="docutils literal notranslate"><span class="pre">include/linux/preempt.h</span></code>) is false.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Beware that if you have preemption or softirqs disabled (see below),
<code class="xref c c-func docutils literal notranslate"><span class="pre">in_interrupt()</span></code> will return a false positive.</p>
</div>
</div>
<div class="section" id="hardware-interrupts-hard-irqs">
<h3>Hardware Interrupts (Hard IRQs)<a class="headerlink" href="#hardware-interrupts-hard-irqs" title="Permalink to this headline">¶</a></h3>
<p>Timer ticks, network cards and keyboard are examples of real hardware
which produce interrupts at any time. The kernel runs interrupt
handlers, which services the hardware. The kernel guarantees that this
handler is never re-entered: if the same interrupt arrives, it is queued
(or dropped). Because it disables interrupts, this handler has to be
fast: frequently it simply acknowledges the interrupt, marks a ‘software
interrupt’ for execution and exits.</p>
<p>You can tell you are in a hardware interrupt, because
<code class="xref c c-func docutils literal notranslate"><span class="pre">in_irq()</span></code> returns true.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Beware that this will return a false positive if interrupts are
disabled (see below).</p>
</div>
</div>
<div class="section" id="software-interrupt-context-softirqs-and-tasklets">
<h3>Software Interrupt Context: Softirqs and Tasklets<a class="headerlink" href="#software-interrupt-context-softirqs-and-tasklets" title="Permalink to this headline">¶</a></h3>
<p>Whenever a system call is about to return to userspace, or a hardware
interrupt handler exits, any ‘software interrupts’ which are marked
pending (usually by hardware interrupts) are run (<code class="docutils literal notranslate"><span class="pre">kernel/softirq.c</span></code>).</p>
<p>Much of the real interrupt handling work is done here. Early in the
transition to SMP, there were only ‘bottom halves’ (BHs), which didn’t
take advantage of multiple CPUs. Shortly after we switched from wind-up
computers made of match-sticks and snot, we abandoned this limitation
and switched to ‘softirqs’.</p>
<p><code class="docutils literal notranslate"><span class="pre">include/linux/interrupt.h</span></code> lists the different softirqs. A very
important softirq is the timer softirq (<code class="docutils literal notranslate"><span class="pre">include/linux/timer.h</span></code>): you
can register to have it call functions for you in a given length of
time.</p>
<p>Softirqs are often a pain to deal with, since the same softirq will run
simultaneously on more than one CPU. For this reason, tasklets
(<code class="docutils literal notranslate"><span class="pre">include/linux/interrupt.h</span></code>) are more often used: they are
dynamically-registrable (meaning you can have as many as you want), and
they also guarantee that any tasklet will only run on one CPU at any
time, although different tasklets can run simultaneously.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The name ‘tasklet’ is misleading: they have nothing to do with
‘tasks’, and probably more to do with some bad vodka Alexey
Kuznetsov had at the time.</p>
</div>
<p>You can tell you are in a softirq (or tasklet) using the
<code class="xref c c-func docutils literal notranslate"><span class="pre">in_softirq()</span></code> macro (<code class="docutils literal notranslate"><span class="pre">include/linux/preempt.h</span></code>).</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Beware that this will return a false positive if a
<a class="reference internal" href="#local-bh-disable"><span class="std std-ref">botton half lock</span></a> is held.</p>
</div>
</div>
</div>
<div class="section" id="some-basic-rules">
<h2>Some Basic Rules<a class="headerlink" href="#some-basic-rules" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>No memory protection</dt><dd><p>If you corrupt memory, whether in user context or interrupt context,
the whole machine will crash. Are you sure you can’t do what you
want in userspace?</p>
</dd>
<dt>No floating point or MMX</dt><dd><p>The FPU context is not saved; even in user context the FPU state
probably won’t correspond with the current process: you would mess
with some user process’ FPU state. If you really want to do this,
you would have to explicitly save/restore the full FPU state (and
avoid context switches). It is generally a bad idea; use fixed point
arithmetic first.</p>
</dd>
<dt>A rigid stack limit</dt><dd><p>Depending on configuration options the kernel stack is about 3K to
6K for most 32-bit architectures: it’s about 14K on most 64-bit
archs, and often shared with interrupts so you can’t use it all.
Avoid deep recursion and huge local arrays on the stack (allocate
them dynamically instead).</p>
</dd>
<dt>The Linux kernel is portable</dt><dd><p>Let’s keep it that way. Your code should be 64-bit clean, and
endian-independent. You should also minimize CPU specific stuff,
e.g. inline assembly should be cleanly encapsulated and minimized to
ease porting. Generally it should be restricted to the
architecture-dependent part of the kernel tree.</p>
</dd>
</dl>
</div>
<div class="section" id="ioctls-not-writing-a-new-system-call">
<h2>ioctls: Not writing a new system call<a class="headerlink" href="#ioctls-not-writing-a-new-system-call" title="Permalink to this headline">¶</a></h2>
<p>A system call generally looks like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>asmlinkage long sys_mycall(int arg)
{
        return 0;
}
</pre></div>
</div>
<p>First, in most cases you don’t want to create a new system call. You
create a character device and implement an appropriate ioctl for it.
This is much more flexible than system calls, doesn’t have to be entered
in every architecture’s <code class="docutils literal notranslate"><span class="pre">include/asm/unistd.h</span></code> and
<code class="docutils literal notranslate"><span class="pre">arch/kernel/entry.S</span></code> file, and is much more likely to be accepted by
Linus.</p>
<p>If all your routine does is read or write some parameter, consider
implementing a <code class="xref c c-func docutils literal notranslate"><span class="pre">sysfs()</span></code> interface instead.</p>
<p>Inside the ioctl you’re in user context to a process. When a error
occurs you return a negated errno (see
<code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/errno-base.h</span></code>,
<code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/errno.h</span></code> and <code class="docutils literal notranslate"><span class="pre">include/linux/errno.h</span></code>),
otherwise you return 0.</p>
<p>After you slept you should check if a signal occurred: the Unix/Linux
way of handling signals is to temporarily exit the system call with the
<code class="docutils literal notranslate"><span class="pre">-ERESTARTSYS</span></code> error. The system call entry code will switch back to
user context, process the signal handler and then your system call will
be restarted (unless the user disabled that). So you should be prepared
to process the restart, e.g. if you’re in the middle of manipulating
some data structure.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (signal_pending(current))
        return -ERESTARTSYS;
</pre></div>
</div>
<p>If you’re doing longer computations: first think userspace. If you
<strong>really</strong> want to do it in kernel you should regularly check if you need
to give up the CPU (remember there is cooperative multitasking per CPU).
Idiom:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cond_resched(); /* Will sleep */
</pre></div>
</div>
<p>A short note on interface design: the UNIX system call motto is “Provide
mechanism not policy”.</p>
</div>
<div class="section" id="recipes-for-deadlock">
<h2>Recipes for Deadlock<a class="headerlink" href="#recipes-for-deadlock" title="Permalink to this headline">¶</a></h2>
<p>You cannot call any routines which may sleep, unless:</p>
<ul class="simple">
<li><p>You are in user context.</p></li>
<li><p>You do not own any spinlocks.</p></li>
<li><p>You have interrupts enabled (actually, Andi Kleen says that the
scheduling code will enable them for you, but that’s probably not
what you wanted).</p></li>
</ul>
<p>Note that some functions may sleep implicitly: common ones are the user
space access functions (*_user) and memory allocation functions
without <code class="docutils literal notranslate"><span class="pre">GFP_ATOMIC</span></code>.</p>
<p>You should always compile your kernel <code class="docutils literal notranslate"><span class="pre">CONFIG_DEBUG_ATOMIC_SLEEP</span></code> on,
and it will warn you if you break these rules. If you <strong>do</strong> break the
rules, you will eventually lock up your box.</p>
<p>Really.</p>
</div>
<div class="section" id="common-routines">
<h2>Common Routines<a class="headerlink" href="#common-routines" title="Permalink to this headline">¶</a></h2>
<div class="section" id="printk">
<h3><a class="reference internal" href="../core-api/printk-basics.html#c.printk" title="printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a><a class="headerlink" href="#printk" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/printk.h</span></code></p>
<p><a class="reference internal" href="../core-api/printk-basics.html#c.printk" title="printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a> feeds kernel messages to the console, dmesg, and
the syslog daemon. It is useful for debugging and reporting errors, and
can be used inside interrupt context, but use with caution: a machine
which has its console flooded with printk messages is unusable. It uses
a format string mostly compatible with ANSI C printf, and C string
concatenation to give it a first “priority” argument:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>printk(KERN_INFO &quot;i = %u\n&quot;, i);
</pre></div>
</div>
<p>See <code class="docutils literal notranslate"><span class="pre">include/linux/kern_levels.h</span></code>; for other <code class="docutils literal notranslate"><span class="pre">KERN_</span></code> values; these are
interpreted by syslog as the level. Special case: for printing an IP
address use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>__be32 ipaddress;
printk(KERN_INFO &quot;my ip: %pI4\n&quot;, &amp;ipaddress);
</pre></div>
</div>
<p><a class="reference internal" href="../core-api/printk-basics.html#c.printk" title="printk"><code class="xref c c-func docutils literal notranslate"><span class="pre">printk()</span></code></a> internally uses a 1K buffer and does not catch
overruns. Make sure that will be enough.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You will know when you are a real kernel hacker when you start
typoing printf as printk in your user programs :)</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Another sidenote: the original Unix Version 6 sources had a comment
on top of its printf function: “Printf should not be used for
chit-chat”. You should follow that advice.</p>
</div>
</div>
<div class="section" id="copy-to-user-copy-from-user-get-user-put-user">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">copy_to_user()</span></code> / <code class="xref c c-func docutils literal notranslate"><span class="pre">copy_from_user()</span></code> / <a class="reference internal" href="../core-api/mm-api.html#c.get_user" title="get_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">get_user()</span></code></a> / <a class="reference internal" href="../core-api/mm-api.html#c.put_user" title="put_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">put_user()</span></code></a><a class="headerlink" href="#copy-to-user-copy-from-user-get-user-put-user" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/uaccess.h</span></code> / <code class="docutils literal notranslate"><span class="pre">asm/uaccess.h</span></code></p>
<p><strong>[SLEEPS]</strong></p>
<p><a class="reference internal" href="../core-api/mm-api.html#c.put_user" title="put_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">put_user()</span></code></a> and <a class="reference internal" href="../core-api/mm-api.html#c.get_user" title="get_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">get_user()</span></code></a> are used to get
and put single values (such as an int, char, or long) from and to
userspace. A pointer into userspace should never be simply dereferenced:
data should be copied using these routines. Both return <code class="docutils literal notranslate"><span class="pre">-EFAULT</span></code> or
0.</p>
<p><code class="xref c c-func docutils literal notranslate"><span class="pre">copy_to_user()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">copy_from_user()</span></code> are
more general: they copy an arbitrary amount of data to and from
userspace.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Unlike <a class="reference internal" href="../core-api/mm-api.html#c.put_user" title="put_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">put_user()</span></code></a> and <a class="reference internal" href="../core-api/mm-api.html#c.get_user" title="get_user"><code class="xref c c-func docutils literal notranslate"><span class="pre">get_user()</span></code></a>, they
return the amount of uncopied data (ie. 0 still means success).</p>
</div>
<p>[Yes, this moronic interface makes me cringe. The flamewar comes up
every year or so. –RR.]</p>
<p>The functions may sleep implicitly. This should never be called outside
user context (it makes no sense), with interrupts disabled, or a
spinlock held.</p>
</div>
<div class="section" id="kmalloc-kfree">
<h3><a class="reference internal" href="../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a>/<a class="reference internal" href="../core-api/mm-api.html#c.kfree" title="kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kfree()</span></code></a><a class="headerlink" href="#kmalloc-kfree" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/slab.h</span></code></p>
<p><strong>[MAY SLEEP: SEE BELOW]</strong></p>
<p>These routines are used to dynamically request pointer-aligned chunks of
memory, like malloc and free do in userspace, but
<a class="reference internal" href="../core-api/mm-api.html#c.kmalloc" title="kmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">kmalloc()</span></code></a> takes an extra flag word. Important values:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">GFP_KERNEL</span></code></dt><dd><p>May sleep and swap to free memory. Only allowed in user context, but
is the most reliable way to allocate memory.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GFP_ATOMIC</span></code></dt><dd><p>Don’t sleep. Less reliable than <code class="docutils literal notranslate"><span class="pre">GFP_KERNEL</span></code>, but may be called
from interrupt context. You should <strong>really</strong> have a good
out-of-memory error-handling strategy.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">GFP_DMA</span></code></dt><dd><p>Allocate ISA DMA lower than 16MB. If you don’t know what that is you
don’t need it. Very unreliable.</p>
</dd>
</dl>
<p>If you see a sleeping function called from invalid context warning
message, then maybe you called a sleeping allocation function from
interrupt context without <code class="docutils literal notranslate"><span class="pre">GFP_ATOMIC</span></code>. You should really fix that.
Run, don’t walk.</p>
<p>If you are allocating at least <code class="docutils literal notranslate"><span class="pre">PAGE_SIZE</span></code> (<code class="docutils literal notranslate"><span class="pre">asm/page.h</span></code> or
<code class="docutils literal notranslate"><span class="pre">asm/page_types.h</span></code>) bytes, consider using <code class="xref c c-func docutils literal notranslate"><span class="pre">__get_free_pages()</span></code>
(<code class="docutils literal notranslate"><span class="pre">include/linux/gfp.h</span></code>). It takes an order argument (0 for page sized,
1 for double page, 2 for four pages etc.) and the same memory priority
flag word as above.</p>
<p>If you are allocating more than a page worth of bytes you can use
<a class="reference internal" href="../core-api/mm-api.html#c.vmalloc" title="vmalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">vmalloc()</span></code></a>. It’ll allocate virtual memory in the kernel
map. This block is not contiguous in physical memory, but the MMU makes
it look like it is for you (so it’ll only look contiguous to the CPUs,
not to external device drivers). If you really need large physically
contiguous memory for some weird device, you have a problem: it is
poorly supported in Linux because after some time memory fragmentation
in a running kernel makes it hard. The best way is to allocate the block
early in the boot process via the <code class="xref c c-func docutils literal notranslate"><span class="pre">alloc_bootmem()</span></code>
routine.</p>
<p>Before inventing your own cache of often-used objects consider using a
slab cache in <code class="docutils literal notranslate"><span class="pre">include/linux/slab.h</span></code></p>
</div>
<div class="section" id="current">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">current()</span></code><a class="headerlink" href="#current" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/asm/current.h</span></code></p>
<p>This global variable (really a macro) contains a pointer to the current
task structure, so is only valid in user context. For example, when a
process makes a system call, this will point to the task structure of
the calling process. It is <strong>not NULL</strong> in interrupt context.</p>
</div>
<div class="section" id="mdelay-udelay">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">mdelay()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">udelay()</span></code><a class="headerlink" href="#mdelay-udelay" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/asm/delay.h</span></code> / <code class="docutils literal notranslate"><span class="pre">include/linux/delay.h</span></code></p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">udelay()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">ndelay()</span></code> functions can be
used for small pauses. Do not use large values with them as you risk
overflow - the helper function <code class="xref c c-func docutils literal notranslate"><span class="pre">mdelay()</span></code> is useful here, or
consider <a class="reference internal" href="../driver-api/basics.html#c.msleep" title="msleep"><code class="xref c c-func docutils literal notranslate"><span class="pre">msleep()</span></code></a>.</p>
</div>
<div class="section" id="cpu-to-be32-be32-to-cpu-cpu-to-le32-le32-to-cpu">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_be32()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">be32_to_cpu()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_le32()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">le32_to_cpu()</span></code><a class="headerlink" href="#cpu-to-be32-be32-to-cpu-cpu-to-le32-le32-to-cpu" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/asm/byteorder.h</span></code></p>
<p>The <code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_be32()</span></code> family (where the “32” can be replaced
by 64 or 16, and the “be” can be replaced by “le”) are the general way
to do endian conversions in the kernel: they return the converted value.
All variations supply the reverse as well:
<code class="xref c c-func docutils literal notranslate"><span class="pre">be32_to_cpu()</span></code>, etc.</p>
<p>There are two major variations of these functions: the pointer
variation, such as <code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_be32p()</span></code>, which take a pointer
to the given type, and return the converted value. The other variation
is the “in-situ” family, such as <code class="xref c c-func docutils literal notranslate"><span class="pre">cpu_to_be32s()</span></code>, which
convert value referred to by the pointer, and return void.</p>
</div>
<div class="section" id="local-irq-save-local-irq-restore">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_save()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_restore()</span></code><a class="headerlink" href="#local-irq-save-local-irq-restore" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/irqflags.h</span></code></p>
<p>These routines disable hard interrupts on the local CPU, and restore
them. They are reentrant; saving the previous state in their one
<code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">flags</span></code> argument. If you know that interrupts are
enabled, you can simply use <code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_disable()</span></code> and
<code class="xref c c-func docutils literal notranslate"><span class="pre">local_irq_enable()</span></code>.</p>
</div>
<div class="section" id="local-bh-disable-local-bh-enable">
<span id="local-bh-disable"></span><h3><code class="xref c c-func docutils literal notranslate"><span class="pre">local_bh_disable()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">local_bh_enable()</span></code><a class="headerlink" href="#local-bh-disable-local-bh-enable" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/bottom_half.h</span></code></p>
<p>These routines disable soft interrupts on the local CPU, and restore
them. They are reentrant; if soft interrupts were disabled before, they
will still be disabled after this pair of functions has been called.
They prevent softirqs and tasklets from running on the current CPU.</p>
</div>
<div class="section" id="smp-processor-id">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">smp_processor_id()</span></code><a class="headerlink" href="#smp-processor-id" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/smp.h</span></code></p>
<p><code class="xref c c-func docutils literal notranslate"><span class="pre">get_cpu()</span></code> disables preemption (so you won’t suddenly get
moved to another CPU) and returns the current processor number, between
0 and <code class="docutils literal notranslate"><span class="pre">NR_CPUS</span></code>. Note that the CPU numbers are not necessarily
continuous. You return it again with <code class="xref c c-func docutils literal notranslate"><span class="pre">put_cpu()</span></code> when you
are done.</p>
<p>If you know you cannot be preempted by another task (ie. you are in
interrupt context, or have preemption disabled) you can use
smp_processor_id().</p>
</div>
<div class="section" id="init-exit-initdata">
<h3><code class="docutils literal notranslate"><span class="pre">__init</span></code>/<code class="docutils literal notranslate"><span class="pre">__exit</span></code>/<code class="docutils literal notranslate"><span class="pre">__initdata</span></code><a class="headerlink" href="#init-exit-initdata" title="Permalink to this headline">¶</a></h3>
<p>Defined in  <code class="docutils literal notranslate"><span class="pre">include/linux/init.h</span></code></p>
<p>After boot, the kernel frees up a special section; functions marked with
<code class="docutils literal notranslate"><span class="pre">__init</span></code> and data structures marked with <code class="docutils literal notranslate"><span class="pre">__initdata</span></code> are dropped
after boot is complete: similarly modules discard this memory after
initialization. <code class="docutils literal notranslate"><span class="pre">__exit</span></code> is used to declare a function which is only
required on exit: the function will be dropped if this file is not
compiled as a module. See the header file for use. Note that it makes no
sense for a function marked with <code class="docutils literal notranslate"><span class="pre">__init</span></code> to be exported to modules
with <code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL()</span></code> or <code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_GPL()</span></code>- this
will break.</p>
</div>
<div class="section" id="initcall-module-init">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">__initcall()</span></code>/<a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a><a class="headerlink" href="#initcall-module-init" title="Permalink to this headline">¶</a></h3>
<p>Defined in  <code class="docutils literal notranslate"><span class="pre">include/linux/init.h</span></code> / <code class="docutils literal notranslate"><span class="pre">include/linux/module.h</span></code></p>
<p>Many parts of the kernel are well served as a module
(dynamically-loadable parts of the kernel). Using the
<a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a> and <a class="reference internal" href="../driver-api/basics.html#c.module_exit" title="module_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_exit()</span></code></a> macros it
is easy to write code without #ifdefs which can operate both as a module
or built into the kernel.</p>
<p>The <a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a> macro defines which function is to be
called at module insertion time (if the file is compiled as a module),
or at boot time: if the file is not compiled as a module the
<a class="reference internal" href="../driver-api/basics.html#c.module_init" title="module_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_init()</span></code></a> macro becomes equivalent to
<code class="xref c c-func docutils literal notranslate"><span class="pre">__initcall()</span></code>, which through linker magic ensures that
the function is called on boot.</p>
<p>The function can return a negative error number to cause module loading
to fail (unfortunately, this has no effect if the module is compiled
into the kernel). This function is called in user context with
interrupts enabled, so it can sleep.</p>
</div>
<div class="section" id="module-exit">
<h3><a class="reference internal" href="../driver-api/basics.html#c.module_exit" title="module_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">module_exit()</span></code></a><a class="headerlink" href="#module-exit" title="Permalink to this headline">¶</a></h3>
<p>Defined in  <code class="docutils literal notranslate"><span class="pre">include/linux/module.h</span></code></p>
<p>This macro defines the function to be called at module removal time (or
never, in the case of the file compiled into the kernel). It will only
be called if the module usage count has reached zero. This function can
also sleep, but cannot fail: everything must be cleaned up by the time
it returns.</p>
<p>Note that this macro is optional: if it is not present, your module will
not be removable (except for ‘rmmod -f’).</p>
</div>
<div class="section" id="try-module-get-module-put">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">try_module_get()</span></code>/<code class="xref c c-func docutils literal notranslate"><span class="pre">module_put()</span></code><a class="headerlink" href="#try-module-get-module-put" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/module.h</span></code></p>
<p>These manipulate the module usage count, to protect against removal (a
module also can’t be removed if another module uses one of its exported
symbols: see below). Before calling into module code, you should call
<code class="xref c c-func docutils literal notranslate"><span class="pre">try_module_get()</span></code> on that module: if it fails, then the
module is being removed and you should act as if it wasn’t there.
Otherwise, you can safely enter the module, and call
<code class="xref c c-func docutils literal notranslate"><span class="pre">module_put()</span></code> when you’re finished.</p>
<p>Most registerable structures have an owner field, such as in the
<code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">file_operations</span></code> structure.
Set this field to the macro <code class="docutils literal notranslate"><span class="pre">THIS_MODULE</span></code>.</p>
</div>
</div>
<div class="section" id="wait-queues-include-linux-wait-h">
<h2>Wait Queues <code class="docutils literal notranslate"><span class="pre">include/linux/wait.h</span></code><a class="headerlink" href="#wait-queues-include-linux-wait-h" title="Permalink to this headline">¶</a></h2>
<p><strong>[SLEEPS]</strong></p>
<p>A wait queue is used to wait for someone to wake you up when a certain
condition is true. They must be used carefully to ensure there is no
race condition. You declare a <code class="xref c c-type docutils literal notranslate"><span class="pre">wait_queue_head_t</span></code>, and then processes
which want to wait for that condition declare a <code class="xref c c-type docutils literal notranslate"><span class="pre">wait_queue_entry_t</span></code>
referring to themselves, and place that in the queue.</p>
<div class="section" id="declaring">
<h3>Declaring<a class="headerlink" href="#declaring" title="Permalink to this headline">¶</a></h3>
<p>You declare a <code class="docutils literal notranslate"><span class="pre">wait_queue_head_t</span></code> using the
<code class="xref c c-func docutils literal notranslate"><span class="pre">DECLARE_WAIT_QUEUE_HEAD()</span></code> macro, or using the
<code class="xref c c-func docutils literal notranslate"><span class="pre">init_waitqueue_head()</span></code> routine in your initialization
code.</p>
</div>
<div class="section" id="queuing">
<h3>Queuing<a class="headerlink" href="#queuing" title="Permalink to this headline">¶</a></h3>
<p>Placing yourself in the waitqueue is fairly complex, because you must
put yourself in the queue before checking the condition. There is a
macro to do this: <a class="reference internal" href="../driver-api/basics.html#c.wait_event_interruptible" title="wait_event_interruptible"><code class="xref c c-func docutils literal notranslate"><span class="pre">wait_event_interruptible()</span></code></a>
(<code class="docutils literal notranslate"><span class="pre">include/linux/wait.h</span></code>) The first argument is the wait queue head, and
the second is an expression which is evaluated; the macro returns 0 when
this expression is true, or <code class="docutils literal notranslate"><span class="pre">-ERESTARTSYS</span></code> if a signal is received. The
<a class="reference internal" href="../driver-api/basics.html#c.wait_event" title="wait_event"><code class="xref c c-func docutils literal notranslate"><span class="pre">wait_event()</span></code></a> version ignores signals.</p>
</div>
<div class="section" id="waking-up-queued-tasks">
<h3>Waking Up Queued Tasks<a class="headerlink" href="#waking-up-queued-tasks" title="Permalink to this headline">¶</a></h3>
<p>Call <code class="xref c c-func docutils literal notranslate"><span class="pre">wake_up()</span></code> (<code class="docutils literal notranslate"><span class="pre">include/linux/wait.h</span></code>), which will wake
up every process in the queue. The exception is if one has
<code class="docutils literal notranslate"><span class="pre">TASK_EXCLUSIVE</span></code> set, in which case the remainder of the queue will
not be woken. There are other variants of this basic function available
in the same header.</p>
</div>
</div>
<div class="section" id="atomic-operations">
<h2>Atomic Operations<a class="headerlink" href="#atomic-operations" title="Permalink to this headline">¶</a></h2>
<p>Certain operations are guaranteed atomic on all platforms. The first
class of operations work on <code class="xref c c-type docutils literal notranslate"><span class="pre">atomic_t</span></code> (<code class="docutils literal notranslate"><span class="pre">include/asm/atomic.h</span></code>);
this contains a signed integer (at least 32 bits long), and you must use
these functions to manipulate or read <code class="xref c c-type docutils literal notranslate"><span class="pre">atomic_t</span></code> variables.
<code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_read()</span></code> and <code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_set()</span></code> get and set
the counter, <code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_add()</span></code>, <code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_sub()</span></code>,
<code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_inc()</span></code>, <code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_dec()</span></code>, and
<code class="xref c c-func docutils literal notranslate"><span class="pre">atomic_dec_and_test()</span></code> (returns true if it was
decremented to zero).</p>
<p>Yes. It returns true (i.e. != 0) if the atomic variable is zero.</p>
<p>Note that these functions are slower than normal arithmetic, and so
should not be used unnecessarily.</p>
<p>The second class of atomic operations is atomic bit operations on an
<code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span></code>, defined in <code class="docutils literal notranslate"><span class="pre">include/linux/bitops.h</span></code>. These
operations generally take a pointer to the bit pattern, and a bit
number: 0 is the least significant bit. <a class="reference internal" href="../core-api/kernel-api.html#c.set_bit" title="set_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">set_bit()</span></code></a>,
<a class="reference internal" href="../core-api/kernel-api.html#c.clear_bit" title="clear_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">clear_bit()</span></code></a> and <a class="reference internal" href="../core-api/kernel-api.html#c.change_bit" title="change_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">change_bit()</span></code></a> set, clear,
and flip the given bit. <a class="reference internal" href="../core-api/kernel-api.html#c.test_and_set_bit" title="test_and_set_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">test_and_set_bit()</span></code></a>,
<a class="reference internal" href="../core-api/kernel-api.html#c.test_and_clear_bit" title="test_and_clear_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">test_and_clear_bit()</span></code></a> and
<a class="reference internal" href="../core-api/kernel-api.html#c.test_and_change_bit" title="test_and_change_bit"><code class="xref c c-func docutils literal notranslate"><span class="pre">test_and_change_bit()</span></code></a> do the same thing, except return
true if the bit was previously set; these are particularly useful for
atomically setting flags.</p>
<p>It is possible to call these operations with bit indices greater than
<code class="docutils literal notranslate"><span class="pre">BITS_PER_LONG</span></code>. The resulting behavior is strange on big-endian
platforms though so it is a good idea not to do this.</p>
</div>
<div class="section" id="symbols">
<h2>Symbols<a class="headerlink" href="#symbols" title="Permalink to this headline">¶</a></h2>
<p>Within the kernel proper, the normal linking rules apply (ie. unless a
symbol is declared to be file scope with the <code class="docutils literal notranslate"><span class="pre">static</span></code> keyword, it can
be used anywhere in the kernel). However, for modules, a special
exported symbol table is kept which limits the entry points to the
kernel proper. Modules can also export symbols.</p>
<div class="section" id="export-symbol">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL()</span></code><a class="headerlink" href="#export-symbol" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/export.h</span></code></p>
<p>This is the classic method of exporting a symbol: dynamically loaded
modules will be able to use the symbol as normal.</p>
</div>
<div class="section" id="export-symbol-gpl">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_GPL()</span></code><a class="headerlink" href="#export-symbol-gpl" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/export.h</span></code></p>
<p>Similar to <code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL()</span></code> except that the symbols
exported by <code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_GPL()</span></code> can only be seen by
modules with a <code class="xref c c-func docutils literal notranslate"><span class="pre">MODULE_LICENSE()</span></code> that specifies a GPL
compatible license. It implies that the function is considered an
internal implementation issue, and not really an interface. Some
maintainers and developers may however require EXPORT_SYMBOL_GPL()
when adding any new APIs or functionality.</p>
</div>
<div class="section" id="export-symbol-ns">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_NS()</span></code><a class="headerlink" href="#export-symbol-ns" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/export.h</span></code></p>
<p>This is the variant of <cite>EXPORT_SYMBOL()</cite> that allows specifying a symbol
namespace. Symbol Namespaces are documented in
<a class="reference internal" href="../core-api/symbol-namespaces.html"><span class="doc">Symbol Namespaces</span></a></p>
</div>
<div class="section" id="export-symbol-ns-gpl">
<h3><code class="xref c c-func docutils literal notranslate"><span class="pre">EXPORT_SYMBOL_NS_GPL()</span></code><a class="headerlink" href="#export-symbol-ns-gpl" title="Permalink to this headline">¶</a></h3>
<p>Defined in <code class="docutils literal notranslate"><span class="pre">include/linux/export.h</span></code></p>
<p>This is the variant of <cite>EXPORT_SYMBOL_GPL()</cite> that allows specifying a symbol
namespace. Symbol Namespaces are documented in
<a class="reference internal" href="../core-api/symbol-namespaces.html"><span class="doc">Symbol Namespaces</span></a></p>
</div>
</div>
<div class="section" id="routines-and-conventions">
<h2>Routines and Conventions<a class="headerlink" href="#routines-and-conventions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="double-linked-lists-include-linux-list-h">
<h3>Double-linked lists <code class="docutils literal notranslate"><span class="pre">include/linux/list.h</span></code><a class="headerlink" href="#double-linked-lists-include-linux-list-h" title="Permalink to this headline">¶</a></h3>
<p>There used to be three sets of linked-list routines in the kernel
headers, but this one is the winner. If you don’t have some particular
pressing need for a single list, it’s a good choice.</p>
<p>In particular, <a class="reference internal" href="../core-api/kernel-api.html#c.list_for_each_entry" title="list_for_each_entry"><code class="xref c c-func docutils literal notranslate"><span class="pre">list_for_each_entry()</span></code></a> is useful.</p>
</div>
<div class="section" id="return-conventions">
<h3>Return Conventions<a class="headerlink" href="#return-conventions" title="Permalink to this headline">¶</a></h3>
<p>For code called in user context, it’s very common to defy C convention,
and return 0 for success, and a negative error number (eg. <code class="docutils literal notranslate"><span class="pre">-EFAULT</span></code>) for
failure. This can be unintuitive at first, but it’s fairly widespread in
the kernel.</p>
<p>Using <code class="xref c c-func docutils literal notranslate"><span class="pre">ERR_PTR()</span></code> (<code class="docutils literal notranslate"><span class="pre">include/linux/err.h</span></code>) to encode a
negative error number into a pointer, and <code class="xref c c-func docutils literal notranslate"><span class="pre">IS_ERR()</span></code> and
<code class="xref c c-func docutils literal notranslate"><span class="pre">PTR_ERR()</span></code> to get it back out again: avoids a separate
pointer parameter for the error number. Icky, but in a good way.</p>
</div>
<div class="section" id="breaking-compilation">
<h3>Breaking Compilation<a class="headerlink" href="#breaking-compilation" title="Permalink to this headline">¶</a></h3>
<p>Linus and the other developers sometimes change function or structure
names in development kernels; this is not done just to keep everyone on
their toes: it reflects a fundamental change (eg. can no longer be
called with interrupts on, or does extra checks, or doesn’t do checks
which were caught before). Usually this is accompanied by a fairly
complete note to the linux-kernel mailing list; search the archive.
Simply doing a global replace on the file usually makes things <strong>worse</strong>.</p>
</div>
<div class="section" id="initializing-structure-members">
<h3>Initializing structure members<a class="headerlink" href="#initializing-structure-members" title="Permalink to this headline">¶</a></h3>
<p>The preferred method of initializing structures is to use designated
initialisers, as defined by ISO C99, eg:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static struct block_device_operations opt_fops = {
        .open               = opt_open,
        .release            = opt_release,
        .ioctl              = opt_ioctl,
        .check_media_change = opt_media_change,
};
</pre></div>
</div>
<p>This makes it easy to grep for, and makes it clear which structure
fields are set. You should do this because it looks cool.</p>
</div>
<div class="section" id="gnu-extensions">
<h3>GNU Extensions<a class="headerlink" href="#gnu-extensions" title="Permalink to this headline">¶</a></h3>
<p>GNU Extensions are explicitly allowed in the Linux kernel. Note that
some of the more complex ones are not very well supported, due to lack
of general use, but the following are considered standard (see the GCC
info page section “C Extensions” for more details - Yes, really the info
page, the man page is only a short summary of the stuff in info).</p>
<ul class="simple">
<li><p>Inline functions</p></li>
<li><p>Statement expressions (ie. the ({ and }) constructs).</p></li>
<li><p>Declaring attributes of a function / variable / type
(__attribute__)</p></li>
<li><p>typeof</p></li>
<li><p>Zero length arrays</p></li>
<li><p>Macro varargs</p></li>
<li><p>Arithmetic on void pointers</p></li>
<li><p>Non-Constant initializers</p></li>
<li><p>Assembler Instructions (not outside arch/ and include/asm/)</p></li>
<li><p>Function names as strings (__func__).</p></li>
<li><p>__builtin_constant_p()</p></li>
</ul>
<p>Be wary when using long long in the kernel, the code gcc generates for
it is horrible and worse: division and multiplication does not work on
i386 because the GCC runtime functions for it are missing from the
kernel environment.</p>
</div>
<div class="section" id="c">
<h3>C++<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h3>
<p>Using C++ in the kernel is usually a bad idea, because the kernel does
not provide the necessary runtime environment and the include files are
not tested for it. It is still possible, but not recommended. If you
really want to do this, forget about exceptions at least.</p>
</div>
<div class="section" id="if">
<h3>#if<a class="headerlink" href="#if" title="Permalink to this headline">¶</a></h3>
<p>It is generally considered cleaner to use macros in header files (or at
the top of .c files) to abstract away functions rather than using `#if’
pre-processor statements throughout the source code.</p>
</div>
</div>
<div class="section" id="putting-your-stuff-in-the-kernel">
<h2>Putting Your Stuff in the Kernel<a class="headerlink" href="#putting-your-stuff-in-the-kernel" title="Permalink to this headline">¶</a></h2>
<p>In order to get your stuff into shape for official inclusion, or even to
make a neat patch, there’s administrative work to be done:</p>
<ul>
<li><p>Figure out whose pond you’ve been pissing in. Look at the top of the
source files, inside the <code class="docutils literal notranslate"><span class="pre">MAINTAINERS</span></code> file, and last of all in the
<code class="docutils literal notranslate"><span class="pre">CREDITS</span></code> file. You should coordinate with this person to make sure
you’re not duplicating effort, or trying something that’s already
been rejected.</p>
<p>Make sure you put your name and EMail address at the top of any files
you create or mangle significantly. This is the first place people
will look when they find a bug, or when <strong>they</strong> want to make a change.</p>
</li>
<li><p>Usually you want a configuration option for your kernel hack. Edit
<code class="docutils literal notranslate"><span class="pre">Kconfig</span></code> in the appropriate directory. The Config language is
simple to use by cut and paste, and there’s complete documentation in
<code class="docutils literal notranslate"><span class="pre">Documentation/kbuild/kconfig-language.rst</span></code>.</p>
<p>In your description of the option, make sure you address both the
expert user and the user who knows nothing about your feature.
Mention incompatibilities and issues here. <strong>Definitely</strong> end your
description with “if in doubt, say N” (or, occasionally, `Y’); this
is for people who have no idea what you are talking about.</p>
</li>
<li><p>Edit the <code class="docutils literal notranslate"><span class="pre">Makefile</span></code>: the CONFIG variables are exported here so you
can usually just add a “obj-$(CONFIG_xxx) += xxx.o” line. The syntax
is documented in <code class="docutils literal notranslate"><span class="pre">Documentation/kbuild/makefiles.rst</span></code>.</p></li>
<li><p>Put yourself in <code class="docutils literal notranslate"><span class="pre">CREDITS</span></code> if you’ve done something noteworthy,
usually beyond a single file (your name should be at the top of the
source files anyway). <code class="docutils literal notranslate"><span class="pre">MAINTAINERS</span></code> means you want to be consulted
when changes are made to a subsystem, and hear about bugs; it implies
a more-than-passing commitment to some part of the code.</p></li>
<li><p>Finally, don’t forget to read
<code class="docutils literal notranslate"><span class="pre">Documentation/process/submitting-patches.rst</span></code> and possibly
<code class="docutils literal notranslate"><span class="pre">Documentation/process/submitting-drivers.rst</span></code>.</p></li>
</ul>
</div>
<div class="section" id="kernel-cantrips">
<h2>Kernel Cantrips<a class="headerlink" href="#kernel-cantrips" title="Permalink to this headline">¶</a></h2>
<p>Some favorites from browsing the source. Feel free to add to this list.</p>
<p><code class="docutils literal notranslate"><span class="pre">arch/x86/include/asm/delay.h</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define ndelay(n) (__builtin_constant_p(n) ? \
        ((n) &gt; 20000 ? __bad_ndelay() : __const_udelay((n) * 5ul)) : \
        __ndelay(n))
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">include/linux/fs.h</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 * Kernel pointers have redundant information, so we can use a
 * scheme where we can return either an error code or a dentry
 * pointer with the same return value.
 *
 * This should be a per-architecture thing, to allow different
 * error and pointer decisions.
 */
 #define ERR_PTR(err)    ((void *)((long)(err)))
 #define PTR_ERR(ptr)    ((long)(ptr))
 #define IS_ERR(ptr)     ((unsigned long)(ptr) &gt; (unsigned long)(-1000))
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">arch/x86/include/asm/uaccess_32.h:</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define copy_to_user(to,from,n)                         \
        (__builtin_constant_p(n) ?                      \
         __constant_copy_to_user((to),(from),(n)) :     \
         __generic_copy_to_user((to),(from),(n)))
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">arch/sparc/kernel/head.S:</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/*
 * Sun people can&#39;t spell worth damn. &quot;compatability&quot; indeed.
 * At least we *know* we can&#39;t spell, and use a spell-checker.
 */

/* Uh, actually Linus it is I who cannot spell. Too much murky
 * Sparc assembly will do this to ya.
 */
C_LABEL(cputypvar):
        .asciz &quot;compatibility&quot;

/* Tested on SS-5, SS-10. Probably someone at Sun applied a spell-checker. */
        .align 4
C_LABEL(cputypvar_sun4m):
        .asciz &quot;compatible&quot;
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">arch/sparc/lib/checksum.S:</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* Sun, you just can&#39;t beat me, you just can&#39;t.  Stop trying,
 * give up.  I&#39;m serious, I am going to kick the living shit
 * out of you, game over, lights out.
 */
</pre></div>
</div>
</div>
<div class="section" id="thanks">
<h2>Thanks<a class="headerlink" href="#thanks" title="Permalink to this headline">¶</a></h2>
<p>Thanks to Andi Kleen for the idea, answering my questions, fixing my
mistakes, filling content, etc. Philipp Rumpf for more spelling and
clarity fixes, and some excellent non-obvious points. Werner Almesberger
for giving me a great summary of <a class="reference internal" href="../core-api/genericirq.html#c.disable_irq" title="disable_irq"><code class="xref c c-func docutils literal notranslate"><span class="pre">disable_irq()</span></code></a>, and Jes
Sorensen and Andrea Arcangeli added caveats. Michael Elizabeth Chastain
for checking and adding to the Configure section. Telsa Gwynne for
teaching me DocBook.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="locking.html" class="btn btn-neutral float-right" title="Unreliable Guide To Locking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="Kernel Hacking Guides" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>