

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>9.6. PCI NTB Function &mdash; The Linux Kernel 5.12.0-rc3+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9.7. PCI Non-Transparent Bridge (NTB) Endpoint Function (EPF) User Guide" href="pci-ntb-howto.html" />
    <link rel="prev" title="9.5. PCI Test User Guide" href="pci-test-howto.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.12.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux PCI Bus Subsystem</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../pci.html">1. How To Write Linux PCI Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pciebus-howto.html">2. The PCI Express Port Bus Driver Guide HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci-iov-howto.html">3. PCI Express I/O Virtualization Howto</a></li>
<li class="toctree-l2"><a class="reference internal" href="../msi-howto.html">4. The MSI Driver Guide HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sysfs-pci.html">5. Accessing PCI device resources through sysfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acpi-info.html">6. ACPI considerations for PCI host bridges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci-error-recovery.html">7. PCI Error Recovery</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pcieaer-howto.html">8. The PCI Express Advanced Error Reporting Driver Guide HOWTO</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">9. PCI Endpoint Framework</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="pci-endpoint.html">9.1. Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci-endpoint.html#pci-endpoint-core">9.2. PCI Endpoint Core</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci-endpoint-cfs.html">9.3. Configuring PCI Endpoint Using CONFIGFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci-test-function.html">9.4. PCI Test Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="pci-test-howto.html">9.5. PCI Test User Guide</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">9.6. PCI NTB Function</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#constructs-used-for-implementing-ntb">9.6.1. Constructs used for Implementing NTB</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modeling-constructs">9.6.2. Modeling Constructs:</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="pci-ntb-howto.html">9.7. PCI Non-Transparent Bridge (NTB) Endpoint Function (EPF) User Guide</a></li>
<li class="toctree-l3"><a class="reference internal" href="function/binding/pci-test.html">9.8. PCI Test Endpoint Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="function/binding/pci-ntb.html">9.9. PCI NTB Endpoint Function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../boot-interrupts.html">10. Boot Interrupts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Linux PCI Bus Subsystem</a> &raquo;</li>
        
          <li><a href="index.html"><span class="section-number">9. </span>PCI Endpoint Framework</a> &raquo;</li>
        
      <li><span class="section-number">9.6. </span>PCI NTB Function</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/PCI/endpoint/pci-ntb-function.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pci-ntb-function">
<h1><span class="section-number">9.6. </span>PCI NTB Function<a class="headerlink" href="#pci-ntb-function" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Kishon Vijay Abraham I &lt;<a class="reference external" href="mailto:kishon&#37;&#52;&#48;ti&#46;com">kishon<span>&#64;</span>ti<span>&#46;</span>com</a>&gt;</p>
</dd>
</dl>
<p>PCI Non-Transparent Bridges (NTB) allow two host systems to communicate
with each other by exposing each host as a device to the other host.
NTBs typically support the ability to generate interrupts on the remote
machine, expose memory ranges as BARs, and perform DMA.  They also support
scratchpads, which are areas of memory within the NTB that are accessible
from both machines.</p>
<p>PCI NTB Function allows two different systems (or hosts) to communicate
with each other by configuring the endpoint instances in such a way that
transactions from one system are routed to the other system.</p>
<p>In the below diagram, PCI NTB function configures the SoC with multiple
PCI Endpoint (EP) instances in such a way that transactions from one EP
controller are routed to the other EP controller. Once PCI NTB function
configures the SoC with multiple EP instances, HOST1 and HOST2 can
communicate with each other using SoC as a bridge.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>   +-------------+                                   +-------------+
   |             |                                   |             |
   |    HOST1    |                                   |    HOST2    |
   |             |                                   |             |
   +------^------+                                   +------^------+
          |                                                 |
          |                                                 |
+---------|-------------------------------------------------|---------+
|  +------v------+                                   +------v------+  |
|  |             |                                   |             |  |
|  |     EP      |                                   |     EP      |  |
|  | CONTROLLER1 |                                   | CONTROLLER2 |  |
|  |             &lt;-----------------------------------&gt;             |  |
|  |             |                                   |             |  |
|  |             |                                   |             |  |
|  |             |  SoC With Multiple EP Instances   |             |  |
|  |             |  (Configured using NTB Function)  |             |  |
|  +-------------+                                   +-------------+  |
+---------------------------------------------------------------------+
</pre></div>
</div>
<div class="section" id="constructs-used-for-implementing-ntb">
<h2><span class="section-number">9.6.1. </span>Constructs used for Implementing NTB<a class="headerlink" href="#constructs-used-for-implementing-ntb" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ol class="arabic simple">
<li><p>Config Region</p></li>
<li><p>Self Scratchpad Registers</p></li>
<li><p>Peer Scratchpad Registers</p></li>
<li><p>Doorbell (DB) Registers</p></li>
<li><p>Memory Window (MW)</p></li>
</ol>
</div></blockquote>
<div class="section" id="config-region">
<h3><span class="section-number">9.6.1.1. </span>Config Region:<a class="headerlink" href="#config-region" title="Permalink to this headline">¶</a></h3>
<p>Config Region is a construct that is specific to NTB implemented using NTB
Endpoint Function Driver. The host and endpoint side NTB function driver will
exchange information with each other using this region. Config Region has
Control/Status Registers for configuring the Endpoint Controller. Host can
write into this region for configuring the outbound Address Translation Unit
(ATU) and to indicate the link status. Endpoint can indicate the status of
commands issued by host in this region. Endpoint can also indicate the
scratchpad offset and number of memory windows to the host using this region.</p>
<p>The format of Config Region is given below. All the fields here are 32 bits.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>      +------------------------+
      |         COMMAND        |
      +------------------------+
      |         ARGUMENT       |
      +------------------------+
      |         STATUS         |
      +------------------------+
      |         TOPOLOGY       |
      +------------------------+
      |    ADDRESS (LOWER 32)  |
      +------------------------+
      |    ADDRESS (UPPER 32)  |
      +------------------------+
      |           SIZE         |
      +------------------------+
      |   NO OF MEMORY WINDOW  |
      +------------------------+
      |  MEMORY WINDOW1 OFFSET |
      +------------------------+
      |       SPAD OFFSET      |
      +------------------------+
      |        SPAD COUNT      |
      +------------------------+
      |      DB ENTRY SIZE     |
      +------------------------+
      |         DB DATA        |
      +------------------------+
      |            :           |
      +------------------------+
      |            :           |
      +------------------------+
      |         DB DATA        |
      +------------------------+


COMMAND:

      NTB function supports three commands:

        CMD_CONFIGURE_DOORBELL (0x1): Command to configure doorbell. Before
      invoking this command, the host should allocate and initialize
      MSI/MSI-X vectors (i.e., initialize the MSI/MSI-X Capability in the
      Endpoint). The endpoint on receiving this command will configure
      the outbound ATU such that transactions to Doorbell BAR will be routed
      to the MSI/MSI-X address programmed by the host. The ARGUMENT
      register should be populated with number of DBs to configure (in the
      lower 16 bits) and if MSI or MSI-X should be configured (BIT 16).

        CMD_CONFIGURE_MW (0x2): Command to configure memory window (MW). The
      host invokes this command after allocating a buffer that can be
      accessed by remote host. The allocated address should be programmed
      in the ADDRESS register (64 bit), the size should be programmed in
      the SIZE register and the memory window index should be programmed
      in the ARGUMENT register. The endpoint on receiving this command
      will configure the outbound ATU such that transactions to MW BAR
      are routed to the address provided by the host.

        CMD_LINK_UP (0x3): Command to indicate an NTB application is
      bound to the EP device on the host side. Once the endpoint
      receives this command from both the hosts, the endpoint will
      raise a LINK_UP event to both the hosts to indicate the host
      NTB applications can start communicating with each other.

ARGUMENT:

      The value of this register is based on the commands issued in
      command register. See COMMAND section for more information.

TOPOLOGY:

      Set to NTB_TOPO_B2B_USD for Primary interface
      Set to NTB_TOPO_B2B_DSD for Secondary interface

ADDRESS/SIZE:

      Address and Size to be used while configuring the memory window.
      See &quot;CMD_CONFIGURE_MW&quot; for more info.

MEMORY WINDOW1 OFFSET:

      Memory Window 1 and Doorbell registers are packed together in the
      same BAR. The initial portion of the region will have doorbell
      registers and the latter portion of the region is for memory window 1.
      This register will specify the offset of the memory window 1.

NO OF MEMORY WINDOW:

      Specifies the number of memory windows supported by the NTB device.

SPAD OFFSET:

      Self scratchpad region and config region are packed together in the
      same BAR. The initial portion of the region will have config region
      and the latter portion of the region is for self scratchpad. This
      register will specify the offset of the self scratchpad registers.

SPAD COUNT:

      Specifies the number of scratchpad registers supported by the NTB
      device.

DB ENTRY SIZE:

      Used to determine the offset within the DB BAR that should be written
      in order to raise doorbell. EPF NTB can use either MSI or MSI-X to
      ring doorbell (MSI-X support will be added later). MSI uses same
      address for all the interrupts and MSI-X can provide different
      addresses for different interrupts. The MSI/MSI-X address is provided
      by the host and the address it gives is based on the MSI/MSI-X
      implementation supported by the host. For instance, ARM platform
      using GIC ITS will have the same MSI-X address for all the interrupts.
      In order to support all the combinations and use the same mechanism
      for both MSI and MSI-X, EPF NTB allocates a separate region in the
      Outbound Address Space for each of the interrupts. This region will
      be mapped to the MSI/MSI-X address provided by the host. If a host
      provides the same address for all the interrupts, all the regions
      will be translated to the same address. If a host provides different
      addresses, the regions will be translated to different addresses. This
      will ensure there is no difference while raising the doorbell.

DB DATA:

      EPF NTB supports 32 interrupts, so there are 32 DB DATA registers.
      This holds the MSI/MSI-X data that has to be written to MSI address
      for raising doorbell interrupt. This will be populated by EPF NTB
      while invoking CMD_CONFIGURE_DOORBELL.
</pre></div>
</div>
</div>
<div class="section" id="scratchpad-registers">
<h3><span class="section-number">9.6.1.2. </span>Scratchpad Registers:<a class="headerlink" href="#scratchpad-registers" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Each host has its own register space allocated in the memory of NTB endpoint
controller. They are both readable and writable from both sides of the bridge.
They are used by applications built over NTB and can be used to pass control
and status information between both sides of a device.</p>
<dl class="simple">
<dt>Scratchpad registers has 2 parts</dt><dd><ol class="arabic simple">
<li><p>Self Scratchpad: Host’s own register space</p></li>
<li><p>Peer Scratchpad: Remote host’s register space.</p></li>
</ol>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="doorbell-registers">
<h3><span class="section-number">9.6.1.3. </span>Doorbell Registers:<a class="headerlink" href="#doorbell-registers" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Doorbell Registers are used by the hosts to interrupt each other.</p>
</div></blockquote>
</div>
<div class="section" id="memory-window">
<h3><span class="section-number">9.6.1.4. </span>Memory Window:<a class="headerlink" href="#memory-window" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Actual transfer of data between the two hosts will happen using the
memory window.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="modeling-constructs">
<h2><span class="section-number">9.6.2. </span>Modeling Constructs:<a class="headerlink" href="#modeling-constructs" title="Permalink to this headline">¶</a></h2>
<p>There are 5 or more distinct regions (config, self scratchpad, peer
scratchpad, doorbell, one or more memory windows) to be modeled to achieve
NTB functionality. At least one memory window is required while more than
one is permitted. All these regions should be mapped to BARs for hosts to
access these regions.</p>
<p>If one 32-bit BAR is allocated for each of these regions, the scheme would
look like this:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 29%" />
<col style="width: 71%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>BAR NO</p></th>
<th class="head"><p>CONSTRUCTS USED</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BAR0</p></td>
<td><p>Config Region</p></td>
</tr>
<tr class="row-odd"><td><p>BAR1</p></td>
<td><p>Self Scratchpad</p></td>
</tr>
<tr class="row-even"><td><p>BAR2</p></td>
<td><p>Peer Scratchpad</p></td>
</tr>
<tr class="row-odd"><td><p>BAR3</p></td>
<td><p>Doorbell</p></td>
</tr>
<tr class="row-even"><td><p>BAR4</p></td>
<td><p>Memory Window 1</p></td>
</tr>
<tr class="row-odd"><td><p>BAR5</p></td>
<td><p>Memory Window 2</p></td>
</tr>
</tbody>
</table>
<p>However if we allocate a separate BAR for each of the regions, there would not
be enough BARs for all the regions in a platform that supports only 64-bit
BARs.</p>
<p>In order to be supported by most of the platforms, the regions should be
packed and mapped to BARs in a way that provides NTB functionality and
also makes sure the host doesn’t access any region that it is not supposed
to.</p>
<p>The following scheme is used in EPF NTB Function:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 16%" />
<col style="width: 84%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>BAR NO</p></th>
<th class="head"><p>CONSTRUCTS USED</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>BAR0</p></td>
<td><p>Config Region + Self Scratchpad</p></td>
</tr>
<tr class="row-odd"><td><p>BAR1</p></td>
<td><p>Peer Scratchpad</p></td>
</tr>
<tr class="row-even"><td><p>BAR2</p></td>
<td><p>Doorbell + Memory Window 1</p></td>
</tr>
<tr class="row-odd"><td><p>BAR3</p></td>
<td><p>Memory Window 2</p></td>
</tr>
<tr class="row-even"><td><p>BAR4</p></td>
<td><p>Memory Window 3</p></td>
</tr>
<tr class="row-odd"><td><p>BAR5</p></td>
<td><p>Memory Window 4</p></td>
</tr>
</tbody>
</table>
<p>With this scheme, for the basic NTB functionality 3 BARs should be sufficient.</p>
<div class="section" id="modeling-config-scratchpad-region">
<h3><span class="section-number">9.6.2.1. </span>Modeling Config/Scratchpad Region:<a class="headerlink" href="#modeling-config-scratchpad-region" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+-----------------+-------&gt;+------------------+        +-----------------+
|       BAR0      |        |  CONFIG REGION   |        |       BAR0      |
+-----------------+----+   +------------------+&lt;-------+-----------------+
|       BAR1      |    |   |SCRATCHPAD REGION |        |       BAR1      |
+-----------------+    +--&gt;+------------------+&lt;-------+-----------------+
|       BAR2      |            Local Memory            |       BAR2      |
+-----------------+                                    +-----------------+
|       BAR3      |                                    |       BAR3      |
+-----------------+                                    +-----------------+
|       BAR4      |                                    |       BAR4      |
+-----------------+                                    +-----------------+
|       BAR5      |                                    |       BAR5      |
+-----------------+                                    +-----------------+
  EP CONTROLLER 1                                        EP CONTROLLER 2
</pre></div>
</div>
<p>Above diagram shows Config region + Scratchpad region for HOST1 (connected to
EP controller 1) allocated in local memory. The HOST1 can access the config
region and scratchpad region (self scratchpad) using BAR0 of EP controller 1.
The peer host (HOST2 connected to EP controller 2) can also access this
scratchpad region (peer scratchpad) using BAR1 of EP controller 2. This
diagram shows the case where Config region and Scratchpad regions are allocated
for HOST1, however the same is applicable for HOST2.</p>
</div>
<div class="section" id="modeling-doorbell-memory-window-1">
<h3><span class="section-number">9.6.2.2. </span>Modeling Doorbell/Memory Window 1:<a class="headerlink" href="#modeling-doorbell-memory-window-1" title="Permalink to this headline">¶</a></h3>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>+-----------------+    +-----&gt;+----------------+-----------+-----------------+
|       BAR0      |    |      |   Doorbell 1   +-----------&gt; MSI-X ADDRESS 1 |
+-----------------+    |      +----------------+           +-----------------+
|       BAR1      |    |      |   Doorbell 2   +---------+ |                 |
+-----------------+----+      +----------------+         | |                 |
|       BAR2      |           |   Doorbell 3   +-------+ | +-----------------+
+-----------------+----+      +----------------+       | +-&gt; MSI-X ADDRESS 2 |
|       BAR3      |    |      |   Doorbell 4   +-----+ |   +-----------------+
+-----------------+    |      |----------------+     | |   |                 |
|       BAR4      |    |      |                |     | |   +-----------------+
+-----------------+    |      |      MW1       +---+ | +--&gt;+ MSI-X ADDRESS 3||
|       BAR5      |    |      |                |   | |     +-----------------+
+-----------------+    +-----&gt;-----------------+   | |     |                 |
  EP CONTROLLER 1             |                |   | |     +-----------------+
                              |                |   | +----&gt;+ MSI-X ADDRESS 4 |
                              +----------------+   |       +-----------------+
                               EP CONTROLLER 2     |       |                 |
                                 (OB SPACE)        |       |                 |
                                                   +-------&gt;      MW1        |
                                                           |                 |
                                                           |                 |
                                                           +-----------------+
                                                           |                 |
                                                           |                 |
                                                           |                 |
                                                           |                 |
                                                           |                 |
                                                           +-----------------+
                                                            PCI Address Space
                                                            (Managed by HOST2)
</pre></div>
</div>
<p>Above diagram shows how the doorbell and memory window 1 is mapped so that
HOST1 can raise doorbell interrupt on HOST2 and also how HOST1 can access
buffers exposed by HOST2 using memory window1 (MW1). Here doorbell and
memory window 1 regions are allocated in EP controller 2 outbound (OB) address
space. Allocating and configuring BARs for doorbell and memory window1
is done during the initialization phase of NTB endpoint function driver.
Mapping from EP controller 2 OB space to PCI address space is done when HOST2
sends CMD_CONFIGURE_MW/CMD_CONFIGURE_DOORBELL.</p>
</div>
<div class="section" id="modeling-optional-memory-windows">
<h3><span class="section-number">9.6.2.3. </span>Modeling Optional Memory Windows:<a class="headerlink" href="#modeling-optional-memory-windows" title="Permalink to this headline">¶</a></h3>
<p>This is modeled the same was as MW1 but each of the additional memory windows
is mapped to separate BARs.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="pci-ntb-howto.html" class="btn btn-neutral float-right" title="9.7. PCI Non-Transparent Bridge (NTB) Endpoint Function (EPF) User Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="pci-test-howto.html" class="btn btn-neutral float-left" title="9.5. PCI Test User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>