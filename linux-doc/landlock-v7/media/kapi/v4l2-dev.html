

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>1.4. Video device’ s internal representation &mdash; The Linux Kernel 4.13.0-rc5+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 4.13.0-rc5+ documentation" href="../../index.html"/>
        <link rel="up" title="1. Video4Linux devices" href="v4l2-core.html"/>
        <link rel="next" title="1.5. V4L2 device instance" href="v4l2-device.html"/>
        <link rel="prev" title="1.1. Introduction" href="v4l2-intro.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.13.0-rc5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user&#8217;s and administrator&#8217;s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer&#8217;s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Media Subsystem Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../media_uapi.html">Linux Media Infrastructure userspace API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../media_kapi.html">Media subsystem kernel internal API</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="v4l2-core.html">1. Video4Linux devices</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="v4l2-intro.html">1.1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-intro.html#structure-of-a-v4l-driver">1.2. Structure of a V4L driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-intro.html#structure-of-the-v4l2-framework">1.3. Structure of the V4L2 framework</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">1.4. Video device&#8217; s internal representation</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-device.html">1.5. V4L2 device instance</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-fh.html">1.6. V4L2 File handlers</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-subdev.html">1.7. V4L2 sub-devices</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-subdev.html#v4l2-sub-device-userspace-api">1.8. V4L2 sub-device userspace API</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-subdev.html#i2c-sub-device-drivers">1.9. I2C sub-device drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-subdev.html#v4l2-sub-device-functions-and-data-structures">1.10. V4L2 sub-device functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-event.html">1.11. V4L2 events</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-controls.html">1.12. V4L2 Controls</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-videobuf.html">1.13. Videobuf Framework</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-videobuf2.html">1.14. V4L2 videobuf2 functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-clocks.html">1.15. V4L2 clocks</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-dv-timings.html">1.16. V4L2 DV Timings functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-flash-led-class.html">1.17. V4L2 flash functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-mc.html">1.18. V4L2 Media Controller functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-mediabus.html">1.19. V4L2 Media Bus functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-mem2mem.html">1.20. V4L2 Memory to Memory functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-fwnode.html">1.21. V4L2 fwnode kAPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-rect.html">1.22. V4L2 rect helper functions</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-tuner.html">1.23. Tuner functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-common.html">1.24. V4L2 common functions and data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2-tveeprom.html">1.25. Hauppauge TV EEPROM functions and data structures</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html">2. Digital TV (DVB) devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#digital-tv-common-functions">3. Digital TV Common functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#digital-tv-ring-buffer">4. Digital TV Ring buffer</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#digital-tv-frontend-kabi">5. Digital TV Frontend kABI</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#digital-tv-demux-kabi">6. Digital TV Demux kABI</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#demux-callback-api">7. Demux Callback API</a></li>
<li class="toctree-l3"><a class="reference internal" href="dtv-core.html#digital-tv-conditional-access-kabi">8. Digital TV Conditional Access kABI</a></li>
<li class="toctree-l3"><a class="reference internal" href="rc-core.html">9. Remote Controller devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="mc-core.html">10. Media Controller devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="cec-core.html">11. CEC Kernel Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="csi2.html">12. MIPI CSI-2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dvb-drivers/index.html">Linux Digital TV driver-specific documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../v4l-drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Linux Filesystems API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/ja_JP/index.html">Japanese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Media Subsystem Documentation</a> &raquo;</li>
        
          <li><a href="../media_kapi.html">Media subsystem kernel internal API</a> &raquo;</li>
        
          <li><a href="v4l2-core.html">1. Video4Linux devices</a> &raquo;</li>
        
      <li>1.4. Video device&#8217; s internal representation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/media/kapi/v4l2-dev.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="video-device-s-internal-representation">
<h1>1.4. Video device&#8217; s internal representation<a class="headerlink" href="#video-device-s-internal-representation" title="Permalink to this headline">¶</a></h1>
<p>The actual device nodes in the <code class="docutils literal"><span class="pre">/dev</span></code> directory are created using the
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> struct (<code class="docutils literal"><span class="pre">v4l2-dev.h</span></code>). This struct can either be
allocated dynamically or embedded in a larger struct.</p>
<p>To allocate it dynamically use <a class="reference internal" href="#c.video_device_alloc" title="video_device_alloc"><code class="xref c c-func docutils literal"><span class="pre">video_device_alloc()</span></code></a>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>

<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
</pre></div>
</div>
<p>If you embed it in a larger struct, then you must set the <code class="docutils literal"><span class="pre">release()</span></code>
callback to your own function:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_vdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>

<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">my_vdev_release</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">release()</span></code> callback must be set and it is called when the last user
of the video device exits.</p>
<p>The default <a class="reference internal" href="#c.video_device_release" title="video_device_release"><code class="xref c c-func docutils literal"><span class="pre">video_device_release()</span></code></a> callback currently
just calls <code class="docutils literal"><span class="pre">kfree</span></code> to free the allocated memory.</p>
<p>There is also a :<a class="reference internal" href="#c.video_device_release_empty" title="video_device_release_empty"><code class="xref c c-func docutils literal"><span class="pre">video_device_release_empty()</span></code></a> function that does
nothing (is empty) and should be used if the struct is embedded and there
is nothing to do when it is released.</p>
<p>You should also set these fields of <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>:</p>
<ul>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;v4l2_dev: must be set to the <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a>
parent device.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;name: set to something descriptive and unique.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;vfl_dir: set this to <code class="docutils literal"><span class="pre">VFL_DIR_RX</span></code> for capture
devices (<code class="docutils literal"><span class="pre">VFL_DIR_RX</span></code> has value 0, so this is normally already the
default), set to <code class="docutils literal"><span class="pre">VFL_DIR_TX</span></code> for output devices and <code class="docutils literal"><span class="pre">VFL_DIR_M2M</span></code> for mem2mem (codec) devices.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;fops: set to the <a class="reference internal" href="#c.v4l2_file_operations" title="v4l2_file_operations"><code class="xref c c-type docutils literal"><span class="pre">v4l2_file_operations</span></code></a>
struct.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;ioctl_ops: if you use the <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a>
to simplify ioctl maintenance (highly recommended to use this and it might
become compulsory in the future!), then set this to your
<a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a> struct. The <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;vfl_type and
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;vfl_dir fields are used to disable ops that do not
match the type/dir combination. E.g. VBI ops are disabled for non-VBI nodes,
and output ops  are disabled for a capture device. This makes it possible to
provide just one <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a> struct for both vbi and
video nodes.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;lock: leave to <code class="docutils literal"><span class="pre">NULL</span></code> if you want to do all the
locking  in the driver. Otherwise you give it a pointer to a struct
<code class="docutils literal"><span class="pre">mutex_lock</span></code> and before the <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;unlocked_ioctl
file operation is called this lock will be taken by the core and released
afterwards. See the next section for more details.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;queue: a pointer to the struct <a class="reference internal" href="v4l2-videobuf2.html#c.vb2_queue" title="vb2_queue"><code class="xref c c-type docutils literal"><span class="pre">vb2_queue</span></code></a>
associated with this device node.
If queue is not <code class="docutils literal"><span class="pre">NULL</span></code>, and queue-&gt;lock is not <code class="docutils literal"><span class="pre">NULL</span></code>, then queue-&gt;lock
is used for the queuing ioctls (<code class="docutils literal"><span class="pre">VIDIOC_REQBUFS</span></code>, <code class="docutils literal"><span class="pre">CREATE_BUFS</span></code>,
<code class="docutils literal"><span class="pre">QBUF</span></code>, <code class="docutils literal"><span class="pre">DQBUF</span></code>,  <code class="docutils literal"><span class="pre">QUERYBUF</span></code>, <code class="docutils literal"><span class="pre">PREPARE_BUF</span></code>, <code class="docutils literal"><span class="pre">STREAMON</span></code> and
<code class="docutils literal"><span class="pre">STREAMOFF</span></code>) instead of the lock above.
That way the <a class="reference internal" href="v4l2-videobuf2.html#vb2-framework"><span class="std std-ref">vb2</span></a> queuing framework does not have
to wait for other ioctls.   This queue pointer is also used by the
<a class="reference internal" href="v4l2-videobuf2.html#vb2-framework"><span class="std std-ref">vb2</span></a> helper functions to check for
queuing ownership (i.e. is the filehandle calling it allowed to do the
operation).</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;prio: keeps track of the priorities. Used to
implement <code class="docutils literal"><span class="pre">VIDIOC_G_PRIORITY</span></code> and <code class="docutils literal"><span class="pre">VIDIOC_S_PRIORITY</span></code>.
If left to <code class="docutils literal"><span class="pre">NULL</span></code>, then it will use the struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">v4l2_prio_state</span></code></a>
in <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a>. If you want to have a separate priority state per
(group of) device node(s),   then you can point it to your own struct
<a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">v4l2_prio_state</span></code></a>.</p>
</li>
<li><p class="first"><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;dev_parent: you only set this if v4l2_device was
registered with <code class="docutils literal"><span class="pre">NULL</span></code> as the parent <code class="docutils literal"><span class="pre">device</span></code> struct. This only happens
in cases where one hardware device has multiple PCI devices that all share
the same <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a> core.</p>
<p>The cx88 driver is an example of this: one core <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a> struct,
but   it is used by both a raw video PCI device (cx8800) and a MPEG PCI device
(cx8802). Since the <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a> cannot be associated with two PCI
devices at the same time it is setup without a parent device. But when the
struct <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> is initialized you <strong>do</strong> know which parent
PCI device to use and so you set <code class="docutils literal"><span class="pre">dev_device</span></code> to the correct PCI device.</p>
</li>
</ul>
<p>If you use <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a>, then you should set
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;unlocked_ioctl to <a class="reference internal" href="v4l2-common.html#c.video_ioctl2" title="video_ioctl2"><code class="xref c c-func docutils literal"><span class="pre">video_ioctl2()</span></code></a> in your
<a class="reference internal" href="#c.v4l2_file_operations" title="v4l2_file_operations"><code class="xref c c-type docutils literal"><span class="pre">v4l2_file_operations</span></code></a> struct.</p>
<p>In some cases you want to tell the core that a function you had specified in
your <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a> should be ignored. You can mark such ioctls by
calling this function before <a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a> is called:</p>
<blockquote>
<div><a class="reference internal" href="#c.v4l2_disable_ioctl" title="v4l2_disable_ioctl"><code class="xref c c-func docutils literal"><span class="pre">v4l2_disable_ioctl</span></code></a>
(<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">vdev</span></code></a>, cmd).</div></blockquote>
<p>This tends to be needed if based on external factors (e.g. which card is
being used) you want to turns off certain features in <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">v4l2_ioctl_ops</span></code></a>
without having to make a new struct.</p>
<p>The <a class="reference internal" href="#c.v4l2_file_operations" title="v4l2_file_operations"><code class="xref c c-type docutils literal"><span class="pre">v4l2_file_operations</span></code></a> struct is a subset of file_operations.
The main difference is that the inode argument is omitted since it is never
used.</p>
<p>If integration with the media framework is needed, you must initialize the
<a class="reference internal" href="mc-core.html#c.media_entity" title="media_entity"><code class="xref c c-type docutils literal"><span class="pre">media_entity</span></code></a> struct embedded in the <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> struct
(entity field) by calling <a class="reference internal" href="mc-core.html#c.media_entity_pads_init" title="media_entity_pads_init"><code class="xref c c-func docutils literal"><span class="pre">media_entity_pads_init()</span></code></a>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_vdev</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

<span class="n">err</span> <span class="o">=</span> <span class="n">media_entity_pads_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
</pre></div>
</div>
<p>The pads array must have been previously initialized. There is no need to
manually set the struct media_entity type and name fields.</p>
<p>A reference to the entity will be automatically acquired/released when the
video device is opened/closed.</p>
<div class="section" id="ioctls-and-locking">
<h2>1.4.1. ioctls and locking<a class="headerlink" href="#ioctls-and-locking" title="Permalink to this headline">¶</a></h2>
<p>The V4L core provides optional locking services. The main service is the
lock field in struct <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>, which is a pointer to a mutex.
If you set this pointer, then that will be used by unlocked_ioctl to
serialize all ioctls.</p>
<p>If you are using the <a class="reference internal" href="v4l2-videobuf2.html#vb2-framework"><span class="std std-ref">videobuf2 framework</span></a>, then there
is a second lock that you can set: <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;queue-&gt;lock. If
set, then this lock will be used instead of <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;lock
to serialize all queuing ioctls (see the previous section
for the full list of those ioctls).</p>
<p>The advantage of using a different lock for the queuing ioctls is that for some
drivers (particularly USB drivers) certain commands such as setting controls
can take a long time, so you want to use a separate lock for the buffer queuing
ioctls. That way your <code class="docutils literal"><span class="pre">VIDIOC_DQBUF</span></code> doesn&#8217;t stall because the driver is busy
changing the e.g. exposure of the webcam.</p>
<p>Of course, you can always do all the locking yourself by leaving both lock
pointers at <code class="docutils literal"><span class="pre">NULL</span></code>.</p>
<p>If you use the old <a class="reference internal" href="v4l2-videobuf.html#vb-framework"><span class="std std-ref">videobuf framework</span></a> then you must
pass the <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;lock to the videobuf queue initialize
function: if videobuf has to wait for a frame to arrive, then it will
temporarily unlock the lock and relock it afterwards. If your driver also
waits in the code, then you should do the same to allow other
processes to access the device node while the first process is waiting for
something.</p>
<p>In the case of <a class="reference internal" href="v4l2-videobuf2.html#vb2-framework"><span class="std std-ref">videobuf2</span></a> you will need to implement the
<code class="docutils literal"><span class="pre">wait_prepare()</span></code> and <code class="docutils literal"><span class="pre">wait_finish()</span></code> callbacks to unlock/lock if applicable.
If you use the <code class="docutils literal"><span class="pre">queue-&gt;lock</span></code> pointer, then you can use the helper functions
<a class="reference internal" href="v4l2-videobuf2.html#c.vb2_ops_wait_prepare" title="vb2_ops_wait_prepare"><code class="xref c c-func docutils literal"><span class="pre">vb2_ops_wait_prepare()</span></code></a> and <a class="reference internal" href="v4l2-videobuf2.html#c.vb2_ops_wait_finish" title="vb2_ops_wait_finish"><code class="xref c c-func docutils literal"><span class="pre">vb2_ops_wait_finish()</span></code></a>.</p>
<p>The implementation of a hotplug disconnect should also take the lock from
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> before calling v4l2_device_disconnect. If you are also
using <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;queue-&gt;lock, then you have to first lock
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;queue-&gt;lock followed by <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;lock.
That way you can be sure no ioctl is running when you call
<a class="reference internal" href="v4l2-device.html#c.v4l2_device_disconnect" title="v4l2_device_disconnect"><code class="xref c c-func docutils literal"><span class="pre">v4l2_device_disconnect()</span></code></a>.</p>
</div>
<div class="section" id="video-device-registration">
<h2>1.4.2. Video device registration<a class="headerlink" href="#video-device-registration" title="Permalink to this headline">¶</a></h2>
<p>Next you register the video device with <a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a>.
This will create the character device for you.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">video_device_release</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span> <span class="cm">/* or kfree(my_vdev); */</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If the <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">v4l2_device</span></code></a> parent device has a not <code class="docutils literal"><span class="pre">NULL</span></code> mdev field,
the video device entity will be automatically registered with the media
device.</p>
<p>Which device is registered depends on the type argument. The following
types exist:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">VFL_TYPE_GRABBER</span></code>: <code class="docutils literal"><span class="pre">/dev/videoX</span></code> for video input/output devices</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_VBI</span></code>: <code class="docutils literal"><span class="pre">/dev/vbiX</span></code> for vertical blank data (i.e. closed captions, teletext)</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_RADIO</span></code>: <code class="docutils literal"><span class="pre">/dev/radioX</span></code> for radio tuners</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_SDR</span></code>: <code class="docutils literal"><span class="pre">/dev/swradioX</span></code> for Software Defined Radio tuners</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_TOUCH</span></code>: <code class="docutils literal"><span class="pre">/dev/v4l-touchX</span></code> for touch sensors</li>
</ul>
<p>The last argument gives you a certain amount of control over the device
device node number used (i.e. the X in <code class="docutils literal"><span class="pre">videoX</span></code>). Normally you will pass -1
to let the v4l2 framework pick the first free number. But sometimes users
want to select a specific node number. It is common that drivers allow
the user to select a specific device node number through a driver module
option. That number is then passed to this function and video_register_device
will attempt to select that device node number. If that number was already
in use, then the next free device node number will be selected and it
will send a warning to the kernel log.</p>
<p>Another use-case is if a driver creates many devices. In that case it can
be useful to place different video devices in separate ranges. For example,
video capture devices start at 0, video output devices start at 16.
So you can use the last argument to specify a minimum device node number
and the v4l2 framework will try to pick the first free number that is equal
or higher to what you passed. If that fails, then it will just pick the
first free number.</p>
<p>Since in this case you do not care about a warning about not being able
to select the specified device node number, you can call the function
<a class="reference internal" href="#c.video_register_device_no_warn" title="video_register_device_no_warn"><code class="xref c c-func docutils literal"><span class="pre">video_register_device_no_warn()</span></code></a> instead.</p>
<p>Whenever a device node is created some attributes are also created for you.
If you look in <code class="docutils literal"><span class="pre">/sys/class/video4linux</span></code> you see the devices. Go into e.g.
<code class="docutils literal"><span class="pre">video0</span></code> and you will see &#8216;name&#8217;, &#8216;dev_debug&#8217; and &#8216;index&#8217; attributes. The
&#8216;name&#8217; attribute is the &#8216;name&#8217; field of the video_device struct. The
&#8216;dev_debug&#8217; attribute can be used to enable core debugging. See the next
section for more detailed information on this.</p>
<p>The &#8216;index&#8217; attribute is the index of the device node: for each call to
<a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a> the index is just increased by 1. The
first video device node you register always starts with index 0.</p>
<p>Users can setup udev rules that utilize the index attribute to make fancy
device names (e.g. &#8216;<code class="docutils literal"><span class="pre">mpegX</span></code>&#8216; for MPEG video capture device nodes).</p>
<p>After the device was successfully registered, then you can use these fields:</p>
<ul class="simple">
<li><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;vfl_type: the device type passed to
<a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a>.</li>
<li><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;minor: the assigned device minor number.</li>
<li><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;num: the device node number (i.e. the X in
<code class="docutils literal"><span class="pre">videoX</span></code>).</li>
<li><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>-&gt;index: the device index number.</li>
</ul>
<p>If the registration failed, then you need to call
<a class="reference internal" href="#c.video_device_release" title="video_device_release"><code class="xref c c-func docutils literal"><span class="pre">video_device_release()</span></code></a> to free the allocated <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a>
struct, or free your own struct if the <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> was embedded in
it. The <code class="docutils literal"><span class="pre">vdev-&gt;release()</span></code> callback will never be called if the registration
failed, nor should you ever attempt to unregister the device if the
registration failed.</p>
</div>
<div class="section" id="video-device-debugging">
<h2>1.4.3. video device debugging<a class="headerlink" href="#video-device-debugging" title="Permalink to this headline">¶</a></h2>
<p>The &#8216;dev_debug&#8217; attribute that is created for each video, vbi, radio or swradio
device in <code class="docutils literal"><span class="pre">/sys/class/video4linux/&lt;devX&gt;/</span></code> allows you to enable logging of
file operations.</p>
<p>It is a bitmask and the following bits can be set:</p>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="93%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Mask</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x01</td>
<td>Log the ioctl name and error code. VIDIOC_(D)QBUF ioctls are
only logged if bit 0x08 is also set.</td>
</tr>
<tr class="row-odd"><td>0x02</td>
<td>Log the ioctl name arguments and error code. VIDIOC_(D)QBUF
ioctls are
only logged if bit 0x08 is also set.</td>
</tr>
<tr class="row-even"><td>0x04</td>
<td>Log the file operations open, release, read, write, mmap and
get_unmapped_area. The read and write operations are only
logged if bit 0x08 is also set.</td>
</tr>
<tr class="row-odd"><td>0x08</td>
<td>Log the read and write file operations and the VIDIOC_QBUF and
VIDIOC_DQBUF ioctls.</td>
</tr>
<tr class="row-even"><td>0x10</td>
<td>Log the poll file operation.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="video-device-cleanup">
<h2>1.4.4. Video device cleanup<a class="headerlink" href="#video-device-cleanup" title="Permalink to this headline">¶</a></h2>
<p>When the video device nodes have to be removed, either during the unload
of the driver or because the USB device was disconnected, then you should
unregister them with:</p>
<blockquote>
<div><a class="reference internal" href="#c.video_unregister_device" title="video_unregister_device"><code class="xref c c-func docutils literal"><span class="pre">video_unregister_device()</span></code></a>
(<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">vdev</span></code></a>);</div></blockquote>
<p>This will remove the device nodes from sysfs (causing udev to remove them
from <code class="docutils literal"><span class="pre">/dev</span></code>).</p>
<p>After <a class="reference internal" href="#c.video_unregister_device" title="video_unregister_device"><code class="xref c c-func docutils literal"><span class="pre">video_unregister_device()</span></code></a> returns no new opens can be done.
However, in the case of USB devices some application might still have one of
these device nodes open. So after the unregister all file operations (except
release, of course) will return an error as well.</p>
<p>When the last user of the video device node exits, then the <code class="docutils literal"><span class="pre">vdev-&gt;release()</span></code>
callback is called and you can do the final cleanup there.</p>
<p>Don&#8217;t forget to cleanup the media entity associated with the video device if
it has been initialized:</p>
<blockquote>
<div><a class="reference internal" href="mc-core.html#c.media_entity_cleanup" title="media_entity_cleanup"><code class="xref c c-func docutils literal"><span class="pre">media_entity_cleanup</span></code></a>
(&amp;vdev-&gt;entity);</div></blockquote>
<p>This can be done from the release callback.</p>
</div>
<div class="section" id="helper-functions">
<h2>1.4.5. helper functions<a class="headerlink" href="#helper-functions" title="Permalink to this headline">¶</a></h2>
<p>There are a few useful helper functions:</p>
<ul class="simple">
<li>file and <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> private data</li>
</ul>
<p>You can set/get driver private data in the video_device struct using:</p>
<blockquote>
<div><p><a class="reference internal" href="#c.video_get_drvdata" title="video_get_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_get_drvdata</span></code></a>
(<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">vdev</span></code></a>);</p>
<p><a class="reference internal" href="#c.video_set_drvdata" title="video_set_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_set_drvdata</span></code></a>
(<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">vdev</span></code></a>);</p>
</div></blockquote>
<p>Note that you can safely call <a class="reference internal" href="#c.video_set_drvdata" title="video_set_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_set_drvdata()</span></code></a> before calling
<a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a>.</p>
<p>And this function:</p>
<blockquote>
<div><a class="reference internal" href="#c.video_devdata" title="video_devdata"><code class="xref c c-func docutils literal"><span class="pre">video_devdata</span></code></a>
(struct file *file);</div></blockquote>
<p>returns the video_device belonging to the file struct.</p>
<p>The <a class="reference internal" href="#c.video_devdata" title="video_devdata"><code class="xref c c-func docutils literal"><span class="pre">video_devdata()</span></code></a> function combines <a class="reference internal" href="#c.video_get_drvdata" title="video_get_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_get_drvdata()</span></code></a>
with <a class="reference internal" href="#c.video_devdata" title="video_devdata"><code class="xref c c-func docutils literal"><span class="pre">video_devdata()</span></code></a>:</p>
<blockquote>
<div><a class="reference internal" href="#c.video_drvdata" title="video_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_drvdata</span></code></a>
(struct file *file);</div></blockquote>
<p>You can go from a <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> struct to the v4l2_device struct using:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li>Device node name</li>
</ul>
<p>The <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">video_device</span></code></a> node kernel name can be retrieved using:</p>
<blockquote>
<div><a class="reference internal" href="#c.video_device_node_name" title="video_device_node_name"><code class="xref c c-func docutils literal"><span class="pre">video_device_node_name</span></code></a>
(<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">vdev</span></code></a>);</div></blockquote>
<p>The name is used as a hint by userspace tools such as udev. The function
should be used where possible instead of accessing the video_device::num and
video_device::minor fields.</p>
</div>
<div class="section" id="video-device-functions-and-data-structures">
<h2>1.4.6. video_device functions and data structures<a class="headerlink" href="#video-device-functions-and-data-structures" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.v4l2_prio_state">
struct <code class="descname">v4l2_prio_state</code><a class="headerlink" href="#c.v4l2_prio_state" title="Permalink to this definition">¶</a></dt>
<dd><p>stores the priority states</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct v4l2_prio_state {
  atomic_t prios;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">prios</span></code></dt>
<dd>array with elements to store the array priorities</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The size of <strong>prios</strong> array matches the number of priority types defined
by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a>.</p>
</div>
<dl class="function">
<dt id="c.v4l2_prio_init">
void <code class="descname">v4l2_prio_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_init" title="Permalink to this definition">¶</a></dt>
<dd><p>initializes a struct v4l2_prio_state</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a></dd>
</dl>
<dl class="function">
<dt id="c.v4l2_prio_change">
int <code class="descname">v4l2_prio_change</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em>, enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a> *<em>&nbsp;local</em>, enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a><em>&nbsp;new</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_change" title="Permalink to this definition">¶</a></dt>
<dd><p>changes the v4l2 file handler priority</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to the <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> of the device node.</dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">v4l2_priority</span> <span class="pre">*</span> <span class="pre">local</span></code></dt>
<dd>pointer to the desired priority, as defined by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">v4l2_priority</span> <span class="pre">new</span></code></dt>
<dd>Priority type requested, as defined by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a>.</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function should be used only by the V4L2 core.</p>
</div>
<dl class="function">
<dt id="c.v4l2_prio_open">
void <code class="descname">v4l2_prio_open</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em>, enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a> *<em>&nbsp;local</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_open" title="Permalink to this definition">¶</a></dt>
<dd><p>Implements the priority logic for a file handler open</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to the <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> of the device node.</dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">v4l2_priority</span> <span class="pre">*</span> <span class="pre">local</span></code></dt>
<dd>pointer to the desired priority, as defined by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function should be used only by the V4L2 core.</p>
</div>
<dl class="function">
<dt id="c.v4l2_prio_close">
void <code class="descname">v4l2_prio_close</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em>, enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a><em>&nbsp;local</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_close" title="Permalink to this definition">¶</a></dt>
<dd><p>Implements the priority logic for a file handler close</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to the <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> of the device node.</dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">v4l2_priority</span> <span class="pre">local</span></code></dt>
<dd>priority to be released, as defined by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function should be used only by the V4L2 core.</p>
</div>
<dl class="function">
<dt id="c.v4l2_prio_max">
enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a> <code class="descname">v4l2_prio_max</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_max" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the maximum priority, as stored at the <strong>global</strong> array.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to the <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> of the device node.</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function should be used only by the V4L2 core.</p>
</div>
<dl class="function">
<dt id="c.v4l2_prio_check">
int <code class="descname">v4l2_prio_check</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state">v4l2_prio_state</a> *<em>&nbsp;global</em>, enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority">v4l2_priority</a><em>&nbsp;local</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_prio_check" title="Permalink to this definition">¶</a></dt>
<dd><p>Implements the priority logic for a file handler close</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span> <span class="pre">*</span> <span class="pre">global</span></code></dt>
<dd>pointer to the <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> of the device node.</dd>
<dt><code class="docutils literal"><span class="pre">enum</span> <span class="pre">v4l2_priority</span> <span class="pre">local</span></code></dt>
<dd>desired priority, as defined by enum <a class="reference internal" href="../uapi/v4l/vidioc-g-priority.html#c.v4l2_priority" title="v4l2_priority"><code class="xref c c-type docutils literal"><span class="pre">v4l2_priority</span></code></a> local</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function should be used only by the V4L2 core.</p>
</div>
<dl class="type">
<dt id="c.v4l2_file_operations">
struct <code class="descname">v4l2_file_operations</code><a class="headerlink" href="#c.v4l2_file_operations" title="Permalink to this definition">¶</a></dt>
<dd><p>fs operations used by a V4L2 device</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct v4l2_file_operations {
  struct module * owner;
  ssize_t (* read) (struct file *, char __user *, size_t, loff_t *);
  ssize_t (* write) (struct file *, const char __user *, size_t, loff_t *);
  unsigned int (* poll) (struct file *, struct poll_table_struct *);
  long (* unlocked_ioctl) (struct file *, unsigned int, unsigned long);
#ifdef CONFIG_COMPAT
  long (* compat_ioctl32) (struct file *, unsigned int, unsigned long);
#endif
  unsigned long (* get_unmapped_area) (struct file *, unsigned long,unsigned long, unsigned long, unsigned long);
  int (* mmap) (struct file *, struct vm_area_struct *);
  int (* open) (struct file *);
  int (* release) (struct file *);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">owner</span></code></dt>
<dd>pointer to struct module</dd>
<dt><code class="docutils literal"><span class="pre">read</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">read()</span></code> syscall</dd>
<dt><code class="docutils literal"><span class="pre">write</span></code></dt>
<dd>operations needed to implement the <a class="reference internal" href="../uapi/dvb/video-fwrite.html#c.write" title="write"><code class="xref c c-func docutils literal"><span class="pre">write()</span></code></a> syscall</dd>
<dt><code class="docutils literal"><span class="pre">poll</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">poll()</span></code> syscall</dd>
<dt><code class="docutils literal"><span class="pre">unlocked_ioctl</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">ioctl()</span></code> syscall</dd>
<dt><code class="docutils literal"><span class="pre">compat_ioctl32</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">ioctl()</span></code> syscall for
the special case where the Kernel uses 64 bits instructions, but
the userspace uses 32 bits.</dd>
<dt><code class="docutils literal"><span class="pre">get_unmapped_area</span></code></dt>
<dd>called by the <code class="xref c c-func docutils literal"><span class="pre">mmap()</span></code> syscall, used when %!CONFIG_MMU</dd>
<dt><code class="docutils literal"><span class="pre">mmap</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">mmap()</span></code> syscall</dd>
<dt><code class="docutils literal"><span class="pre">open</span></code></dt>
<dd>operations needed to implement the <a class="reference internal" href="../uapi/dvb/video-fopen.html#c.open" title="open"><code class="xref c c-func docutils literal"><span class="pre">open()</span></code></a> syscall</dd>
<dt><code class="docutils literal"><span class="pre">release</span></code></dt>
<dd>operations needed to implement the <code class="xref c c-func docutils literal"><span class="pre">release()</span></code> syscall</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Those operations are used to implemente the fs struct file_operations
at the V4L2 drivers. The V4L2 core overrides the fs ops with some
extra logic needed by the subsystem.</p>
</div>
<dl class="type">
<dt id="c.video_device">
struct <code class="descname">video_device</code><a class="headerlink" href="#c.video_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Structure used to create and manage the V4L2 device nodes.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct video_device {
#if defined(CONFIG_MEDIA_CONTROLLER
  struct media_entity entity;
  struct media_intf_devnode * intf_devnode;
  struct media_pipeline pipe;
#endif
  const struct v4l2_file_operations * fops;
  u32 device_caps;
  struct device dev;
  struct cdev * cdev;
  struct v4l2_device * v4l2_dev;
  struct device * dev_parent;
  struct v4l2_ctrl_handler * ctrl_handler;
  struct vb2_queue * queue;
  struct v4l2_prio_state * prio;
  char name;
  int vfl_type;
  int vfl_dir;
  int minor;
  u16 num;
  unsigned long flags;
  int index;
  spinlock_t fh_lock;
  struct list_head fh_list;
  int dev_debug;
  v4l2_std_id tvnorms;
  void (* release) (struct video_device *vdev);
  const struct v4l2_ioctl_ops * ioctl_ops;
  unsigned long valid_ioctls;
  unsigned long disable_locking;
  struct mutex * lock;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">entity</span></code></dt>
<dd><a class="reference internal" href="mc-core.html#c.media_entity" title="media_entity"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">media_entity</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">intf_devnode</span></code></dt>
<dd>pointer to <a class="reference internal" href="mc-core.html#c.media_intf_devnode" title="media_intf_devnode"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">media_intf_devnode</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">pipe</span></code></dt>
<dd><a class="reference internal" href="mc-core.html#c.media_pipeline" title="media_pipeline"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">media_pipeline</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">fops</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.v4l2_file_operations" title="v4l2_file_operations"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_file_operations</span></code></a> for the video device</dd>
<dt><code class="docutils literal"><span class="pre">device_caps</span></code></dt>
<dd>device capabilities as used in v4l2_capabilities</dd>
<dt><code class="docutils literal"><span class="pre">dev</span></code></dt>
<dd><a class="reference internal" href="../../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">device</span></code></a> for the video device</dd>
<dt><code class="docutils literal"><span class="pre">cdev</span></code></dt>
<dd>character device</dd>
<dt><code class="docutils literal"><span class="pre">v4l2_dev</span></code></dt>
<dd>pointer to <a class="reference internal" href="v4l2-device.html#c.v4l2_device" title="v4l2_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_device</span></code></a> parent</dd>
<dt><code class="docutils literal"><span class="pre">dev_parent</span></code></dt>
<dd>pointer to <a class="reference internal" href="../../driver-api/infrastructure.html#c.device" title="device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">device</span></code></a> parent</dd>
<dt><code class="docutils literal"><span class="pre">ctrl_handler</span></code></dt>
<dd>Control handler associated with this device node.
May be NULL.</dd>
<dt><code class="docutils literal"><span class="pre">queue</span></code></dt>
<dd><a class="reference internal" href="v4l2-videobuf2.html#c.vb2_queue" title="vb2_queue"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">vb2_queue</span></code></a> associated with this device node. May be NULL.</dd>
<dt><code class="docutils literal"><span class="pre">prio</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.v4l2_prio_state" title="v4l2_prio_state"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_prio_state</span></code></a> with device&#8217;s Priority state.
If NULL, then v4l2_dev-&gt;prio will be used.</dd>
<dt><code class="docutils literal"><span class="pre">name</span></code></dt>
<dd>video device name</dd>
<dt><code class="docutils literal"><span class="pre">vfl_type</span></code></dt>
<dd>V4L device type</dd>
<dt><code class="docutils literal"><span class="pre">vfl_dir</span></code></dt>
<dd>V4L receiver, transmitter or m2m</dd>
<dt><code class="docutils literal"><span class="pre">minor</span></code></dt>
<dd>device node &#8216;minor&#8217;. It is set to -1 if the registration failed</dd>
<dt><code class="docutils literal"><span class="pre">num</span></code></dt>
<dd>number of the video device node</dd>
<dt><code class="docutils literal"><span class="pre">flags</span></code></dt>
<dd>video device flags. Use bitops to set/clear/test flags</dd>
<dt><code class="docutils literal"><span class="pre">index</span></code></dt>
<dd>attribute to differentiate multiple indices on one physical device</dd>
<dt><code class="docutils literal"><span class="pre">fh_lock</span></code></dt>
<dd>Lock for all v4l2_fhs</dd>
<dt><code class="docutils literal"><span class="pre">fh_list</span></code></dt>
<dd>List of <a class="reference internal" href="v4l2-fh.html#c.v4l2_fh" title="v4l2_fh"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_fh</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">dev_debug</span></code></dt>
<dd>Internal device debug flags, not for use by drivers</dd>
<dt><code class="docutils literal"><span class="pre">tvnorms</span></code></dt>
<dd>Supported tv norms</dd>
<dt><code class="docutils literal"><span class="pre">release</span></code></dt>
<dd>video device <code class="xref c c-func docutils literal"><span class="pre">release()</span></code> callback</dd>
<dt><code class="docutils literal"><span class="pre">ioctl_ops</span></code></dt>
<dd>pointer to <a class="reference internal" href="v4l2-common.html#c.v4l2_ioctl_ops" title="v4l2_ioctl_ops"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">v4l2_ioctl_ops</span></code></a> with ioctl callbacks</dd>
<dt><code class="docutils literal"><span class="pre">valid_ioctls</span></code></dt>
<dd>bitmap with the valid ioctls for this device</dd>
<dt><code class="docutils literal"><span class="pre">disable_locking</span></code></dt>
<dd>bitmap with the ioctls that don&#8217;t require locking</dd>
<dt><code class="docutils literal"><span class="pre">lock</span></code></dt>
<dd>pointer to <code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">mutex</span></code> serialization lock</dd>
</dl>
<p><strong>Description</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Only set <strong>dev_parent</strong> if that can&#8217;t be deduced from <strong>v4l2_dev</strong>.</p>
</div>
<dl class="function">
<dt id="c.__video_register_device">
int <code class="descname">__video_register_device</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em>, int<em>&nbsp;type</em>, int<em>&nbsp;nr</em>, int<em>&nbsp;warn_if_nr_in_use</em>, struct module *<em>&nbsp;owner</em><span class="sig-paren">)</span><a class="headerlink" href="#c.__video_register_device" title="Permalink to this definition">¶</a></dt>
<dd><p>register video4linux devices</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>struct video_device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">type</span></code></dt>
<dd>type of device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">nr</span></code></dt>
<dd>which device node number is desired:
(0 == /dev/video0, 1 == /dev/video1, ..., -1 == first free)</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">warn_if_nr_in_use</span></code></dt>
<dd>warn if the desired device node number
was already in use and another number was chosen instead.</dd>
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">module</span> <span class="pre">*</span> <span class="pre">owner</span></code></dt>
<dd>module that owns the video device node</dd>
</dl>
<p><strong>Description</strong></p>
<p>The registration code assigns minor numbers and device node numbers
based on the requested type and registers the new device node with
the kernel.</p>
<p>This function assumes that struct video_device was zeroed when it
was allocated and does not contain any stale date.</p>
<p>An error is returned if no free minor or device node number could be
found, or if the registration of the device node failed.</p>
<p>Returns 0 on success.</p>
<p>Valid values for <strong>type</strong> are:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">VFL_TYPE_GRABBER</span></code> - A frame grabber</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_VBI</span></code> - Vertical blank data (undecoded)</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_RADIO</span></code> - A radio card</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_SUBDEV</span></code> - A subdevice</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_SDR</span></code> - Software Defined Radio</li>
<li><code class="docutils literal"><span class="pre">VFL_TYPE_TOUCH</span></code> - A touch sensor</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This function is meant to be used only inside the V4L2 core.
Drivers should use <a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a> or
<a class="reference internal" href="#c.video_register_device_no_warn" title="video_register_device_no_warn"><code class="xref c c-func docutils literal"><span class="pre">video_register_device_no_warn()</span></code></a>.</p>
</div>
<dl class="function">
<dt id="c.video_register_device">
int <code class="descname">video_register_device</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em>, int<em>&nbsp;type</em>, int<em>&nbsp;nr</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_register_device" title="Permalink to this definition">¶</a></dt>
<dd><p>register video4linux devices</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>struct video_device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">type</span></code></dt>
<dd>type of device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">nr</span></code></dt>
<dd>which device node number is desired:
(0 == /dev/video0, 1 == /dev/video1, ..., -1 == first free)</dd>
</dl>
<p><strong>Description</strong></p>
<p>Internally, it calls <a class="reference internal" href="#c.__video_register_device" title="__video_register_device"><code class="xref c c-func docutils literal"><span class="pre">__video_register_device()</span></code></a>. Please see its
documentation for more details.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">if video_register_device fails, the <code class="xref c c-func docutils literal"><span class="pre">release()</span></code> callback of
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> structure is <em>not</em> called, so the caller
is responsible for freeing any data. Usually that means that
you <a class="reference internal" href="#c.video_device_release" title="video_device_release"><code class="xref c c-func docutils literal"><span class="pre">video_device_release()</span></code></a> should be called on failure.</p>
</div>
<dl class="function">
<dt id="c.video_register_device_no_warn">
int <code class="descname">video_register_device_no_warn</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em>, int<em>&nbsp;type</em>, int<em>&nbsp;nr</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_register_device_no_warn" title="Permalink to this definition">¶</a></dt>
<dd><p>register video4linux devices</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>struct video_device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">type</span></code></dt>
<dd>type of device to register</dd>
<dt><code class="docutils literal"><span class="pre">int</span> <span class="pre">nr</span></code></dt>
<dd>which device node number is desired:
(0 == /dev/video0, 1 == /dev/video1, ..., -1 == first free)</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function is identical to <a class="reference internal" href="#c.video_register_device" title="video_register_device"><code class="xref c c-func docutils literal"><span class="pre">video_register_device()</span></code></a> except that no
warning is issued if the desired device node number was already in use.</p>
<p>Internally, it calls <a class="reference internal" href="#c.__video_register_device" title="__video_register_device"><code class="xref c c-func docutils literal"><span class="pre">__video_register_device()</span></code></a>. Please see its
documentation for more details.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">if video_register_device fails, the <code class="xref c c-func docutils literal"><span class="pre">release()</span></code> callback of
<a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> structure is <em>not</em> called, so the caller
is responsible for freeing any data. Usually that means that
you <a class="reference internal" href="#c.video_device_release" title="video_device_release"><code class="xref c c-func docutils literal"><span class="pre">video_device_release()</span></code></a> should be called on failure.</p>
</div>
<dl class="function">
<dt id="c.video_unregister_device">
void <code class="descname">video_unregister_device</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_unregister_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Unregister video devices.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd><a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> to register</dd>
</dl>
<p><strong>Description</strong></p>
<p>Does nothing if vdev == NULL or if <a class="reference internal" href="#c.video_is_registered" title="video_is_registered"><code class="xref c c-func docutils literal"><span class="pre">video_is_registered()</span></code></a> returns false.</p>
<dl class="function">
<dt id="c.video_device_alloc">
struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> * <code class="descname">video_device_alloc</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.video_device_alloc" title="Permalink to this definition">¶</a></dt>
<dd><p>helper function to alloc <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns NULL if <code class="docutils literal"><span class="pre">-ENOMEM</span></code> or a <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> on success.</p>
<dl class="function">
<dt id="c.video_device_release">
void <code class="descname">video_device_release</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_device_release" title="Permalink to this definition">¶</a></dt>
<dd><p>helper function to release <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<p>Can also be used for video_device-&gt;release().</p>
<dl class="function">
<dt id="c.video_device_release_empty">
void <code class="descname">video_device_release_empty</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_device_release_empty" title="Permalink to this definition">¶</a></dt>
<dd><p>helper function to implement the video_device-&gt;release() callback.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<p>This release function does nothing.</p>
<p>It should be used when the video_device is a static global struct.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Having a static video_device is a dubious construction at best.</p>
</div>
<dl class="function">
<dt id="c.v4l2_is_known_ioctl">
bool <code class="descname">v4l2_is_known_ioctl</code><span class="sig-paren">(</span>unsigned int<em>&nbsp;cmd</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_is_known_ioctl" title="Permalink to this definition">¶</a></dt>
<dd><p>Checks if a given cmd is a known V4L ioctl</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">cmd</span></code></dt>
<dd>ioctl command</dd>
</dl>
<p><strong>Description</strong></p>
<p>returns true if cmd is a known V4L2 ioctl</p>
<dl class="function">
<dt id="c.v4l2_disable_ioctl">
void <code class="descname">v4l2_disable_ioctl</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em>, unsigned int<em>&nbsp;cmd</em><span class="sig-paren">)</span><a class="headerlink" href="#c.v4l2_disable_ioctl" title="Permalink to this definition">¶</a></dt>
<dd><p>mark that a given command isn&#8217;t implemented. shouldn&#8217;t use core locking</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">cmd</span></code></dt>
<dd>ioctl command</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function allows drivers to provide just one v4l2_ioctl_ops struct, but
disable ioctls based on the specific card that is actually found.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This must be called before video_register_device.
See also the comments for <code class="xref c c-func docutils literal"><span class="pre">determine_valid_ioctls()</span></code>.</p>
</div>
<dl class="function">
<dt id="c.video_get_drvdata">
void * <code class="descname">video_get_drvdata</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_get_drvdata" title="Permalink to this definition">¶</a></dt>
<dd><p>gets private data from <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a>.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<p>returns a pointer to the private data</p>
<dl class="function">
<dt id="c.video_set_drvdata">
void <code class="descname">video_set_drvdata</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em>, void *<em>&nbsp;data</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_set_drvdata" title="Permalink to this definition">¶</a></dt>
<dd><p>sets private data from <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a>.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
<dt><code class="docutils literal"><span class="pre">void</span> <span class="pre">*</span> <span class="pre">data</span></code></dt>
<dd>private data pointer</dd>
</dl>
<dl class="function">
<dt id="c.video_devdata">
struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> * <code class="descname">video_devdata</code><span class="sig-paren">(</span>struct file *<em>&nbsp;file</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_devdata" title="Permalink to this definition">¶</a></dt>
<dd><p>gets <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> from struct file.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*</span> <span class="pre">file</span></code></dt>
<dd>pointer to struct file</dd>
</dl>
<dl class="function">
<dt id="c.video_drvdata">
void * <code class="descname">video_drvdata</code><span class="sig-paren">(</span>struct file *<em>&nbsp;file</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_drvdata" title="Permalink to this definition">¶</a></dt>
<dd><p>gets private data from <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> using the struct file.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">file</span> <span class="pre">*</span> <span class="pre">file</span></code></dt>
<dd>pointer to struct file</dd>
</dl>
<p><strong>Description</strong></p>
<p>This is function combines both <a class="reference internal" href="#c.video_get_drvdata" title="video_get_drvdata"><code class="xref c c-func docutils literal"><span class="pre">video_get_drvdata()</span></code></a> and <a class="reference internal" href="#c.video_devdata" title="video_devdata"><code class="xref c c-func docutils literal"><span class="pre">video_devdata()</span></code></a>
as this is used very often.</p>
<dl class="function">
<dt id="c.video_device_node_name">
const char * <code class="descname">video_device_node_name</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_device_node_name" title="Permalink to this definition">¶</a></dt>
<dd><p>returns the video device name</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns the device name string</p>
<dl class="function">
<dt id="c.video_is_registered">
int <code class="descname">video_is_registered</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.video_device" title="video_device">video_device</a> *<em>&nbsp;vdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.video_is_registered" title="Permalink to this definition">¶</a></dt>
<dd><p>returns true if the <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a> is registered.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span> <span class="pre">*</span> <span class="pre">vdev</span></code></dt>
<dd>pointer to <a class="reference internal" href="#c.video_device" title="video_device"><code class="xref c c-type docutils literal"><span class="pre">struct</span> <span class="pre">video_device</span></code></a></dd>
</dl>
<p><strong>Description</strong></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="v4l2-device.html" class="btn btn-neutral float-right" title="1.5. V4L2 device instance" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="v4l2-intro.html" class="btn btn-neutral" title="1.1. Introduction" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.13.0-rc5+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>