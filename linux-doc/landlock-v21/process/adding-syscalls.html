

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Adding a New System Call &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linux magic numbers" href="magic-number.html" />
    <link rel="prev" title="Applying Patches To The Linux Kernel" href="applying-patches.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.9.0-rc8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Working with the kernel development community</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="license-rules.html">Linux kernel licensing rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="howto.html">HOWTO do Linux kernel development</a></li>
<li class="toctree-l2"><a class="reference internal" href="code-of-conduct.html">Contributor Covenant Code of Conduct</a></li>
<li class="toctree-l2"><a class="reference internal" href="code-of-conduct-interpretation.html">Linux Kernel Contributor Covenant Code of Conduct Interpretation</a></li>
<li class="toctree-l2"><a class="reference internal" href="development-process.html">A guide to the Kernel Development Process</a></li>
<li class="toctree-l2"><a class="reference internal" href="submitting-patches.html">Submitting patches: the essential guide to getting your code into the kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="programming-language.html">Programming Language</a></li>
<li class="toctree-l2"><a class="reference internal" href="coding-style.html">Linux kernel coding style</a></li>
<li class="toctree-l2"><a class="reference internal" href="maintainer-pgp-guide.html">Kernel Maintainer PGP guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="email-clients.html">Email clients info for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-enforcement-statement.html">Linux Kernel Enforcement Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-driver-statement.html">Kernel Driver Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="changes.html">Minimal requirements to compile the Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="submitting-drivers.html">Submitting Drivers For The Linux Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="stable-api-nonsense.html">The Linux Kernel Driver Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="management-style.html">Linux kernel management style</a></li>
<li class="toctree-l2"><a class="reference internal" href="stable-kernel-rules.html">Everything you ever wanted to know about Linux -stable releases</a></li>
<li class="toctree-l2"><a class="reference internal" href="submit-checklist.html">Linux Kernel patch submission checklist</a></li>
<li class="toctree-l2"><a class="reference internal" href="kernel-docs.html">Index of Documentation for People Interested in Writing and/or Understanding the Linux Kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="deprecated.html">Deprecated Interfaces, Language Features, Attributes, and Conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="embargoed-hardware-issues.html">Embargoed hardware issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="maintainers.html">List of maintainers and how to submit kernel changes</a></li>
<li class="toctree-l2"><a class="reference internal" href="applying-patches.html">Applying Patches To The Linux Kernel</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Adding a New System Call</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#system-call-alternatives">System Call Alternatives</a></li>
<li class="toctree-l3"><a class="reference internal" href="#designing-the-api-planning-for-extension">Designing the API: Planning for Extension</a></li>
<li class="toctree-l3"><a class="reference internal" href="#designing-the-api-other-considerations">Designing the API: Other Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#proposing-the-api">Proposing the API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-system-call-implementation">Generic System Call Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#x86-system-call-implementation">x86 System Call Implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compatibility-system-calls-generic">Compatibility System Calls (Generic)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compatibility-system-calls-x86">Compatibility System Calls (x86)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#system-calls-returning-elsewhere">System Calls Returning Elsewhere</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-details">Other Details</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#man-page">Man Page</a></li>
<li class="toctree-l3"><a class="reference internal" href="#do-not-call-system-calls-in-the-kernel">Do not call System Calls in the Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#references-and-sources">References and Sources</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="magic-number.html">Linux magic numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="volatile-considered-harmful.html">Why the “volatile” type class should not be used</a></li>
<li class="toctree-l2"><a class="reference internal" href="botching-up-ioctls.html">(How to avoid) Botching up ioctls</a></li>
<li class="toctree-l2"><a class="reference internal" href="clang-format.html">clang-format</a></li>
<li class="toctree-l2"><a class="reference internal" href="../riscv/patch-acceptance.html">arch/riscv maintenance guidelines for developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../core-api/unaligned-memory-access.html">Unaligned Memory Accesses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Working with the kernel development community</a> &raquo;</li>
        
      <li>Adding a New System Call</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/process/adding-syscalls.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="adding-a-new-system-call">
<span id="addsyscalls"></span><h1>Adding a New System Call<a class="headerlink" href="#adding-a-new-system-call" title="Permalink to this headline">¶</a></h1>
<p>This document describes what’s involved in adding a new system call to the
Linux kernel, over and above the normal submission advice in
<a class="reference internal" href="submitting-patches.html#submittingpatches"><span class="std std-ref">Documentation/process/submitting-patches.rst</span></a>.</p>
<div class="section" id="system-call-alternatives">
<h2>System Call Alternatives<a class="headerlink" href="#system-call-alternatives" title="Permalink to this headline">¶</a></h2>
<p>The first thing to consider when adding a new system call is whether one of
the alternatives might be suitable instead.  Although system calls are the
most traditional and most obvious interaction points between userspace and the
kernel, there are other possibilities – choose what fits best for your
interface.</p>
<blockquote>
<div><ul>
<li><p class="first">If the operations involved can be made to look like a filesystem-like
object, it may make more sense to create a new filesystem or device.  This
also makes it easier to encapsulate the new functionality in a kernel module
rather than requiring it to be built into the main kernel.</p>
<blockquote>
<div><ul class="simple">
<li>If the new functionality involves operations where the kernel notifies
userspace that something has happened, then returning a new file
descriptor for the relevant object allows userspace to use
<code class="docutils literal notranslate"><span class="pre">poll</span></code>/<code class="docutils literal notranslate"><span class="pre">select</span></code>/<code class="docutils literal notranslate"><span class="pre">epoll</span></code> to receive that notification.</li>
<li>However, operations that don’t map to
<em class="manpage">read(2)</em>/<em class="manpage">write(2)</em>-like operations
have to be implemented as <em class="manpage">ioctl(2)</em> requests, which can lead
to a somewhat opaque API.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">If you’re just exposing runtime system information, a new node in sysfs
(see <code class="docutils literal notranslate"><span class="pre">Documentation/filesystems/sysfs.rst</span></code>) or the <code class="docutils literal notranslate"><span class="pre">/proc</span></code> filesystem may
be more appropriate.  However, access to these mechanisms requires that the
relevant filesystem is mounted, which might not always be the case (e.g.
in a namespaced/sandboxed/chrooted environment).  Avoid adding any API to
debugfs, as this is not considered a ‘production’ interface to userspace.</p>
</li>
<li><p class="first">If the operation is specific to a particular file or file descriptor, then
an additional <em class="manpage">fcntl(2)</em> command option may be more appropriate.  However,
<em class="manpage">fcntl(2)</em> is a multiplexing system call that hides a lot of complexity, so
this option is best for when the new function is closely analogous to
existing <em class="manpage">fcntl(2)</em> functionality, or the new functionality is very simple
(for example, getting/setting a simple flag related to a file descriptor).</p>
</li>
<li><p class="first">If the operation is specific to a particular task or process, then an
additional <em class="manpage">prctl(2)</em> command option may be more appropriate.  As
with <em class="manpage">fcntl(2)</em>, this system call is a complicated multiplexor so
is best reserved for near-analogs of existing <code class="docutils literal notranslate"><span class="pre">prctl()</span></code> commands or
getting/setting a simple flag related to a process.</p>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="designing-the-api-planning-for-extension">
<h2>Designing the API: Planning for Extension<a class="headerlink" href="#designing-the-api-planning-for-extension" title="Permalink to this headline">¶</a></h2>
<p>A new system call forms part of the API of the kernel, and has to be supported
indefinitely.  As such, it’s a very good idea to explicitly discuss the
interface on the kernel mailing list, and it’s important to plan for future
extensions of the interface.</p>
<p>(The syscall table is littered with historical examples where this wasn’t done,
together with the corresponding follow-up system calls –
<code class="docutils literal notranslate"><span class="pre">eventfd</span></code>/<code class="docutils literal notranslate"><span class="pre">eventfd2</span></code>, <code class="docutils literal notranslate"><span class="pre">dup2</span></code>/<code class="docutils literal notranslate"><span class="pre">dup3</span></code>, <code class="docutils literal notranslate"><span class="pre">inotify_init</span></code>/<code class="docutils literal notranslate"><span class="pre">inotify_init1</span></code>,
<code class="docutils literal notranslate"><span class="pre">pipe</span></code>/<code class="docutils literal notranslate"><span class="pre">pipe2</span></code>, <code class="docutils literal notranslate"><span class="pre">renameat</span></code>/<code class="docutils literal notranslate"><span class="pre">renameat2</span></code> – so
learn from the history of the kernel and plan for extensions from the start.)</p>
<p>For simpler system calls that only take a couple of arguments, the preferred
way to allow for future extensibility is to include a flags argument to the
system call.  To make sure that userspace programs can safely use flags
between kernel versions, check whether the flags value holds any unknown
flags, and reject the system call (with <code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>) if it does:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (flags &amp; ~(THING_FLAG1 | THING_FLAG2 | THING_FLAG3))
    return -EINVAL;
</pre></div>
</div>
<p>(If no flags values are used yet, check that the flags argument is zero.)</p>
<p>For more sophisticated system calls that involve a larger number of arguments,
it’s preferred to encapsulate the majority of the arguments into a structure
that is passed in by pointer.  Such a structure can cope with future extension
by including a size argument in the structure:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct xyzzy_params {
    u32 size; /* userspace sets p-&gt;size = sizeof(struct xyzzy_params) */
    u32 param_1;
    u64 param_2;
    u64 param_3;
};
</pre></div>
</div>
<p>As long as any subsequently added field, say <code class="docutils literal notranslate"><span class="pre">param_4</span></code>, is designed so that a
zero value gives the previous behaviour, then this allows both directions of
version mismatch:</p>
<blockquote>
<div><ul class="simple">
<li>To cope with a later userspace program calling an older kernel, the kernel
code should check that any memory beyond the size of the structure that it
expects is zero (effectively checking that <code class="docutils literal notranslate"><span class="pre">param_4</span> <span class="pre">==</span> <span class="pre">0</span></code>).</li>
<li>To cope with an older userspace program calling a newer kernel, the kernel
code can zero-extend a smaller instance of the structure (effectively
setting <code class="docutils literal notranslate"><span class="pre">param_4</span> <span class="pre">=</span> <span class="pre">0</span></code>).</li>
</ul>
</div></blockquote>
<p>See <em class="manpage">perf_event_open(2)</em> and the <code class="docutils literal notranslate"><span class="pre">perf_copy_attr()</span></code> function (in
<code class="docutils literal notranslate"><span class="pre">kernel/events/core.c</span></code>) for an example of this approach.</p>
</div>
<div class="section" id="designing-the-api-other-considerations">
<h2>Designing the API: Other Considerations<a class="headerlink" href="#designing-the-api-other-considerations" title="Permalink to this headline">¶</a></h2>
<p>If your new system call allows userspace to refer to a kernel object, it
should use a file descriptor as the handle for that object – don’t invent a
new type of userspace object handle when the kernel already has mechanisms and
well-defined semantics for using file descriptors.</p>
<p>If your new <em class="manpage">xyzzy(2)</em> system call does return a new file descriptor,
then the flags argument should include a value that is equivalent to setting
<code class="docutils literal notranslate"><span class="pre">O_CLOEXEC</span></code> on the new FD.  This makes it possible for userspace to close
the timing window between <code class="docutils literal notranslate"><span class="pre">xyzzy()</span></code> and calling
<code class="docutils literal notranslate"><span class="pre">fcntl(fd,</span> <span class="pre">F_SETFD,</span> <span class="pre">FD_CLOEXEC)</span></code>, where an unexpected <code class="docutils literal notranslate"><span class="pre">fork()</span></code> and
<code class="docutils literal notranslate"><span class="pre">execve()</span></code> in another thread could leak a descriptor to
the exec’ed program. (However, resist the temptation to re-use the actual value
of the <code class="docutils literal notranslate"><span class="pre">O_CLOEXEC</span></code> constant, as it is architecture-specific and is part of a
numbering space of <code class="docutils literal notranslate"><span class="pre">O_*</span></code> flags that is fairly full.)</p>
<p>If your system call returns a new file descriptor, you should also consider
what it means to use the <em class="manpage">poll(2)</em> family of system calls on that file
descriptor. Making a file descriptor ready for reading or writing is the
normal way for the kernel to indicate to userspace that an event has
occurred on the corresponding kernel object.</p>
<p>If your new <em class="manpage">xyzzy(2)</em> system call involves a filename argument:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int sys_xyzzy(const char __user *path, ..., unsigned int flags);
</pre></div>
</div>
<p>you should also consider whether an <em class="manpage">xyzzyat(2)</em> version is more appropriate:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int sys_xyzzyat(int dfd, const char __user *path, ..., unsigned int flags);
</pre></div>
</div>
<p>This allows more flexibility for how userspace specifies the file in question;
in particular it allows userspace to request the functionality for an
already-opened file descriptor using the <code class="docutils literal notranslate"><span class="pre">AT_EMPTY_PATH</span></code> flag, effectively
giving an <em class="manpage">fxyzzy(3)</em> operation for free:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- xyzzyat(AT_FDCWD, path, ..., 0) is equivalent to xyzzy(path,...)
- xyzzyat(fd, &quot;&quot;, ..., AT_EMPTY_PATH) is equivalent to fxyzzy(fd, ...)
</pre></div>
</div>
<p>(For more details on the rationale of the *at() calls, see the
<em class="manpage">openat(2)</em> man page; for an example of AT_EMPTY_PATH, see the
<em class="manpage">fstatat(2)</em> man page.)</p>
<p>If your new <em class="manpage">xyzzy(2)</em> system call involves a parameter describing an
offset within a file, make its type <code class="docutils literal notranslate"><span class="pre">loff_t</span></code> so that 64-bit offsets can be
supported even on 32-bit architectures.</p>
<p>If your new <em class="manpage">xyzzy(2)</em> system call involves privileged functionality,
it needs to be governed by the appropriate Linux capability bit (checked with
a call to <code class="docutils literal notranslate"><span class="pre">capable()</span></code>), as described in the <em class="manpage">capabilities(7)</em> man
page.  Choose an existing capability bit that governs related functionality,
but try to avoid combining lots of only vaguely related functions together
under the same bit, as this goes against capabilities’ purpose of splitting
the power of root.  In particular, avoid adding new uses of the already
overly-general <code class="docutils literal notranslate"><span class="pre">CAP_SYS_ADMIN</span></code> capability.</p>
<p>If your new <em class="manpage">xyzzy(2)</em> system call manipulates a process other than
the calling process, it should be restricted (using a call to
<code class="docutils literal notranslate"><span class="pre">ptrace_may_access()</span></code>) so that only a calling process with the same
permissions as the target process, or with the necessary capabilities, can
manipulate the target process.</p>
<p>Finally, be aware that some non-x86 architectures have an easier time if
system call parameters that are explicitly 64-bit fall on odd-numbered
arguments (i.e. parameter 1, 3, 5), to allow use of contiguous pairs of 32-bit
registers.  (This concern does not apply if the arguments are part of a
structure that’s passed in by pointer.)</p>
</div>
<div class="section" id="proposing-the-api">
<h2>Proposing the API<a class="headerlink" href="#proposing-the-api" title="Permalink to this headline">¶</a></h2>
<p>To make new system calls easy to review, it’s best to divide up the patchset
into separate chunks.  These should include at least the following items as
distinct commits (each of which is described further below):</p>
<blockquote>
<div><ul class="simple">
<li>The core implementation of the system call, together with prototypes,
generic numbering, Kconfig changes and fallback stub implementation.</li>
<li>Wiring up of the new system call for one particular architecture, usually
x86 (including all of x86_64, x86_32 and x32).</li>
<li>A demonstration of the use of the new system call in userspace via a
selftest in <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/</span></code>.</li>
<li>A draft man-page for the new system call, either as plain text in the
cover letter, or as a patch to the (separate) man-pages repository.</li>
</ul>
</div></blockquote>
<p>New system call proposals, like any change to the kernel’s API, should always
be cc’ed to <a class="reference external" href="mailto:linux-api&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-api<span>&#64;</span>vger<span>&#46;</span>kernel<span>&#46;</span>org</a>.</p>
</div>
<div class="section" id="generic-system-call-implementation">
<h2>Generic System Call Implementation<a class="headerlink" href="#generic-system-call-implementation" title="Permalink to this headline">¶</a></h2>
<p>The main entry point for your new <em class="manpage">xyzzy(2)</em> system call will be called
<code class="docutils literal notranslate"><span class="pre">sys_xyzzy()</span></code>, but you add this entry point with the appropriate
<code class="docutils literal notranslate"><span class="pre">SYSCALL_DEFINEn()</span></code> macro rather than explicitly.  The ‘n’ indicates the
number of arguments to the system call, and the macro takes the system call name
followed by the (type, name) pairs for the parameters as arguments.  Using
this macro allows metadata about the new system call to be made available for
other tools.</p>
<p>The new entry point also needs a corresponding function prototype, in
<code class="docutils literal notranslate"><span class="pre">include/linux/syscalls.h</span></code>, marked as asmlinkage to match the way that system
calls are invoked:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>asmlinkage long sys_xyzzy(...);
</pre></div>
</div>
<p>Some architectures (e.g. x86) have their own architecture-specific syscall
tables, but several other architectures share a generic syscall table. Add your
new system call to the generic list by adding an entry to the list in
<code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/unistd.h</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define __NR_xyzzy 292
__SYSCALL(__NR_xyzzy, sys_xyzzy)
</pre></div>
</div>
<p>Also update the __NR_syscalls count to reflect the additional system call, and
note that if multiple new system calls are added in the same merge window,
your new syscall number may get adjusted to resolve conflicts.</p>
<p>The file <code class="docutils literal notranslate"><span class="pre">kernel/sys_ni.c</span></code> provides a fallback stub implementation of each
system call, returning <code class="docutils literal notranslate"><span class="pre">-ENOSYS</span></code>.  Add your new system call here too:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>COND_SYSCALL(xyzzy);
</pre></div>
</div>
<p>Your new kernel functionality, and the system call that controls it, should
normally be optional, so add a <code class="docutils literal notranslate"><span class="pre">CONFIG</span></code> option (typically to
<code class="docutils literal notranslate"><span class="pre">init/Kconfig</span></code>) for it. As usual for new <code class="docutils literal notranslate"><span class="pre">CONFIG</span></code> options:</p>
<blockquote>
<div><ul class="simple">
<li>Include a description of the new functionality and system call controlled
by the option.</li>
<li>Make the option depend on EXPERT if it should be hidden from normal users.</li>
<li>Make any new source files implementing the function dependent on the CONFIG
option in the Makefile (e.g. <code class="docutils literal notranslate"><span class="pre">obj-$(CONFIG_XYZZY_SYSCALL)</span> <span class="pre">+=</span> <span class="pre">xyzzy.o</span></code>).</li>
<li>Double check that the kernel still builds with the new CONFIG option turned
off.</li>
</ul>
</div></blockquote>
<p>To summarize, you need a commit that includes:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">CONFIG</span></code> option for the new function, normally in <code class="docutils literal notranslate"><span class="pre">init/Kconfig</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">SYSCALL_DEFINEn(xyzzy,</span> <span class="pre">...)</span></code> for the entry point</li>
<li>corresponding prototype in <code class="docutils literal notranslate"><span class="pre">include/linux/syscalls.h</span></code></li>
<li>generic table entry in <code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/unistd.h</span></code></li>
<li>fallback stub in <code class="docutils literal notranslate"><span class="pre">kernel/sys_ni.c</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="x86-system-call-implementation">
<h2>x86 System Call Implementation<a class="headerlink" href="#x86-system-call-implementation" title="Permalink to this headline">¶</a></h2>
<p>To wire up your new system call for x86 platforms, you need to update the
master syscall tables.  Assuming your new system call isn’t special in some
way (see below), this involves a “common” entry (for x86_64 and x32) in
arch/x86/entry/syscalls/syscall_64.tbl:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>333   common   xyzzy     sys_xyzzy
</pre></div>
</div>
<p>and an “i386” entry in <code class="docutils literal notranslate"><span class="pre">arch/x86/entry/syscalls/syscall_32.tbl</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>380   i386     xyzzy     sys_xyzzy
</pre></div>
</div>
<p>Again, these numbers are liable to be changed if there are conflicts in the
relevant merge window.</p>
</div>
<div class="section" id="compatibility-system-calls-generic">
<h2>Compatibility System Calls (Generic)<a class="headerlink" href="#compatibility-system-calls-generic" title="Permalink to this headline">¶</a></h2>
<p>For most system calls the same 64-bit implementation can be invoked even when
the userspace program is itself 32-bit; even if the system call’s parameters
include an explicit pointer, this is handled transparently.</p>
<p>However, there are a couple of situations where a compatibility layer is
needed to cope with size differences between 32-bit and 64-bit.</p>
<p>The first is if the 64-bit kernel also supports 32-bit userspace programs, and
so needs to parse areas of (<code class="docutils literal notranslate"><span class="pre">__user</span></code>) memory that could hold either 32-bit or
64-bit values.  In particular, this is needed whenever a system call argument
is:</p>
<blockquote>
<div><ul class="simple">
<li>a pointer to a pointer</li>
<li>a pointer to a struct containing a pointer (e.g. <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iovec</span> <span class="pre">__user</span> <span class="pre">*</span></code>)</li>
<li>a pointer to a varying sized integral type (<code class="docutils literal notranslate"><span class="pre">time_t</span></code>, <code class="docutils literal notranslate"><span class="pre">off_t</span></code>,
<code class="docutils literal notranslate"><span class="pre">long</span></code>, …)</li>
<li>a pointer to a struct containing a varying sized integral type.</li>
</ul>
</div></blockquote>
<p>The second situation that requires a compatibility layer is if one of the
system call’s arguments has a type that is explicitly 64-bit even on a 32-bit
architecture, for example <code class="docutils literal notranslate"><span class="pre">loff_t</span></code> or <code class="docutils literal notranslate"><span class="pre">__u64</span></code>.  In this case, a value that
arrives at a 64-bit kernel from a 32-bit application will be split into two
32-bit values, which then need to be re-assembled in the compatibility layer.</p>
<p>(Note that a system call argument that’s a pointer to an explicit 64-bit type
does <strong>not</strong> need a compatibility layer; for example, <em class="manpage">splice(2)</em>’s arguments of
type <code class="docutils literal notranslate"><span class="pre">loff_t</span> <span class="pre">__user</span> <span class="pre">*</span></code> do not trigger the need for a <code class="docutils literal notranslate"><span class="pre">compat_</span></code> system call.)</p>
<p>The compatibility version of the system call is called <code class="docutils literal notranslate"><span class="pre">compat_sys_xyzzy()</span></code>,
and is added with the <code class="docutils literal notranslate"><span class="pre">COMPAT_SYSCALL_DEFINEn()</span></code> macro, analogously to
SYSCALL_DEFINEn.  This version of the implementation runs as part of a 64-bit
kernel, but expects to receive 32-bit parameter values and does whatever is
needed to deal with them.  (Typically, the <code class="docutils literal notranslate"><span class="pre">compat_sys_</span></code> version converts the
values to 64-bit versions and either calls on to the <code class="docutils literal notranslate"><span class="pre">sys_</span></code> version, or both of
them call a common inner implementation function.)</p>
<p>The compat entry point also needs a corresponding function prototype, in
<code class="docutils literal notranslate"><span class="pre">include/linux/compat.h</span></code>, marked as asmlinkage to match the way that system
calls are invoked:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>asmlinkage long compat_sys_xyzzy(...);
</pre></div>
</div>
<p>If the system call involves a structure that is laid out differently on 32-bit
and 64-bit systems, say <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">xyzzy_args</span></code>, then the include/linux/compat.h
header file should also include a compat version of the structure (<code class="docutils literal notranslate"><span class="pre">struct</span>
<span class="pre">compat_xyzzy_args</span></code>) where each variable-size field has the appropriate
<code class="docutils literal notranslate"><span class="pre">compat_</span></code> type that corresponds to the type in <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">xyzzy_args</span></code>.  The
<code class="docutils literal notranslate"><span class="pre">compat_sys_xyzzy()</span></code> routine can then use this <code class="docutils literal notranslate"><span class="pre">compat_</span></code> structure to
parse the arguments from a 32-bit invocation.</p>
<p>For example, if there are fields:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct xyzzy_args {
    const char __user *ptr;
    __kernel_long_t varying_val;
    u64 fixed_val;
    /* ... */
};
</pre></div>
</div>
<p>in struct xyzzy_args, then struct compat_xyzzy_args would have:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct compat_xyzzy_args {
    compat_uptr_t ptr;
    compat_long_t varying_val;
    u64 fixed_val;
    /* ... */
};
</pre></div>
</div>
<p>The generic system call list also needs adjusting to allow for the compat
version; the entry in <code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/unistd.h</span></code> should use
<code class="docutils literal notranslate"><span class="pre">__SC_COMP</span></code> rather than <code class="docutils literal notranslate"><span class="pre">__SYSCALL</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define __NR_xyzzy 292
__SC_COMP(__NR_xyzzy, sys_xyzzy, compat_sys_xyzzy)
</pre></div>
</div>
<p>To summarize, you need:</p>
<blockquote>
<div><ul class="simple">
<li>a <code class="docutils literal notranslate"><span class="pre">COMPAT_SYSCALL_DEFINEn(xyzzy,</span> <span class="pre">...)</span></code> for the compat entry point</li>
<li>corresponding prototype in <code class="docutils literal notranslate"><span class="pre">include/linux/compat.h</span></code></li>
<li>(if needed) 32-bit mapping struct in <code class="docutils literal notranslate"><span class="pre">include/linux/compat.h</span></code></li>
<li>instance of <code class="docutils literal notranslate"><span class="pre">__SC_COMP</span></code> not <code class="docutils literal notranslate"><span class="pre">__SYSCALL</span></code> in
<code class="docutils literal notranslate"><span class="pre">include/uapi/asm-generic/unistd.h</span></code></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="compatibility-system-calls-x86">
<h2>Compatibility System Calls (x86)<a class="headerlink" href="#compatibility-system-calls-x86" title="Permalink to this headline">¶</a></h2>
<p>To wire up the x86 architecture of a system call with a compatibility version,
the entries in the syscall tables need to be adjusted.</p>
<p>First, the entry in <code class="docutils literal notranslate"><span class="pre">arch/x86/entry/syscalls/syscall_32.tbl</span></code> gets an extra
column to indicate that a 32-bit userspace program running on a 64-bit kernel
should hit the compat entry point:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>380   i386     xyzzy     sys_xyzzy    __ia32_compat_sys_xyzzy
</pre></div>
</div>
<p>Second, you need to figure out what should happen for the x32 ABI version of
the new system call.  There’s a choice here: the layout of the arguments
should either match the 64-bit version or the 32-bit version.</p>
<p>If there’s a pointer-to-a-pointer involved, the decision is easy: x32 is
ILP32, so the layout should match the 32-bit version, and the entry in
<code class="docutils literal notranslate"><span class="pre">arch/x86/entry/syscalls/syscall_64.tbl</span></code> is split so that x32 programs hit
the compatibility wrapper:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>333   64       xyzzy     sys_xyzzy
...
555   x32      xyzzy     __x32_compat_sys_xyzzy
</pre></div>
</div>
<p>If no pointers are involved, then it is preferable to re-use the 64-bit system
call for the x32 ABI (and consequently the entry in
arch/x86/entry/syscalls/syscall_64.tbl is unchanged).</p>
<p>In either case, you should check that the types involved in your argument
layout do indeed map exactly from x32 (-mx32) to either the 32-bit (-m32) or
64-bit (-m64) equivalents.</p>
</div>
<div class="section" id="system-calls-returning-elsewhere">
<h2>System Calls Returning Elsewhere<a class="headerlink" href="#system-calls-returning-elsewhere" title="Permalink to this headline">¶</a></h2>
<p>For most system calls, once the system call is complete the user program
continues exactly where it left off – at the next instruction, with the
stack the same and most of the registers the same as before the system call,
and with the same virtual memory space.</p>
<p>However, a few system calls do things differently.  They might return to a
different location (<code class="docutils literal notranslate"><span class="pre">rt_sigreturn</span></code>) or change the memory space
(<code class="docutils literal notranslate"><span class="pre">fork</span></code>/<code class="docutils literal notranslate"><span class="pre">vfork</span></code>/<code class="docutils literal notranslate"><span class="pre">clone</span></code>) or even architecture (<code class="docutils literal notranslate"><span class="pre">execve</span></code>/<code class="docutils literal notranslate"><span class="pre">execveat</span></code>)
of the program.</p>
<p>To allow for this, the kernel implementation of the system call may need to
save and restore additional registers to the kernel stack, allowing complete
control of where and how execution continues after the system call.</p>
<p>This is arch-specific, but typically involves defining assembly entry points
that save/restore additional registers and invoke the real system call entry
point.</p>
<p>For x86_64, this is implemented as a <code class="docutils literal notranslate"><span class="pre">stub_xyzzy</span></code> entry point in
<code class="docutils literal notranslate"><span class="pre">arch/x86/entry/entry_64.S</span></code>, and the entry in the syscall table
(<code class="docutils literal notranslate"><span class="pre">arch/x86/entry/syscalls/syscall_64.tbl</span></code>) is adjusted to match:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>333   common   xyzzy     stub_xyzzy
</pre></div>
</div>
<p>The equivalent for 32-bit programs running on a 64-bit kernel is normally
called <code class="docutils literal notranslate"><span class="pre">stub32_xyzzy</span></code> and implemented in <code class="docutils literal notranslate"><span class="pre">arch/x86/entry/entry_64_compat.S</span></code>,
with the corresponding syscall table adjustment in
<code class="docutils literal notranslate"><span class="pre">arch/x86/entry/syscalls/syscall_32.tbl</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>380   i386     xyzzy     sys_xyzzy    stub32_xyzzy
</pre></div>
</div>
<p>If the system call needs a compatibility layer (as in the previous section)
then the <code class="docutils literal notranslate"><span class="pre">stub32_</span></code> version needs to call on to the <code class="docutils literal notranslate"><span class="pre">compat_sys_</span></code> version
of the system call rather than the native 64-bit version.  Also, if the x32 ABI
implementation is not common with the x86_64 version, then its syscall
table will also need to invoke a stub that calls on to the <code class="docutils literal notranslate"><span class="pre">compat_sys_</span></code>
version.</p>
<p>For completeness, it’s also nice to set up a mapping so that user-mode Linux
still works – its syscall table will reference stub_xyzzy, but the UML build
doesn’t include <code class="docutils literal notranslate"><span class="pre">arch/x86/entry/entry_64.S</span></code> implementation (because UML
simulates registers etc).  Fixing this is as simple as adding a #define to
<code class="docutils literal notranslate"><span class="pre">arch/x86/um/sys_call_table_64.c</span></code>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#define stub_xyzzy sys_xyzzy
</pre></div>
</div>
</div>
<div class="section" id="other-details">
<h2>Other Details<a class="headerlink" href="#other-details" title="Permalink to this headline">¶</a></h2>
<p>Most of the kernel treats system calls in a generic way, but there is the
occasional exception that may need updating for your particular system call.</p>
<p>The audit subsystem is one such special case; it includes (arch-specific)
functions that classify some special types of system call – specifically
file open (<code class="docutils literal notranslate"><span class="pre">open</span></code>/<code class="docutils literal notranslate"><span class="pre">openat</span></code>), program execution (<code class="docutils literal notranslate"><span class="pre">execve</span></code>/<code class="docutils literal notranslate"><span class="pre">exeveat</span></code>) or
socket multiplexor (<code class="docutils literal notranslate"><span class="pre">socketcall</span></code>) operations. If your new system call is
analogous to one of these, then the audit system should be updated.</p>
<p>More generally, if there is an existing system call that is analogous to your
new system call, it’s worth doing a kernel-wide grep for the existing system
call to check there are no other special cases.</p>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>A new system call should obviously be tested; it is also useful to provide
reviewers with a demonstration of how user space programs will use the system
call.  A good way to combine these aims is to include a simple self-test
program in a new directory under <code class="docutils literal notranslate"><span class="pre">tools/testing/selftests/</span></code>.</p>
<p>For a new system call, there will obviously be no libc wrapper function and so
the test will need to invoke it using <code class="docutils literal notranslate"><span class="pre">syscall()</span></code>; also, if the system call
involves a new userspace-visible structure, the corresponding header will need
to be installed to compile the test.</p>
<p>Make sure the selftest runs successfully on all supported architectures.  For
example, check that it works when compiled as an x86_64 (-m64), x86_32 (-m32)
and x32 (-mx32) ABI program.</p>
<p>For more extensive and thorough testing of new functionality, you should also
consider adding tests to the Linux Test Project, or to the xfstests project
for filesystem-related changes.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://linux-test-project.github.io/">https://linux-test-project.github.io/</a></li>
<li>git://git.kernel.org/pub/scm/fs/xfs/xfstests-dev.git</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="man-page">
<h2>Man Page<a class="headerlink" href="#man-page" title="Permalink to this headline">¶</a></h2>
<p>All new system calls should come with a complete man page, ideally using groff
markup, but plain text will do.  If groff is used, it’s helpful to include a
pre-rendered ASCII version of the man page in the cover email for the
patchset, for the convenience of reviewers.</p>
<p>The man page should be cc’ed to <a class="reference external" href="mailto:linux-man&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-man<span>&#64;</span>vger<span>&#46;</span>kernel<span>&#46;</span>org</a>
For more details, see <a class="reference external" href="https://www.kernel.org/doc/man-pages/patches.html">https://www.kernel.org/doc/man-pages/patches.html</a></p>
</div>
<div class="section" id="do-not-call-system-calls-in-the-kernel">
<h2>Do not call System Calls in the Kernel<a class="headerlink" href="#do-not-call-system-calls-in-the-kernel" title="Permalink to this headline">¶</a></h2>
<p>System calls are, as stated above, interaction points between userspace and
the kernel.  Therefore, system call functions such as <code class="docutils literal notranslate"><span class="pre">sys_xyzzy()</span></code> or
<code class="docutils literal notranslate"><span class="pre">compat_sys_xyzzy()</span></code> should only be called from userspace via the syscall
table, but not from elsewhere in the kernel.  If the syscall functionality is
useful to be used within the kernel, needs to be shared between an old and a
new syscall, or needs to be shared between a syscall and its compatibility
variant, it should be implemented by means of a “helper” function (such as
<code class="docutils literal notranslate"><span class="pre">kern_xyzzy()</span></code>).  This kernel function may then be called within the
syscall stub (<code class="docutils literal notranslate"><span class="pre">sys_xyzzy()</span></code>), the compatibility syscall stub
(<code class="docutils literal notranslate"><span class="pre">compat_sys_xyzzy()</span></code>), and/or other kernel code.</p>
<p>At least on 64-bit x86, it will be a hard requirement from v4.17 onwards to not
call system call functions in the kernel.  It uses a different calling
convention for system calls where <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">pt_regs</span></code> is decoded on-the-fly in a
syscall wrapper which then hands processing over to the actual syscall function.
This means that only those parameters which are actually needed for a specific
syscall are passed on during syscall entry, instead of filling in six CPU
registers with random user space content all the time (which may cause serious
trouble down the call chain).</p>
<p>Moreover, rules on how data may be accessed may differ between kernel data and
user data.  This is another reason why calling <code class="docutils literal notranslate"><span class="pre">sys_xyzzy()</span></code> is generally a
bad idea.</p>
<p>Exceptions to this rule are only allowed in architecture-specific overrides,
architecture-specific compatibility wrappers, or other code in arch/.</p>
</div>
<div class="section" id="references-and-sources">
<h2>References and Sources<a class="headerlink" href="#references-and-sources" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul>
<li><p class="first">LWN article from Michael Kerrisk on use of flags argument in system calls:
<a class="reference external" href="https://lwn.net/Articles/585415/">https://lwn.net/Articles/585415/</a></p>
</li>
<li><p class="first">LWN article from Michael Kerrisk on how to handle unknown flags in a system
call: <a class="reference external" href="https://lwn.net/Articles/588444/">https://lwn.net/Articles/588444/</a></p>
</li>
<li><p class="first">LWN article from Jake Edge describing constraints on 64-bit system call
arguments: <a class="reference external" href="https://lwn.net/Articles/311630/">https://lwn.net/Articles/311630/</a></p>
</li>
<li><p class="first">Pair of LWN articles from David Drysdale that describe the system call
implementation paths in detail for v3.14:</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="https://lwn.net/Articles/604287/">https://lwn.net/Articles/604287/</a></li>
<li><a class="reference external" href="https://lwn.net/Articles/604515/">https://lwn.net/Articles/604515/</a></li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Architecture-specific requirements for system calls are discussed in the
<em class="manpage">syscall(2)</em> man-page:
<a class="reference external" href="http://man7.org/linux/man-pages/man2/syscall.2.html#NOTES">http://man7.org/linux/man-pages/man2/syscall.2.html#NOTES</a></p>
</li>
<li><p class="first">Collated emails from Linus Torvalds discussing the problems with <code class="docutils literal notranslate"><span class="pre">ioctl()</span></code>:
<a class="reference external" href="https://yarchive.net/comp/linux/ioctl.html">https://yarchive.net/comp/linux/ioctl.html</a></p>
</li>
<li><p class="first">“How to not invent kernel interfaces”, Arnd Bergmann,
<a class="reference external" href="https://www.ukuug.org/events/linux2007/2007/papers/Bergmann.pdf">https://www.ukuug.org/events/linux2007/2007/papers/Bergmann.pdf</a></p>
</li>
<li><p class="first">LWN article from Michael Kerrisk on avoiding new uses of CAP_SYS_ADMIN:
<a class="reference external" href="https://lwn.net/Articles/486306/">https://lwn.net/Articles/486306/</a></p>
</li>
<li><p class="first">Recommendation from Andrew Morton that all related information for a new
system call should come in the same email thread:
<a class="reference external" href="https://lkml.org/lkml/2014/7/24/641">https://lkml.org/lkml/2014/7/24/641</a></p>
</li>
<li><p class="first">Recommendation from Michael Kerrisk that a new system call should come with
a man page: <a class="reference external" href="https://lkml.org/lkml/2014/6/13/309">https://lkml.org/lkml/2014/6/13/309</a></p>
</li>
<li><p class="first">Suggestion from Thomas Gleixner that x86 wire-up should be in a separate
commit: <a class="reference external" href="https://lkml.org/lkml/2014/11/19/254">https://lkml.org/lkml/2014/11/19/254</a></p>
</li>
<li><p class="first">Suggestion from Greg Kroah-Hartman that it’s good for new system calls to
come with a man-page &amp; selftest: <a class="reference external" href="https://lkml.org/lkml/2014/3/19/710">https://lkml.org/lkml/2014/3/19/710</a></p>
</li>
<li><p class="first">Discussion from Michael Kerrisk of new system call vs. <em class="manpage">prctl(2)</em> extension:
<a class="reference external" href="https://lkml.org/lkml/2014/6/3/411">https://lkml.org/lkml/2014/6/3/411</a></p>
</li>
<li><p class="first">Suggestion from Ingo Molnar that system calls that involve multiple
arguments should encapsulate those arguments in a struct, which includes a
size field for future extensibility: <a class="reference external" href="https://lkml.org/lkml/2015/7/30/117">https://lkml.org/lkml/2015/7/30/117</a></p>
</li>
<li><p class="first">Numbering oddities arising from (re-)use of O_* numbering space flags:</p>
<blockquote>
<div><ul class="simple">
<li>commit 75069f2b5bfb (“vfs: renumber FMODE_NONOTIFY and add to uniqueness
check”)</li>
<li>commit 12ed2e36c98a (“fanotify: FMODE_NONOTIFY and __O_SYNC in sparc
conflict”)</li>
<li>commit bb458c644a59 (“Safer ABI for O_TMPFILE”)</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">Discussion from Matthew Wilcox about restrictions on 64-bit arguments:
<a class="reference external" href="https://lkml.org/lkml/2008/12/12/187">https://lkml.org/lkml/2008/12/12/187</a></p>
</li>
<li><p class="first">Recommendation from Greg Kroah-Hartman that unknown flags should be
policed: <a class="reference external" href="https://lkml.org/lkml/2014/7/17/577">https://lkml.org/lkml/2014/7/17/577</a></p>
</li>
<li><p class="first">Recommendation from Linus Torvalds that x32 system calls should prefer
compatibility with 64-bit versions rather than 32-bit versions:
<a class="reference external" href="https://lkml.org/lkml/2011/8/31/244">https://lkml.org/lkml/2011/8/31/244</a></p>
</li>
</ul>
</div></blockquote>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="magic-number.html" class="btn btn-neutral float-right" title="Linux magic numbers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="applying-patches.html" class="btn btn-neutral float-left" title="Applying Patches To The Linux Kernel" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>