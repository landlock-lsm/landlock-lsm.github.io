

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Intel Integrated Sensor Hub (ISH) &mdash; The Linux Kernel  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="I2C/SMBus Subsystem" href="../i2c/index.html" />
    <link rel="prev" title="ALPS HID Touchpad Protocol" href="hid-alps.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.9.0-rc8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Human Interface Devices (HID)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="hiddev.html">Care and feeding of your Human Interface Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="hidraw.html">HIDRAW - Raw Access to USB and Bluetooth Human Interface Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="hid-sensor.html">HID Sensors Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="hid-transport.html">HID I/O Transport Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="uhid.html">UHID - User-space I/O driver support for HID subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="hid-alps.html">ALPS HID Touchpad Protocol</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Intel Integrated Sensor Hub (ISH)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">1. Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ish-implementation-block-diagram">2. ISH Implementation: Block Diagram</a></li>
<li class="toctree-l3"><a class="reference internal" href="#high-level-processing-in-above-blocks">3. High level processing in above blocks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#hardware-interface">3.1 Hardware Interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="#inter-processor-communication-ipc-driver">3.2 Inter Processor Communication (IPC) driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ish-transport-layer">3.3 ISH Transport layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hid-over-ish-client">3.4 HID over ISH Client</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hid-sensor-hub-mfd-and-iio-sensor-drivers">3.5 HID Sensor Hub MFD and IIO sensor drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#end-to-end-hid-transport-sequence-diagram">3.6 End to End HID transport Sequence Diagram</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ish-debugging">3.7 ISH Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ish-iio-sysfs-example-on-lenovo-thinkpad-yoga-260">3.8 ISH IIO sysfs Example on Lenovo thinkpad Yoga 260</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Human Interface Devices (HID)</a> &raquo;</li>
        
      <li>Intel Integrated Sensor Hub (ISH)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/hid/intel-ish-hid.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="intel-integrated-sensor-hub-ish">
<h1>Intel Integrated Sensor Hub (ISH)<a class="headerlink" href="#intel-integrated-sensor-hub-ish" title="Permalink to this headline">¶</a></h1>
<p>A sensor hub enables the ability to offload sensor polling and algorithm
processing to a dedicated low power co-processor. This allows the core
processor to go into low power modes more often, resulting in the increased
battery life.</p>
<p>There are many vendors providing external sensor hubs confirming to HID
Sensor usage tables, and used in several tablets, 2 in 1 convertible laptops
and embedded products. Linux had this support since Linux 3.9.</p>
<p>Intel® introduced integrated sensor hubs as a part of the SoC starting from
Cherry Trail and now supported on multiple generations of CPU packages. There
are many commercial devices already shipped with Integrated Sensor Hubs (ISH).
These ISH also comply to HID sensor specification, but the  difference is the
transport protocol used for communication. The current external sensor hubs
mainly use HID over i2C or USB. But ISH doesn’t use either i2c or USB.</p>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Using a analogy with a usbhid implementation, the ISH follows a similar model
for a very high speed communication:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-----------------               ----------------------
|    USB HID    |       --&gt;     |    ISH HID         |
-----------------               ----------------------
-----------------               ----------------------
|  USB protocol |       --&gt;     |    ISH Transport   |
-----------------               ----------------------
-----------------               ----------------------
|  EHCI/XHCI    |       --&gt;     |    ISH IPC         |
-----------------               ----------------------
      PCI                                PCI
-----------------               ----------------------
|Host controller|       --&gt;     |    ISH processor   |
-----------------               ----------------------
     USB Link
-----------------               ----------------------
| USB End points|       --&gt;     |    ISH Clients     |
-----------------               ----------------------
</pre></div>
</div>
<p>Like USB protocol provides a method for device enumeration, link management
and user data encapsulation, the ISH also provides similar services. But it is
very light weight tailored to manage and communicate with ISH client
applications implemented in the firmware.</p>
<p>The ISH allows multiple sensor management applications executing in the
firmware. Like USB endpoints the messaging can be to/from a client. As part of
enumeration process, these clients are identified. These clients can be simple
HID sensor applications, sensor calibration application or senor firmware
update application.</p>
<p>The implementation model is similar, like USB bus, ISH transport is also
implemented as a bus. Each client application executing in the ISH processor
is registered as a device on this bus. The driver, which binds each device
(ISH HID driver) identifies the device type and registers with the hid core.</p>
</div>
<div class="section" id="ish-implementation-block-diagram">
<h2>2. ISH Implementation: Block Diagram<a class="headerlink" href="#ish-implementation-block-diagram" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>       ---------------------------
      |  User Space Applications  |
       ---------------------------

----------------IIO ABI----------------
       --------------------------
      |  IIO Sensor Drivers     |
       --------------------------
       --------------------------
      |        IIO core         |
       --------------------------
       --------------------------
      |   HID Sensor Hub MFD    |
       --------------------------
       --------------------------
      |       HID Core          |
       --------------------------
       --------------------------
      |   HID over ISH Client   |
       --------------------------
       --------------------------
      |   ISH Transport (ISHTP) |
       --------------------------
       --------------------------
      |      IPC Drivers        |
       --------------------------
OS
---------------- PCI -----------------
Hardware + Firmware
       ----------------------------
      | ISH Hardware/Firmware(FW) |
       ----------------------------
</pre></div>
</div>
</div>
<div class="section" id="high-level-processing-in-above-blocks">
<h2>3. High level processing in above blocks<a class="headerlink" href="#high-level-processing-in-above-blocks" title="Permalink to this headline">¶</a></h2>
<div class="section" id="hardware-interface">
<h3>3.1 Hardware Interface<a class="headerlink" href="#hardware-interface" title="Permalink to this headline">¶</a></h3>
<p>The ISH is exposed as “Non-VGA unclassified PCI device” to the host. The PCI
product and vendor IDs are changed from different generations of processors. So
the source code which enumerate drivers needs to update from generation to
generation.</p>
</div>
<div class="section" id="inter-processor-communication-ipc-driver">
<h3>3.2 Inter Processor Communication (IPC) driver<a class="headerlink" href="#inter-processor-communication-ipc-driver" title="Permalink to this headline">¶</a></h3>
<p>Location: drivers/hid/intel-ish-hid/ipc</p>
<p>The IPC message used memory mapped I/O. The registers are defined in
hw-ish-regs.h.</p>
<div class="section" id="ipc-fw-message-types">
<h4>3.2.1 IPC/FW message types<a class="headerlink" href="#ipc-fw-message-types" title="Permalink to this headline">¶</a></h4>
<p>There are two types of messages, one for management of link and other messages
are to and from transport layers.</p>
<div class="section" id="tx-and-rx-of-transport-messages">
<h5>TX and RX of Transport messages<a class="headerlink" href="#tx-and-rx-of-transport-messages" title="Permalink to this headline">¶</a></h5>
<p>A set of memory mapped register offers support of multi byte messages TX and
RX (E.g.IPC_REG_ISH2HOST_MSG, IPC_REG_HOST2ISH_MSG). The IPC layer maintains
internal queues to sequence messages and send them in order to the FW.
Optionally the caller can register handler to get notification of completion.
A door bell mechanism is used in messaging to trigger processing in host and
client firmware side. When ISH interrupt handler is called, the ISH2HOST
doorbell register is used by host drivers to determine that the interrupt
is for ISH.</p>
<p>Each side has 32 32-bit message registers and a 32-bit doorbell. Doorbell
register has the following format:
Bits 0..6: fragment length (7 bits are used)
Bits 10..13: encapsulated protocol
Bits 16..19: management command (for IPC management protocol)
Bit 31: doorbell trigger (signal H/W interrupt to the other side)
Other bits are reserved, should be 0.</p>
</div>
</div>
<div class="section" id="transport-layer-interface">
<h4>3.2.2 Transport layer interface<a class="headerlink" href="#transport-layer-interface" title="Permalink to this headline">¶</a></h4>
<p>To abstract HW level IPC communication, a set of callbacks are registered.
The transport layer uses them to send and receive messages.
Refer to  struct ishtp_hw_ops for callbacks.</p>
</div>
</div>
<div class="section" id="ish-transport-layer">
<h3>3.3 ISH Transport layer<a class="headerlink" href="#ish-transport-layer" title="Permalink to this headline">¶</a></h3>
<p>Location: drivers/hid/intel-ish-hid/ishtp/</p>
<div class="section" id="a-generic-transport-layer">
<h4>3.3.1 A Generic Transport Layer<a class="headerlink" href="#a-generic-transport-layer" title="Permalink to this headline">¶</a></h4>
<p>The transport layer is a bi-directional protocol, which defines:
- Set of commands to start, stop, connect, disconnect and flow control
(ishtp/hbm.h) for details
- A flow control mechanism to avoid buffer overflows</p>
<p>This protocol resembles bus messages described in the following document:
<a class="reference external" href="http://www.intel.com/content/dam/www/public/us/en/documents/technical">http://www.intel.com/content/dam/www/public/us/en/documents/technical</a>-specifications/dcmi-hi-1-0-spec.pdf “Chapter 7: Bus Message Layer”</p>
</div>
<div class="section" id="connection-and-flow-control-mechanism">
<h4>3.3.2 Connection and Flow Control Mechanism<a class="headerlink" href="#connection-and-flow-control-mechanism" title="Permalink to this headline">¶</a></h4>
<p>Each FW client and a protocol is identified by an UUID. In order to communicate
to a FW client, a connection must be established using connect request and
response bus messages. If successful, a pair (host_client_id and fw_client_id)
will identify the connection.</p>
<p>Once connection is established, peers send each other flow control bus messages
independently. Every peer may send a message only if it has received a
flow-control credit before. Once it sent a message, it may not send another one
before receiving the next flow control credit.
Either side can send disconnect request bus message to end communication. Also
the link will be dropped if major FW reset occurs.</p>
</div>
<div class="section" id="peer-to-peer-data-transfer">
<h4>3.3.3 Peer to Peer data transfer<a class="headerlink" href="#peer-to-peer-data-transfer" title="Permalink to this headline">¶</a></h4>
<p>Peer to Peer data transfer can happen with or without using DMA. Depending on
the sensor bandwidth requirement DMA can be enabled by using module parameter
ishtp_use_dma under intel_ishtp.</p>
<p>Each side (host and FW) manages its DMA transfer memory independently. When an
ISHTP client from either host or FW side wants to send something, it decides
whether to send over IPC or over DMA; for each transfer the decision is
independent. The sending side sends DMA_XFER message when the message is in
the respective host buffer (TX when host client sends, RX when FW client
sends). The recipient of DMA message responds with DMA_XFER_ACK, indicating
the sender that the memory region for that message may be reused.</p>
<p>DMA initialization is started with host sending DMA_ALLOC_NOTIFY bus message
(that includes RX buffer) and FW responds with DMA_ALLOC_NOTIFY_ACK.
Additionally to DMA address communication, this sequence checks capabilities:
if thw host doesn’t support DMA, then it won’t send DMA allocation, so FW can’t
send DMA; if FW doesn’t support DMA then it won’t respond with
DMA_ALLOC_NOTIFY_ACK, in which case host will not use DMA transfers.
Here ISH acts as busmaster DMA controller. Hence when host sends DMA_XFER,
it’s request to do host-&gt;ISH DMA transfer; when FW sends DMA_XFER, it means
that it already did DMA and the message resides at host. Thus, DMA_XFER
and DMA_XFER_ACK act as ownership indicators.</p>
<p>At initial state all outgoing memory belongs to the sender (TX to host, RX to
FW), DMA_XFER transfers ownership on the region that contains ISHTP message to
the receiving side, DMA_XFER_ACK returns ownership to the sender. A sender
needs not wait for previous DMA_XFER to be ack’ed, and may send another message
as long as remaining continuous memory in its ownership is enough.
In principle, multiple DMA_XFER and DMA_XFER_ACK messages may be sent at once
(up to IPC MTU), thus allowing for interrupt throttling.
Currently, ISH FW decides to send over DMA if ISHTP message is more than 3 IPC
fragments and via IPC otherwise.</p>
</div>
<div class="section" id="ring-buffers">
<h4>3.3.4 Ring Buffers<a class="headerlink" href="#ring-buffers" title="Permalink to this headline">¶</a></h4>
<p>When a client initiate a connection, a ring or RX and TX buffers are allocated.
The size of ring can be specified by the client. HID client set 16 and 32 for
TX and RX buffers respectively. On send request from client, the data to be
sent is copied to one of the send ring buffer and scheduled to be sent using
bus message protocol. These buffers are required because the FW may have not
have processed the last message and may not have enough flow control credits
to send. Same thing holds true on receive side and flow control is required.</p>
</div>
<div class="section" id="host-enumeration">
<h4>3.3.5 Host Enumeration<a class="headerlink" href="#host-enumeration" title="Permalink to this headline">¶</a></h4>
<p>The host enumeration bus command allow discovery of clients present in the FW.
There can be multiple sensor clients and clients for calibration function.</p>
<p>To ease in implantation and allow independent driver handle each client
this transport layer takes advantage of Linux Bus driver model. Each
client is registered as device on the transport bus (ishtp bus).</p>
<p>Enumeration sequence of messages:</p>
<ul class="simple">
<li>Host sends HOST_START_REQ_CMD, indicating that host ISHTP layer is up.</li>
<li>FW responds with HOST_START_RES_CMD</li>
<li>Host sends HOST_ENUM_REQ_CMD (enumerate FW clients)</li>
<li>FW responds with HOST_ENUM_RES_CMD that includes bitmap of available FW
client IDs</li>
<li>For each FW ID found in that bitmap host sends
HOST_CLIENT_PROPERTIES_REQ_CMD</li>
<li>FW responds with HOST_CLIENT_PROPERTIES_RES_CMD. Properties include UUID,
max ISHTP message size, etc.</li>
<li>Once host received properties for that last discovered client, it considers
ISHTP device fully functional (and allocates DMA buffers)</li>
</ul>
</div>
</div>
<div class="section" id="hid-over-ish-client">
<h3>3.4 HID over ISH Client<a class="headerlink" href="#hid-over-ish-client" title="Permalink to this headline">¶</a></h3>
<p>Location: drivers/hid/intel-ish-hid</p>
<p>The ISHTP client driver is responsible for:</p>
<ul class="simple">
<li>enumerate HID devices under FW ISH client</li>
<li>Get Report descriptor</li>
<li>Register with HID core as a LL driver</li>
<li>Process Get/Set feature request</li>
<li>Get input reports</li>
</ul>
</div>
<div class="section" id="hid-sensor-hub-mfd-and-iio-sensor-drivers">
<h3>3.5 HID Sensor Hub MFD and IIO sensor drivers<a class="headerlink" href="#hid-sensor-hub-mfd-and-iio-sensor-drivers" title="Permalink to this headline">¶</a></h3>
<p>The functionality in these drivers is the same as an external sensor hub.
Refer to
Documentation/hid/hid-sensor.rst for HID sensor
Documentation/ABI/testing/sysfs-bus-iio for IIO ABIs to user space</p>
</div>
<div class="section" id="end-to-end-hid-transport-sequence-diagram">
<h3>3.6 End to End HID transport Sequence Diagram<a class="headerlink" href="#end-to-end-hid-transport-sequence-diagram" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>HID-ISH-CLN                    ISHTP                    IPC                             HW
        |                        |                       |                               |
        |                        |                       |-----WAKE UP------------------&gt;|
        |                        |                       |                               |
        |                        |                       |-----HOST READY---------------&gt;|
        |                        |                       |                               |
        |                        |                       |&lt;----MNG_RESET_NOTIFY_ACK----- |
        |                        |                       |                               |
        |                        |&lt;----ISHTP_START------ |                               |
        |                        |                       |                               |
        |                        |&lt;-----------------HOST_START_RES_CMD-------------------|
        |                        |                       |                               |
        |                        |------------------QUERY_SUBSCRIBER--------------------&gt;|
        |                        |                       |                               |
        |                        |------------------HOST_ENUM_REQ_CMD-------------------&gt;|
        |                        |                       |                               |
        |                        |&lt;-----------------HOST_ENUM_RES_CMD--------------------|
        |                        |                       |                               |
        |                        |------------------HOST_CLIENT_PROPERTIES_REQ_CMD------&gt;|
        |                        |                       |                               |
        |                        |&lt;-----------------HOST_CLIENT_PROPERTIES_RES_CMD-------|
        |       Create new device on in ishtp bus        |                               |
        |                        |                       |                               |
        |                        |------------------HOST_CLIENT_PROPERTIES_REQ_CMD------&gt;|
        |                        |                       |                               |
        |                        |&lt;-----------------HOST_CLIENT_PROPERTIES_RES_CMD-------|
        |       Create new device on in ishtp bus        |                               |
        |                        |                       |                               |
        |                        |--Repeat HOST_CLIENT_PROPERTIES_REQ_CMD-till last one--|
        |                        |                       |                               |
     probed()
        |----ishtp_cl_connect---&gt;|----------------- CLIENT_CONNECT_REQ_CMD--------------&gt;|
        |                        |                       |                               |
        |                        |&lt;----------------CLIENT_CONNECT_RES_CMD----------------|
        |                        |                       |                               |
        |register event callback |                       |                               |
        |                        |                       |                               |
        |ishtp_cl_send(
        HOSTIF_DM_ENUM_DEVICES)  |----------fill ishtp_msg_hdr struct write to HW-----  &gt;|
        |                        |                       |                               |
        |                        |                       |&lt;-----IRQ(IPC_PROTOCOL_ISHTP---|
        |                        |                       |                               |
        |&lt;--ENUM_DEVICE RSP------|                       |                               |
        |                        |                       |                               |
for each enumerated device
        |ishtp_cl_send(
        HOSTIF_GET_HID_DESCRIPTOR|----------fill ishtp_msg_hdr struct write to HW-----  &gt;|
        |                        |                       |                               |
        ...Response
        |                        |                       |                               |
for each enumerated device
        |ishtp_cl_send(
     HOSTIF_GET_REPORT_DESCRIPTOR|--------------fill ishtp_msg_hdr struct write to HW-- &gt;|
        |                        |                       |                               |
        |                        |                       |                               |
 hid_allocate_device
        |                        |                       |                               |
 hid_add_device                  |                       |                               |
        |                        |                       |                               |
</pre></div>
</div>
</div>
<div class="section" id="ish-debugging">
<h3>3.7 ISH Debugging<a class="headerlink" href="#ish-debugging" title="Permalink to this headline">¶</a></h3>
<p>To debug ISH, event tracing mechanism is used. To enable debug logs
echo 1 &gt; /sys/kernel/debug/tracing/events/intel_ish/enable
cat sys/kernel/debug/tracing/trace</p>
</div>
<div class="section" id="ish-iio-sysfs-example-on-lenovo-thinkpad-yoga-260">
<h3>3.8 ISH IIO sysfs Example on Lenovo thinkpad Yoga 260<a class="headerlink" href="#ish-iio-sysfs-example-on-lenovo-thinkpad-yoga-260" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>root@otcpl-ThinkPad-Yoga-260:~# tree -l /sys/bus/iio/devices/
/sys/bus/iio/devices/
├── iio:device0 -&gt; ../../../devices/0044:8086:22D8.0001/HID-SENSOR-200073.9.auto/iio:device0
│   ├── buffer
│   │   ├── enable
│   │   ├── length
│   │   └── watermark
...
│   ├── in_accel_hysteresis
│   ├── in_accel_offset
│   ├── in_accel_sampling_frequency
│   ├── in_accel_scale
│   ├── in_accel_x_raw
│   ├── in_accel_y_raw
│   ├── in_accel_z_raw
│   ├── name
│   ├── scan_elements
│   │   ├── in_accel_x_en
│   │   ├── in_accel_x_index
│   │   ├── in_accel_x_type
│   │   ├── in_accel_y_en
│   │   ├── in_accel_y_index
│   │   ├── in_accel_y_type
│   │   ├── in_accel_z_en
│   │   ├── in_accel_z_index
│   │   └── in_accel_z_type
...
│   │   ├── devices
│   │   │   │   ├── buffer
│   │   │   │   │   ├── enable
│   │   │   │   │   ├── length
│   │   │   │   │   └── watermark
│   │   │   │   ├── dev
│   │   │   │   ├── in_intensity_both_raw
│   │   │   │   ├── in_intensity_hysteresis
│   │   │   │   ├── in_intensity_offset
│   │   │   │   ├── in_intensity_sampling_frequency
│   │   │   │   ├── in_intensity_scale
│   │   │   │   ├── name
│   │   │   │   ├── scan_elements
│   │   │   │   │   ├── in_intensity_both_en
│   │   │   │   │   ├── in_intensity_both_index
│   │   │   │   │   └── in_intensity_both_type
│   │   │   │   ├── trigger
│   │   │   │   │   └── current_trigger
...
│   │   │   │   ├── buffer
│   │   │   │   │   ├── enable
│   │   │   │   │   ├── length
│   │   │   │   │   └── watermark
│   │   │   │   ├── dev
│   │   │   │   ├── in_magn_hysteresis
│   │   │   │   ├── in_magn_offset
│   │   │   │   ├── in_magn_sampling_frequency
│   │   │   │   ├── in_magn_scale
│   │   │   │   ├── in_magn_x_raw
│   │   │   │   ├── in_magn_y_raw
│   │   │   │   ├── in_magn_z_raw
│   │   │   │   ├── in_rot_from_north_magnetic_tilt_comp_raw
│   │   │   │   ├── in_rot_hysteresis
│   │   │   │   ├── in_rot_offset
│   │   │   │   ├── in_rot_sampling_frequency
│   │   │   │   ├── in_rot_scale
│   │   │   │   ├── name
...
│   │   │   │   ├── scan_elements
│   │   │   │   │   ├── in_magn_x_en
│   │   │   │   │   ├── in_magn_x_index
│   │   │   │   │   ├── in_magn_x_type
│   │   │   │   │   ├── in_magn_y_en
│   │   │   │   │   ├── in_magn_y_index
│   │   │   │   │   ├── in_magn_y_type
│   │   │   │   │   ├── in_magn_z_en
│   │   │   │   │   ├── in_magn_z_index
│   │   │   │   │   ├── in_magn_z_type
│   │   │   │   │   ├── in_rot_from_north_magnetic_tilt_comp_en
│   │   │   │   │   ├── in_rot_from_north_magnetic_tilt_comp_index
│   │   │   │   │   └── in_rot_from_north_magnetic_tilt_comp_type
│   │   │   │   ├── trigger
│   │   │   │   │   └── current_trigger
...
│   │   │   │   ├── buffer
│   │   │   │   │   ├── enable
│   │   │   │   │   ├── length
│   │   │   │   │   └── watermark
│   │   │   │   ├── dev
│   │   │   │   ├── in_anglvel_hysteresis
│   │   │   │   ├── in_anglvel_offset
│   │   │   │   ├── in_anglvel_sampling_frequency
│   │   │   │   ├── in_anglvel_scale
│   │   │   │   ├── in_anglvel_x_raw
│   │   │   │   ├── in_anglvel_y_raw
│   │   │   │   ├── in_anglvel_z_raw
│   │   │   │   ├── name
│   │   │   │   ├── scan_elements
│   │   │   │   │   ├── in_anglvel_x_en
│   │   │   │   │   ├── in_anglvel_x_index
│   │   │   │   │   ├── in_anglvel_x_type
│   │   │   │   │   ├── in_anglvel_y_en
│   │   │   │   │   ├── in_anglvel_y_index
│   │   │   │   │   ├── in_anglvel_y_type
│   │   │   │   │   ├── in_anglvel_z_en
│   │   │   │   │   ├── in_anglvel_z_index
│   │   │   │   │   └── in_anglvel_z_type
│   │   │   │   ├── trigger
│   │   │   │   │   └── current_trigger
...
│   │   │   │   ├── buffer
│   │   │   │   │   ├── enable
│   │   │   │   │   ├── length
│   │   │   │   │   └── watermark
│   │   │   │   ├── dev
│   │   │   │   ├── in_anglvel_hysteresis
│   │   │   │   ├── in_anglvel_offset
│   │   │   │   ├── in_anglvel_sampling_frequency
│   │   │   │   ├── in_anglvel_scale
│   │   │   │   ├── in_anglvel_x_raw
│   │   │   │   ├── in_anglvel_y_raw
│   │   │   │   ├── in_anglvel_z_raw
│   │   │   │   ├── name
│   │   │   │   ├── scan_elements
│   │   │   │   │   ├── in_anglvel_x_en
│   │   │   │   │   ├── in_anglvel_x_index
│   │   │   │   │   ├── in_anglvel_x_type
│   │   │   │   │   ├── in_anglvel_y_en
│   │   │   │   │   ├── in_anglvel_y_index
│   │   │   │   │   ├── in_anglvel_y_type
│   │   │   │   │   ├── in_anglvel_z_en
│   │   │   │   │   ├── in_anglvel_z_index
│   │   │   │   │   └── in_anglvel_z_type
│   │   │   │   ├── trigger
│   │   │   │   │   └── current_trigger
...
</pre></div>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../i2c/index.html" class="btn btn-neutral float-right" title="I2C/SMBus Subsystem" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="hid-alps.html" class="btn btn-neutral float-left" title="ALPS HID Touchpad Protocol" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>