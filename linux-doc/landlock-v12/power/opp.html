

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Operating Performance Points (OPP) Library &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="PCI Power Management" href="pci.html" />
    <link rel="prev" title="Power Management Interface for System Sleep" href="interface.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.4.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ioctl/index.html">IOCTLs</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Power Management</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="apm-acpi.html">APM or ACPI?</a></li>
<li class="toctree-l2"><a class="reference internal" href="basic-pm-debugging.html">Debugging hibernation and suspend</a></li>
<li class="toctree-l2"><a class="reference internal" href="charger-manager.html">Charger Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="drivers-testing.html">Testing suspend and resume support in device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="energy-model.html">Energy Model of CPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="freezing-of-tasks.html">Freezing of tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="interface.html">Power Management Interface for System Sleep</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Operating Performance Points (OPP) Library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">1. Introduction</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#what-is-an-operating-performance-point-opp">1.1 What is an Operating Performance Point (OPP)?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#operating-performance-points-library">1.2 Operating Performance Points Library</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#initial-opp-list-registration">2. Initial OPP List Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opp-search-functions">3. OPP Search Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opp-availability-control-functions">4. OPP Availability Control Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#opp-data-retrieval-functions">5. OPP Data Retrieval Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-structures">6. Data Structures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="pci.html">PCI Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="pm_qos_interface.html">PM Quality Of Service Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="power_supply_class.html">Linux power supply class</a></li>
<li class="toctree-l2"><a class="reference internal" href="runtime_pm.html">Runtime Power Management Framework for I/O Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="s2ram.html">How to get s2ram working</a></li>
<li class="toctree-l2"><a class="reference internal" href="suspend-and-cpuhotplug.html">Interaction of Suspend code (S3) with the CPU hotplug infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="suspend-and-interrupts.html">System Suspend and Device Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp-and-swap-files.html">Using swap files with software suspend (swsusp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp-dmcrypt.html">How to use dm-crypt and swsusp together</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp.html">Swap suspend</a></li>
<li class="toctree-l2"><a class="reference internal" href="video.html">Video issues with S3 resume</a></li>
<li class="toctree-l2"><a class="reference internal" href="tricks.html">swsusp/S3 tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="userland-swsusp.html">Documentation for userland software suspend interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="powercap/powercap.html">Power Capping Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/consumer.html">Regulator Consumer Driver Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/design.html">Regulator API design notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/machine.html">Regulator Machine Driver Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/overview.html">Linux voltage and current regulator framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/regulator.html">Regulator Driver Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mic/index.html">Intel Many Integrated Core (MIC) architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Power Management</a> &raquo;</li>
        
      <li>Operating Performance Points (OPP) Library</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/power/opp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="operating-performance-points-opp-library">
<h1>Operating Performance Points (OPP) Library<a class="headerlink" href="#operating-performance-points-opp-library" title="Permalink to this headline">¶</a></h1>
<ol class="upperalpha simple" start="3">
<li>2009-2010 Nishanth Menon &lt;<a class="reference external" href="mailto:nm&#37;&#52;&#48;ti&#46;com">nm<span>&#64;</span>ti<span>&#46;</span>com</a>&gt;, Texas Instruments Incorporated</li>
</ol>
<div class="section" id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-is-an-operating-performance-point-opp">
<h3>1.1 What is an Operating Performance Point (OPP)?<a class="headerlink" href="#what-is-an-operating-performance-point-opp" title="Permalink to this headline">¶</a></h3>
<p>Complex SoCs of today consists of a multiple sub-modules working in conjunction.
In an operational system executing varied use cases, not all modules in the SoC
need to function at their highest performing frequency all the time. To
facilitate this, sub-modules in a SoC are grouped into domains, allowing some
domains to run at lower voltage and frequency while other domains run at
voltage/frequency pairs that are higher.</p>
<p>The set of discrete tuples consisting of frequency and voltage pairs that
the device will support per domain are called Operating Performance Points or
OPPs.</p>
<p>As an example:</p>
<p>Let us consider an MPU device which supports the following:
{300MHz at minimum voltage of 1V}, {800MHz at minimum voltage of 1.2V},
{1GHz at minimum voltage of 1.3V}</p>
<p>We can represent these as three OPPs as the following {Hz, uV} tuples:</p>
<ul class="simple">
<li>{300000000, 1000000}</li>
<li>{800000000, 1200000}</li>
<li>{1000000000, 1300000}</li>
</ul>
</div>
<div class="section" id="operating-performance-points-library">
<h3>1.2 Operating Performance Points Library<a class="headerlink" href="#operating-performance-points-library" title="Permalink to this headline">¶</a></h3>
<p>OPP library provides a set of helper functions to organize and query the OPP
information. The library is located in drivers/opp/ directory and the header
is located in include/linux/pm_opp.h. OPP library can be enabled by enabling
CONFIG_PM_OPP from power management menuconfig menu. OPP library depends on
CONFIG_PM as certain SoCs such as Texas Instrument’s OMAP framework allows to
optionally boot at a certain OPP without needing cpufreq.</p>
<p>Typical usage of the OPP library is as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(users)        -&gt; registers a set of default OPPs              -&gt; (library)
SoC framework  -&gt; modifies on required cases certain OPPs      -&gt; OPP layer
               -&gt; queries to search/retrieve information       -&gt;
</pre></div>
</div>
<p>OPP layer expects each domain to be represented by a unique device pointer. SoC
framework registers a set of initial OPPs per device with the OPP layer. This
list is expected to be an optimally small number typically around 5 per device.
This initial list contains a set of OPPs that the framework expects to be safely
enabled by default in the system.</p>
<div class="section" id="note-on-opp-availability">
<h4>Note on OPP Availability<a class="headerlink" href="#note-on-opp-availability" title="Permalink to this headline">¶</a></h4>
<p>As the system proceeds to operate, SoC framework may choose to make certain
OPPs available or not available on each device based on various external
factors. Example usage: Thermal management or other exceptional situations where
SoC framework might choose to disable a higher frequency OPP to safely continue
operations until that OPP could be re-enabled if possible.</p>
<p>OPP library facilitates this concept in it’s implementation. The following
operational functions operate only on available opps:
opp_find_freq_{ceil, floor}, dev_pm_opp_get_voltage, dev_pm_opp_get_freq, dev_pm_opp_get_opp_count</p>
<p>dev_pm_opp_find_freq_exact is meant to be used to find the opp pointer which can then
be used for dev_pm_opp_enable/disable functions to make an opp available as required.</p>
<p>WARNING: Users of OPP library should refresh their availability count using
get_opp_count if dev_pm_opp_enable/disable functions are invoked for a device, the
exact mechanism to trigger these or the notification mechanism to other
dependent subsystems such as cpufreq are left to the discretion of the SoC
specific framework which uses the OPP library. Similar care needs to be taken
care to refresh the cpufreq table in cases of these operations.</p>
</div>
</div>
</div>
<div class="section" id="initial-opp-list-registration">
<h2>2. Initial OPP List Registration<a class="headerlink" href="#initial-opp-list-registration" title="Permalink to this headline">¶</a></h2>
<p>The SoC implementation calls dev_pm_opp_add function iteratively to add OPPs per
device. It is expected that the SoC framework will register the OPP entries
optimally- typical numbers range to be less than 5. The list generated by
registering the OPPs is maintained by OPP library throughout the device
operation. The SoC framework can subsequently control the availability of the
OPPs dynamically using the dev_pm_opp_enable / disable functions.</p>
<dl class="docutils">
<dt>dev_pm_opp_add</dt>
<dd><p class="first">Add a new OPP for a specific domain represented by the device pointer.
The OPP is defined using the frequency and voltage. Once added, the OPP
is assumed to be available and control of it’s availability can be done
with the dev_pm_opp_enable/disable functions. OPP library internally stores
and manages this information in the opp struct. This function may be
used by SoC framework to define a optimal list as per the demands of
SoC usage environment.</p>
<dl class="docutils">
<dt>WARNING:</dt>
<dd>Do not use this function in interrupt context.</dd>
</dl>
<p>Example:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>soc_pm_init()
{
       /* Do things */
       r = dev_pm_opp_add(mpu_dev, 1000000, 900000);
       if (!r) {
               pr_err(&quot;%s: unable to register mpu opp(%d)\n&quot;, r);
               goto no_cpufreq;
       }
       /* Do cpufreq things */
no_cpufreq:
       /* Do remaining things */
}
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="opp-search-functions">
<h2>3. OPP Search Functions<a class="headerlink" href="#opp-search-functions" title="Permalink to this headline">¶</a></h2>
<p>High level framework such as cpufreq operates on frequencies. To map the
frequency back to the corresponding OPP, OPP library provides handy functions
to search the OPP list that OPP library internally manages. These search
functions return the matching pointer representing the opp if a match is
found, else returns error. These errors are expected to be handled by standard
error checks such as IS_ERR() and appropriate actions taken by the caller.</p>
<p>Callers of these functions shall call dev_pm_opp_put() after they have used the
OPP. Otherwise the memory for the OPP will never get freed and result in
memleak.</p>
<dl class="docutils">
<dt>dev_pm_opp_find_freq_exact</dt>
<dd><p class="first">Search for an OPP based on an <em>exact</em> frequency and
availability. This function is especially useful to enable an OPP which
is not available by default.
Example: In a case when SoC framework detects a situation where a
higher frequency could be made available, it can use this function to
find the OPP prior to call the dev_pm_opp_enable to actually make
it available:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>opp = dev_pm_opp_find_freq_exact(dev, 1000000000, false);
dev_pm_opp_put(opp);
/* dont operate on the pointer.. just do a sanity check.. */
if (IS_ERR(opp)) {
       pr_err(&quot;frequency not disabled!\n&quot;);
       /* trigger appropriate actions.. */
} else {
       dev_pm_opp_enable(dev,1000000000);
}
</pre></div>
</div>
<dl class="last docutils">
<dt>NOTE:</dt>
<dd>This is the only search function that operates on OPPs which are
not available.</dd>
</dl>
</dd>
<dt>dev_pm_opp_find_freq_floor</dt>
<dd><p class="first">Search for an available OPP which is <em>at most</em> the
provided frequency. This function is useful while searching for a lesser
match OR operating on OPP information in the order of decreasing
frequency.
Example: To find the highest opp for a device:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>freq = ULONG_MAX;
opp = dev_pm_opp_find_freq_floor(dev, &amp;freq);
dev_pm_opp_put(opp);
</pre></div>
</div>
</dd>
<dt>dev_pm_opp_find_freq_ceil</dt>
<dd><p class="first">Search for an available OPP which is <em>at least</em> the
provided frequency. This function is useful while searching for a
higher match OR operating on OPP information in the order of increasing
frequency.
Example 1: To find the lowest opp for a device:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>freq = 0;
opp = dev_pm_opp_find_freq_ceil(dev, &amp;freq);
dev_pm_opp_put(opp);
</pre></div>
</div>
<p>Example 2: A simplified implementation of a SoC cpufreq_driver-&gt;target:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>soc_cpufreq_target(..)
{
       /* Do stuff like policy checks etc. */
       /* Find the best frequency match for the req */
       opp = dev_pm_opp_find_freq_ceil(dev, &amp;freq);
       dev_pm_opp_put(opp);
       if (!IS_ERR(opp))
               soc_switch_to_freq_voltage(freq);
       else
               /* do something when we can&#39;t satisfy the req */
       /* do other stuff */
}
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="opp-availability-control-functions">
<h2>4. OPP Availability Control Functions<a class="headerlink" href="#opp-availability-control-functions" title="Permalink to this headline">¶</a></h2>
<p>A default OPP list registered with the OPP library may not cater to all possible
situation. The OPP library provides a set of functions to modify the
availability of a OPP within the OPP list. This allows SoC frameworks to have
fine grained dynamic control of which sets of OPPs are operationally available.
These functions are intended to <em>temporarily</em> remove an OPP in conditions such
as thermal considerations (e.g. don’t use OPPx until the temperature drops).</p>
<dl class="docutils">
<dt>WARNING:</dt>
<dd>Do not use these functions in interrupt context.</dd>
<dt>dev_pm_opp_enable</dt>
<dd><p class="first">Make a OPP available for operation.
Example: Lets say that 1GHz OPP is to be made available only if the
SoC temperature is lower than a certain threshold. The SoC framework
implementation might choose to do something as follows:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>if (cur_temp &lt; temp_low_thresh) {
       /* Enable 1GHz if it was disabled */
       opp = dev_pm_opp_find_freq_exact(dev, 1000000000, false);
       dev_pm_opp_put(opp);
       /* just error check */
       if (!IS_ERR(opp))
               ret = dev_pm_opp_enable(dev, 1000000000);
       else
               goto try_something_else;
}
</pre></div>
</div>
</dd>
<dt>dev_pm_opp_disable</dt>
<dd><p class="first">Make an OPP to be not available for operation
Example: Lets say that 1GHz OPP is to be disabled if the temperature
exceeds a threshold value. The SoC framework implementation might
choose to do something as follows:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>if (cur_temp &gt; temp_high_thresh) {
       /* Disable 1GHz if it was enabled */
       opp = dev_pm_opp_find_freq_exact(dev, 1000000000, true);
       dev_pm_opp_put(opp);
       /* just error check */
       if (!IS_ERR(opp))
               ret = dev_pm_opp_disable(dev, 1000000000);
       else
               goto try_something_else;
}
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="opp-data-retrieval-functions">
<h2>5. OPP Data Retrieval Functions<a class="headerlink" href="#opp-data-retrieval-functions" title="Permalink to this headline">¶</a></h2>
<p>Since OPP library abstracts away the OPP information, a set of functions to pull
information from the OPP structure is necessary. Once an OPP pointer is
retrieved using the search functions, the following functions can be used by SoC
framework to retrieve the information represented inside the OPP layer.</p>
<dl class="docutils">
<dt>dev_pm_opp_get_voltage</dt>
<dd><p class="first">Retrieve the voltage represented by the opp pointer.
Example: At a cpufreq transition to a different frequency, SoC
framework requires to set the voltage represented by the OPP using
the regulator framework to the Power Management chip providing the
voltage:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>soc_switch_to_freq_voltage(freq)
{
       /* do things */
       opp = dev_pm_opp_find_freq_ceil(dev, &amp;freq);
       v = dev_pm_opp_get_voltage(opp);
       dev_pm_opp_put(opp);
       if (v)
               regulator_set_voltage(.., v);
       /* do other things */
}
</pre></div>
</div>
</dd>
<dt>dev_pm_opp_get_freq</dt>
<dd><p class="first">Retrieve the freq represented by the opp pointer.
Example: Lets say the SoC framework uses a couple of helper functions
we could pass opp pointers instead of doing additional parameters to
handle quiet a bit of data parameters:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>soc_cpufreq_target(..)
{
       /* do things.. */
        max_freq = ULONG_MAX;
        max_opp = dev_pm_opp_find_freq_floor(dev,&amp;max_freq);
        requested_opp = dev_pm_opp_find_freq_ceil(dev,&amp;freq);
        if (!IS_ERR(max_opp) &amp;&amp; !IS_ERR(requested_opp))
               r = soc_test_validity(max_opp, requested_opp);
        dev_pm_opp_put(max_opp);
        dev_pm_opp_put(requested_opp);
       /* do other things */
}
soc_test_validity(..)
{
        if(dev_pm_opp_get_voltage(max_opp) &lt; dev_pm_opp_get_voltage(requested_opp))
                return -EINVAL;
        if(dev_pm_opp_get_freq(max_opp) &lt; dev_pm_opp_get_freq(requested_opp))
                return -EINVAL;
       /* do things.. */
}
</pre></div>
</div>
</dd>
<dt>dev_pm_opp_get_opp_count</dt>
<dd><p class="first">Retrieve the number of available opps for a device
Example: Lets say a co-processor in the SoC needs to know the available
frequencies in a table, the main processor can notify as following:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>soc_notify_coproc_available_frequencies()
{
       /* Do things */
       num_available = dev_pm_opp_get_opp_count(dev);
       speeds = kzalloc(sizeof(u32) * num_available, GFP_KERNEL);
       /* populate the table in increasing order */
       freq = 0;
       while (!IS_ERR(opp = dev_pm_opp_find_freq_ceil(dev, &amp;freq))) {
               speeds[i] = freq;
               freq++;
               i++;
               dev_pm_opp_put(opp);
       }

       soc_notify_coproc(AVAILABLE_FREQs, speeds, num_available);
       /* Do other things */
}
</pre></div>
</div>
</dd>
</dl>
</div>
<div class="section" id="data-structures">
<h2>6. Data Structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h2>
<p>Typically an SoC contains multiple voltage domains which are variable. Each
domain is represented by a device pointer. The relationship to OPP can be
represented as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SoC
 |- device 1
 |    |- opp 1 (availability, freq, voltage)
 |    |- opp 2 ..
 ...  ...
 |    `- opp n ..
 |- device 2
 ...
 `- device m
</pre></div>
</div>
<p>OPP library maintains a internal list that the SoC framework populates and
accessed by various functions as described above. However, the structures
representing the actual OPPs and domains are internal to the OPP library itself
to allow for suitable abstraction reusable across systems.</p>
<dl class="docutils">
<dt>struct dev_pm_opp</dt>
<dd><p class="first">The internal data structure of OPP library which is used to
represent an OPP. In addition to the freq, voltage, availability
information, it also contains internal book keeping information required
for the OPP library to operate on.  Pointer to this structure is
provided back to the users such as SoC framework to be used as a
identifier for OPP in the interactions with OPP layer.</p>
<dl class="last docutils">
<dt>WARNING:</dt>
<dd>The struct dev_pm_opp pointer should not be parsed or modified by the
users. The defaults of for an instance is populated by
dev_pm_opp_add, but the availability of the OPP can be modified
by dev_pm_opp_enable/disable functions.</dd>
</dl>
</dd>
<dt>struct device</dt>
<dd>This is used to identify a domain to the OPP layer. The
nature of the device and it’s implementation is left to the user of
OPP library such as the SoC framework.</dd>
</dl>
<p>Overall, in a simplistic view, the data structure operations is represented as
following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Initialization / modification:
            +-----+        /- dev_pm_opp_enable
dev_pm_opp_add --&gt; | opp | &lt;-------
  |         +-----+        \- dev_pm_opp_disable
  \-------&gt; domain_info(device)

Search functions:
             /-- dev_pm_opp_find_freq_ceil  ---\   +-----+
domain_info&lt;---- dev_pm_opp_find_freq_exact -----&gt; | opp |
             \-- dev_pm_opp_find_freq_floor ---/   +-----+

Retrieval functions:
+-----+     /- dev_pm_opp_get_voltage
| opp | &lt;---
+-----+     \- dev_pm_opp_get_freq

domain_info &lt;- dev_pm_opp_get_opp_count
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="pci.html" class="btn btn-neutral float-right" title="PCI Power Management" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="interface.html" class="btn btn-neutral float-left" title="Power Management Interface for System Sleep" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>