

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Universal Flash Storage &mdash; The Linux Kernel 5.7.0-rc7+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Driver for Western Digital WD7193, WD7197 and WD7296 SCSI cards" href="wd719x.html" />
    <link rel="prev" title="tcm_qla2xxx Driver Notes" href="tcm_qla2xxx.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0-rc7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux SCSI Subsystem</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="53c700.html">The 53c700 Driver Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="aacraid.html">AACRAID Driver for Linux (take two)</a></li>
<li class="toctree-l2"><a class="reference internal" href="advansys.html">AdvanSys Driver Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="aha152x.html">Adaptec AHA-1520/1522 SCSI driver for Linux (aha152x)</a></li>
<li class="toctree-l2"><a class="reference internal" href="aic79xx.html">Adaptec Ultra320 Family Manager Set</a></li>
<li class="toctree-l2"><a class="reference internal" href="aic7xxx.html">Adaptec Aic7xxx Fast -&gt; Ultra160 Family Manager Set v7.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcmsr_spec.html">ARECA FIRMWARE SPEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcmsr_spec.html#usage-of-iop331-adapter">Usage of IOP331 adapter</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcmsr_spec.html#rs-232-interface-for-areca-raid-controller">RS-232 Interface for Areca Raid Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="bfa.html">Linux driver for Brocade FC/FCOE adapters</a></li>
<li class="toctree-l2"><a class="reference internal" href="bnx2fc.html">Operating FCoE using bnx2fc</a></li>
<li class="toctree-l2"><a class="reference internal" href="BusLogic.html">BusLogic MultiMaster and FlashPoint SCSI Driver for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="cxgb3i.html">Chelsio S3 iSCSI Driver for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="dc395x.html">README file for the dc395x SCSI driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="dpti.html">Adaptec dpti driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="FlashPoint.html">The BusLogic FlashPoint SCSI Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="g_NCR5380.html">README file for the Linux g_NCR5380 driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="hpsa.html">HPSA - Hewlett Packard Smart Array driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="hptiop.html">Highpoint RocketRAID 3xxx/4xxx Adapter Driver (hptiop)</a></li>
<li class="toctree-l2"><a class="reference internal" href="libsas.html">SAS Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="link_power_management_policy.html">Link Power Managent Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="lpfc.html">LPFC Driver Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="megaraid.html">Notes on Management Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="ncr53c8xx.html">The Linux NCR53C8XX/SYM53C8XX drivers README file</a></li>
<li class="toctree-l2"><a class="reference internal" href="NinjaSCSI.html">WorkBiT NinjaSCSI-3/32Bi driver for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppa.html">Terse where to get ZIP Drive help info</a></li>
<li class="toctree-l2"><a class="reference internal" href="qlogicfas.html">Qlogic FASXXX Family Driver Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi-changer.html">README for the SCSI media changer driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi_eh.html">SCSI EH</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi_fc_transport.html">SCSI FC Tansport</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi-generic.html">Notes on Linux SCSI Generic (sg) driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi_mid_low_api.html">SCSI mid_level - lower_level driver interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi-parameters.html">SCSI Kernel Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi.html">SCSI subsystem documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="sd-parameters.html">Linux SCSI Disk Driver (sd) Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="smartpqi.html">SMARTPQI - Microsemi Smart PQI Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="st.html">The SCSI Tape Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="sym53c500_cs.html">The sym53c500_cs Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="sym53c8xx_2.html">The Linux SYM-2 driver documentation file</a></li>
<li class="toctree-l2"><a class="reference internal" href="tcm_qla2xxx.html">tcm_qla2xxx Driver Notes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Universal Flash Storage</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">1. Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ufs-architecture-overview">2. UFS Architecture Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#application-layer">2.1 Application Layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ufs-transport-protocol-utp-layer">2.2 UFS Transport Protocol(UTP) layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ufs-interconnect-uic-layer">2.3 UFS Interconnect(UIC) Layer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#ufshcd-overview">3. UFSHCD Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ufs-controller-initialization">3.1 UFS controller initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utp-transfer-requests">3.2 UTP Transfer requests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ufs-error-handling">3.3 UFS error handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scsi-error-handling">3.4 SCSI Error handling</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#bsg-support">4. BSG Support</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="wd719x.html">Driver for Western Digital WD7193, WD7197 and WD7296 SCSI cards</a></li>
<li class="toctree-l2"><a class="reference internal" href="scsi_transport_srp/figures.html">SCSI RDMA (SRP) transport class diagram</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux SCSI Subsystem</a> &raquo;</li>
        
      <li>Universal Flash Storage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/scsi/ufs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="universal-flash-storage">
<h1>Universal Flash Storage<a class="headerlink" href="#universal-flash-storage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Universal Flash Storage(UFS) is a storage specification for flash devices.
It is aimed to provide a universal storage interface for both
embedded and removable flash memory based storage in mobile
devices such as smart phones and tablet computers. The specification
is defined by JEDEC Solid State Technology Association. UFS is based
on MIPI M-PHY physical layer standard. UFS uses MIPI M-PHY as the
physical layer and MIPI Unipro as the link layer.</p>
<p>The main goals of UFS is to provide:</p>
<blockquote>
<div><ul>
<li><p>Optimized performance:</p>
<p>For UFS version 1.0 and 1.1 the target performance is as follows:</p>
<ul class="simple">
<li><p>Support for Gear1 is mandatory (rate A: 1248Mbps, rate B: 1457.6Mbps)</p></li>
<li><p>Support for Gear2 is optional (rate A: 2496Mbps, rate B: 2915.2Mbps)</p></li>
</ul>
<p>Future version of the standard,</p>
<ul class="simple">
<li><p>Gear3 (rate A: 4992Mbps, rate B: 5830.4Mbps)</p></li>
</ul>
</li>
<li><p>Low power consumption</p></li>
<li><p>High random IOPs and low latency</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="ufs-architecture-overview">
<h2>2. UFS Architecture Overview<a class="headerlink" href="#ufs-architecture-overview" title="Permalink to this headline">¶</a></h2>
<p>UFS has a layered communication architecture which is based on SCSI
SAM-5 architectural model.</p>
<p>UFS communication architecture consists of following layers,</p>
<div class="section" id="application-layer">
<h3>2.1 Application Layer<a class="headerlink" href="#application-layer" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The Application layer is composed of UFS command set layer(UCS),
Task Manager and Device manager. The UFS interface is designed to be
protocol agnostic, however SCSI has been selected as a baseline
protocol for versions 1.0 and 1.1 of UFS protocol  layer.</p>
<p>UFS supports subset of SCSI commands defined by SPC-4 and SBC-3.</p>
<ul class="simple">
<li><dl class="simple">
<dt>UCS:</dt><dd><p>It handles SCSI commands supported by UFS specification.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Task manager:</dt><dd><p>It handles task management functions defined by the
UFS which are meant for command queue control.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Device manager:</dt><dd><p>It handles device level operations and device
configuration operations. Device level operations mainly involve
device power management operations and commands to Interconnect
layers. Device level configurations involve handling of query
requests which are used to modify and retrieve configuration
information of the device.</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="ufs-transport-protocol-utp-layer">
<h3>2.2 UFS Transport Protocol(UTP) layer<a class="headerlink" href="#ufs-transport-protocol-utp-layer" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>UTP layer provides services for
the higher layers through Service Access Points. UTP defines 3
service access points for higher layers.</p>
<ul class="simple">
<li><p>UDM_SAP: Device manager service access point is exposed to device
manager for device level operations. These device level operations
are done through query requests.</p></li>
<li><p>UTP_CMD_SAP: Command service access point is exposed to UFS command
set layer(UCS) to transport commands.</p></li>
<li><p>UTP_TM_SAP: Task management service access point is exposed to task
manager to transport task management functions.</p></li>
</ul>
<p>UTP transports messages through UFS protocol information unit(UPIU).</p>
</div></blockquote>
</div>
<div class="section" id="ufs-interconnect-uic-layer">
<h3>2.3 UFS Interconnect(UIC) Layer<a class="headerlink" href="#ufs-interconnect-uic-layer" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>UIC is the lowest layer of UFS layered architecture. It handles
connection between UFS host and UFS device. UIC consists of
MIPI UniPro and MIPI M-PHY. UIC provides 2 service access points
to upper layer,</p>
<ul class="simple">
<li><p>UIC_SAP: To transport UPIU between UFS host and UFS device.</p></li>
<li><p>UIO_SAP: To issue commands to Unipro layers.</p></li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="ufshcd-overview">
<h2>3. UFSHCD Overview<a class="headerlink" href="#ufshcd-overview" title="Permalink to this headline">¶</a></h2>
<p>The UFS host controller driver is based on Linux SCSI Framework.
UFSHCD is a low level device driver which acts as an interface between
SCSI Midlayer and PCIe based UFS host controllers.</p>
<p>The current UFSHCD implementation supports following functionality,</p>
<div class="section" id="ufs-controller-initialization">
<h3>3.1 UFS controller initialization<a class="headerlink" href="#ufs-controller-initialization" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>The initialization module brings UFS host controller to active state
and prepares the controller to transfer commands/response between
UFSHCD and UFS device.</p>
</div></blockquote>
</div>
<div class="section" id="utp-transfer-requests">
<h3>3.2 UTP Transfer requests<a class="headerlink" href="#utp-transfer-requests" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Transfer request handling module of UFSHCD receives SCSI commands
from SCSI Midlayer, forms UPIUs and issues the UPIUs to UFS Host
controller. Also, the module decodes, responses received from UFS
host controller in the form of UPIUs and intimates the SCSI Midlayer
of the status of the command.</p>
</div></blockquote>
</div>
<div class="section" id="ufs-error-handling">
<h3>3.3 UFS error handling<a class="headerlink" href="#ufs-error-handling" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>Error handling module handles Host controller fatal errors,
Device fatal errors and UIC interconnect layer related errors.</p>
</div></blockquote>
</div>
<div class="section" id="scsi-error-handling">
<h3>3.4 SCSI Error handling<a class="headerlink" href="#scsi-error-handling" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><p>This is done through UFSHCD SCSI error handling routines registered
with SCSI Midlayer. Examples of some of the error handling commands
issues by SCSI Midlayer are Abort task, Lun reset and host reset.
UFSHCD Routines to perform these tasks are registered with
SCSI Midlayer through .eh_abort_handler, .eh_device_reset_handler and
.eh_host_reset_handler.</p>
</div></blockquote>
<p>In this version of UFSHCD Query requests and power management
functionality are not implemented.</p>
</div>
</div>
<div class="section" id="bsg-support">
<h2>4. BSG Support<a class="headerlink" href="#bsg-support" title="Permalink to this headline">¶</a></h2>
<p>This transport driver supports exchanging UFS protocol information units
(UPIUs) with a UFS device. Typically, user space will allocate
struct ufs_bsg_request and struct ufs_bsg_reply (see ufs_bsg.h) as
request_upiu and reply_upiu respectively.  Filling those UPIUs should
be done in accordance with JEDEC spec UFS2.1 paragraph 10.7.
<em>Caveat emptor</em>: The driver makes no further input validations and sends the
UPIU to the device as it is.  Open the bsg device in /dev/ufs-bsg and
send SG_IO with the applicable sg_io_v4:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>io_hdr_v4.guard = &#39;Q&#39;;
io_hdr_v4.protocol = BSG_PROTOCOL_SCSI;
io_hdr_v4.subprotocol = BSG_SUB_PROTOCOL_SCSI_TRANSPORT;
io_hdr_v4.response = (__u64)reply_upiu;
io_hdr_v4.max_response_len = reply_len;
io_hdr_v4.request_len = request_len;
io_hdr_v4.request = (__u64)request_upiu;
if (dir == SG_DXFER_TO_DEV) {
        io_hdr_v4.dout_xfer_len = (uint32_t)byte_cnt;
        io_hdr_v4.dout_xferp = (uintptr_t)(__u64)buff;
} else {
        io_hdr_v4.din_xfer_len = (uint32_t)byte_cnt;
        io_hdr_v4.din_xferp = (uintptr_t)(__u64)buff;
}
</pre></div>
</div>
<p>If you wish to read or write a descriptor, use the appropriate xferp of
sg_io_v4.</p>
<p>The userspace tool that interacts with the ufs-bsg endpoint and uses its
upiu-based protocol is available at:</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/westerndigitalcorporation/ufs-tool">https://github.com/westerndigitalcorporation/ufs-tool</a></p>
</div></blockquote>
<p>For more detailed information about the tool and its supported
features, please see the tool’s README.</p>
<p>UFS Specifications can be found at:</p>
<ul class="simple">
<li><p>UFS - <a class="reference external" href="http://www.jedec.org/sites/default/files/docs/JESD220.pdf">http://www.jedec.org/sites/default/files/docs/JESD220.pdf</a></p></li>
<li><p>UFSHCI - <a class="reference external" href="http://www.jedec.org/sites/default/files/docs/JESD223.pdf">http://www.jedec.org/sites/default/files/docs/JESD223.pdf</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="wd719x.html" class="btn btn-neutral float-right" title="Driver for Western Digital WD7193, WD7197 and WD7296 SCSI cards" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tcm_qla2xxx.html" class="btn btn-neutral float-left" title="tcm_qla2xxx Driver Notes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>