

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Kernel TLS &mdash; The Linux Kernel 5.7.0-rc7+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Kernel TLS offload" href="tls-offload.html" />
    <link rel="prev" title="Scaling in the Linux Networking Stack" href="scaling.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0-rc7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Networking Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="netdev-FAQ.html">netdev FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="bareudp.html">Bare UDP Tunnelling Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="batman-adv.html">batman-adv</a></li>
<li class="toctree-l2"><a class="reference internal" href="can.html">SocketCAN - Controller Area Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="can_ucan_protocol.html">The UCAN Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_drivers/index.html">Vendor Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsa/index.html">Distributed Switch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devlink/index.html">Linux Devlink Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool-netlink.html">Netlink interface for ethtool</a></li>
<li class="toctree-l2"><a class="reference internal" href="ieee802154.html">IEEE 802.15.4 Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="j1939.html">J1939 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="kapi.html">Linux Networking and Network Devices APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="z8530book.html">Z8530 Programming Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="msg_zerocopy.html">MSG_ZEROCOPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="failover.html">FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_dim.html">Net DIM - Generic Network Dynamic Interrupt Moderation</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_failover.html">NET_FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">PHY Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp-phylink.html">phylink</a></li>
<li class="toctree-l2"><a class="reference internal" href="alias.html">IP-Aliasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="bridge.html">Ethernet Bridging</a></li>
<li class="toctree-l2"><a class="reference internal" href="snmp_counter.html">SNMP counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="checksum-offloads.html">Checksum Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="segmentation-offloads.html">Segmentation Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="scaling.html">Scaling in the Linux Networking Stack</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kernel TLS</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-interface">User interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-tls-connection">Creating a TLS connection</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sending-tls-application-data">Sending TLS application data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiving-tls-application-data">Receiving TLS application data</a></li>
<li class="toctree-l4"><a class="reference internal" href="#send-tls-control-messages">Send TLS control messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#receiving-tls-control-messages">Receiving TLS control messages</a></li>
<li class="toctree-l4"><a class="reference internal" href="#integrating-in-to-userspace-tls-library">Integrating in to userspace TLS library</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#statistics">Statistics</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tls-offload.html">Kernel TLS offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="nfc.html">Linux NFC subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="6lowpan.html">Netdev private dataroom for 6lowpan interfaces</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Networking Documentation</a> &raquo;</li>
        
      <li>Kernel TLS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/tls.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kernel-tls">
<span id="id1"></span><h1>Kernel TLS<a class="headerlink" href="#kernel-tls" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Transport Layer Security (TLS) is a Upper Layer Protocol (ULP) that runs over
TCP. TLS provides end-to-end data integrity and confidentiality.</p>
</div>
<div class="section" id="user-interface">
<h2>User interface<a class="headerlink" href="#user-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-a-tls-connection">
<h3>Creating a TLS connection<a class="headerlink" href="#creating-a-tls-connection" title="Permalink to this headline">¶</a></h3>
<p>First create a new TCP socket and set the TLS ULP.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_TCP</span><span class="p">,</span> <span class="n">TCP_ULP</span><span class="p">,</span> <span class="s">&quot;tls&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="s">&quot;tls&quot;</span><span class="p">));</span>
</pre></div>
</div>
<p>Setting the TLS ULP allows us to set/get TLS socket options. Currently
only the symmetric encryption is handled in the kernel.  After the TLS
handshake is complete, we have all the parameters required to move the
data-path to the kernel. There is a separate socket option for moving
the transmit and the receive into the kernel.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* From linux/tls.h */</span>
<span class="k">struct</span> <span class="n">tls_crypto_info</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">version</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cipher_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tls12_crypto_info_aes_gcm_128</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">tls_crypto_info</span> <span class="n">info</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iv</span><span class="p">[</span><span class="n">TLS_CIPHER_AES_GCM_128_IV_SIZE</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="n">TLS_CIPHER_AES_GCM_128_KEY_SIZE</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">salt</span><span class="p">[</span><span class="n">TLS_CIPHER_AES_GCM_128_SALT_SIZE</span><span class="p">];</span>
        <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rec_seq</span><span class="p">[</span><span class="n">TLS_CIPHER_AES_GCM_128_REC_SEQ_SIZE</span><span class="p">];</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">tls12_crypto_info_aes_gcm_128</span> <span class="n">crypto_info</span><span class="p">;</span>

<span class="n">crypto_info</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">TLS_1_2_VERSION</span><span class="p">;</span>
<span class="n">crypto_info</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">cipher_type</span> <span class="o">=</span> <span class="n">TLS_CIPHER_AES_GCM_128</span><span class="p">;</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto_info</span><span class="p">.</span><span class="n">iv</span><span class="p">,</span> <span class="n">iv_write</span><span class="p">,</span> <span class="n">TLS_CIPHER_AES_GCM_128_IV_SIZE</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto_info</span><span class="p">.</span><span class="n">rec_seq</span><span class="p">,</span> <span class="n">seq_number_write</span><span class="p">,</span>
                                      <span class="n">TLS_CIPHER_AES_GCM_128_REC_SEQ_SIZE</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto_info</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">cipher_key_write</span><span class="p">,</span> <span class="n">TLS_CIPHER_AES_GCM_128_KEY_SIZE</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto_info</span><span class="p">.</span><span class="n">salt</span><span class="p">,</span> <span class="n">implicit_iv_write</span><span class="p">,</span> <span class="n">TLS_CIPHER_AES_GCM_128_SALT_SIZE</span><span class="p">);</span>

<span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_TLS</span><span class="p">,</span> <span class="n">TLS_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypto_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crypto_info</span><span class="p">));</span>
</pre></div>
</div>
<p>Transmit and receive are set separately, but the setup is the same, using either
TLS_TX or TLS_RX.</p>
</div>
<div class="section" id="sending-tls-application-data">
<h3>Sending TLS application data<a class="headerlink" href="#sending-tls-application-data" title="Permalink to this headline">¶</a></h3>
<p>After setting the TLS_TX socket option all application data sent over this
socket is encrypted using TLS and the parameters provided in the socket option.
For example, we can send an encrypted hello world record as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;hello world</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">send</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</pre></div>
</div>
<p>send() data is directly encrypted from the userspace buffer provided
to the encrypted kernel send buffer if possible.</p>
<p>The sendfile system call will send the file’s data over TLS records of maximum
length (2^14).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
<span class="n">fstat</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
<span class="n">sendfile</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">stat</span><span class="p">.</span><span class="n">st_size</span><span class="p">);</span>
</pre></div>
</div>
<p>TLS records are created and sent after each send() call, unless
MSG_MORE is passed.  MSG_MORE will delay creation of a record until
MSG_MORE is not passed, or the maximum record size is reached.</p>
<p>The kernel will need to allocate a buffer for the encrypted data.
This buffer is allocated at the time send() is called, such that
either the entire send() call will return -ENOMEM (or block waiting
for memory), or the encryption will always succeed.  If send() returns
-ENOMEM and some data was left on the socket buffer from a previous
call using MSG_MORE, the MSG_MORE data is left on the socket buffer.</p>
</div>
<div class="section" id="receiving-tls-application-data">
<h3>Receiving TLS application data<a class="headerlink" href="#receiving-tls-application-data" title="Permalink to this headline">¶</a></h3>
<p>After setting the TLS_RX socket option, all recv family socket calls
are decrypted using TLS parameters provided.  A full TLS record must
be received before decryption can happen.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16384</span><span class="p">];</span>
<span class="n">recv</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">16384</span><span class="p">);</span>
</pre></div>
</div>
<p>Received data is decrypted directly in to the user buffer if it is
large enough, and no additional allocations occur.  If the userspace
buffer is too small, data is decrypted in the kernel and copied to
userspace.</p>
<p><code class="docutils literal notranslate"><span class="pre">EINVAL</span></code> is returned if the TLS version in the received message does not
match the version passed in setsockopt.</p>
<p><code class="docutils literal notranslate"><span class="pre">EMSGSIZE</span></code> is returned if the received message is too big.</p>
<p><code class="docutils literal notranslate"><span class="pre">EBADMSG</span></code> is returned if decryption failed for any other reason.</p>
</div>
<div class="section" id="send-tls-control-messages">
<h3>Send TLS control messages<a class="headerlink" href="#send-tls-control-messages" title="Permalink to this headline">¶</a></h3>
<p>Other than application data, TLS has control messages such as alert
messages (record type 21) and handshake messages (record type 22), etc.
These messages can be sent over the socket by providing the TLS record type
via a CMSG. For example the following function sends &#64;data of &#64;length bytes
using a record of type &#64;record_type.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/* send TLS control message using record_type */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">klts_send_ctrl_message</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">record_type</span><span class="p">,</span>
                                  <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
      <span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
      <span class="kt">int</span> <span class="n">cmsg_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">record_type</span><span class="p">);</span>
      <span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="n">cmsg_len</span><span class="p">)];</span>
      <span class="k">struct</span> <span class="n">iovec</span> <span class="n">msg_iov</span><span class="p">;</span>   <span class="cm">/* Vector of data to send/receive into.  */</span>

      <span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
      <span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
      <span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
      <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">=</span> <span class="n">SOL_TLS</span><span class="p">;</span>
      <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">=</span> <span class="n">TLS_SET_RECORD_TYPE</span><span class="p">;</span>
      <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span> <span class="o">=</span> <span class="n">CMSG_LEN</span><span class="p">(</span><span class="n">cmsg_len</span><span class="p">);</span>
      <span class="o">*</span><span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">)</span> <span class="o">=</span> <span class="n">record_type</span><span class="p">;</span>
      <span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_len</span><span class="p">;</span>

      <span class="n">msg_iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
      <span class="n">msg_iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
      <span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg_iov</span><span class="p">;</span>
      <span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">return</span> <span class="n">sendmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Control message data should be provided unencrypted, and will be
encrypted by the kernel.</p>
</div>
<div class="section" id="receiving-tls-control-messages">
<h3>Receiving TLS control messages<a class="headerlink" href="#receiving-tls-control-messages" title="Permalink to this headline">¶</a></h3>
<p>TLS control messages are passed in the userspace buffer, with message
type passed via cmsg.  If no cmsg buffer is provided, an error is
returned if a control message is received.  Data messages may be
received without a cmsg buffer set.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">16384</span><span class="p">];</span>
<span class="kt">char</span> <span class="n">cmsg</span><span class="p">[</span><span class="n">CMSG_SPACE</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">))];</span>
<span class="k">struct</span> <span class="n">msghdr</span> <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="n">msg</span><span class="p">.</span><span class="n">msg_control</span> <span class="o">=</span> <span class="n">cmsg</span><span class="p">;</span>
<span class="n">msg</span><span class="p">.</span><span class="n">msg_controllen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmsg</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">iovec</span> <span class="n">msg_iov</span><span class="p">;</span>
<span class="n">msg_iov</span><span class="p">.</span><span class="n">iov_base</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
<span class="n">msg_iov</span><span class="p">.</span><span class="n">iov_len</span> <span class="o">=</span> <span class="mi">16384</span><span class="p">;</span>

<span class="n">msg</span><span class="p">.</span><span class="n">msg_iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg_iov</span><span class="p">;</span>
<span class="n">msg</span><span class="p">.</span><span class="n">msg_iovlen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">recvmsg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* flags */</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">cmsghdr</span> <span class="o">*</span><span class="n">cmsg</span> <span class="o">=</span> <span class="n">CMSG_FIRSTHDR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_level</span> <span class="o">==</span> <span class="n">SOL_TLS</span> <span class="o">&amp;&amp;</span>
    <span class="n">cmsg</span><span class="o">-&gt;</span><span class="n">cmsg_type</span> <span class="o">==</span> <span class="n">TLS_GET_RECORD_TYPE</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">record_type</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">CMSG_DATA</span><span class="p">(</span><span class="n">cmsg</span><span class="p">));</span>
    <span class="c1">// Do something with record_type, and control message data in</span>
    <span class="c1">// buffer.</span>
    <span class="c1">//</span>
    <span class="c1">// Note that record_type may be == to application data (23).</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Buffer contains application data.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>recv will never return data from mixed types of TLS records.</p>
</div>
<div class="section" id="integrating-in-to-userspace-tls-library">
<h3>Integrating in to userspace TLS library<a class="headerlink" href="#integrating-in-to-userspace-tls-library" title="Permalink to this headline">¶</a></h3>
<p>At a high level, the kernel TLS ULP is a replacement for the record
layer of a userspace TLS library.</p>
<p>A patchset to OpenSSL to use ktls as the record layer is
<a class="reference external" href="https://github.com/Mellanox/openssl/commits/tls_rx2">here</a>.</p>
<p><a class="reference external" href="https://github.com/ktls/af_ktls-tool/commits/RX">An example</a>
of calling send directly after a handshake using gnutls.
Since it doesn’t implement a full record layer, control
messages are not supported.</p>
</div>
</div>
<div class="section" id="statistics">
<h2>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h2>
<p>TLS implementation exposes the following per-namespace statistics
(<code class="docutils literal notranslate"><span class="pre">/proc/net/tls_stat</span></code>):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TlsCurrTxSw</span></code>, <code class="docutils literal notranslate"><span class="pre">TlsCurrRxSw</span></code> -
number of TX and RX sessions currently installed where host handles
cryptography</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsCurrTxDevice</span></code>, <code class="docutils literal notranslate"><span class="pre">TlsCurrRxDevice</span></code> -
number of TX and RX sessions currently installed where NIC handles
cryptography</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsTxSw</span></code>, <code class="docutils literal notranslate"><span class="pre">TlsRxSw</span></code> -
number of TX and RX sessions opened with host cryptography</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsTxDevice</span></code>, <code class="docutils literal notranslate"><span class="pre">TlsRxDevice</span></code> -
number of TX and RX sessions opened with NIC cryptography</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsDecryptError</span></code> -
record decryption failed (e.g. due to incorrect authentication tag)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TlsDeviceRxResync</span></code> -
number of RX resyncs sent to NICs handling cryptography</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tls-offload.html" class="btn btn-neutral float-right" title="Kernel TLS offload" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="scaling.html" class="btn btn-neutral float-left" title="Scaling in the Linux Networking Stack" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>