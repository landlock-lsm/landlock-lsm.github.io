

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fallback mechanisms &mdash; The Linux Kernel 4.11.0-rc3+ documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 4.11.0-rc3+ documentation" href="../../index.html"/>
        <link rel="up" title="Firmware API core features" href="core.html"/>
        <link rel="next" title="Firmware lookup order" href="lookup-order.html"/>
        <link rel="prev" title="Direct filesystem lookup" href="direct-fs-lookup.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.11.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user&#8217;s and administrator&#8217;s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux driver implementer&#8217;s API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../basics.html">Driver Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infrastructure.html">Device drivers infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">Device Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma-buf.html">Buffer Sharing and Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_link.html">Device links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../message-based.html">Message-based devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sound.html">Sound Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input.html">Input Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb.html">The Linux-USB Host Side API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../80211/index.html">Linux 802.11 Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Linux Firmware API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="core.html">Firmware API core features</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="fw_search_path.html">Firmware search paths</a></li>
<li class="toctree-l4"><a class="reference internal" href="built-in-fw.html">Built-in firmware</a></li>
<li class="toctree-l4"><a class="reference internal" href="firmware_cache.html">Firmware cache</a></li>
<li class="toctree-l4"><a class="reference internal" href="direct-fs-lookup.html">Direct filesystem lookup</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Fallback mechanisms</a></li>
<li class="toctree-l4"><a class="reference internal" href="lookup-order.html">Firmware lookup order</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="request_firmware.html">request_firmware API</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Linux Kernel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">The Linux driver implementer&#8217;s API guide</a> &raquo;</li>
      
          <li><a href="index.html">Linux Firmware API</a> &raquo;</li>
      
          <li><a href="core.html">Firmware API core features</a> &raquo;</li>
      
    <li>Fallback mechanisms</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/driver-api/firmware/fallback-mechanisms.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fallback-mechanisms">
<h1>Fallback mechanisms<a class="headerlink" href="#fallback-mechanisms" title="Permalink to this headline">¶</a></h1>
<p>A fallback mechanism is supported to allow to overcome failures to do a direct
filesystem lookup on the root filesystem or when the firmware simply cannot be
installed for practical reasons on the root filesystem. The kernel
configuration options related to supporting the firmware fallback mechanism are:</p>
<blockquote>
<div><ul class="simple">
<li>CONFIG_FW_LOADER_USER_HELPER: enables building the firmware fallback
mechanism. Most distributions enable this option today. If enabled but
CONFIG_FW_LOADER_USER_HELPER_FALLBACK is disabled, only the custom fallback
mechanism is available and for the request_firmware_nowait() call.</li>
<li>CONFIG_FW_LOADER_USER_HELPER_FALLBACK: force enables each request to
enable the kobject uevent fallback mechanism on all firmware API calls
except request_firmware_direct(). Most distributions disable this option
today. The call request_firmware_nowait() allows for one alternative
fallback mechanism: if this kconfig option is enabled and your second
argument to request_firmware_nowait(), uevent, is set to false you are
informing the kernel that you have a custom fallback mechanism and it will
manually load the firmware. Read below for more details.</li>
</ul>
</div></blockquote>
<p>Note that this means when having this configuration:</p>
<p>CONFIG_FW_LOADER_USER_HELPER=y
CONFIG_FW_LOADER_USER_HELPER_FALLBACK=n</p>
<p>the kobject uevent fallback mechanism will never take effect even
for request_firmware_nowait() when uevent is set to true.</p>
<div class="section" id="justifying-the-firmware-fallback-mechanism">
<h2>Justifying the firmware fallback mechanism<a class="headerlink" href="#justifying-the-firmware-fallback-mechanism" title="Permalink to this headline">¶</a></h2>
<p>Direct filesystem lookups may fail for a variety of reasons. Known reasons for
this are worth itemizing and documenting as it justifies the need for the
fallback mechanism:</p>
<ul class="simple">
<li>Race against access with the root filesystem upon bootup.</li>
<li>Races upon resume from suspend. This is resolved by the firmware cache, but
the firmware cache is only supported if you use uevents, and its not
supported for request_firmware_into_buf().</li>
<li><dl class="first docutils">
<dt>Firmware is not accessible through typical means:</dt>
<dd><ul class="first last">
<li>It cannot be installed into the root filesystem</li>
<li>The firmware provides very unique device specific data tailored for
the unit gathered with local information. An example is calibration
data for WiFi chipsets for mobile devices. This calibration data is
not common to all units, but tailored per unit.  Such information may
be installed on a separate flash partition other than where the root
filesystem is provided.</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="types-of-fallback-mechanisms">
<h2>Types of fallback mechanisms<a class="headerlink" href="#types-of-fallback-mechanisms" title="Permalink to this headline">¶</a></h2>
<p>There are really two fallback mechanisms available using one shared sysfs
interface as a loading facility:</p>
<ul class="simple">
<li>Kobject uevent fallback mechanism</li>
<li>Custom fallback mechanism</li>
</ul>
<p>First lets document the shared sysfs loading facility.</p>
</div>
<div class="section" id="firmware-sysfs-loading-facility">
<h2>Firmware sysfs loading facility<a class="headerlink" href="#firmware-sysfs-loading-facility" title="Permalink to this headline">¶</a></h2>
<p>In order to help device drivers upload firmware using a fallback mechanism
the firmware infrastructure creates a sysfs interface to enable userspace
to load and indicate when firmware is ready. The sysfs directory is created
via fw_create_instance(). This call creates a new struct device named after
the firmware requested, and establishes it in the device hierarchy by
associating the device used to make the request as the device&#8217;s parent.
The sysfs directory&#8217;s file attributes are defined and controlled through
the new device&#8217;s class (firmare_class) and group (fw_dev_attr_groups).
This is actually where the original firmware_class.c file name comes from,
as originally the only firmware loading mechanism available was the
mechanism we now use as a fallback mechanism.</p>
<p>To load firmware using the sysfs interface we expose a loading indicator,
and a file upload firmware into:</p>
<blockquote>
<div><ul class="simple">
<li>/sys/$DEVPATH/loading</li>
<li>/sys/$DEVPATH/data</li>
</ul>
</div></blockquote>
<p>To upload firmware you will echo 1 onto the loading file to indicate
you are loading firmware. You then cat the firmware into the data file,
and you notify the kernel the firmware is ready by echo&#8217;ing 0 onto
the loading file.</p>
<p>The firmware device used to help load firmware using sysfs is only created if
direct firmware loading fails and if the fallback mechanism is enabled for your
firmware request, this is set up with fw_load_from_user_helper().  It is
important to re-iterate that no device is created if a direct filesystem lookup
succeeded.</p>
<p>Using:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>echo 1 &gt; /sys/$DEVPATH/loading
</pre></div>
</div>
<p>Will clean any previous partial load at once and make the firmware API
return an error. When loading firmware the firmware_class grows a buffer
for the firmware in PAGE_SIZE increments to hold the image as it comes in.</p>
<p>firmware_data_read() and firmware_loading_show() are just provided for the
test_firmware driver for testing, they are not called in normal use or
expected to be used regularly by userspace.</p>
</div>
<div class="section" id="firmware-kobject-uevent-fallback-mechanism">
<h2>Firmware kobject uevent fallback mechanism<a class="headerlink" href="#firmware-kobject-uevent-fallback-mechanism" title="Permalink to this headline">¶</a></h2>
<p>Since a device is created for the sysfs interface to help load firmware as a
fallback mechanism userspace can be informed of the addition of the device by
relying on kobject uevents. The addition of the device into the device
hierarchy means the fallback mechanism for firmware loading has been initiated.
For details of implementation refer to _request_firmware_load(), in particular
on the use of dev_set_uevent_suppress() and kobject_uevent().</p>
<p>The kernel&#8217;s kobject uevent mechanism is implemented in lib/kobject_uevent.c,
it issues uevents to userspace. As a supplement to kobject uevents Linux
distributions could also enable CONFIG_UEVENT_HELPER_PATH, which makes use of
core kernel&#8217;s usermode helper (UMH) functionality to call out to a userspace
helper for kobject uevents. In practice though no standard distribution has
ever used the CONFIG_UEVENT_HELPER_PATH. If CONFIG_UEVENT_HELPER_PATH is
enabled this binary would be called each time kobject_uevent_env() gets called
in the kernel for each kobject uevent triggered.</p>
<p>Different implementations have been supported in userspace to take advantage of
this fallback mechanism. When firmware loading was only possible using the
sysfs mechanism the userspace component &#8220;hotplug&#8221; provided the functionality of
monitoring for kobject events. Historically this was superseded be systemd&#8217;s
udev, however firmware loading support was removed from udev as of systemd
commit be2ea723b1d0 (&#8220;udev: remove userspace firmware loading support&#8221;)
as of v217 on August, 2014. This means most Linux distributions today are
not using or taking advantage of the firmware fallback mechanism provided
by kobject uevents. This is specially exacerbated due to the fact that most
distributions today disable CONFIG_FW_LOADER_USER_HELPER_FALLBACK.</p>
<p>Refer to do_firmware_uevent() for details of the kobject event variables
setup. Variables passwdd with a kobject add event:</p>
<ul class="simple">
<li>FIRMWARE=firmware name</li>
<li>TIMEOUT=timeout value</li>
<li>ASYNC=whether or not the API request was asynchronous</li>
</ul>
<p>By default DEVPATH is set by the internal kernel kobject infrastructure.
Below is an example simple kobject uevent script:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span># Both $DEVPATH and $FIRMWARE are already provided in the environment.
MY_FW_DIR=/lib/firmware/
echo 1 &gt; /sys/$DEVPATH/loading
cat $MY_FW_DIR/$FIRMWARE &gt; /sys/$DEVPATH/data
echo 0 &gt; /sys/$DEVPATH/loading
</pre></div>
</div>
</div>
<div class="section" id="firmware-custom-fallback-mechanism">
<h2>Firmware custom fallback mechanism<a class="headerlink" href="#firmware-custom-fallback-mechanism" title="Permalink to this headline">¶</a></h2>
<p>Users of the request_firmware_nowait() call have yet another option available
at their disposal: rely on the sysfs fallback mechanism but request that no
kobject uevents be issued to userspace. The original logic behind this
was that utilities other than udev might be required to lookup firmware
in non-traditional paths &#8211; paths outside of the listing documented in the
section &#8216;Direct filesystem lookup&#8217;. This option is not available to any of
the other API calls as uevents are always forced for them.</p>
<p>Since uevents are only meaningful if the fallback mechanism is enabled
in your kernel it would seem odd to enable uevents with kernels that do not
have the fallback mechanism enabled in their kernels. Unfortunately we also
rely on the uevent flag which can be disabled by request_firmware_nowait() to
also setup the firmware cache for firmware requests. As documented above,
the firmware cache is only set up if uevent is enabled for an API call.
Although this can disable the firmware cache for request_firmware_nowait()
calls, users of this API should not use it for the purposes of disabling
the cache as that was not the original purpose of the flag. Not setting
the uevent flag means you want to opt-in for the firmware fallback mechanism
but you want to suppress kobject uevents, as you have a custom solution which
will monitor for your device addition into the device hierarchy somehow and
load firmware for you through a custom path.</p>
</div>
<div class="section" id="firmware-fallback-timeout">
<h2>Firmware fallback timeout<a class="headerlink" href="#firmware-fallback-timeout" title="Permalink to this headline">¶</a></h2>
<p>The firmware fallback mechanism has a timeout. If firmware is not loaded
onto the sysfs interface by the timeout value an error is sent to the
driver. By default the timeout is set to 60 seconds if uevents are
desirable, otherwise MAX_JIFFY_OFFSET is used (max timeout possible).
The logic behind using MAX_JIFFY_OFFSET for non-uevents is that a custom
solution will have as much time as it needs to load firmware.</p>
<p>You can customize the firmware timeout by echo&#8217;ing your desired timeout into
the following file:</p>
<ul class="simple">
<li>/sys/class/firmware/timeout</li>
</ul>
<p>If you echo 0 into it means MAX_JIFFY_OFFSET will be used. The data type
for the timeout is an int.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lookup-order.html" class="btn btn-neutral float-right" title="Firmware lookup order" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="direct-fs-lookup.html" class="btn btn-neutral" title="Direct filesystem lookup" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.11.0-rc3+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>