

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>28. The Soc-Camera Drivers &mdash; The Linux Kernel 4.11.0-rc3+ documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 4.11.0-rc3+ documentation" href="../../index.html"/>
        <link rel="up" title="Video4Linux (V4L) driver-specific documentation" href="index.html"/>
        <link rel="next" title="29. The Linux USB Video Class (UVC) driver" href="uvcvideo.html"/>
        <link rel="prev" title="27. The SI476x Driver" href="si476x.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                4.11.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user&#8217;s and administrator&#8217;s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer&#8217;s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Media Subsystem Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../media_uapi.html">Linux Media Infrastructure userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../media_kapi.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dvb-drivers/index.html">Linux Digital TV driver-specific documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Video4Linux (V4L)  driver-specific documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="fourcc.html">1. Guidelines for Video4Linux pixel format 4CCs</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html">2. Infrared remote control support in video4linux drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html#using-with-lircd">3. Using with lircd</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html#using-without-lircd">4. Using without lircd</a></li>
<li class="toctree-l3"><a class="reference internal" href="tuners.html">5. Tuner drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="cardlist.html">6. Cards List</a></li>
<li class="toctree-l3"><a class="reference internal" href="bttv.html">7. The bttv driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cafe_ccic.html">8. The cafe_ccic driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpia2.html">9. The cpia2 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx18.html">10. The cx18 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx2341x.html">11. The cx2341x driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx88.html">12. The cx88 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="davinci-vpbe.html">13. The VPBE V4L2 driver design</a></li>
<li class="toctree-l3"><a class="reference internal" href="fimc.html">14. The Samsung S5P/EXYNOS4 FIMC driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="ivtv.html">15. The ivtv driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="meye.html">16. Vaio Picturebook Motion Eye Camera Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="omap3isp.html">17. OMAP 3 Image Signal Processor (ISP) driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="omap4_camera.html">18. OMAP4 ISS Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="pvrusb2.html">19. The pvrusb2 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="pxa_camera.html">20. PXA-Camera Host Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="radiotrack.html">21. The Radiotrack radio driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="rcar-fdp1.html">22. Renesas R-Car Fine Display Processor (FDP1) Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="saa7134.html">23. The saa7134 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="sh_mobile_ceu_camera.html">24. Cropping and Scaling algorithm, used in the sh_mobile_ceu_camera driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si470x.html">25. The Silicon Labs Si470x FM Radio Receivers driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si4713.html">26. The Silicon Labs Si4713 FM Radio Transmitter Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si476x.html">27. The SI476x Driver</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">28. The Soc-Camera Drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#terminology">28.1. Terminology</a></li>
<li class="toctree-l4"><a class="reference internal" href="#purpose-of-the-soc-camera-subsystem">28.2. Purpose of the soc-camera subsystem</a></li>
<li class="toctree-l4"><a class="reference internal" href="#existing-drivers">28.3. Existing drivers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#camera-host-api">28.4. Camera host API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#camera-api">28.5. Camera API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#vidioc-s-crop-and-vidioc-s-fmt-behaviour">28.6. VIDIOC_S_CROP and VIDIOC_S_FMT behaviour</a></li>
<li class="toctree-l4"><a class="reference internal" href="#format-conversion">28.7. Format conversion</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="uvcvideo.html">29. The Linux USB Video Class (UVC) driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="vivid.html">30. The Virtual Video Test Driver (vivid)</a></li>
<li class="toctree-l3"><a class="reference internal" href="zoran.html">31. The Zoran driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="zr364xx.html">32. Zoran 364xx based USB webcam module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer&#8217;s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/ko_KR/index.html">Korean translations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/zh_CN/index.html">Chinese translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">The Linux Kernel</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Linux Media Subsystem Documentation</a> &raquo;</li>
      
          <li><a href="index.html">Video4Linux (V4L)  driver-specific documentation</a> &raquo;</li>
      
    <li>28. The Soc-Camera Drivers</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/media/v4l-drivers/soc-camera.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="the-soc-camera-drivers">
<h1>28. The Soc-Camera Drivers<a class="headerlink" href="#the-soc-camera-drivers" title="Permalink to this headline">¶</a></h1>
<p>Author: Guennadi Liakhovetski &lt;<a class="reference external" href="mailto:g&#46;liakhovetski&#37;&#52;&#48;gmx&#46;de">g<span>&#46;</span>liakhovetski<span>&#64;</span>gmx<span>&#46;</span>de</a>&gt;</p>
<div class="section" id="terminology">
<h2>28.1. Terminology<a class="headerlink" href="#terminology" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>The following terms are used in this document:</dt>
<dd><ul class="first last simple">
<li>camera / camera device / camera sensor - a video-camera sensor chip, capable
of connecting to a variety of systems and interfaces, typically uses i2c for
control and configuration, and a parallel or a serial bus for data.</li>
<li>camera host - an interface, to which a camera is connected. Typically a
specialised interface, present on many SoCs, e.g. PXA27x and PXA3xx, SuperH,
AVR32, i.MX27, i.MX31.</li>
<li>camera host bus - a connection between a camera host and a camera. Can be
parallel or serial, consists of data and control lines, e.g. clock, vertical
and horizontal synchronization signals.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="purpose-of-the-soc-camera-subsystem">
<h2>28.2. Purpose of the soc-camera subsystem<a class="headerlink" href="#purpose-of-the-soc-camera-subsystem" title="Permalink to this headline">¶</a></h2>
<p>The soc-camera subsystem initially provided a unified API between camera host
drivers and camera sensor drivers. Later the soc-camera sensor API has been
replaced with the V4L2 standard subdev API. This also made camera driver re-use
with non-soc-camera hosts possible. The camera host API to the soc-camera core
has been preserved.</p>
<p>Soc-camera implements a V4L2 interface to the user, currently only the &#8220;mmap&#8221;
method is supported by host drivers. However, the soc-camera core also provides
support for the &#8220;read&#8221; method.</p>
<p>The subsystem has been designed to support multiple camera host interfaces and
multiple cameras per interface, although most applications have only one camera
sensor.</p>
</div>
<div class="section" id="existing-drivers">
<h2>28.3. Existing drivers<a class="headerlink" href="#existing-drivers" title="Permalink to this headline">¶</a></h2>
<p>As of 3.7 there are seven host drivers in the mainline: atmel-isi.c,
mx1_camera.c (broken, scheduled for removal), mx2_camera.c, mx3_camera.c,
omap1_camera.c, pxa_camera.c, sh_mobile_ceu_camera.c, and multiple sensor
drivers under drivers/media/i2c/soc_camera/.</p>
</div>
<div class="section" id="camera-host-api">
<h2>28.4. Camera host API<a class="headerlink" href="#camera-host-api" title="Permalink to this headline">¶</a></h2>
<p>A host camera driver is registered using the</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>soc_camera_host_register(struct soc_camera_host *);
</pre></div>
</div>
<p>function. The host object can be initialized as follows:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>struct soc_camera_host  *ici;
ici-&gt;drv_name           = DRV_NAME;
ici-&gt;ops                = &amp;camera_host_ops;
ici-&gt;priv               = pcdev;
ici-&gt;v4l2_dev.dev       = &amp;pdev-&gt;dev;
ici-&gt;nr                 = pdev-&gt;id;
</pre></div>
</div>
<p>All camera host methods are passed in a struct soc_camera_host_ops:</p>
<div class="highlight-none"><div class="highlight"><pre><span></span>static struct soc_camera_host_ops camera_host_ops = {
        .owner          = THIS_MODULE,
        .add            = camera_add_device,
        .remove         = camera_remove_device,
        .set_fmt        = camera_set_fmt_cap,
        .try_fmt        = camera_try_fmt_cap,
        .init_videobuf2 = camera_init_videobuf2,
        .poll           = camera_poll,
        .querycap       = camera_querycap,
        .set_bus_param  = camera_set_bus_param,
        /* The rest of host operations are optional */
};
</pre></div>
</div>
<p>.add and .remove methods are called when a sensor is attached to or detached
from the host. .set_bus_param is used to configure physical connection
parameters between the host and the sensor. .init_videobuf2 is called by
soc-camera core when a video-device is opened, the host driver would typically
call vb2_queue_init() in this method. Further video-buffer management is
implemented completely by the specific camera host driver. If the host driver
supports non-standard pixel format conversion, it should implement a
.get_formats and, possibly, a .put_formats operations. See below for more
details about format conversion. The rest of the methods are called from
respective V4L2 operations.</p>
</div>
<div class="section" id="camera-api">
<h2>28.5. Camera API<a class="headerlink" href="#camera-api" title="Permalink to this headline">¶</a></h2>
<p>Sensor drivers can use struct soc_camera_link, typically provided by the
platform, and used to specify to which camera host bus the sensor is connected,
and optionally provide platform .power and .reset methods for the camera. This
struct is provided to the camera driver via the I2C client device platform data
and can be obtained, using the soc_camera_i2c_to_link() macro. Care should be
taken, when using soc_camera_vdev_to_subdev() and when accessing struct
soc_camera_device, using v4l2_get_subdev_hostdata(): both only work, when
running on an soc-camera host. The actual camera driver operation is implemented
using the V4L2 subdev API. Additionally soc-camera camera drivers can use
auxiliary soc-camera helper functions like soc_camera_power_on() and
soc_camera_power_off(), which switch regulators, provided by the platform and call
board-specific power switching methods. soc_camera_apply_board_flags() takes
camera bus configuration capability flags and applies any board transformations,
e.g. signal polarity inversion. soc_mbus_get_fmtdesc() can be used to obtain a
pixel format descriptor, corresponding to a certain media-bus pixel format code.
soc_camera_limit_side() can be used to restrict beginning and length of a frame
side, based on camera capabilities.</p>
</div>
<div class="section" id="vidioc-s-crop-and-vidioc-s-fmt-behaviour">
<h2>28.6. VIDIOC_S_CROP and VIDIOC_S_FMT behaviour<a class="headerlink" href="#vidioc-s-crop-and-vidioc-s-fmt-behaviour" title="Permalink to this headline">¶</a></h2>
<p>Above user ioctls modify image geometry as follows:</p>
<p>VIDIOC_S_CROP: sets location and sizes of the sensor window. Unit is one sensor
pixel. Changing sensor window sizes preserves any scaling factors, therefore
user window sizes change as well.</p>
<p>VIDIOC_S_FMT: sets user window. Should preserve previously set sensor window as
much as possible by modifying scaling factors. If the sensor window cannot be
preserved precisely, it may be changed too.</p>
<p>In soc-camera there are two locations, where scaling and cropping can take
place: in the camera driver and in the host driver. User ioctls are first passed
to the host driver, which then generally passes them down to the camera driver.
It is more efficient to perform scaling and cropping in the camera driver to
save camera bus bandwidth and maximise the framerate. However, if the camera
driver failed to set the required parameters with sufficient precision, the host
driver may decide to also use its own scaling and cropping to fulfill the user&#8217;s
request.</p>
<p>Camera drivers are interfaced to the soc-camera core and to host drivers over
the v4l2-subdev API, which is completely functional, it doesn&#8217;t pass any data.
Therefore all camera drivers shall reply to .g_fmt() requests with their current
output geometry. This is necessary to correctly configure the camera bus.
.s_fmt() and .try_fmt() have to be implemented too. Sensor window and scaling
factors have to be maintained by camera drivers internally. According to the
V4L2 API all capture drivers must support the VIDIOC_CROPCAP ioctl, hence we
rely on camera drivers implementing .cropcap(). If the camera driver does not
support cropping, it may choose to not implement .s_crop(), but to enable
cropping support by the camera host driver at least the .g_crop method must be
implemented.</p>
<p>User window geometry is kept in .user_width and .user_height fields in struct
soc_camera_device and used by the soc-camera core and host drivers. The core
updates these fields upon successful completion of a .s_fmt() call, but if these
fields change elsewhere, e.g. during .s_crop() processing, the host driver is
responsible for updating them.</p>
</div>
<div class="section" id="format-conversion">
<h2>28.7. Format conversion<a class="headerlink" href="#format-conversion" title="Permalink to this headline">¶</a></h2>
<p>V4L2 distinguishes between pixel formats, as they are stored in memory, and as
they are transferred over a media bus. Soc-camera provides support to
conveniently manage these formats. A table of standard transformations is
maintained by soc-camera core, which describes, what FOURCC pixel format will
be obtained, if a media-bus pixel format is stored in memory according to
certain rules. E.g. if MEDIA_BUS_FMT_YUYV8_2X8 data is sampled with 8 bits per
sample and stored in memory in the little-endian order with no gaps between
bytes, data in memory will represent the V4L2_PIX_FMT_YUYV FOURCC format. These
standard transformations will be used by soc-camera or by camera host drivers to
configure camera drivers to produce the FOURCC format, requested by the user,
using the VIDIOC_S_FMT ioctl(). Apart from those standard format conversions,
host drivers can also provide their own conversion rules by implementing a
.get_formats and, if required, a .put_formats methods.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="uvcvideo.html" class="btn btn-neutral float-right" title="29. The Linux USB Video Class (UVC) driver" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="si476x.html" class="btn btn-neutral" title="27. The SI476x Driver" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'4.11.0-rc3+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>