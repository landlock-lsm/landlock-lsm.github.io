

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller &mdash; The Linux Kernel 5.12.0-rc3+ documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Writing a MUSB Glue Layer" href="writing_musb_glue_layer.html" />
    <link rel="prev" title="Writing USB Device Drivers" href="writing_usb_driver.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.12.0-rc3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux driver implementer’s API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../driver-model/index.html">Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics.html">Driver Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infrastructure.html">Device drivers infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ioctl.html">ioctl based interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../early-userspace/index.html">Early Userspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">CPU and Device Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clk.html">The Common Clk Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma-buf.html">Buffer Sharing and Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_link.html">Device links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../component.html">Component Helper for Aggregate Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../message-based.html">Message-based devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infiniband.html">InfiniBand and Remote DMA (RDMA) Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reset.html">Reset controller API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input.html">Input Subsystem</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Linux USB API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="usb.html">The Linux-USB Host Side API</a></li>
<li class="toctree-l3"><a class="reference internal" href="gadget.html">USB Gadget API for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="anchors.html">USB Anchors</a></li>
<li class="toctree-l3"><a class="reference internal" href="bulk-streams.html">USB bulk streams</a></li>
<li class="toctree-l3"><a class="reference internal" href="callbacks.html">USB core callbacks</a></li>
<li class="toctree-l3"><a class="reference internal" href="dma.html">USB DMA</a></li>
<li class="toctree-l3"><a class="reference internal" href="URB.html">USB Request Block (URB)</a></li>
<li class="toctree-l3"><a class="reference internal" href="power-management.html">Power Management for USB</a></li>
<li class="toctree-l3"><a class="reference internal" href="hotplug.html">USB hotplugging</a></li>
<li class="toctree-l3"><a class="reference internal" href="persist.html">USB device persistence during system suspend</a></li>
<li class="toctree-l3"><a class="reference internal" href="error-codes.html">USB Error codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing_usb_driver.html">Writing USB Device Drivers</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#summary-of-features">Summary of Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="#driver-design">Driver Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="#known-limitations">Known Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reporting-bugs">Reporting Bugs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging">Debugging</a></li>
<li class="toctree-l4"><a class="reference internal" href="#structures-methods-and-definitions">Structures, Methods and Definitions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="writing_musb_glue_layer.html">Writing a MUSB Glue Layer</a></li>
<li class="toctree-l3"><a class="reference internal" href="typec.html">USB Type-C connector class</a></li>
<li class="toctree-l3"><a class="reference internal" href="typec_bus.html">API for USB Type-C Alternate Mode drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="usb3-debug-port.html">USB3 debug port</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci/index.html">The Linux PCI driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxl/index.html">Compute Express Link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmb.html">IPMB Driver for a Satellite MC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmi.html">The Linux IPMI Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interconnect.html">Generic System Interconnect Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devfreq.html">Device Frequency Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi.html">SCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libata.html">libATA Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target.html">target and iSCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mailbox.html">The Common Mailbox Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtdnand.html">MTD NAND Driver Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mei/index.html">Intel(R) Management Engine Interface (Intel(R) MEI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtd/index.html">Memory Technology Device (MTD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mmc/index.html">MMC/SD/SDIO card support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvdimm/index.html">Non-Volatile Memory Device (NVDIMM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1.html">W1: Dallas’ 1-wire bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rapidio/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390-drivers.html">Writing s390 channel device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../80211/index.html">Linux 802.11 Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firmware/index.html">Linux Firmware API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pinctl.html">PINCTRL (PIN CONTROL) subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../md/index.html">RAID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../media/index.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc_devices.html">Miscellaneous Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfc/index.html">Near Field Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dmaengine/index.html">DMAEngine documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../soundwire/index.html">SoundWire Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermal/index.html">Thermal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">FPGA Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auxiliary_bus.html">Auxiliary Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backlight/lp855x-driver.html">Kernel driver lp855x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../connector.html">Kernel Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console.html">Console Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dcdbas.html">Dell Systems Management Base Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eisa.html">EISA bus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isa.html">ISA Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isapnp.html">ISA Plug &amp; Play support by Jaroslav Kysela &lt;perex&#64;suse.cz&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../io-mapping.html">The io_mapping functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../io_ordering.html">Ordering I/O writes to memory-mapped addresses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generic-counter.html">Generic Counter Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lightnvm-pblk.html">pblk: Physical Block Device Target</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory-devices/index.html">Memory Controller drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntb.html">NTB Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvmem.html">NVMEM Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parport-lowlevel.html">PARPORT interface documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pps.html">PPS - Pulse Per Second</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ptp.html">PTP hardware clock infrastructure for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../phy/index.html">Generic PHY Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pwm.html">Pulse Width Modulation (PWM) interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pldmfw/index.html">PLDM Firmware Flash Update Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pldmfw/index.html#overview-of-the-pldmfw-library">Overview of the <code class="docutils literal notranslate"><span class="pre">pldmfw</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rfkill.html">rfkill - RF kill switch support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serial/index.html">Support for Serial devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sm501.html">SM501 Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../surface_aggregator/index.html">Surface System Aggregator Module (SSAM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../switchtec.html">Linux Switchtec Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync_file.html">Sync File API Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio-mediated-device.html">VFIO Mediated devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio.html">VFIO - “Virtual Function I/O” </a></li>
<li class="toctree-l2"><a class="reference internal" href="../xilinx/index.html">Xilinx FPGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xillybus.html">Xillybus driver for generic FPGA interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zorro.html">Writing Device Drivers for Zorro Devices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">The Linux driver implementer’s API guide</a> &raquo;</li>
        
          <li><a href="index.html">Linux USB API</a> &raquo;</li>
        
      <li>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/driver-api/usb/dwc3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="synopsys-designware-core-superspeed-usb-3-0-controller">
<h1>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller<a class="headerlink" href="#synopsys-designware-core-superspeed-usb-3-0-controller" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Felipe Balbi &lt;<a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">felipe<span>&#46;</span>balbi<span>&#64;</span>linux<span>&#46;</span>intel<span>&#46;</span>com</a>&gt;</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>April 2017</p>
</dd>
</dl>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The <em>Synopsys DesignWare Core SuperSpeed USB 3.0 Controller</em>
(hereinafter referred to as <em>DWC3</em>) is a USB SuperSpeed compliant
controller which can be configured in one of 4 ways:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Peripheral-only configuration</p></li>
<li><p>Host-only configuration</p></li>
<li><p>Dual-Role configuration</p></li>
<li><p>Hub configuration</p></li>
</ol>
</div></blockquote>
<p>Linux currently supports several versions of this controller. In all
likelyhood, the version in your SoC is already supported. At the time
of this writing, known tested versions range from 2.02a to 3.10a. As a
rule of thumb, anything above 2.02a should work reliably well.</p>
<p>Currently, we have many known users for this driver. In alphabetical
order:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Cavium</p></li>
<li><p>Intel Corporation</p></li>
<li><p>Qualcomm</p></li>
<li><p>Rockchip</p></li>
<li><p>ST</p></li>
<li><p>Samsung</p></li>
<li><p>Texas Instruments</p></li>
<li><p>Xilinx</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="summary-of-features">
<h2>Summary of Features<a class="headerlink" href="#summary-of-features" title="Permalink to this headline">¶</a></h2>
<p>For details about features supported by your version of DWC3, consult
your IP team and/or <em>Synopsys DesignWare Core SuperSpeed USB 3.0
Controller Databook</em>. Following is a list of features supported by the
driver at the time of this writing:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Up to 16 bidirectional endpoints (including the control
pipe - ep0)</p></li>
<li><p>Flexible endpoint configuration</p></li>
<li><p>Simultaneous IN and OUT transfer support</p></li>
<li><p>Scatter-list support</p></li>
<li><p>Up to 256 TRBs <a class="footnote-reference brackets" href="#trb" id="id1">1</a> per endpoint</p></li>
<li><p>Support for all transfer types (<em>Control</em>, <em>Bulk</em>,
<em>Interrupt</em>, and <em>Isochronous</em>)</p></li>
<li><p>SuperSpeed Bulk Streams</p></li>
<li><p>Link Power Management</p></li>
<li><p>Trace Events for debugging</p></li>
<li><p>DebugFS <a class="footnote-reference brackets" href="#id9" id="id2">3</a> interface</p></li>
</ol>
</div></blockquote>
<p>These features have all been exercised with many of the <strong>in-tree</strong>
gadget drivers. We have verified both <em>ConfigFS</em> <a class="footnote-reference brackets" href="#configfs" id="id3">4</a> and
legacy gadget drivers.</p>
</div>
<div class="section" id="driver-design">
<h2>Driver Design<a class="headerlink" href="#driver-design" title="Permalink to this headline">¶</a></h2>
<p>The DWC3 driver sits on the <em>drivers/usb/dwc3/</em> directory. All files
related to this driver are in this one directory. This makes it easy
for new-comers to read the code and understand how it behaves.</p>
<p>Because of DWC3’s configuration flexibility, the driver is a little
complex in some places but it should be rather straightforward to
understand.</p>
<p>The biggest part of the driver refers to the Gadget API.</p>
</div>
<div class="section" id="known-limitations">
<h2>Known Limitations<a class="headerlink" href="#known-limitations" title="Permalink to this headline">¶</a></h2>
<p>Like any other HW, DWC3 has its own set of limitations. To avoid
constant questions about such problems, we decided to document them
here and have a single location to where we could point users.</p>
<div class="section" id="out-transfer-size-requirements">
<h3>OUT Transfer Size Requirements<a class="headerlink" href="#out-transfer-size-requirements" title="Permalink to this headline">¶</a></h3>
<p>According to Synopsys Databook, all OUT transfer TRBs <a class="footnote-reference brackets" href="#trb" id="id4">1</a> must
have their <em>size</em> field set to a value which is integer divisible by
the endpoint’s <em>wMaxPacketSize</em>. This means that <em>e.g.</em> in order to
receive a Mass Storage <em>CBW</em> <a class="footnote-reference brackets" href="#cbw" id="id5">5</a>, req-&gt;length must either be set
to a value that’s divisible by <em>wMaxPacketSize</em> (1024 on SuperSpeed,
512 on HighSpeed, etc), or DWC3 driver must add a Chained TRB pointing
to a throw-away buffer for the remaining length. Without this, OUT
transfers will <strong>NOT</strong> start.</p>
<p>Note that as of this writing, this won’t be a problem because DWC3 is
fully capable of appending a chained TRB for the remaining length and
completely hide this detail from the gadget driver. It’s still worth
mentioning because this seems to be the largest source of queries
about DWC3 and <em>non-working transfers</em>.</p>
</div>
<div class="section" id="trb-ring-size-limitation">
<h3>TRB Ring Size Limitation<a class="headerlink" href="#trb-ring-size-limitation" title="Permalink to this headline">¶</a></h3>
<p>We, currently, have a hard limit of 256 TRBs <a class="footnote-reference brackets" href="#trb" id="id6">1</a> per endpoint,
with the last TRB being a Link TRB <a class="footnote-reference brackets" href="#link-trb" id="id7">2</a> pointing back to the
first. This limit is arbitrary but it has the benefit of adding up to
exactly 4096 bytes, or 1 Page.</p>
<p>DWC3 driver will try its best to cope with more than 255 requests and,
for the most part, it should work normally. However this is not
something that has been exercised very frequently. If you experience
any problems, see section <strong>Reporting Bugs</strong> below.</p>
</div>
</div>
<div class="section" id="reporting-bugs">
<h2>Reporting Bugs<a class="headerlink" href="#reporting-bugs" title="Permalink to this headline">¶</a></h2>
<p>Whenever you encounter a problem with DWC3, first and foremost you
should make sure that:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>You’re running latest tag from <a class="reference external" href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/">Linus’ tree</a></p></li>
<li><p>You can reproduce the error without any out-of-tree changes
to DWC3</p></li>
<li><p>You have checked that it’s not a fault on the host machine</p></li>
</ol>
</div></blockquote>
<p>After all these are verified, then here’s how to capture enough
information so we can be of any help to you.</p>
<div class="section" id="required-information">
<h3>Required Information<a class="headerlink" href="#required-information" title="Permalink to this headline">¶</a></h3>
<p>DWC3 relies exclusively on Trace Events for debugging. Everything is
exposed there, with some extra bits being exposed to DebugFS
<a class="footnote-reference brackets" href="#id9" id="id8">3</a>.</p>
<p>In order to capture DWC3’s Trace Events you should run the following
commands <strong>before</strong> plugging the USB cable to a host machine:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># mkdir -p /d</span>
<span class="c1"># mkdir -p /t</span>
<span class="c1"># mount -t debugfs none /d</span>
<span class="c1"># mount -t tracefs none /t</span>
<span class="c1"># echo 81920 &gt; /t/buffer_size_kb</span>
<span class="c1"># echo 1 &gt; /t/events/dwc3/enable</span>
</pre></div>
</div>
<p>After this is done, you can connect your USB cable and reproduce the
problem. As soon as the fault is reproduced, make a copy of files
<code class="docutils literal notranslate"><span class="pre">trace</span></code> and <code class="docutils literal notranslate"><span class="pre">regdump</span></code>, like so:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># cp /t/trace /root/trace.txt</span>
<span class="c1"># cat /d/*dwc3*/regdump &gt; /root/regdump.txt</span>
</pre></div>
</div>
<p>Make sure to compress <code class="docutils literal notranslate"><span class="pre">trace.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">regdump.txt</span></code> in a tarball
and email it to <a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">me</a> with <a class="reference external" href="mailto:linux-usb&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-usb</a> in Cc. If you want to be extra
sure that I’ll help you, write your subject line in the following
format:</p>
<blockquote>
<div><p><strong>[BUG REPORT] usb: dwc3: Bug while doing XYZ</strong></p>
</div></blockquote>
<p>On the email body, make sure to detail what you doing, which gadget
driver you were using, how to reproduce the problem, what SoC you’re
using, which OS (and its version) was running on the Host machine.</p>
<p>With all this information, we should be able to understand what’s
going on and be helpful to you.</p>
</div>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>First and foremost a disclaimer:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DISCLAIMER: The information available on DebugFS and/or TraceFS can
change at any time at any Major Linux Kernel Release. If writing
scripts, do **NOT** assume information to be available in the
current format.
</pre></div>
</div>
<p>With that out of the way, let’s carry on.</p>
<p>If you’re willing to debug your own problem, you deserve a round of
applause :-)</p>
<p>Anyway, there isn’t much to say here other than Trace Events will be
really helpful in figuring out issues with DWC3. Also, access to
Synopsys Databook will be <strong>really</strong> valuable in this case.</p>
<p>A USB Sniffer can be helpful at times but it’s not entirely required,
there’s a lot that can be understood without looking at the wire.</p>
<p>Feel free to email <a class="reference external" href="mailto:felipe&#46;balbi&#37;&#52;&#48;linux&#46;intel&#46;com">me</a> and Cc <a class="reference external" href="mailto:linux-usb&#37;&#52;&#48;vger&#46;kernel&#46;org">linux-usb</a> if you need any help.</p>
<div class="section" id="debugfs">
<h3><code class="docutils literal notranslate"><span class="pre">DebugFS</span></code><a class="headerlink" href="#debugfs" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">DebugFS</span></code> is very good for gathering snapshots of what’s going on
with DWC3 and/or any endpoint.</p>
<p>On DWC3’s <code class="docutils literal notranslate"><span class="pre">DebugFS</span></code> directory, you will find the following files and
directories:</p>
<p><code class="docutils literal notranslate"><span class="pre">ep[0..15]{in,out}/</span></code>
<code class="docutils literal notranslate"><span class="pre">link_state</span></code>
<code class="docutils literal notranslate"><span class="pre">regdump</span></code>
<code class="docutils literal notranslate"><span class="pre">testmode</span></code></p>
<div class="section" id="link-state">
<h4><code class="docutils literal notranslate"><span class="pre">link_state</span></code><a class="headerlink" href="#link-state" title="Permalink to this headline">¶</a></h4>
<p>When read, <code class="docutils literal notranslate"><span class="pre">link_state</span></code> will print out one of <code class="docutils literal notranslate"><span class="pre">U0</span></code>, <code class="docutils literal notranslate"><span class="pre">U1</span></code>,
<code class="docutils literal notranslate"><span class="pre">U2</span></code>, <code class="docutils literal notranslate"><span class="pre">U3</span></code>, <code class="docutils literal notranslate"><span class="pre">SS.Disabled</span></code>, <code class="docutils literal notranslate"><span class="pre">RX.Detect</span></code>, <code class="docutils literal notranslate"><span class="pre">SS.Inactive</span></code>,
<code class="docutils literal notranslate"><span class="pre">Polling</span></code>, <code class="docutils literal notranslate"><span class="pre">Recovery</span></code>, <code class="docutils literal notranslate"><span class="pre">Hot</span> <span class="pre">Reset</span></code>, <code class="docutils literal notranslate"><span class="pre">Compliance</span></code>,
<code class="docutils literal notranslate"><span class="pre">Loopback</span></code>, <code class="docutils literal notranslate"><span class="pre">Reset</span></code>, <code class="docutils literal notranslate"><span class="pre">Resume</span></code> or <code class="docutils literal notranslate"><span class="pre">UNKNOWN</span> <span class="pre">link</span> <span class="pre">state</span></code>.</p>
<p>This file can also be written to in order to force link to one of the
states above.</p>
</div>
<div class="section" id="regdump">
<h4><code class="docutils literal notranslate"><span class="pre">regdump</span></code><a class="headerlink" href="#regdump" title="Permalink to this headline">¶</a></h4>
<p>File name is self-explanatory. When read, <code class="docutils literal notranslate"><span class="pre">regdump</span></code> will print out a
register dump of DWC3. Note that this file can be grepped to find the
information you want.</p>
</div>
<div class="section" id="testmode">
<h4><code class="docutils literal notranslate"><span class="pre">testmode</span></code><a class="headerlink" href="#testmode" title="Permalink to this headline">¶</a></h4>
<p>When read, <code class="docutils literal notranslate"><span class="pre">testmode</span></code> will print out a name of one of the specified
USB 2.0 Testmodes (<code class="docutils literal notranslate"><span class="pre">test_j</span></code>, <code class="docutils literal notranslate"><span class="pre">test_k</span></code>, <code class="docutils literal notranslate"><span class="pre">test_se0_nak</span></code>,
<code class="docutils literal notranslate"><span class="pre">test_packet</span></code>, <code class="docutils literal notranslate"><span class="pre">test_force_enable</span></code>) or the string <code class="docutils literal notranslate"><span class="pre">no</span> <span class="pre">test</span></code> in
case no tests are currently being executed.</p>
<p>In order to start any of these test modes, the same strings can be
written to the file and DWC3 will enter the requested test mode.</p>
</div>
<div class="section" id="ep-0-15-in-out">
<h4><code class="docutils literal notranslate"><span class="pre">ep[0..15]{in,out}</span></code><a class="headerlink" href="#ep-0-15-in-out" title="Permalink to this headline">¶</a></h4>
<p>For each endpoint we expose one directory following the naming
convention <code class="docutils literal notranslate"><span class="pre">ep$num$dir</span></code> <em>(ep0in, ep0out, ep1in, …)</em>. Inside each
of these directories you will find the following files:</p>
<p><code class="docutils literal notranslate"><span class="pre">descriptor_fetch_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">event_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">rx_fifo_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">rx_info_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">rx_request_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">transfer_type</span></code>
<code class="docutils literal notranslate"><span class="pre">trb_ring</span></code>
<code class="docutils literal notranslate"><span class="pre">tx_fifo_queue</span></code>
<code class="docutils literal notranslate"><span class="pre">tx_request_queue</span></code></p>
<p>With access to Synopsys Databook, you can decode the information on
them.</p>
<div class="section" id="transfer-type">
<h5><code class="docutils literal notranslate"><span class="pre">transfer_type</span></code><a class="headerlink" href="#transfer-type" title="Permalink to this headline">¶</a></h5>
<p>When read, <code class="docutils literal notranslate"><span class="pre">transfer_type</span></code> will print out one of <code class="docutils literal notranslate"><span class="pre">control</span></code>,
<code class="docutils literal notranslate"><span class="pre">bulk</span></code>, <code class="docutils literal notranslate"><span class="pre">interrupt</span></code> or <code class="docutils literal notranslate"><span class="pre">isochronous</span></code> depending on what the
endpoint descriptor says. If the endpoint hasn’t been enabled yet, it
will print <code class="docutils literal notranslate"><span class="pre">--</span></code>.</p>
</div>
<div class="section" id="trb-ring">
<h5><code class="docutils literal notranslate"><span class="pre">trb_ring</span></code><a class="headerlink" href="#trb-ring" title="Permalink to this headline">¶</a></h5>
<p>When read, <code class="docutils literal notranslate"><span class="pre">trb_ring</span></code> will print out details about all TRBs on the
ring. It will also tell you where our enqueue and dequeue pointers are
located in the ring:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>buffer_addr,size,type,ioc,isp_imi,csp,chn,lst,hwo
000000002c754000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c75c000,481,normal,1,0,1,0,0,0
000000002c780000,481,normal,1,0,1,0,0,0
000000002c784000,481,normal,1,0,1,0,0,0
000000002c788000,481,normal,1,0,1,0,0,0
000000002c78c000,481,normal,1,0,1,0,0,0
000000002c790000,481,normal,1,0,1,0,0,0
000000002c754000,481,normal,1,0,1,0,0,0
000000002c758000,481,normal,1,0,1,0,0,0
000000002c75c000,512,normal,1,0,1,0,0,1        D
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0       E
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
<span class="m">0000000000000000</span>,0,UNKNOWN,0,0,0,0,0,0
00000000381ab000,0,link,0,0,0,0,0,1
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="trace-events">
<h3>Trace Events<a class="headerlink" href="#trace-events" title="Permalink to this headline">¶</a></h3>
<p>DWC3 also provides several trace events which help us gathering
information about the behavior of the driver during runtime.</p>
<p>In order to use these events, you must enable <code class="docutils literal notranslate"><span class="pre">CONFIG_FTRACE</span></code> in
your kernel config.</p>
<p>For details about how enable DWC3 events, see section <strong>Reporting
Bugs</strong>.</p>
<p>The following subsections will give details about each Event Class and
each Event defined by DWC3.</p>
<div class="section" id="mmio">
<h4>MMIO<a class="headerlink" href="#mmio" title="Permalink to this headline">¶</a></h4>
<p>It is sometimes useful to look at every MMIO access when looking for
bugs. Because of that, DWC3 offers two Trace Events (one for
dwc3_readl() and one for dwc3_writel()). <code class="docutils literal notranslate"><span class="pre">TP_printk</span></code> follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;addr %p value %08x&quot;, __entry-&gt;base + __entry-&gt;offset,
              __entry-&gt;value)
</pre></div>
</div>
</div>
<div class="section" id="interrupt-events">
<h4>Interrupt Events<a class="headerlink" href="#interrupt-events" title="Permalink to this headline">¶</a></h4>
<p>Every IRQ event can be logged and decoded into a human readable
string. Because every event will be different, we don’t give an
example other than the <code class="docutils literal notranslate"><span class="pre">TP_printk</span></code> format used:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;event (%08x): %s&quot;, __entry-&gt;event,
              dwc3_decode_event(__entry-&gt;event, __entry-&gt;ep0state))
</pre></div>
</div>
</div>
<div class="section" id="control-request">
<h4>Control Request<a class="headerlink" href="#control-request" title="Permalink to this headline">¶</a></h4>
<p>Every USB Control Request can be logged to the trace buffer. The
output format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;%s&quot;, dwc3_decode_ctrl(__entry-&gt;bRequestType,
                              __entry-&gt;bRequest, __entry-&gt;wValue,
                              __entry-&gt;wIndex, __entry-&gt;wLength)
)
</pre></div>
</div>
<p>Note that Standard Control Requests will be decoded into
human-readable strings with their respective arguments. Class and
Vendor requests will be printed out a sequence of 8 bytes in hex
format.</p>
</div>
<div class="section" id="lifetime-of-a-struct-usb-request">
<h4>Lifetime of a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usb_request</span></code><a class="headerlink" href="#lifetime-of-a-struct-usb-request" title="Permalink to this headline">¶</a></h4>
<p>The entire lifetime of a <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usb_request</span></code> can be tracked on the
trace buffer. We have one event for each of allocation, free,
queueing, dequeueing, and giveback. Output format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;%s: req %p length %u/%u %s%s%s ==&gt; %d&quot;,
      __get_str(name), __entry-&gt;req, __entry-&gt;actual, __entry-&gt;length,
      __entry-&gt;zero ? &quot;Z&quot; : &quot;z&quot;,
      __entry-&gt;short_not_ok ? &quot;S&quot; : &quot;s&quot;,
      __entry-&gt;no_interrupt ? &quot;i&quot; : &quot;I&quot;,
      __entry-&gt;status
)
</pre></div>
</div>
</div>
<div class="section" id="generic-commands">
<h4>Generic Commands<a class="headerlink" href="#generic-commands" title="Permalink to this headline">¶</a></h4>
<p>We can log and decode every Generic Command with its completion
code. Format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;cmd &#39;%s&#39; [%x] param %08x --&gt; status: %s&quot;,
      dwc3_gadget_generic_cmd_string(__entry-&gt;cmd),
      __entry-&gt;cmd, __entry-&gt;param,
      dwc3_gadget_generic_cmd_status_string(__entry-&gt;status)
)
</pre></div>
</div>
</div>
<div class="section" id="endpoint-commands">
<h4>Endpoint Commands<a class="headerlink" href="#endpoint-commands" title="Permalink to this headline">¶</a></h4>
<p>Endpoints commands can also be logged together with completion
code. Format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;%s: cmd &#39;%s&#39; [%d] params %08x %08x %08x --&gt; status: %s&quot;,
      __get_str(name), dwc3_gadget_ep_cmd_string(__entry-&gt;cmd),
      __entry-&gt;cmd, __entry-&gt;param0,
      __entry-&gt;param1, __entry-&gt;param2,
      dwc3_ep_cmd_status_string(__entry-&gt;cmd_status)
)
</pre></div>
</div>
</div>
<div class="section" id="lifetime-of-a-trb">
<h4>Lifetime of a <code class="docutils literal notranslate"><span class="pre">TRB</span></code><a class="headerlink" href="#lifetime-of-a-trb" title="Permalink to this headline">¶</a></h4>
<p>A <code class="docutils literal notranslate"><span class="pre">TRB</span></code> Lifetime is simple. We are either preparing a <code class="docutils literal notranslate"><span class="pre">TRB</span></code> or
completing it. With these two events, we can see how a <code class="docutils literal notranslate"><span class="pre">TRB</span></code> changes
over time. Format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;%s: %d/%d trb %p buf %08x%08x size %s%d ctrl %08x (%c%c%c%c:%c%c:%s)&quot;,
      __get_str(name), __entry-&gt;queued, __entry-&gt;allocated,
      __entry-&gt;trb, __entry-&gt;bph, __entry-&gt;bpl,
      ({char *s;
      int pcm = ((__entry-&gt;size &gt;&gt; 24) &amp; 3) + 1;
      switch (__entry-&gt;type) {
      case USB_ENDPOINT_XFER_INT:
      case USB_ENDPOINT_XFER_ISOC:
              switch (pcm) {
              case 1:
                      s = &quot;1x &quot;;
                      break;
              case 2:
                      s = &quot;2x &quot;;
                      break;
              case 3:
                      s = &quot;3x &quot;;
                      break;
              }
      default:
              s = &quot;&quot;;
      } s; }),
      DWC3_TRB_SIZE_LENGTH(__entry-&gt;size), __entry-&gt;ctrl,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_HWO ? &#39;H&#39; : &#39;h&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_LST ? &#39;L&#39; : &#39;l&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_CHN ? &#39;C&#39; : &#39;c&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_CSP ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_ISP_IMI ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;ctrl &amp; DWC3_TRB_CTRL_IOC ? &#39;C&#39; : &#39;c&#39;,
    dwc3_trb_type_string(DWC3_TRBCTL_TYPE(__entry-&gt;ctrl))
)
</pre></div>
</div>
</div>
<div class="section" id="lifetime-of-an-endpoint">
<h4>Lifetime of an Endpoint<a class="headerlink" href="#lifetime-of-an-endpoint" title="Permalink to this headline">¶</a></h4>
<p>And endpoint’s lifetime is summarized with enable and disable
operations, both of which can be traced. Format is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>TP_printk(&quot;%s: mps %d/%d streams %d burst %d ring %d/%d flags %c:%c%c%c%c%c:%c:%c&quot;,
      __get_str(name), __entry-&gt;maxpacket,
      __entry-&gt;maxpacket_limit, __entry-&gt;max_streams,
      __entry-&gt;maxburst, __entry-&gt;trb_enqueue,
      __entry-&gt;trb_dequeue,
      __entry-&gt;flags &amp; DWC3_EP_ENABLED ? &#39;E&#39; : &#39;e&#39;,
      __entry-&gt;flags &amp; DWC3_EP_STALL ? &#39;S&#39; : &#39;s&#39;,
      __entry-&gt;flags &amp; DWC3_EP_WEDGE ? &#39;W&#39; : &#39;w&#39;,
      __entry-&gt;flags &amp; DWC3_EP_TRANSFER_STARTED ? &#39;B&#39; : &#39;b&#39;,
      __entry-&gt;flags &amp; DWC3_EP_PENDING_REQUEST ? &#39;P&#39; : &#39;p&#39;,
      __entry-&gt;flags &amp; DWC3_EP_END_TRANSFER_PENDING ? &#39;E&#39; : &#39;e&#39;,
      __entry-&gt;direction ? &#39;&lt;&#39; : &#39;&gt;&#39;
)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="structures-methods-and-definitions">
<h2>Structures, Methods and Definitions<a class="headerlink" href="#structures-methods-and-definitions" title="Permalink to this headline">¶</a></h2>
<dl class="c struct">
<dt id="c.dwc3_event_buffer">
<em class="property">struct </em><code class="sig-name descname">dwc3_event_buffer</code><a class="headerlink" href="#c.dwc3_event_buffer" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Software event buffer representation</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_event_buffer {
  void *buf;
  void *cache;
  unsigned int            length;
  unsigned int            lpos;
  unsigned int            count;
  unsigned int            flags;
#define DWC3_EVENT_PENDING      BIT(0);
  dma_addr_t dma;
  struct dwc3             *dwc;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">buf</span></code></dt><dd><p>_THE_ buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cache</span></code></dt><dd><p>The buffer cache used in the threaded interrupt</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">length</span></code></dt><dd><p>size of this buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lpos</span></code></dt><dd><p>event offset</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">count</span></code></dt><dd><p>cache of last read event count register</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt><dd><p>flags related to this event buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dma</span></code></dt><dd><p>dma_addr_t</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dwc</span></code></dt><dd><p>pointer to DWC controller</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_ep">
<em class="property">struct </em><code class="sig-name descname">dwc3_ep</code><a class="headerlink" href="#c.dwc3_ep" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>device side endpoint representation</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_ep {
  struct usb_ep           endpoint;
  struct list_head        cancelled_list;
  struct list_head        pending_list;
  struct list_head        started_list;
  void __iomem            *regs;
  struct dwc3_trb         *trb_pool;
  dma_addr_t trb_pool_dma;
  struct dwc3             *dwc;
  u32 saved_state;
  unsigned int            flags;
#define DWC3_EP_ENABLED         BIT(0);
#define DWC3_EP_STALL           BIT(1);
#define DWC3_EP_WEDGE           BIT(2);
#define DWC3_EP_TRANSFER_STARTED BIT(3);
#define DWC3_EP_END_TRANSFER_PENDING BIT(4);
#define DWC3_EP_PENDING_REQUEST BIT(5);
#define DWC3_EP_DELAY_START     BIT(6);
#define DWC3_EP_WAIT_TRANSFER_COMPLETE  BIT(7);
#define DWC3_EP_IGNORE_NEXT_NOSTREAM    BIT(8);
#define DWC3_EP_FORCE_RESTART_STREAM    BIT(9);
#define DWC3_EP_FIRST_STREAM_PRIMED     BIT(10);
#define DWC3_EP_PENDING_CLEAR_STALL     BIT(11);
#define DWC3_EP0_DIR_IN         BIT(31);
  u8 trb_enqueue;
  u8 trb_dequeue;
  u8 number;
  u8 type;
  u8 resource_index;
  u32 frame_number;
  u32 interval;
  char name[20];
  unsigned direction:1;
  unsigned stream_capable:1;
  u8 combo_num;
  int start_cmd_status;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">endpoint</span></code></dt><dd><p>usb endpoint</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cancelled_list</span></code></dt><dd><p>list of cancelled requests for this endpoint</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending_list</span></code></dt><dd><p>list of pending requests for this endpoint</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">started_list</span></code></dt><dd><p>list of started requests on this endpoint</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">regs</span></code></dt><dd><p>pointer to first endpoint register</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb_pool</span></code></dt><dd><p>array of transaction buffers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb_pool_dma</span></code></dt><dd><p>dma address of <strong>trb_pool</strong></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dwc</span></code></dt><dd><p>pointer to DWC controller</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">saved_state</span></code></dt><dd><p>ep state saved during hibernation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt><dd><p>endpoint flags (wedged, stalled, …)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb_enqueue</span></code></dt><dd><p>enqueue ‘pointer’ into TRB array</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb_dequeue</span></code></dt><dd><p>dequeue ‘pointer’ into TRB array</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">number</span></code></dt><dd><p>endpoint number (1 - 15)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>set to bmAttributes &amp; USB_ENDPOINT_XFERTYPE_MASK</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">resource_index</span></code></dt><dd><p>Resource transfer index</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">frame_number</span></code></dt><dd><p>set to the frame number we want this transfer to start (ISOC)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">interval</span></code></dt><dd><p>the interval on which the ISOC transfer is started</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>a human readable name e.g. ep1out-bulk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">direction</span></code></dt><dd><p>true for TX, false for RX</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">stream_capable</span></code></dt><dd><p>true when streams are enabled</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">combo_num</span></code></dt><dd><p>the test combination BIT[15:14] of the frame number to test
isochronous START TRANSFER command failure workaround</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">start_cmd_status</span></code></dt><dd><p>the status of testing START TRANSFER command with
combo_num = ‘b00</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_trb">
<em class="property">struct </em><code class="sig-name descname">dwc3_trb</code><a class="headerlink" href="#c.dwc3_trb" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>transfer request block (hw format)</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_trb {
  u32 bpl;
  u32 bph;
  u32 size;
  u32 ctrl;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">bpl</span></code></dt><dd><p>DW0-3</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bph</span></code></dt><dd><p>DW4-7</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size</span></code></dt><dd><p>DW8-B</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ctrl</span></code></dt><dd><p>DWC-F</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_hwparams">
<em class="property">struct </em><code class="sig-name descname">dwc3_hwparams</code><a class="headerlink" href="#c.dwc3_hwparams" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>copy of HWPARAMS registers</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_hwparams {
  u32 hwparams0;
  u32 hwparams1;
  u32 hwparams2;
  u32 hwparams3;
  u32 hwparams4;
  u32 hwparams5;
  u32 hwparams6;
  u32 hwparams7;
  u32 hwparams8;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">hwparams0</span></code></dt><dd><p>GHWPARAMS0</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams1</span></code></dt><dd><p>GHWPARAMS1</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams2</span></code></dt><dd><p>GHWPARAMS2</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams3</span></code></dt><dd><p>GHWPARAMS3</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams4</span></code></dt><dd><p>GHWPARAMS4</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams5</span></code></dt><dd><p>GHWPARAMS5</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams6</span></code></dt><dd><p>GHWPARAMS6</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams7</span></code></dt><dd><p>GHWPARAMS7</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams8</span></code></dt><dd><p>GHWPARAMS8</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_request">
<em class="property">struct </em><code class="sig-name descname">dwc3_request</code><a class="headerlink" href="#c.dwc3_request" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>representation of a transfer request</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_request {
  struct usb_request      request;
  struct list_head        list;
  struct dwc3_ep          *dep;
  struct scatterlist      *sg;
  struct scatterlist      *start_sg;
  unsigned int            num_pending_sgs;
  unsigned int            num_queued_sgs;
  unsigned int            remaining;
  unsigned int            status;
#define DWC3_REQUEST_STATUS_QUEUED      0;
#define DWC3_REQUEST_STATUS_STARTED     1;
#define DWC3_REQUEST_STATUS_CANCELLED   2;
#define DWC3_REQUEST_STATUS_COMPLETED   3;
#define DWC3_REQUEST_STATUS_UNKNOWN     -1;
  u8 epnum;
  struct dwc3_trb         *trb;
  dma_addr_t trb_dma;
  unsigned int            num_trbs;
  unsigned int            needs_extra_trb:1;
  unsigned int            direction:1;
  unsigned int            mapped:1;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">request</span></code></dt><dd><p><a class="reference internal" href="gadget.html#c.usb_request" title="usb_request"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usb_request</span></code></a> to be transferred</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">list</span></code></dt><dd><p>a list_head used for request queueing</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dep</span></code></dt><dd><p><a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span></code></a> owning this request</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sg</span></code></dt><dd><p>pointer to first incomplete sg</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">start_sg</span></code></dt><dd><p>pointer to the sg which should be queued next</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_pending_sgs</span></code></dt><dd><p>counter to pending sgs</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_queued_sgs</span></code></dt><dd><p>counter to the number of sgs which already got queued</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">remaining</span></code></dt><dd><p>amount of data remaining</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd><p>internal dwc3 request status tracking</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">epnum</span></code></dt><dd><p>endpoint number to which this request refers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb</span></code></dt><dd><p>pointer to <a class="reference internal" href="#c.dwc3_trb" title="dwc3_trb"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_trb</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">trb_dma</span></code></dt><dd><p>DMA address of <strong>trb</strong></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_trbs</span></code></dt><dd><p>number of TRBs used by this request</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">needs_extra_trb</span></code></dt><dd><p>true when request needs one extra TRB (either due to ZLP
or unaligned OUT)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">direction</span></code></dt><dd><p>IN or OUT direction flag</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mapped</span></code></dt><dd><p>true when request has been dma-mapped</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3">
<em class="property">struct </em><code class="sig-name descname">dwc3</code><a class="headerlink" href="#c.dwc3" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>representation of our controller</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3 {
  struct work_struct      drd_work;
  struct dwc3_trb         *ep0_trb;
  void *bounce;
  void *scratchbuf;
  u8 *setup_buf;
  dma_addr_t ep0_trb_addr;
  dma_addr_t bounce_addr;
  dma_addr_t scratch_addr;
  struct dwc3_request     ep0_usb_req;
  struct completion       ep0_in_setup;
  spinlock_t lock;
  struct device           *dev;
  struct device           *sysdev;
  struct platform_device  *xhci;
  struct resource         xhci_resources[DWC3_XHCI_RESOURCES_NUM];
  struct dwc3_event_buffer *ev_buf;
  struct dwc3_ep          *eps[DWC3_ENDPOINTS_NUM];
  struct usb_gadget       *gadget;
  struct usb_gadget_driver *gadget_driver;
  struct clk_bulk_data    *clks;
  int num_clks;
  struct reset_control    *reset;
  struct usb_phy          *usb2_phy;
  struct usb_phy          *usb3_phy;
  struct phy              *usb2_generic_phy;
  struct phy              *usb3_generic_phy;
  bool phys_ready;
  struct ulpi             *ulpi;
  bool ulpi_ready;
  void __iomem            *regs;
  size_t regs_size;
  enum usb_dr_mode        dr_mode;
  u32 current_dr_role;
  u32 desired_dr_role;
  struct extcon_dev       *edev;
  struct notifier_block   edev_nb;
  enum usb_phy_interface  hsphy_mode;
  struct usb_role_switch  *role_sw;
  enum usb_dr_mode        role_switch_default_mode;
  u32 fladj;
  u32 irq_gadget;
  u32 otg_irq;
  u32 current_otg_role;
  u32 desired_otg_role;
  bool otg_restart_host;
  u32 nr_scratch;
  u32 u1u2;
  u32 maximum_speed;
  u32 gadget_max_speed;
  enum usb_ssp_rate       max_ssp_rate;
  enum usb_ssp_rate       gadget_ssp_rate;
  u32 ip;
#define DWC3_IP                 0x5533;
#define DWC31_IP                0x3331;
#define DWC32_IP                0x3332;
  u32 revision;
#define DWC3_REVISION_ANY       0x0;
#define DWC3_REVISION_173A      0x5533173a;
#define DWC3_REVISION_175A      0x5533175a;
#define DWC3_REVISION_180A      0x5533180a;
#define DWC3_REVISION_183A      0x5533183a;
#define DWC3_REVISION_185A      0x5533185a;
#define DWC3_REVISION_187A      0x5533187a;
#define DWC3_REVISION_188A      0x5533188a;
#define DWC3_REVISION_190A      0x5533190a;
#define DWC3_REVISION_194A      0x5533194a;
#define DWC3_REVISION_200A      0x5533200a;
#define DWC3_REVISION_202A      0x5533202a;
#define DWC3_REVISION_210A      0x5533210a;
#define DWC3_REVISION_220A      0x5533220a;
#define DWC3_REVISION_230A      0x5533230a;
#define DWC3_REVISION_240A      0x5533240a;
#define DWC3_REVISION_250A      0x5533250a;
#define DWC3_REVISION_260A      0x5533260a;
#define DWC3_REVISION_270A      0x5533270a;
#define DWC3_REVISION_280A      0x5533280a;
#define DWC3_REVISION_290A      0x5533290a;
#define DWC3_REVISION_300A      0x5533300a;
#define DWC3_REVISION_310A      0x5533310a;
#define DWC3_REVISION_330A      0x5533330a;
#define DWC31_REVISION_ANY      0x0;
#define DWC31_REVISION_110A     0x3131302a;
#define DWC31_REVISION_120A     0x3132302a;
#define DWC31_REVISION_160A     0x3136302a;
#define DWC31_REVISION_170A     0x3137302a;
#define DWC31_REVISION_180A     0x3138302a;
#define DWC31_REVISION_190A     0x3139302a;
#define DWC32_REVISION_ANY      0x0;
#define DWC32_REVISION_100A     0x3130302a;
  u32 version_type;
#define DWC31_VERSIONTYPE_ANY           0x0;
#define DWC31_VERSIONTYPE_EA01          0x65613031;
#define DWC31_VERSIONTYPE_EA02          0x65613032;
#define DWC31_VERSIONTYPE_EA03          0x65613033;
#define DWC31_VERSIONTYPE_EA04          0x65613034;
#define DWC31_VERSIONTYPE_EA05          0x65613035;
#define DWC31_VERSIONTYPE_EA06          0x65613036;
  enum dwc3_ep0_next      ep0_next_event;
  enum dwc3_ep0_state     ep0state;
  enum dwc3_link_state    link_state;
  u16 u2sel;
  u16 u2pel;
  u8 u1sel;
  u8 u1pel;
  u8 speed;
  u8 num_eps;
  struct dwc3_hwparams    hwparams;
  struct dentry           *root;
  struct debugfs_regset32 *regset;
  u32 dbg_lsp_select;
  u8 test_mode;
  u8 test_mode_nr;
  u8 lpm_nyet_threshold;
  u8 hird_threshold;
  u8 rx_thr_num_pkt_prd;
  u8 rx_max_burst_prd;
  u8 tx_thr_num_pkt_prd;
  u8 tx_max_burst_prd;
  const char              *hsphy_interface;
  unsigned connected:1;
  unsigned delayed_status:1;
  unsigned ep0_bounced:1;
  unsigned ep0_expect_in:1;
  unsigned has_hibernation:1;
  unsigned sysdev_is_parent:1;
  unsigned has_lpm_erratum:1;
  unsigned is_utmi_l1_suspend:1;
  unsigned is_fpga:1;
  unsigned pending_events:1;
  unsigned pullups_connected:1;
  unsigned setup_packet_pending:1;
  unsigned three_stage_setup:1;
  unsigned dis_start_transfer_quirk:1;
  unsigned usb3_lpm_capable:1;
  unsigned usb2_lpm_disable:1;
  unsigned disable_scramble_quirk:1;
  unsigned u2exit_lfps_quirk:1;
  unsigned u2ss_inp3_quirk:1;
  unsigned req_p1p2p3_quirk:1;
  unsigned del_p1p2p3_quirk:1;
  unsigned del_phy_power_chg_quirk:1;
  unsigned lfps_filter_quirk:1;
  unsigned rx_detect_poll_quirk:1;
  unsigned dis_u3_susphy_quirk:1;
  unsigned dis_u2_susphy_quirk:1;
  unsigned dis_enblslpm_quirk:1;
  unsigned dis_u1_entry_quirk:1;
  unsigned dis_u2_entry_quirk:1;
  unsigned dis_rxdet_inp3_quirk:1;
  unsigned dis_u2_freeclk_exists_quirk:1;
  unsigned dis_del_phy_power_chg_quirk:1;
  unsigned dis_tx_ipgap_linecheck_quirk:1;
  unsigned parkmode_disable_ss_quirk:1;
  unsigned tx_de_emphasis_quirk:1;
  unsigned tx_de_emphasis:2;
  unsigned dis_metastability_quirk:1;
  unsigned dis_split_quirk:1;
  u16 imod_interval;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">drd_work</span></code></dt><dd><p>workqueue used for role swapping</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_trb</span></code></dt><dd><p>trb which is used for the ctrl_req</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bounce</span></code></dt><dd><p>address of bounce buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">scratchbuf</span></code></dt><dd><p>address of scratch buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">setup_buf</span></code></dt><dd><p>used while precessing STD USB requests</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_trb_addr</span></code></dt><dd><p>dma address of <strong>ep0_trb</strong></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bounce_addr</span></code></dt><dd><p>dma address of <strong>bounce</strong></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">scratch_addr</span></code></dt><dd><p>dma address of scratchbuf</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_usb_req</span></code></dt><dd><p>dummy req used while handling STD USB requests</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_in_setup</span></code></dt><dd><p>one control transfer is completed and enter setup phase</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lock</span></code></dt><dd><p>for synchronizing</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt><dd><p>pointer to our <a class="reference internal" href="../infrastructure.html#c.device" title="device"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span></code></a></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sysdev</span></code></dt><dd><p>pointer to the DMA-capable device</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">xhci</span></code></dt><dd><p>pointer to our xHCI child</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">xhci_resources</span></code></dt><dd><p>struct resources for our <strong>xhci</strong> child</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ev_buf</span></code></dt><dd><p><a class="reference internal" href="#c.dwc3_event_buffer" title="dwc3_event_buffer"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_event_buffer</span></code></a> pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">eps</span></code></dt><dd><p>endpoint array</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gadget</span></code></dt><dd><p>device side representation of the peripheral controller</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gadget_driver</span></code></dt><dd><p>pointer to the gadget driver</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">clks</span></code></dt><dd><p>array of clocks</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_clks</span></code></dt><dd><p>number of clocks</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reset</span></code></dt><dd><p>reset control</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb2_phy</span></code></dt><dd><p>pointer to USB2 PHY</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb3_phy</span></code></dt><dd><p>pointer to USB3 PHY</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb2_generic_phy</span></code></dt><dd><p>pointer to USB2 PHY</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb3_generic_phy</span></code></dt><dd><p>pointer to USB3 PHY</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">phys_ready</span></code></dt><dd><p>flag to indicate that PHYs are ready</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ulpi</span></code></dt><dd><p>pointer to ulpi interface</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ulpi_ready</span></code></dt><dd><p>flag to indicate that ULPI is initialized</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">regs</span></code></dt><dd><p>base address for our registers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">regs_size</span></code></dt><dd><p>address space size</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dr_mode</span></code></dt><dd><p>requested mode of operation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">current_dr_role</span></code></dt><dd><p>current role of operation when in dual-role mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">desired_dr_role</span></code></dt><dd><p>desired role of operation when in dual-role mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">edev</span></code></dt><dd><p>extcon handle</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">edev_nb</span></code></dt><dd><p>extcon notifier</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hsphy_mode</span></code></dt><dd><p>UTMI phy mode, one of following:
- USBPHY_INTERFACE_MODE_UTMI
- USBPHY_INTERFACE_MODE_UTMIW</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">role_sw</span></code></dt><dd><p>usb_role_switch handle</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">role_switch_default_mode</span></code></dt><dd><p>default operation mode of controller while
usb role is USB_ROLE_NONE.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">fladj</span></code></dt><dd><p>frame length adjustment</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irq_gadget</span></code></dt><dd><p>peripheral controller’s IRQ number</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">otg_irq</span></code></dt><dd><p>IRQ number for OTG IRQs</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">current_otg_role</span></code></dt><dd><p>current role of operation while using the OTG block</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">desired_otg_role</span></code></dt><dd><p>desired role of operation while using the OTG block</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">otg_restart_host</span></code></dt><dd><p>flag that OTG controller needs to restart host</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nr_scratch</span></code></dt><dd><p>number of scratch buffers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u1u2</span></code></dt><dd><p>only used on revisions &lt;1.83a for workaround</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">maximum_speed</span></code></dt><dd><p>maximum speed requested (mainly for testing purposes)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gadget_max_speed</span></code></dt><dd><p>maximum gadget speed requested</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">max_ssp_rate</span></code></dt><dd><p>SuperSpeed Plus maximum signaling rate and lane count</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gadget_ssp_rate</span></code></dt><dd><p>Gadget driver’s maximum supported SuperSpeed Plus signaling
rate and lane count.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ip</span></code></dt><dd><p>controller’s ID</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">revision</span></code></dt><dd><p>controller’s version of an IP</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">version_type</span></code></dt><dd><p>VERSIONTYPE register contents, a sub release of a revision</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_next_event</span></code></dt><dd><p>hold the next expected event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0state</span></code></dt><dd><p>state of endpoint zero</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">link_state</span></code></dt><dd><p>link state</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u2sel</span></code></dt><dd><p>parameter from Set SEL request.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u2pel</span></code></dt><dd><p>parameter from Set SEL request.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u1sel</span></code></dt><dd><p>parameter from Set SEL request.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u1pel</span></code></dt><dd><p>parameter from Set SEL request.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">speed</span></code></dt><dd><p>device speed (super, high, full, low)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">num_eps</span></code></dt><dd><p>number of endpoints</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hwparams</span></code></dt><dd><p>copy of hwparams registers</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">root</span></code></dt><dd><p>debugfs root folder pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">regset</span></code></dt><dd><p>debugfs pointer to regdump file</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dbg_lsp_select</span></code></dt><dd><p>current debug lsp mux register selection</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">test_mode</span></code></dt><dd><p>true when we’re entering a USB test mode</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">test_mode_nr</span></code></dt><dd><p>test feature selector</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lpm_nyet_threshold</span></code></dt><dd><p>LPM NYET response threshold</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hird_threshold</span></code></dt><dd><p>HIRD threshold</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx_thr_num_pkt_prd</span></code></dt><dd><p>periodic ESS receive packet count</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx_max_burst_prd</span></code></dt><dd><p>max periodic ESS receive burst size</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_thr_num_pkt_prd</span></code></dt><dd><p>periodic ESS transmit packet count</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_max_burst_prd</span></code></dt><dd><p>max periodic ESS transmit burst size</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">hsphy_interface</span></code></dt><dd><p>“utmi” or “ulpi”</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">connected</span></code></dt><dd><p>true when we’re connected to a host, false otherwise</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">delayed_status</span></code></dt><dd><p>true when gadget driver asks for delayed status</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_bounced</span></code></dt><dd><p>true when we used bounce buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ep0_expect_in</span></code></dt><dd><p>true when we expect a DATA IN transfer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">has_hibernation</span></code></dt><dd><p>true when dwc3 was configured with Hibernation</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">sysdev_is_parent</span></code></dt><dd><p>true when dwc3 device has a parent driver</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">has_lpm_erratum</span></code></dt><dd><p>true when core was configured with LPM Erratum. Note that
there’s now way for software to detect this in runtime.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">is_utmi_l1_suspend</span></code></dt><dd><p>the core asserts output signal
0       - utmi_sleep_n
1       - utmi_l1_suspend_n</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">is_fpga</span></code></dt><dd><p>true when we are using the FPGA board</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending_events</span></code></dt><dd><p>true when we have pending IRQs to be handled</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pullups_connected</span></code></dt><dd><p>true when Run/Stop bit is set</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">setup_packet_pending</span></code></dt><dd><p>true when there’s a Setup Packet in FIFO. Workaround</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">three_stage_setup</span></code></dt><dd><p>set if we perform a three phase setup</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_start_transfer_quirk</span></code></dt><dd><p>set if start_transfer failure SW workaround is
not needed for DWC_usb31 version 1.70a-ea06 and below</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb3_lpm_capable</span></code></dt><dd><p>set if hadrware supports Link Power Management</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">usb2_lpm_disable</span></code></dt><dd><p>set to disable usb2 lpm</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">disable_scramble_quirk</span></code></dt><dd><p>set if we enable the disable scramble quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u2exit_lfps_quirk</span></code></dt><dd><p>set if we enable u2exit lfps quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u2ss_inp3_quirk</span></code></dt><dd><p>set if we enable P3 OK for U2/SS Inactive quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">req_p1p2p3_quirk</span></code></dt><dd><p>set if we enable request p1p2p3 quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">del_p1p2p3_quirk</span></code></dt><dd><p>set if we enable delay p1p2p3 quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">del_phy_power_chg_quirk</span></code></dt><dd><p>set if we enable delay phy power change quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lfps_filter_quirk</span></code></dt><dd><p>set if we enable LFPS filter quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx_detect_poll_quirk</span></code></dt><dd><p>set if we enable rx_detect to polling lfps quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_u3_susphy_quirk</span></code></dt><dd><p>set if we disable usb3 suspend phy</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_u2_susphy_quirk</span></code></dt><dd><p>set if we disable usb2 suspend phy</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_enblslpm_quirk</span></code></dt><dd><p>set if we clear enblslpm in GUSB2PHYCFG,
disabling the suspend signal to the PHY.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_u1_entry_quirk</span></code></dt><dd><p>set if link entering into U1 state needs to be disabled.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_u2_entry_quirk</span></code></dt><dd><p>set if link entering into U2 state needs to be disabled.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_rxdet_inp3_quirk</span></code></dt><dd><p>set if we disable Rx.Detect in P3</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_u2_freeclk_exists_quirk</span></code></dt><dd><p>set if we clear u2_freeclk_exists
in GUSB2PHYCFG, specify that USB2 PHY doesn’t
provide a free-running PHY clock.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_del_phy_power_chg_quirk</span></code></dt><dd><p>set if we disable delay phy power
change quirk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_tx_ipgap_linecheck_quirk</span></code></dt><dd><p>set if we disable u2mac linestate
check during HS transmit.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parkmode_disable_ss_quirk</span></code></dt><dd><p>set if we need to disable all SuperSpeed
instances in park mode.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_de_emphasis_quirk</span></code></dt><dd><p>set if we enable Tx de-emphasis quirk</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx_de_emphasis</span></code></dt><dd><p>Tx de-emphasis value
0       - -6dB de-emphasis
1       - -3.5dB de-emphasis
2       - No de-emphasis
3       - Reserved</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_metastability_quirk</span></code></dt><dd><p>set to disable metastability quirk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">dis_split_quirk</span></code></dt><dd><p>set to disable split boundary.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">imod_interval</span></code></dt><dd><p>set the interrupt moderation interval in 250ns
increments or 0 to disable.</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_event_depevt">
<em class="property">struct </em><code class="sig-name descname">dwc3_event_depevt</code><a class="headerlink" href="#c.dwc3_event_depevt" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Device Endpoint Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_event_depevt {
  u32 one_bit:1;
  u32 endpoint_number:5;
  u32 endpoint_event:4;
  u32 reserved11_10:2;
  u32 status:4;
#define DEPEVT_STATUS_TRANSFER_ACTIVE   BIT(3);
#define DEPEVT_STATUS_BUSERR    BIT(0);
#define DEPEVT_STATUS_SHORT     BIT(1);
#define DEPEVT_STATUS_IOC       BIT(2);
#define DEPEVT_STATUS_LST       BIT(3) ;
#define DEPEVT_STATUS_MISSED_ISOC BIT(3) ;
#define DEPEVT_STREAMEVT_FOUND          1;
#define DEPEVT_STREAMEVT_NOTFOUND       2;
#define DEPEVT_STREAM_PRIME             0xfffe;
#define DEPEVT_STREAM_NOSTREAM          0x0;
#define DEPEVT_STATUS_CONTROL_DATA      1;
#define DEPEVT_STATUS_CONTROL_STATUS    2;
#define DEPEVT_STATUS_CONTROL_PHASE(n)  ((n) &amp; 3);
#define DEPEVT_TRANSFER_NO_RESOURCE     1;
#define DEPEVT_TRANSFER_BUS_EXPIRY      2;
  u32 parameters:16;
#define DEPEVT_PARAMETER_CMD(n) (((n) &amp; (0xf &lt;&lt; 8)) &gt;&gt; 8);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">one_bit</span></code></dt><dd><p>indicates this is an endpoint event (not used)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">endpoint_number</span></code></dt><dd><p>number of the endpoint</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">endpoint_event</span></code></dt><dd><p>The event we have:
0x00    - Reserved
0x01    - XferComplete
0x02    - XferInProgress
0x03    - XferNotReady
0x04    - RxTxFifoEvt (IN-&gt;Underrun, OUT-&gt;Overrun)
0x05    - Reserved
0x06    - StreamEvt
0x07    - EPCmdCmplt</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reserved11_10</span></code></dt><dd><p>Reserved, don’t use.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd><p>Indicates the status of the event. Refer to databook for
more information.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">parameters</span></code></dt><dd><p>Parameters of the current event. Refer to databook for
more information.</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_event_devt">
<em class="property">struct </em><code class="sig-name descname">dwc3_event_devt</code><a class="headerlink" href="#c.dwc3_event_devt" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Device Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_event_devt {
  u32 one_bit:1;
  u32 device_event:7;
  u32 type:4;
  u32 reserved15_12:4;
  u32 event_info:9;
  u32 reserved31_25:7;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">one_bit</span></code></dt><dd><p>indicates this is a non-endpoint event (not used)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">device_event</span></code></dt><dd><p>indicates it’s a device event. Should read as 0x00</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>indicates the type of device event.
0       - DisconnEvt
1       - USBRst
2       - ConnectDone
3       - ULStChng
4       - WkUpEvt
5       - Reserved
6       - EOPF
7       - SOF
8       - Reserved
9       - ErrticErr
10      - CmdCmplt
11      - EvntOverflow
12      - VndrDevTstRcved</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reserved15_12</span></code></dt><dd><p>Reserved, not used</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event_info</span></code></dt><dd><p>Information about this event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reserved31_25</span></code></dt><dd><p>Reserved, not used</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_event_gevt">
<em class="property">struct </em><code class="sig-name descname">dwc3_event_gevt</code><a class="headerlink" href="#c.dwc3_event_gevt" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Other Core Events</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_event_gevt {
  u32 one_bit:1;
  u32 device_event:7;
  u32 phy_port_number:4;
  u32 reserved31_12:20;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">one_bit</span></code></dt><dd><p>indicates this is a non-endpoint event (not used)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">device_event</span></code></dt><dd><p>indicates it’s (0x03) Carkit or (0x04) I2C event.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">phy_port_number</span></code></dt><dd><p>self-explanatory</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">reserved31_12</span></code></dt><dd><p>Reserved, not used.</p>
</dd>
</dl>
<dl class="c union">
<dt id="c.dwc3_event">
<em class="property">union </em><code class="sig-name descname">dwc3_event</code><a class="headerlink" href="#c.dwc3_event" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>representation of Event Buffer contents</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>union dwc3_event {
  u32 raw;
  struct dwc3_event_type          type;
  struct dwc3_event_depevt        depevt;
  struct dwc3_event_devt          devt;
  struct dwc3_event_gevt          gevt;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">raw</span></code></dt><dd><p>raw 32-bit event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">type</span></code></dt><dd><p>the type of the event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">depevt</span></code></dt><dd><p>Device Endpoint Event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">devt</span></code></dt><dd><p>Device Event</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gevt</span></code></dt><dd><p>Global Event</p>
</dd>
</dl>
<dl class="c struct">
<dt id="c.dwc3_gadget_ep_cmd_params">
<em class="property">struct </em><code class="sig-name descname">dwc3_gadget_ep_cmd_params</code><a class="headerlink" href="#c.dwc3_gadget_ep_cmd_params" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>representation of endpoint command parameters</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct dwc3_gadget_ep_cmd_params {
  u32 param2;
  u32 param1;
  u32 param0;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">param2</span></code></dt><dd><p>third parameter</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">param1</span></code></dt><dd><p>second parameter</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">param0</span></code></dt><dd><p>first parameter</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.next_request">
<em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<code class="sig-name descname">next_request</code><span class="sig-paren">(</span><em class="property">struct</em> list_head *<em>list</em><span class="sig-paren">)</span><a class="headerlink" href="#c.next_request" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>gets the next request on the given list</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">list_head</span> <span class="pre">*list</span></code></dt><dd><p>the request list to operate on</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function return <code class="docutils literal notranslate"><span class="pre">NULL</span></code> or the first
request available on <strong>list</strong>.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_move_started_request">
void <code class="sig-name descname">dwc3_gadget_move_started_request</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_move_started_request" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>move <strong>req</strong> to the started_list</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*req</span></code></dt><dd><p>the request to be moved</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will move <strong>req</strong> from its
current list to the endpoint’s started_list.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_move_cancelled_request">
void <code class="sig-name descname">dwc3_gadget_move_cancelled_request</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>req</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_move_cancelled_request" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>move <strong>req</strong> to the cancelled_list</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*req</span></code></dt><dd><p>the request to be moved</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will move <strong>req</strong> from its
current list to the endpoint’s cancelled_list.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_ep_get_transfer_index">
void <code class="sig-name descname">dwc3_gadget_ep_get_transfer_index</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_ep_get_transfer_index" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Gets transfer index from HW</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>dwc3 endpoint</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Returns the transfer resource
index for a given endpoint.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_dctl_write_safe">
void <code class="sig-name descname">dwc3_gadget_dctl_write_safe</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, u32 <em>value</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_dctl_write_safe" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>write to DCTL safe from link state change</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">value</span></code></dt><dd><p>value to write to DCTL</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Use this function when doing read-modify-write to DCTL. It will not
send link state change request.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_set_test_mode">
int <code class="sig-name descname">dwc3_gadget_set_test_mode</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, int <em>mode</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_set_test_mode" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>enables usb2 test modes</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">mode</span></code></dt><dd><p>the mode to set (J, K SE0 NAK, Force Enable)</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will return 0 on
success or -EINVAL if wrong Test Selector is passed.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_get_link_state">
int <code class="sig-name descname">dwc3_gadget_get_link_state</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_get_link_state" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>gets current state of usb link</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will
return the link state on success (&gt;= 0) or -ETIMEDOUT.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_set_link_state">
int <code class="sig-name descname">dwc3_gadget_set_link_state</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, <em class="property">enum</em> dwc3_link_state <em>state</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_set_link_state" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>sets usb link to a particular state</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">dwc3_link_state</span> <span class="pre">state</span></code></dt><dd><p>the state to put link into</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. This function will
return 0 on success or -ETIMEDOUT.</p>
<dl class="c function">
<dt id="c.dwc3_ep_inc_trb">
void <code class="sig-name descname">dwc3_ep_inc_trb</code><span class="sig-paren">(</span>u8 *<em>index</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_trb" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>increment a trb index.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*index</span></code></dt><dd><p>Pointer to the TRB index to increment.</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>The index should never point to the link TRB. After incrementing,
if it is point to the link TRB, wrap around to the beginning. The
link TRB is always at the last TRB entry.</p>
<dl class="c function">
<dt id="c.dwc3_ep_inc_enq">
void <code class="sig-name descname">dwc3_ep_inc_enq</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_enq" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>increment endpoint’s enqueue pointer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>The endpoint whose enqueue pointer we’re incrementing</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_ep_inc_deq">
void <code class="sig-name descname">dwc3_ep_inc_deq</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_inc_deq" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>increment endpoint’s dequeue pointer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>The endpoint whose enqueue pointer we’re incrementing</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_gadget_giveback">
void <code class="sig-name descname">dwc3_gadget_giveback</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, <em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>req</em>, int <em>status</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_giveback" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>call <a class="reference internal" href="gadget.html#c.usb_request" title="usb_request"><code class="xref c c-struct docutils literal notranslate"><span class="pre">struct</span> <span class="pre">usb_request</span></code></a>’s -&gt;complete callback</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>The endpoint to whom the request belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*req</span></code></dt><dd><p>The request we’re giving back</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">status</span></code></dt><dd><p>completion code for the request</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Must be called with controller’s lock held and interrupts disabled. This
function will unmap <strong>req</strong> and call its -&gt;complete() callback to notify upper
layers that it has completed.</p>
<dl class="c function">
<dt id="c.dwc3_send_gadget_generic_command">
int <code class="sig-name descname">dwc3_send_gadget_generic_command</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, unsigned int <em>cmd</em>, u32 <em>param</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_send_gadget_generic_command" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>issue a generic command for the controller</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to the controller context</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">cmd</span></code></dt><dd><p>the command to be issued</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">param</span></code></dt><dd><p>command parameter</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Issue <strong>cmd</strong> with a given <strong>param</strong> to <strong>dwc</strong>
and wait for its completion.</p>
<dl class="c function">
<dt id="c.dwc3_send_gadget_ep_cmd">
int <code class="sig-name descname">dwc3_send_gadget_ep_cmd</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, unsigned int <em>cmd</em>, <em class="property">struct</em> <a class="reference internal" href="#c.dwc3_gadget_ep_cmd_params" title="dwc3_gadget_ep_cmd_params">dwc3_gadget_ep_cmd_params</a> *<em>params</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_send_gadget_ep_cmd" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>issue an endpoint command</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>the endpoint to which the command is going to be issued</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">cmd</span></code></dt><dd><p>the command to be issued</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_gadget_ep_cmd_params</span> <span class="pre">*params</span></code></dt><dd><p>parameters to the command</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should handle locking. This function will issue <strong>cmd</strong> with given
<strong>params</strong> to <strong>dep</strong> and wait for its completion.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_start_config">
int <code class="sig-name descname">dwc3_gadget_start_config</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_start_config" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>configure ep resources</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>endpoint that is being enabled</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Issue a <code class="docutils literal notranslate"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG</span></code> command to <strong>dep</strong>. After the command’s
completion, it will set Transfer Resource for all available endpoints.</p>
<p>The assignment of transfer resources cannot perfectly follow the data book
due to the fact that the controller driver does not have all knowledge of the
configuration in advance. It is given this information piecemeal by the
composite gadget framework after every SET_CONFIGURATION and
SET_INTERFACE. Trying to follow the databook programming model in this
scenario can cause errors. For two reasons:</p>
<p>1) The databook says to do <code class="docutils literal notranslate"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG</span></code> for every
<code class="docutils literal notranslate"><span class="pre">USB_REQ_SET_CONFIGURATION</span></code> and <code class="docutils literal notranslate"><span class="pre">USB_REQ_SET_INTERFACE</span></code> (8.1.5). This is
incorrect in the scenario of multiple interfaces.</p>
<p>2) The databook does not mention doing more <code class="docutils literal notranslate"><span class="pre">DWC3_DEPCMD_DEPXFERCFG</span></code> for new
endpoint on alt setting (8.1.6).</p>
<p>The following simplified method is used instead:</p>
<p>All hardware endpoints can be assigned a transfer resource and this setting
will stay persistent until either a core reset or hibernation. So whenever we
do a <code class="docutils literal notranslate"><span class="pre">DWC3_DEPCMD_DEPSTARTCFG``(0)</span> <span class="pre">we</span> <span class="pre">can</span> <span class="pre">go</span> <span class="pre">ahead</span> <span class="pre">and</span> <span class="pre">do</span>
<span class="pre">``DWC3_DEPCMD_DEPXFERCFG</span></code> for every hardware endpoint as well. We are
guaranteed that there are as many transfer resources as endpoints.</p>
<p>This function is called for each endpoint when it is being enabled but is
triggered only when called for EP0-out, which always happens first, and which
should only happen in one of the above conditions.</p>
<dl class="c function">
<dt id="c.__dwc3_gadget_ep_enable">
int <code class="sig-name descname">__dwc3_gadget_ep_enable</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, unsigned int <em>action</em><span class="sig-paren">)</span><a class="headerlink" href="#c.__dwc3_gadget_ep_enable" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>initializes a hw endpoint</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>endpoint to be initialized</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">action</span></code></dt><dd><p>one of INIT, MODIFY or RESTORE</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Caller should take care of locking. Execute all necessary commands to
initialize a HW endpoint so it can be used by a gadget driver.</p>
<dl class="c function">
<dt id="c.__dwc3_gadget_ep_disable">
int <code class="sig-name descname">__dwc3_gadget_ep_disable</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.__dwc3_gadget_ep_disable" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>disables a hw endpoint</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>the endpoint to disable</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function undoes what __dwc3_gadget_ep_enable did and also removes
requests which are currently being processed by the hardware and those which
are not yet scheduled.</p>
<p>Caller should take care of locking.</p>
<dl class="c function">
<dt id="c.dwc3_ep_prev_trb">
<em class="property">struct</em> <a class="reference internal" href="#c.dwc3_trb" title="dwc3_trb">dwc3_trb</a> *<code class="sig-name descname">dwc3_ep_prev_trb</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, u8 <em>index</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_ep_prev_trb" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>returns the previous TRB in the ring</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>The endpoint with the TRB ring</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">index</span></code></dt><dd><p>The index of the current TRB in the ring</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns the TRB prior to the one pointed to by the index. If the
index is 0, we will wrap backwards, skip the link TRB, and return
the one just before that.</p>
<dl class="c function">
<dt id="c.dwc3_prepare_one_trb">
void <code class="sig-name descname">dwc3_prepare_one_trb</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, <em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>req</em>, unsigned int <em>trb_length</em>, unsigned int <em>chain</em>, unsigned int <em>node</em>, bool <em>use_bounce_buffer</em>, bool <em>must_interrupt</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_prepare_one_trb" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>setup one TRB from one request</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>endpoint for which this request is prepared</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*req</span></code></dt><dd><p>dwc3_request pointer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">trb_length</span></code></dt><dd><p>buffer size of the TRB</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">chain</span></code></dt><dd><p>should this TRB be chained to the next?</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">node</span></code></dt><dd><p>only for isochronous endpoints. First TRB needs different type.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">use_bounce_buffer</span></code></dt><dd><p>set to use bounce buffer</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">must_interrupt</span></code></dt><dd><p>set to interrupt on TRB completion</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_prepare_last_sg">
int <code class="sig-name descname">dwc3_prepare_last_sg</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em>, <em class="property">struct</em> <a class="reference internal" href="#c.dwc3_request" title="dwc3_request">dwc3_request</a> *<em>req</em>, unsigned int <em>entry_length</em>, unsigned int <em>node</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_prepare_last_sg" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>prepare TRBs for the last SG entry</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>The endpoint that the request belongs to</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_request</span> <span class="pre">*req</span></code></dt><dd><p>The request to prepare</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">entry_length</span></code></dt><dd><p>The last SG entry size</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">int</span> <span class="pre">node</span></code></dt><dd><p>Indicates whether this is not the first entry (for isoc only)</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Return the number of TRBs prepared.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_start_isoc_quirk">
int <code class="sig-name descname">dwc3_gadget_start_isoc_quirk</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3_ep" title="dwc3_ep">dwc3_ep</a> *<em>dep</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_start_isoc_quirk" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>workaround invalid frame number</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_ep</span> <span class="pre">*dep</span></code></dt><dd><p>isoc endpoint</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>This function tests for the correct combination of BIT[15:14] from the 16-bit
microframe number reported by the XferNotReady event for the future frame
number to start the isoc transfer.</p>
<p>In DWC_usb31 version 1.70a-ea06 and prior, for highspeed and fullspeed
isochronous IN, BIT[15:14] of the 16-bit microframe number reported by the
XferNotReady event are invalid. The driver uses this number to schedule the
isochronous transfer and passes it to the START TRANSFER command. Because
this number is invalid, the command may fail. If BIT[15:14] matches the
internal 16-bit microframe, the START TRANSFER command will pass and the
transfer will start at the scheduled time, if it is off by 1, the command
will still pass, but the transfer will start 2 seconds in the future. For all
other conditions, the START TRANSFER command will fail with bus-expiry.</p>
<p>In order to workaround this issue, we can test for the correct combination of
BIT[15:14] by sending START TRANSFER commands with different values of
BIT[15:14]: ‘b00, ‘b01, ‘b10, and ‘b11. Each combination is 2^14 uframe apart
(or 2 seconds). 4 seconds into the future will result in a bus-expiry status.
As the result, within the 4 possible combinations for BIT[15:14], there will
be 2 successful and 2 failure START COMMAND status. One of the 2 successful
command status will result in a 2-second delay start. The smaller BIT[15:14]
value is the correct combination.</p>
<p>Since there are only 4 outcomes and the results are ordered, we can simply
test 2 START TRANSFER commands with BIT[15:14] combinations ‘b00 and ‘b01 to
deduce the smaller successful combination.</p>
<p>Let test0 = test status for combination ‘b00 and test1 = test status for ‘b01
of BIT[15:14]. The correct combination is as follow:</p>
<p>if test0 fails and test1 passes, BIT[15:14] is ‘b01
if test0 fails and test1 fails, BIT[15:14] is ‘b10
if test0 passes and test1 fails, BIT[15:14] is ‘b11
if test0 passes and test1 passes, BIT[15:14] is ‘b00</p>
<p>Synopsys STAR 9001202023: Wrong microframe number for isochronous IN
endpoints.</p>
<dl class="c function">
<dt id="c.dwc3_gadget_setup_nump">
void <code class="sig-name descname">dwc3_gadget_setup_nump</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_setup_nump" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>calculate and initialize NUMP field of <code class="docutils literal notranslate"><span class="pre">DWC3_DCFG</span></code></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>The following looks like complex but it’s actually very simple. In order to
calculate the number of packets we can burst at once on OUT transfers, we’re
gonna use RxFIFO size.</p>
<p>To calculate RxFIFO size we need two numbers:
MDWIDTH = size, in bits, of the internal memory bus
RAM2_DEPTH = depth, in MDWIDTH, of internal RAM2 (where RxFIFO sits)</p>
<p>Given these two numbers, the formula is simple:</p>
<p>RxFIFO Size = (RAM2_DEPTH * MDWIDTH / 8) - 24 - 16;</p>
<p>24 bytes is for 3x SETUP packets
16 bytes is a clock domain crossing tolerance</p>
<p>Given RxFIFO Size, NUMP = RxFIFOSize / 1024;</p>
<dl class="c function">
<dt id="c.dwc3_gadget_init">
int <code class="sig-name descname">dwc3_gadget_init</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_gadget_init" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>initializes gadget related registers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our controller context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<dl class="c function">
<dt id="c.dwc3_get_dr_mode">
int <code class="sig-name descname">dwc3_get_dr_mode</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_get_dr_mode" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Validates and sets dr_mode</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_core_soft_reset">
int <code class="sig-name descname">dwc3_core_soft_reset</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_core_soft_reset" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Issues core soft reset and PHY reset</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our context structure</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_free_one_event_buffer">
void <code class="sig-name descname">dwc3_free_one_event_buffer</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, <em class="property">struct</em> <a class="reference internal" href="#c.dwc3_event_buffer" title="dwc3_event_buffer">dwc3_event_buffer</a> *<em>evt</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_free_one_event_buffer" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Frees one event buffer</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>Pointer to our controller context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3_event_buffer</span> <span class="pre">*evt</span></code></dt><dd><p>Pointer to event buffer to be freed</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_alloc_one_event_buffer">
<em class="property">struct</em> <a class="reference internal" href="#c.dwc3_event_buffer" title="dwc3_event_buffer">dwc3_event_buffer</a> *<code class="sig-name descname">dwc3_alloc_one_event_buffer</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, unsigned <em>length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_alloc_one_event_buffer" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Allocates one event buffer structure</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>Pointer to our controller context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">length</span></code></dt><dd><p>size of the event buffer</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns a pointer to the allocated event buffer structure on success
otherwise ERR_PTR(errno).</p>
<dl class="c function">
<dt id="c.dwc3_free_event_buffers">
void <code class="sig-name descname">dwc3_free_event_buffers</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_free_event_buffers" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>frees all allocated event buffers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>Pointer to our controller context structure</p>
</dd>
</dl>
<dl class="c function">
<dt id="c.dwc3_alloc_event_buffers">
int <code class="sig-name descname">dwc3_alloc_event_buffers</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em>, unsigned <em>length</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_alloc_event_buffers" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Allocates <strong>num</strong> event buffers of size <strong>length</strong></p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our controller context structure</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">length</span></code></dt><dd><p>size of event buffer</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno. In the error case, dwc
may contain some buffers allocated but not all which were requested.</p>
<dl class="c function">
<dt id="c.dwc3_event_buffers_setup">
int <code class="sig-name descname">dwc3_event_buffers_setup</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_event_buffers_setup" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>setup our allocated event buffers</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>pointer to our controller context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<dl class="c function">
<dt id="c.dwc3_phy_setup">
int <code class="sig-name descname">dwc3_phy_setup</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_phy_setup" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Configure USB PHY Interface of DWC3 Core</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>Pointer to our controller context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success. The USB PHY interfaces are configured but not
initialized. The PHY interfaces and the PHYs get initialized together with
the core in dwc3_core_init.</p>
<dl class="c function">
<dt id="c.dwc3_core_init">
int <code class="sig-name descname">dwc3_core_init</code><span class="sig-paren">(</span><em class="property">struct</em> <a class="reference internal" href="#c.dwc3" title="dwc3">dwc3</a> *<em>dwc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.dwc3_core_init" title="Permalink to this definition">¶</a><br /></dt>
<dd><p>Low-level initialization of DWC3 Core</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dwc3</span> <span class="pre">*dwc</span></code></dt><dd><p>Pointer to our controller context structure</p>
</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns 0 on success otherwise negative errno.</p>
<dl class="footnote brackets">
<dt class="label" id="trb"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id4">2</a>,<a href="#id6">3</a>)</span></dt>
<dd><p>Transfer Request Block</p>
</dd>
<dt class="label" id="link-trb"><span class="brackets"><a class="fn-backref" href="#id7">2</a></span></dt>
<dd><p>Transfer Request Block pointing to another Transfer
Request Block.</p>
</dd>
<dt class="label" id="id9"><span class="brackets">3</span><span class="fn-backref">(<a href="#id2">1</a>,<a href="#id8">2</a>)</span></dt>
<dd><p>The Debug File System</p>
</dd>
<dt class="label" id="configfs"><span class="brackets"><a class="fn-backref" href="#id3">4</a></span></dt>
<dd><p>The Config File System</p>
</dd>
<dt class="label" id="cbw"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p>Command Block Wrapper</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="writing_musb_glue_layer.html" class="btn btn-neutral float-right" title="Writing a MUSB Glue Layer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="writing_usb_driver.html" class="btn btn-neutral float-left" title="Writing USB Device Drivers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>