

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4. Request API &mdash; The Linux Kernel 5.10.0-rc6+ documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="5. Function Reference" href="media-funcs.html" />
    <link rel="prev" title="3. Types and flags used to represent the media graph elements" href="media-types.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.10.0-rc6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">The Linux kernel user-space API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unshare.html">unshare system call</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accelerators/ocxl.html">OpenCAPI (Open Coherent Accelerator Processor Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iommu.html">IOMMU Userspace API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux Media Infrastructure userspace API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../v4l/v4l2.html">Part I - Video for Linux API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dvb/dvbapi.html">Part II - Digital TV API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rc/remote_controllers.html">Part III - Remote Controller API</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="media-controller.html">Part IV - Media Controller API</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="media-controller-intro.html">1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-controller-model.html">2. Media device model</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-types.html">3. Types and flags used to represent the media graph elements</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">4. Request API</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-funcs.html">5. Function Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-header.html">6. Media Controller Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-controller.html#revision-and-copyright">Revision and Copyright</a></li>
<li class="toctree-l4"><a class="reference internal" href="media-controller.html#revision-history">Revision History</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../cec/cec-api.html">Part V - Consumer Electronics Control API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gen-errors.html">Generic Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdl-appendix.html">GNU Free Documentation License</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">The Linux kernel user-space API guide</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Media Infrastructure userspace API</a> &raquo;</li>
        
          <li><a href="media-controller.html">Part IV - Media Controller API</a> &raquo;</li>
        
      <li><span class="section-number">4. </span>Request API</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/userspace-api/media/mediactl/request-api.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="request-api">
<span id="media-request-api"></span><h1><span class="section-number">4. </span>Request API<a class="headerlink" href="#request-api" title="Permalink to this headline">¶</a></h1>
<p>The Request API has been designed to allow V4L2 to deal with requirements of
modern devices (stateless codecs, complex camera pipelines, …) and APIs
(Android Codec v2). One such requirement is the ability for devices belonging to
the same pipeline to reconfigure and collaborate closely on a per-frame basis.
Another is support of stateless codecs, which require controls to be applied
to specific frames (aka ‘per-frame controls’) in order to be used efficiently.</p>
<p>While the initial use-case was V4L2, it can be extended to other subsystems
as well, as long as they use the media controller.</p>
<p>Supporting these features without the Request API is not always possible and if
it is, it is terribly inefficient: user-space would have to flush all activity
on the media pipeline, reconfigure it for the next frame, queue the buffers to
be processed with that configuration, and wait until they are all available for
dequeuing before considering the next frame. This defeats the purpose of having
buffer queues since in practice only one buffer would be queued at a time.</p>
<p>The Request API allows a specific configuration of the pipeline (media
controller topology + configuration for each media entity) to be associated with
specific buffers. This allows user-space to schedule several tasks (“requests”)
with different configurations in advance, knowing that the configuration will be
applied when needed to get the expected result. Configuration values at the time
of request completion are also available for reading.</p>
<div class="section" id="general-usage">
<h2><span class="section-number">4.1. </span>General Usage<a class="headerlink" href="#general-usage" title="Permalink to this headline">¶</a></h2>
<p>The Request API extends the Media Controller API and cooperates with
subsystem-specific APIs to support request usage. At the Media Controller
level, requests are allocated from the supporting Media Controller device
node. Their life cycle is then managed through the request file descriptors in
an opaque way. Configuration data, buffer handles and processing results
stored in requests are accessed through subsystem-specific APIs extended for
request support, such as V4L2 APIs that take an explicit <code class="docutils literal notranslate"><span class="pre">request_fd</span></code>
parameter.</p>
</div>
<div class="section" id="request-allocation">
<h2><span class="section-number">4.2. </span>Request Allocation<a class="headerlink" href="#request-allocation" title="Permalink to this headline">¶</a></h2>
<p>User-space allocates requests using <a class="reference internal" href="media-ioc-request-alloc.html#media-ioc-request-alloc"><span class="std std-ref">ioctl MEDIA_IOC_REQUEST_ALLOC</span></a>
for the media device node. This returns a file descriptor representing the
request. Typically, several such requests will be allocated.</p>
</div>
<div class="section" id="request-preparation">
<h2><span class="section-number">4.3. </span>Request Preparation<a class="headerlink" href="#request-preparation" title="Permalink to this headline">¶</a></h2>
<p>Standard V4L2 ioctls can then receive a request file descriptor to express the
fact that the ioctl is part of said request, and is not to be applied
immediately. See <a class="reference internal" href="media-ioc-request-alloc.html#media-ioc-request-alloc"><span class="std std-ref">ioctl MEDIA_IOC_REQUEST_ALLOC</span></a> for a list of ioctls that
support this. Configurations set with a <code class="docutils literal notranslate"><span class="pre">request_fd</span></code> parameter are stored
instead of being immediately applied, and buffers queued to a request do not
enter the regular buffer queue until the request itself is queued.</p>
</div>
<div class="section" id="request-submission">
<h2><span class="section-number">4.4. </span>Request Submission<a class="headerlink" href="#request-submission" title="Permalink to this headline">¶</a></h2>
<p>Once the configuration and buffers of the request are specified, it can be
queued by calling <a class="reference internal" href="media-request-ioc-queue.html#media-request-ioc-queue"><span class="std std-ref">ioctl MEDIA_REQUEST_IOC_QUEUE</span></a> on the request file descriptor.
A request must contain at least one buffer, otherwise <code class="docutils literal notranslate"><span class="pre">ENOENT</span></code> is returned.
A queued request cannot be modified anymore.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>For <a class="reference internal" href="../v4l/dev-mem2mem.html#mem2mem"><span class="std std-ref">memory-to-memory devices</span></a> you can use requests only for
output buffers, not for capture buffers. Attempting to add a capture buffer
to a request will result in an <code class="docutils literal notranslate"><span class="pre">EBADR</span></code> error.</p>
</div>
<p>If the request contains configurations for multiple entities, individual drivers
may synchronize so the requested pipeline’s topology is applied before the
buffers are processed. Media controller drivers do a best effort implementation
since perfect atomicity may not be possible due to hardware limitations.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>It is not allowed to mix queuing requests with directly queuing buffers:
whichever method is used first locks this in place until
<a class="reference internal" href="../v4l/vidioc-streamon.html#vidioc-streamon"><span class="std std-ref">VIDIOC_STREAMOFF</span></a> is called or the device is
<a class="reference internal" href="../v4l/func-close.html#func-close"><span class="std std-ref">closed</span></a>. Attempts to directly queue a buffer when earlier
a buffer was queued via a request or vice versa will result in an <code class="docutils literal notranslate"><span class="pre">EBUSY</span></code>
error.</p>
</div>
<p>Controls can still be set without a request and are applied immediately,
regardless of whether a request is in use or not.</p>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p>Setting the same control through a request and also directly can lead to
undefined behavior!</p>
</div>
<p>User-space can <a class="reference internal" href="request-func-poll.html#c.MC.poll" title="poll"><code class="xref c c-func docutils literal notranslate"><span class="pre">poll()</span></code></a> a request file descriptor in
order to wait until the request completes. A request is considered complete
once all its associated buffers are available for dequeuing and all the
associated controls have been updated with the values at the time of completion.
Note that user-space does not need to wait for the request to complete to
dequeue its buffers: buffers that are available halfway through a request can
be dequeued independently of the request’s state.</p>
<p>A completed request contains the state of the device after the request was
executed. User-space can query that state by calling
<a class="reference internal" href="../v4l/vidioc-g-ext-ctrls.html#vidioc-g-ext-ctrls"><span class="std std-ref">ioctl VIDIOC_G_EXT_CTRLS</span></a> with the request file
descriptor. Calling <a class="reference internal" href="../v4l/vidioc-g-ext-ctrls.html#vidioc-g-ext-ctrls"><span class="std std-ref">ioctl VIDIOC_G_EXT_CTRLS</span></a> for a
request that has been queued but not yet completed will return <code class="docutils literal notranslate"><span class="pre">EBUSY</span></code>
since the control values might be changed at any time by the driver while the
request is in flight.</p>
</div>
<div class="section" id="recycling-and-destruction">
<span id="media-request-life-time"></span><h2><span class="section-number">4.5. </span>Recycling and Destruction<a class="headerlink" href="#recycling-and-destruction" title="Permalink to this headline">¶</a></h2>
<p>Finally, a completed request can either be discarded or be reused. Calling
<a class="reference internal" href="media-func-close.html#c.MC.close" title="close"><code class="xref c c-func docutils literal notranslate"><span class="pre">close()</span></code></a> on a request file descriptor will make
that file descriptor unusable and the request will be freed once it is no
longer in use by the kernel. That is, if the request is queued and then the
file descriptor is closed, then it won’t be freed until the driver completed
the request.</p>
<p>The <a class="reference internal" href="media-request-ioc-reinit.html#media-request-ioc-reinit"><span class="std std-ref">ioctl MEDIA_REQUEST_IOC_REINIT</span></a> will clear a request’s state and make it
available again. No state is retained by this operation: the request is as
if it had just been allocated.</p>
</div>
<div class="section" id="example-for-a-codec-device">
<h2><span class="section-number">4.6. </span>Example for a Codec Device<a class="headerlink" href="#example-for-a-codec-device" title="Permalink to this headline">¶</a></h2>
<p>For use-cases such as <a class="reference internal" href="../v4l/dev-mem2mem.html#mem2mem"><span class="std std-ref">codecs</span></a>, the request API can be used
to associate specific controls to
be applied by the driver for the OUTPUT buffer, allowing user-space
to queue many such buffers in advance. It can also take advantage of requests’
ability to capture the state of controls when the request completes to read back
information that may be subject to change.</p>
<p>Put into code, after obtaining a request, user-space can assign controls and one
OUTPUT buffer to it:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">v4l2_buffer</span> <span class="n">buf</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">v4l2_ext_controls</span> <span class="n">ctrls</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">media_fd</span><span class="p">,</span> <span class="n">MEDIA_IOC_REQUEST_ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_fd</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">V4L2_CTRL_WHICH_REQUEST_VAL</span><span class="p">;</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">request_fd</span> <span class="o">=</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">codec_fd</span><span class="p">,</span> <span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
<span class="n">buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_REQUEST_FD</span><span class="p">;</span>
<span class="n">buf</span><span class="p">.</span><span class="n">request_fd</span> <span class="o">=</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">codec_fd</span><span class="p">,</span> <span class="n">VIDIOC_QBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that it is not allowed to use the Request API for CAPTURE buffers
since there are no per-frame settings to report there.</p>
<p>Once the request is fully prepared, it can be queued to the driver:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">req_fd</span><span class="p">,</span> <span class="n">MEDIA_REQUEST_IOC_QUEUE</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>User-space can then either wait for the request to complete by calling poll() on
its file descriptor, or start dequeuing CAPTURE buffers. Most likely, it will
want to get CAPTURE buffers as soon as possible and this can be done using a
regular <a class="reference internal" href="../v4l/vidioc-qbuf.html#vidioc-qbuf"><span class="std std-ref">VIDIOC_DQBUF</span></a>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">v4l2_buffer</span> <span class="n">buf</span><span class="p">;</span>

<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
<span class="n">buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">codec_fd</span><span class="p">,</span> <span class="n">VIDIOC_DQBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that this example assumes for simplicity that for every OUTPUT buffer
there will be one CAPTURE buffer, but this does not have to be the case.</p>
<p>We can then, after ensuring that the request is completed via polling the
request file descriptor, query control values at the time of its completion via
a call to <a class="reference internal" href="../v4l/vidioc-g-ext-ctrls.html#vidioc-g-ext-ctrls"><span class="std std-ref">VIDIOC_G_EXT_CTRLS</span></a>.
This is particularly useful for volatile controls for which we want to
query values as soon as the capture buffer is produced.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">pollfd</span> <span class="n">pfd</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLPRI</span><span class="p">,</span> <span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">req_fd</span> <span class="p">};</span>
<span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">-1</span><span class="p">);</span>
<span class="p">...</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">V4L2_CTRL_WHICH_REQUEST_VAL</span><span class="p">;</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">request_fd</span> <span class="o">=</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">codec_fd</span><span class="p">,</span> <span class="n">VIDIOC_G_EXT_CTRLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>Once we don’t need the request anymore, we can either recycle it for reuse with
<a class="reference internal" href="media-request-ioc-reinit.html#media-request-ioc-reinit"><span class="std std-ref">ioctl MEDIA_REQUEST_IOC_REINIT</span></a>…</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">req_fd</span><span class="p">,</span> <span class="n">MEDIA_REQUEST_IOC_REINIT</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>… or close its file descriptor to completely dispose of it.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">close</span><span class="p">(</span><span class="n">req_fd</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="example-for-a-simple-capture-device">
<h2><span class="section-number">4.7. </span>Example for a Simple Capture Device<a class="headerlink" href="#example-for-a-simple-capture-device" title="Permalink to this headline">¶</a></h2>
<p>With a simple capture device, requests can be used to specify controls to apply
for a given CAPTURE buffer.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="nc">v4l2_buffer</span> <span class="n">buf</span><span class="p">;</span>
<span class="k">struct</span> <span class="nc">v4l2_ext_controls</span> <span class="n">ctrls</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">media_fd</span><span class="p">,</span> <span class="n">MEDIA_IOC_REQUEST_ALLOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_fd</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">V4L2_CTRL_WHICH_REQUEST_VAL</span><span class="p">;</span>
<span class="n">ctrls</span><span class="p">.</span><span class="n">request_fd</span> <span class="o">=</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">camera_fd</span><span class="p">,</span> <span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">...</span>
<span class="n">buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
<span class="n">buf</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_REQUEST_FD</span><span class="p">;</span>
<span class="n">buf</span><span class="p">.</span><span class="n">request_fd</span> <span class="o">=</span> <span class="n">req_fd</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">camera_fd</span><span class="p">,</span> <span class="n">VIDIOC_QBUF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>Once the request is fully prepared, it can be queued to the driver:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">req_fd</span><span class="p">,</span> <span class="n">MEDIA_REQUEST_IOC_QUEUE</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</pre></div>
</div>
<p>User-space can then dequeue buffers, wait for the request completion, query
controls and recycle the request as in the M2M example above.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="media-funcs.html" class="btn btn-neutral float-right" title="5. Function Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="media-types.html" class="btn btn-neutral float-left" title="3. Types and flags used to represent the media graph elements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright The kernel development community

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>