

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Debugging hibernation and suspend &mdash; The Linux Kernel 5.7.0-rc1+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Charger Manager" href="charger-manager.html" />
    <link rel="prev" title="APM or ACPI?" href="apm-acpi.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0-rc1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Power Management</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="apm-acpi.html">APM or ACPI?</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Debugging hibernation and suspend</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#testing-hibernation-aka-suspend-to-disk-or-std">1. Testing hibernation (aka suspend to disk or STD)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-test-modes-of-hibernation">a) Test modes of hibernation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#b-testing-minimal-configuration">b) Testing minimal configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="#c-using-the-test-resume-hibernation-option">c) Using the “test_resume” hibernation option</a></li>
<li class="toctree-l4"><a class="reference internal" href="#d-advanced-debugging">d) Advanced debugging</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-suspend-to-ram-str">2. Testing suspend to RAM (STR)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="charger-manager.html">Charger Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="drivers-testing.html">Testing suspend and resume support in device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="energy-model.html">Energy Model of CPUs</a></li>
<li class="toctree-l2"><a class="reference internal" href="freezing-of-tasks.html">Freezing of tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="opp.html">Operating Performance Points (OPP) Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="pci.html">PCI Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="pm_qos_interface.html">PM Quality Of Service Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="power_supply_class.html">Linux power supply class</a></li>
<li class="toctree-l2"><a class="reference internal" href="runtime_pm.html">Runtime Power Management Framework for I/O Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="s2ram.html">How to get s2ram working</a></li>
<li class="toctree-l2"><a class="reference internal" href="suspend-and-cpuhotplug.html">Interaction of Suspend code (S3) with the CPU hotplug infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="suspend-and-interrupts.html">System Suspend and Device Interrupts</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp-and-swap-files.html">Using swap files with software suspend (swsusp)</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp-dmcrypt.html">How to use dm-crypt and swsusp together</a></li>
<li class="toctree-l2"><a class="reference internal" href="swsusp.html">Swap suspend</a></li>
<li class="toctree-l2"><a class="reference internal" href="video.html">Video issues with S3 resume</a></li>
<li class="toctree-l2"><a class="reference internal" href="tricks.html">swsusp/S3 tricks</a></li>
<li class="toctree-l2"><a class="reference internal" href="userland-swsusp.html">Documentation for userland software suspend interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="powercap/powercap.html">Power Capping Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/consumer.html">Regulator Consumer Driver Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/design.html">Regulator API design notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/machine.html">Regulator Machine Driver Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/overview.html">Linux voltage and current regulator framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulator/regulator.html">Regulator Driver Interface</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Power Management</a> &raquo;</li>
        
      <li>Debugging hibernation and suspend</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/power/basic-pm-debugging.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="debugging-hibernation-and-suspend">
<h1>Debugging hibernation and suspend<a class="headerlink" href="#debugging-hibernation-and-suspend" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><ol class="upperalpha simple" start="3">
<li><p>2007 Rafael J. Wysocki &lt;<a class="reference external" href="mailto:rjw&#37;&#52;&#48;sisk&#46;pl">rjw<span>&#64;</span>sisk<span>&#46;</span>pl</a>&gt;, GPL</p></li>
</ol>
</div></blockquote>
<div class="section" id="testing-hibernation-aka-suspend-to-disk-or-std">
<h2>1. Testing hibernation (aka suspend to disk or STD)<a class="headerlink" href="#testing-hibernation-aka-suspend-to-disk-or-std" title="Permalink to this headline">¶</a></h2>
<p>To check if hibernation works, you can try to hibernate in the “reboot” mode:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo reboot &gt; /sys/power/disk
# echo disk &gt; /sys/power/state
</pre></div>
</div>
<p>and the system should create a hibernation image, reboot, resume and get back to
the command prompt where you have started the transition.  If that happens,
hibernation is most likely to work correctly.  Still, you need to repeat the
test at least a couple of times in a row for confidence.  [This is necessary,
because some problems only show up on a second attempt at suspending and
resuming the system.]  Moreover, hibernating in the “reboot” and “shutdown”
modes causes the PM core to skip some platform-related callbacks which on ACPI
systems might be necessary to make hibernation work.  Thus, if your machine
fails to hibernate or resume in the “reboot” mode, you should try the
“platform” mode:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo platform &gt; /sys/power/disk
# echo disk &gt; /sys/power/state
</pre></div>
</div>
<p>which is the default and recommended mode of hibernation.</p>
<p>Unfortunately, the “platform” mode of hibernation does not work on some systems
with broken BIOSes.  In such cases the “shutdown” mode of hibernation might
work:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo shutdown &gt; /sys/power/disk
# echo disk &gt; /sys/power/state
</pre></div>
</div>
<p>(it is similar to the “reboot” mode, but it requires you to press the power
button to make the system resume).</p>
<p>If neither “platform” nor “shutdown” hibernation mode works, you will need to
identify what goes wrong.</p>
<div class="section" id="a-test-modes-of-hibernation">
<h3>a) Test modes of hibernation<a class="headerlink" href="#a-test-modes-of-hibernation" title="Permalink to this headline">¶</a></h3>
<p>To find out why hibernation fails on your system, you can use a special testing
facility available if the kernel is compiled with CONFIG_PM_DEBUG set.  Then,
there is the file /sys/power/pm_test that can be used to make the hibernation
core run in a test mode.  There are 5 test modes available:</p>
<dl class="simple">
<dt>freezer</dt><dd><ul class="simple">
<li><p>test the freezing of processes</p></li>
</ul>
</dd>
<dt>devices</dt><dd><ul class="simple">
<li><p>test the freezing of processes and suspending of devices</p></li>
</ul>
</dd>
<dt>platform</dt><dd><ul class="simple">
<li><p>test the freezing of processes, suspending of devices and platform
global control methods <a class="footnote-reference brackets" href="#id4" id="id1">1</a></p></li>
</ul>
</dd>
<dt>processors</dt><dd><ul class="simple">
<li><p>test the freezing of processes, suspending of devices, platform
global control methods <a class="footnote-reference brackets" href="#id4" id="id2">1</a> and the disabling of nonboot CPUs</p></li>
</ul>
</dd>
<dt>core</dt><dd><ul class="simple">
<li><p>test the freezing of processes, suspending of devices, platform global
control methods<a class="footnote-reference brackets" href="#id4" id="id3">1</a>, the disabling of nonboot CPUs and suspending
of platform/system devices</p></li>
</ul>
</dd>
</dl>
<dl class="footnote brackets">
<dt class="label" id="id4"><span class="brackets">1</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>,<a href="#id3">3</a>)</span></dt>
<dd><p>the platform global control methods are only available on ACPI systems
and are only tested if the hibernation mode is set to “platform”</p>
</dd>
</dl>
<p>To use one of them it is necessary to write the corresponding string to
/sys/power/pm_test (eg. “devices” to test the freezing of processes and
suspending devices) and issue the standard hibernation commands.  For example,
to use the “devices” test mode along with the “platform” mode of hibernation,
you should do the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo devices &gt; /sys/power/pm_test
# echo platform &gt; /sys/power/disk
# echo disk &gt; /sys/power/state
</pre></div>
</div>
<p>Then, the kernel will try to freeze processes, suspend devices, wait a few
seconds (5 by default, but configurable by the suspend.pm_test_delay module
parameter), resume devices and thaw processes.  If “platform” is written to
/sys/power/pm_test , then after suspending devices the kernel will additionally
invoke the global control methods (eg. ACPI global control methods) used to
prepare the platform firmware for hibernation.  Next, it will wait a
configurable number of seconds and invoke the platform (eg. ACPI) global
methods used to cancel hibernation etc.</p>
<p>Writing “none” to /sys/power/pm_test causes the kernel to switch to the normal
hibernation/suspend operations.  Also, when open for reading, /sys/power/pm_test
contains a space-separated list of all available tests (including “none” that
represents the normal functionality) in which the current test level is
indicated by square brackets.</p>
<p>Generally, as you can see, each test level is more “invasive” than the previous
one and the “core” level tests the hardware and drivers as deeply as possible
without creating a hibernation image.  Obviously, if the “devices” test fails,
the “platform” test will fail as well and so on.  Thus, as a rule of thumb, you
should try the test modes starting from “freezer”, through “devices”, “platform”
and “processors” up to “core” (repeat the test on each level a couple of times
to make sure that any random factors are avoided).</p>
<p>If the “freezer” test fails, there is a task that cannot be frozen (in that case
it usually is possible to identify the offending task by analysing the output of
dmesg obtained after the failing test).  Failure at this level usually means
that there is a problem with the tasks freezer subsystem that should be
reported.</p>
<p>If the “devices” test fails, most likely there is a driver that cannot suspend
or resume its device (in the latter case the system may hang or become unstable
after the test, so please take that into consideration).  To find this driver,
you can carry out a binary search according to the rules:</p>
<ul class="simple">
<li><p>if the test fails, unload a half of the drivers currently loaded and repeat
(that would probably involve rebooting the system, so always note what drivers
have been loaded before the test),</p></li>
<li><p>if the test succeeds, load a half of the drivers you have unloaded most
recently and repeat.</p></li>
</ul>
<p>Once you have found the failing driver (there can be more than just one of
them), you have to unload it every time before hibernation.  In that case please
make sure to report the problem with the driver.</p>
<p>It is also possible that the “devices” test will still fail after you have
unloaded all modules. In that case, you may want to look in your kernel
configuration for the drivers that can be compiled as modules (and test again
with these drivers compiled as modules).  You may also try to use some special
kernel command line options such as “noapic”, “noacpi” or even “acpi=off”.</p>
<p>If the “platform” test fails, there is a problem with the handling of the
platform (eg. ACPI) firmware on your system.  In that case the “platform” mode
of hibernation is not likely to work.  You can try the “shutdown” mode, but that
is rather a poor man’s workaround.</p>
<p>If the “processors” test fails, the disabling/enabling of nonboot CPUs does not
work (of course, this only may be an issue on SMP systems) and the problem
should be reported.  In that case you can also try to switch the nonboot CPUs
off and on using the /sys/devices/system/cpu/cpu*/online sysfs attributes and
see if that works.</p>
<p>If the “core” test fails, which means that suspending of the system/platform
devices has failed (these devices are suspended on one CPU with interrupts off),
the problem is most probably hardware-related and serious, so it should be
reported.</p>
<p>A failure of any of the “platform”, “processors” or “core” tests may cause your
system to hang or become unstable, so please beware.  Such a failure usually
indicates a serious problem that very well may be related to the hardware, but
please report it anyway.</p>
</div>
<div class="section" id="b-testing-minimal-configuration">
<h3>b) Testing minimal configuration<a class="headerlink" href="#b-testing-minimal-configuration" title="Permalink to this headline">¶</a></h3>
<p>If all of the hibernation test modes work, you can boot the system with the
“init=/bin/bash” command line parameter and attempt to hibernate in the
“reboot”, “shutdown” and “platform” modes.  If that does not work, there
probably is a problem with a driver statically compiled into the kernel and you
can try to compile more drivers as modules, so that they can be tested
individually.  Otherwise, there is a problem with a modular driver and you can
find it by loading a half of the modules you normally use and binary searching
in accordance with the algorithm:
- if there are n modules loaded and the attempt to suspend and resume fails,
unload n/2 of the modules and try again (that would probably involve rebooting
the system),
- if there are n modules loaded and the attempt to suspend and resume succeeds,
load n/2 modules more and try again.</p>
<p>Again, if you find the offending module(s), it(they) must be unloaded every time
before hibernation, and please report the problem with it(them).</p>
</div>
<div class="section" id="c-using-the-test-resume-hibernation-option">
<h3>c) Using the “test_resume” hibernation option<a class="headerlink" href="#c-using-the-test-resume-hibernation-option" title="Permalink to this headline">¶</a></h3>
<p>/sys/power/disk generally tells the kernel what to do after creating a
hibernation image.  One of the available options is “test_resume” which
causes the just created image to be used for immediate restoration.  Namely,
after doing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># echo test_resume &gt; /sys/power/disk
# echo disk &gt; /sys/power/state
</pre></div>
</div>
<p>a hibernation image will be created and a resume from it will be triggered
immediately without involving the platform firmware in any way.</p>
<p>That test can be used to check if failures to resume from hibernation are
related to bad interactions with the platform firmware.  That is, if the above
works every time, but resume from actual hibernation does not work or is
unreliable, the platform firmware may be responsible for the failures.</p>
<p>On architectures and platforms that support using different kernels to restore
hibernation images (that is, the kernel used to read the image from storage and
load it into memory is different from the one included in the image) or support
kernel address space randomization, it also can be used to check if failures
to resume may be related to the differences between the restore and image
kernels.</p>
</div>
<div class="section" id="d-advanced-debugging">
<h3>d) Advanced debugging<a class="headerlink" href="#d-advanced-debugging" title="Permalink to this headline">¶</a></h3>
<p>In case that hibernation does not work on your system even in the minimal
configuration and compiling more drivers as modules is not practical or some
modules cannot be unloaded, you can use one of the more advanced debugging
techniques to find the problem.  First, if there is a serial port in your box,
you can boot the kernel with the ‘no_console_suspend’ parameter and try to log
kernel messages using the serial console.  This may provide you with some
information about the reasons of the suspend (resume) failure.  Alternatively,
it may be possible to use a FireWire port for debugging with firescope
(<a class="reference external" href="http://v3.sk/~lkundrak/firescope/">http://v3.sk/~lkundrak/firescope/</a>).  On x86 it is also possible to
use the PM_TRACE mechanism documented in Documentation/power/s2ram.rst .</p>
</div>
</div>
<div class="section" id="testing-suspend-to-ram-str">
<h2>2. Testing suspend to RAM (STR)<a class="headerlink" href="#testing-suspend-to-ram-str" title="Permalink to this headline">¶</a></h2>
<p>To verify that the STR works, it is generally more convenient to use the s2ram
tool available from <a class="reference external" href="http://suspend.sf.net">http://suspend.sf.net</a> and documented at
<a class="reference external" href="http://en.opensuse.org/SDB:Suspend_to_RAM">http://en.opensuse.org/SDB:Suspend_to_RAM</a> (S2RAM_LINK).</p>
<p>Namely, after writing “freezer”, “devices”, “platform”, “processors”, or “core”
into /sys/power/pm_test (available if the kernel is compiled with
CONFIG_PM_DEBUG set) the suspend code will work in the test mode corresponding
to given string.  The STR test modes are defined in the same way as for
hibernation, so please refer to Section 1 for more information about them.  In
particular, the “core” test allows you to test everything except for the actual
invocation of the platform firmware in order to put the system into the sleep
state.</p>
<p>Among other things, the testing with the help of /sys/power/pm_test may allow
you to identify drivers that fail to suspend or resume their devices.  They
should be unloaded every time before an STR transition.</p>
<p>Next, you can follow the instructions at S2RAM_LINK to test the system, but if
it does not work “out of the box”, you may need to boot it with
“init=/bin/bash” and test s2ram in the minimal configuration.  In that case,
you may be able to search for failing drivers by following the procedure
analogous to the one described in section 1.  If you find some failing drivers,
you will have to unload them every time before an STR transition (ie. before
you run s2ram), and please report the problems with them.</p>
<p>There is a debugfs entry which shows the suspend to RAM statistics. Here is an
example of its output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mount -t debugfs none /sys/kernel/debug
# cat /sys/kernel/debug/suspend_stats
success: 20
fail: 5
failed_freeze: 0
failed_prepare: 0
failed_suspend: 5
failed_suspend_noirq: 0
failed_resume: 0
failed_resume_noirq: 0
failures:
  last_failed_dev:      alarm
                        adc
  last_failed_errno:    -16
                        -16
  last_failed_step:     suspend
                        suspend
</pre></div>
</div>
<p>Field success means the success number of suspend to RAM, and field fail means
the failure number. Others are the failure number of different steps of suspend
to RAM. suspend_stats just lists the last 2 failed devices, error number and
failed step of suspend.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="charger-manager.html" class="btn btn-neutral float-right" title="Charger Manager" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="apm-acpi.html" class="btn btn-neutral float-left" title="APM or ACPI?" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>