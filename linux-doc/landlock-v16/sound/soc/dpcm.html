

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Dynamic PCM &mdash; The Linux Kernel 5.7.0-rc1+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Creating codec to codec dai link for ALSA dapm" href="codec-to-codec.html" />
    <link rel="prev" title="ASoC jack detection" href="jack.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.7.0-rc1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Sound Subsystem Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../kernel-api/index.html">ALSA Kernel API Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../designs/index.html">Designs and Implementations</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">ALSA SoC Layer</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">ALSA SoC Layer Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="codec.html">ASoC Codec Class Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="dai.html">ASoC Digital Audio Interface (DAI)</a></li>
<li class="toctree-l3"><a class="reference internal" href="dapm.html">Dynamic Audio Power Management for Portable Devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="platform.html">ASoC Platform Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="machine.html">ASoC Machine Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="pops-clicks.html">Audio Pops and Clicks</a></li>
<li class="toctree-l3"><a class="reference internal" href="clocking.html">Audio Clocking</a></li>
<li class="toctree-l3"><a class="reference internal" href="jack.html">ASoC jack detection</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Dynamic PCM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#description">Description</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dpcm-machine-driver">DPCM machine driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-a-dpcm-dsp-driver">Writing a DPCM DSP driver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#hostless-pcm-streams">Hostless PCM streams</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="codec-to-codec.html">Creating codec to codec dai link for ALSA dapm</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../alsa-configuration.html">Advanced Linux Sound Architecture - Driver Configuration guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hd-audio/index.html">HD-Audio</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cards/index.html">Card-Specific Information</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nios2/nios2.html">Linux on the Nios II architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Sound Subsystem Documentation</a> &raquo;</li>
        
          <li><a href="index.html">ALSA SoC Layer</a> &raquo;</li>
        
      <li>Dynamic PCM</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/sound/soc/dpcm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dynamic-pcm">
<h1>Dynamic PCM<a class="headerlink" href="#dynamic-pcm" title="Permalink to this headline">¶</a></h1>
<div class="section" id="description">
<h2>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h2>
<p>Dynamic PCM allows an ALSA PCM device to digitally route its PCM audio to
various digital endpoints during the PCM stream runtime. e.g. PCM0 can route
digital audio to I2S DAI0, I2S DAI1 or PDM DAI2. This is useful for on SoC DSP
drivers that expose several ALSA PCMs and can route to multiple DAIs.</p>
<p>The DPCM runtime routing is determined by the ALSA mixer settings in the same
way as the analog signal is routed in an ASoC codec driver. DPCM uses a DAPM
graph representing the DSP internal audio paths and uses the mixer settings to
determine the path used by each ALSA PCM.</p>
<p>DPCM re-uses all the existing component codec, platform and DAI drivers without
any modifications.</p>
<div class="section" id="phone-audio-system-with-soc-based-dsp">
<h3>Phone Audio System with SoC based DSP<a class="headerlink" href="#phone-audio-system-with-soc-based-dsp" title="Permalink to this headline">¶</a></h3>
<p>Consider the following phone audio subsystem. This will be used in this
document for all examples :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>| Front End PCMs    |  SoC DSP  | Back End DAIs | Audio devices |

                    *************
PCM0 &lt;------------&gt; *           * &lt;----DAI0-----&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;----DAI1-----&gt; Codec Speakers
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;----DAI2-----&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;----DAI3-----&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>This diagram shows a simple smart phone audio subsystem. It supports Bluetooth,
FM digital radio, Speakers, Headset Jack, digital microphones and cellular
modem. This sound card exposes 4 DSP front end (FE) ALSA PCM devices and
supports 6 back end (BE) DAIs. Each FE PCM can digitally route audio data to any
of the BE DAIs. The FE PCM devices can also route audio to more than 1 BE DAI.</p>
</div>
<div class="section" id="example-dpcm-switching-playback-from-dai0-to-dai1">
<h3>Example - DPCM Switching playback from DAI0 to DAI1<a class="headerlink" href="#example-dpcm-switching-playback-from-dai0-to-dai1" title="Permalink to this headline">¶</a></h3>
<p>Audio is being played to the Headset. After a while the user removes the headset
and audio continues playing on the speakers.</p>
<p>Playback on PCM0 to Headset would look like :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                    *************
PCM0 &lt;============&gt; *           * &lt;====DAI0=====&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;----DAI1-----&gt; Codec Speakers
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;----DAI2-----&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;----DAI3-----&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>The headset is removed from the jack by user so the speakers must now be used :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                    *************
PCM0 &lt;============&gt; *           * &lt;----DAI0-----&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;====DAI1=====&gt; Codec Speakers
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;----DAI2-----&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;----DAI3-----&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>The audio driver processes this as follows :-</p>
<ol class="arabic simple">
<li><p>Machine driver receives Jack removal event.</p></li>
<li><p>Machine driver OR audio HAL disables the Headset path.</p></li>
<li><p>DPCM runs the PCM trigger(stop), hw_free(), shutdown() operations on DAI0
for headset since the path is now disabled.</p></li>
<li><p>Machine driver or audio HAL enables the speaker path.</p></li>
<li><p>DPCM runs the PCM ops for startup(), hw_params(), prepare() and
trigger(start) for DAI1 Speakers since the path is enabled.</p></li>
</ol>
<p>In this example, the machine driver or userspace audio HAL can alter the routing
and then DPCM will take care of managing the DAI PCM operations to either bring
the link up or down. Audio playback does not stop during this transition.</p>
</div>
</div>
<div class="section" id="dpcm-machine-driver">
<h2>DPCM machine driver<a class="headerlink" href="#dpcm-machine-driver" title="Permalink to this headline">¶</a></h2>
<p>The DPCM enabled ASoC machine driver is similar to normal machine drivers
except that we also have to :-</p>
<ol class="arabic simple">
<li><p>Define the FE and BE DAI links.</p></li>
<li><p>Define any FE/BE PCM operations.</p></li>
<li><p>Define widget graph connections.</p></li>
</ol>
<div class="section" id="fe-and-be-dai-links">
<h3>FE and BE DAI links<a class="headerlink" href="#fe-and-be-dai-links" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>| Front End PCMs    |  SoC DSP  | Back End DAIs | Audio devices |

                    *************
PCM0 &lt;------------&gt; *           * &lt;----DAI0-----&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;----DAI1-----&gt; Codec Speakers
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;----DAI2-----&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;----DAI3-----&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>For the example above we have to define 4 FE DAI links and 6 BE DAI links. The
FE DAI links are defined as follows :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static struct snd_soc_dai_link machine_dais[] = {
      {
              .name = &quot;PCM0 System&quot;,
              .stream_name = &quot;System Playback&quot;,
              .cpu_dai_name = &quot;System Pin&quot;,
              .platform_name = &quot;dsp-audio&quot;,
              .codec_name = &quot;snd-soc-dummy&quot;,
              .codec_dai_name = &quot;snd-soc-dummy-dai&quot;,
              .dynamic = 1,
              .trigger = {SND_SOC_DPCM_TRIGGER_POST, SND_SOC_DPCM_TRIGGER_POST},
              .dpcm_playback = 1,
      },
      .....&lt; other FE and BE DAI links here &gt;
};
</pre></div>
</div>
<p>This FE DAI link is pretty similar to a regular DAI link except that we also
set the DAI link to a DPCM FE with the <code class="docutils literal notranslate"><span class="pre">dynamic</span> <span class="pre">=</span> <span class="pre">1</span></code>. The supported FE stream
directions should also be set with the <code class="docutils literal notranslate"><span class="pre">dpcm_playback</span></code> and <code class="docutils literal notranslate"><span class="pre">dpcm_capture</span></code>
flags. There is also an option to specify the ordering of the trigger call for
each FE. This allows the ASoC core to trigger the DSP before or after the other
components (as some DSPs have strong requirements for the ordering DAI/DSP
start and stop sequences).</p>
<p>The FE DAI above sets the codec and code DAIs to dummy devices since the BE is
dynamic and will change depending on runtime config.</p>
<p>The BE DAIs are configured as follows :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static struct snd_soc_dai_link machine_dais[] = {
      .....&lt; FE DAI links here &gt;
      {
              .name = &quot;Codec Headset&quot;,
              .cpu_dai_name = &quot;ssp-dai.0&quot;,
              .platform_name = &quot;snd-soc-dummy&quot;,
              .no_pcm = 1,
              .codec_name = &quot;rt5640.0-001c&quot;,
              .codec_dai_name = &quot;rt5640-aif1&quot;,
              .ignore_suspend = 1,
              .ignore_pmdown_time = 1,
              .be_hw_params_fixup = hswult_ssp0_fixup,
              .ops = &amp;haswell_ops,
              .dpcm_playback = 1,
              .dpcm_capture = 1,
      },
      .....&lt; other BE DAI links here &gt;
};
</pre></div>
</div>
<p>This BE DAI link connects DAI0 to the codec (in this case RT5460 AIF1). It sets
the <code class="docutils literal notranslate"><span class="pre">no_pcm</span></code> flag to mark it has a BE and sets flags for supported stream
directions using <code class="docutils literal notranslate"><span class="pre">dpcm_playback</span></code> and <code class="docutils literal notranslate"><span class="pre">dpcm_capture</span></code> above.</p>
<p>The BE has also flags set for ignoring suspend and PM down time. This allows
the BE to work in a hostless mode where the host CPU is not transferring data
like a BT phone call :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                    *************
PCM0 &lt;------------&gt; *           * &lt;----DAI0-----&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;----DAI1-----&gt; Codec Speakers
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;====DAI2=====&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;====DAI3=====&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>This allows the host CPU to sleep while the DSP, MODEM DAI and the BT DAI are
still in operation.</p>
<p>A BE DAI link can also set the codec to a dummy device if the codec is a device
that is managed externally.</p>
<p>Likewise a BE DAI can also set a dummy cpu DAI if the CPU DAI is managed by the
DSP firmware.</p>
</div>
<div class="section" id="fe-be-pcm-operations">
<h3>FE/BE PCM operations<a class="headerlink" href="#fe-be-pcm-operations" title="Permalink to this headline">¶</a></h3>
<p>The BE above also exports some PCM operations and a <code class="docutils literal notranslate"><span class="pre">fixup</span></code> callback. The fixup
callback is used by the machine driver to (re)configure the DAI based upon the
FE hw params. i.e. the DSP may perform SRC or ASRC from the FE to BE.</p>
<p>e.g. DSP converts all FE hw params to run at fixed rate of 48k, 16bit, stereo for
DAI0. This means all FE hw_params have to be fixed in the machine driver for
DAI0 so that the DAI is running at desired configuration regardless of the FE
configuration.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static int dai0_fixup(struct snd_soc_pcm_runtime *rtd,
                      struct snd_pcm_hw_params *params)
{
      struct snd_interval *rate = hw_param_interval(params,
                      SNDRV_PCM_HW_PARAM_RATE);
      struct snd_interval *channels = hw_param_interval(params,
                                              SNDRV_PCM_HW_PARAM_CHANNELS);

      /* The DSP will convert the FE rate to 48k, stereo */
      rate-&gt;min = rate-&gt;max = 48000;
      channels-&gt;min = channels-&gt;max = 2;

      /* set DAI0 to 16 bit */
      params_set_format(params, SNDRV_PCM_FORMAT_S16_LE);
      return 0;
}
</pre></div>
</div>
<p>The other PCM operation are the same as for regular DAI links. Use as necessary.</p>
</div>
<div class="section" id="widget-graph-connections">
<h3>Widget graph connections<a class="headerlink" href="#widget-graph-connections" title="Permalink to this headline">¶</a></h3>
<p>The BE DAI links will normally be connected to the graph at initialisation time
by the ASoC DAPM core. However, if the BE codec or BE DAI is a dummy then this
has to be set explicitly in the driver :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* BE for codec Headset -  DAI0 is dummy and managed by DSP FW */
{&quot;DAI0 CODEC IN&quot;, NULL, &quot;AIF1 Capture&quot;},
{&quot;AIF1 Playback&quot;, NULL, &quot;DAI0 CODEC OUT&quot;},
</pre></div>
</div>
</div>
</div>
<div class="section" id="writing-a-dpcm-dsp-driver">
<h2>Writing a DPCM DSP driver<a class="headerlink" href="#writing-a-dpcm-dsp-driver" title="Permalink to this headline">¶</a></h2>
<p>The DPCM DSP driver looks much like a standard platform class ASoC driver
combined with elements from a codec class driver. A DSP platform driver must
implement :-</p>
<ol class="arabic simple">
<li><p>Front End PCM DAIs - i.e. struct snd_soc_dai_driver.</p></li>
<li><p>DAPM graph showing DSP audio routing from FE DAIs to BEs.</p></li>
<li><p>DAPM widgets from DSP graph.</p></li>
<li><p>Mixers for gains, routing, etc.</p></li>
<li><p>DMA configuration.</p></li>
<li><p>BE AIF widgets.</p></li>
</ol>
<p>Items 6 is important for routing the audio outside of the DSP. AIF need to be
defined for each BE and each stream direction. e.g for BE DAI0 above we would
have :-</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SND_SOC_DAPM_AIF_IN(&quot;DAI0 RX&quot;, NULL, 0, SND_SOC_NOPM, 0, 0),
SND_SOC_DAPM_AIF_OUT(&quot;DAI0 TX&quot;, NULL, 0, SND_SOC_NOPM, 0, 0),
</pre></div>
</div>
<p>The BE AIF are used to connect the DSP graph to the graphs for the other
component drivers (e.g. codec graph).</p>
</div>
<div class="section" id="hostless-pcm-streams">
<h2>Hostless PCM streams<a class="headerlink" href="#hostless-pcm-streams" title="Permalink to this headline">¶</a></h2>
<p>A hostless PCM stream is a stream that is not routed through the host CPU. An
example of this would be a phone call from handset to modem.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                    *************
PCM0 &lt;------------&gt; *           * &lt;----DAI0-----&gt; Codec Headset
                    *           *
PCM1 &lt;------------&gt; *           * &lt;====DAI1=====&gt; Codec Speakers/Mic
                    *   DSP     *
PCM2 &lt;------------&gt; *           * &lt;====DAI2=====&gt; MODEM
                    *           *
PCM3 &lt;------------&gt; *           * &lt;----DAI3-----&gt; BT
                    *           *
                    *           * &lt;----DAI4-----&gt; DMIC
                    *           *
                    *           * &lt;----DAI5-----&gt; FM
                    *************
</pre></div>
</div>
<p>In this case the PCM data is routed via the DSP. The host CPU in this use case
is only used for control and can sleep during the runtime of the stream.</p>
<p>The host can control the hostless link either by :-</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Configuring the link as a CODEC &lt;-&gt; CODEC style link. In this case the link
is enabled or disabled by the state of the DAPM graph. This usually means
there is a mixer control that can be used to connect or disconnect the path
between both DAIs.</p></li>
<li><p>Hostless FE. This FE has a virtual connection to the BE DAI links on the DAPM
graph. Control is then carried out by the FE as regular PCM operations.
This method gives more control over the DAI links, but requires much more
userspace code to control the link. Its recommended to use CODEC&lt;-&gt;CODEC
unless your HW needs more fine grained sequencing of the PCM ops.</p></li>
</ol>
</div></blockquote>
<div class="section" id="codec-codec-link">
<h3>CODEC &lt;-&gt; CODEC link<a class="headerlink" href="#codec-codec-link" title="Permalink to this headline">¶</a></h3>
<p>This DAI link is enabled when DAPM detects a valid path within the DAPM graph.
The machine driver sets some additional parameters to the DAI link i.e.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static const struct snd_soc_pcm_stream dai_params = {
      .formats = SNDRV_PCM_FMTBIT_S32_LE,
      .rate_min = 8000,
      .rate_max = 8000,
      .channels_min = 2,
      .channels_max = 2,
};

static struct snd_soc_dai_link dais[] = {
      &lt; ... more DAI links above ... &gt;
      {
              .name = &quot;MODEM&quot;,
              .stream_name = &quot;MODEM&quot;,
              .cpu_dai_name = &quot;dai2&quot;,
              .codec_dai_name = &quot;modem-aif1&quot;,
              .codec_name = &quot;modem&quot;,
              .dai_fmt = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF
                              | SND_SOC_DAIFMT_CBM_CFM,
              .params = &amp;dai_params,
      }
      &lt; ... more DAI links here ... &gt;
</pre></div>
</div>
<p>These parameters are used to configure the DAI hw_params() when DAPM detects a
valid path and then calls the PCM operations to start the link. DAPM will also
call the appropriate PCM operations to disable the DAI when the path is no
longer valid.</p>
</div>
<div class="section" id="hostless-fe">
<h3>Hostless FE<a class="headerlink" href="#hostless-fe" title="Permalink to this headline">¶</a></h3>
<p>The DAI link(s) are enabled by a FE that does not read or write any PCM data.
This means creating a new FE that is connected with a virtual path to both
DAI links. The DAI links will be started when the FE PCM is started and stopped
when the FE PCM is stopped. Note that the FE PCM cannot read or write data in
this configuration.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="codec-to-codec.html" class="btn btn-neutral float-right" title="Creating codec to codec dai link for ALSA dapm" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="jack.html" class="btn btn-neutral float-left" title="ASoC jack detection" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>