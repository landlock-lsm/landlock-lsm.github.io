

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>4.13. Sub-device Interface &mdash; The Linux Kernel 5.11.0-rc6+ documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="4.13.3.4.1. Media Bus Formats" href="subdev-formats.html" />
    <link rel="prev" title="4.12. Event Interface" href="dev-event.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.11.0-rc6
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Device Tree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">The Linux kernel user-space API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../unshare.html">unshare system call</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../accelerators/ocxl.html">OpenCAPI (Open Coherent Accelerator Processor Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../iommu.html">IOMMU Userspace API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">Linux Media Infrastructure userspace API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="v4l2.html">Part I - Video for Linux API</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="common.html">1. Common API Elements</a></li>
<li class="toctree-l4"><a class="reference internal" href="pixfmt.html">2. Image Formats</a></li>
<li class="toctree-l4"><a class="reference internal" href="io.html">3. Input/Output</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="devices.html">4. Interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="libv4l.html">5. Libv4l Userspace Library</a></li>
<li class="toctree-l4"><a class="reference internal" href="compat.html">6. Changes</a></li>
<li class="toctree-l4"><a class="reference internal" href="user-func.html">7. Function Reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="common-defs.html">8. Common definitions for V4L2 and V4L2 subdev interfaces</a></li>
<li class="toctree-l4"><a class="reference internal" href="videodev.html">9. Video For Linux Two Header File</a></li>
<li class="toctree-l4"><a class="reference internal" href="capture-example.html">10. Video Capture Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2grab-example.html">11. Video Grabber example using libv4l</a></li>
<li class="toctree-l4"><a class="reference internal" href="biblio.html">12. References</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-and-copyright">Revision and Copyright</a></li>
<li class="toctree-l4"><a class="reference internal" href="v4l2.html#revision-history">Revision History</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dvb/dvbapi.html">Part II - Digital TV API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../rc/remote_controllers.html">Part III - Remote Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mediactl/media-controller.html">Part IV - Media Controller API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cec/cec-api.html">Part V - Consumer Electronics Control API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../gen-errors.html">Generic Error Codes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdl-appendix.html">GNU Free Documentation License</a></li>
<li class="toctree-l3"><a class="reference internal" href="../drivers/index.html">Video4Linux (V4L)  driver-specific documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mhi/index.html">MHI</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arm/index.html">ARM Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../arm64/index.html">ARM64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ia64/index.html">IA-64 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../m68k/index.html">m68k Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mips/index.html">MIPS-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../nios2/index.html">Nios II Specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../openrisc/index.html">OpenRISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parisc/index.html">PA-RISC Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../powerpc/index.html">powerpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../riscv/index.html">RISC-V architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../s390/index.html">s390 Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sparc/index.html">Sparc Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../x86/index.html">x86-specific Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../xtensa/index.html">Xtensa Architecture</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">The Linux kernel user-space API guide</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Media Infrastructure userspace API</a> &raquo;</li>
        
          <li><a href="v4l2.html">Part I - Video for Linux API</a> &raquo;</li>
        
          <li><a href="devices.html"><span class="section-number">4. </span>Interfaces</a> &raquo;</li>
        
      <li><span class="section-number">4.13. </span>Sub-device Interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../../_sources/userspace-api/media/v4l/dev-subdev.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sub-device-interface">
<span id="subdev"></span><h1><span class="section-number">4.13. </span>Sub-device Interface<a class="headerlink" href="#sub-device-interface" title="Permalink to this headline">¶</a></h1>
<p>The complex nature of V4L2 devices, where hardware is often made of
several integrated circuits that need to interact with each other in a
controlled way, leads to complex V4L2 drivers. The drivers usually
reflect the hardware model in software, and model the different hardware
components as software blocks called sub-devices.</p>
<p>V4L2 sub-devices are usually kernel-only objects. If the V4L2 driver
implements the media device API, they will automatically inherit from
media entities. Applications will be able to enumerate the sub-devices
and discover the hardware topology using the media entities, pads and
links enumeration API.</p>
<p>In addition to make sub-devices discoverable, drivers can also choose to
make them directly configurable by applications. When both the
sub-device driver and the V4L2 device driver support this, sub-devices
will feature a character device node on which ioctls can be called to</p>
<ul class="simple">
<li><p>query, read and write sub-devices controls</p></li>
<li><p>subscribe and unsubscribe to events and retrieve them</p></li>
<li><p>negotiate image formats on individual pads</p></li>
</ul>
<p>Sub-device character device nodes, conventionally named
<code class="docutils literal notranslate"><span class="pre">/dev/v4l-subdev*</span></code>, use major number 81.</p>
<p>Drivers may opt to limit the sub-device character devices to only expose
operations that do not modify the device state. In such a case the sub-devices
are referred to as <code class="docutils literal notranslate"><span class="pre">read-only</span></code> in the rest of this documentation, and the
related restrictions are documented in individual ioctls.</p>
<div class="section" id="controls">
<h2><span class="section-number">4.13.1. </span>Controls<a class="headerlink" href="#controls" title="Permalink to this headline">¶</a></h2>
<p>Most V4L2 controls are implemented by sub-device hardware. Drivers
usually merge all controls and expose them through video device nodes.
Applications can control all sub-devices through a single interface.</p>
<p>Complex devices sometimes implement the same control in different pieces
of hardware. This situation is common in embedded platforms, where both
sensors and image processing hardware implement identical functions,
such as contrast adjustment, white balance or faulty pixels correction.
As the V4L2 controls API doesn’t support several identical controls in a
single device, all but one of the identical controls are hidden.</p>
<p>Applications can access those hidden controls through the sub-device
node with the V4L2 control API described in <a class="reference internal" href="control.html#control"><span class="std std-ref">User Controls</span></a>. The ioctls
behave identically as when issued on V4L2 device nodes, with the
exception that they deal only with controls implemented in the
sub-device.</p>
<p>Depending on the driver, those controls might also be exposed through
one (or several) V4L2 device nodes.</p>
</div>
<div class="section" id="events">
<h2><span class="section-number">4.13.2. </span>Events<a class="headerlink" href="#events" title="Permalink to this headline">¶</a></h2>
<p>V4L2 sub-devices can notify applications of events as described in
<a class="reference internal" href="dev-event.html#event"><span class="std std-ref">Event Interface</span></a>. The API behaves identically as when used on V4L2 device
nodes, with the exception that it only deals with events generated by
the sub-device. Depending on the driver, those events might also be
reported on one (or several) V4L2 device nodes.</p>
</div>
<div class="section" id="pad-level-formats">
<span id="id1"></span><h2><span class="section-number">4.13.3. </span>Pad-level Formats<a class="headerlink" href="#pad-level-formats" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Pad-level formats are only applicable to very complex devices that
need to expose low-level format configuration to user space. Generic
V4L2 applications do <em>not</em> need to use the API described in this
section.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the purpose of this section, the term <em>format</em> means the
combination of media bus data format, frame width and frame height.</p>
</div>
<p>Image formats are typically negotiated on video capture and output
devices using the format and
<a class="reference internal" href="vidioc-subdev-g-selection.html#vidioc-subdev-g-selection"><span class="std std-ref">selection</span></a> ioctls. The driver is
responsible for configuring every block in the video pipeline according
to the requested format at the pipeline input and/or output.</p>
<p>For complex devices, such as often found in embedded systems, identical
image sizes at the output of a pipeline can be achieved using different
hardware configurations. One such example is shown on
<a class="reference internal" href="#pipeline-scaling"><span class="std std-ref">Image Format Negotiation on Pipelines</span></a>, where image scaling can be performed on both
the video sensor and the host image processing hardware.</p>
<div class="figure align-center" id="id2">
<img alt="pipeline.dot" src="../../../_images/pipeline.svg" /><p class="caption"><span class="caption-text">Image Format Negotiation on Pipelines</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
<div class="legend">
<p>High quality and high speed pipeline configuration</p>
</div>
</div>
<p>The sensor scaler is usually of less quality than the host scaler, but
scaling on the sensor is required to achieve higher frame rates.
Depending on the use case (quality vs. speed), the pipeline must be
configured differently. Applications need to configure the formats at
every point in the pipeline explicitly.</p>
<p>Drivers that implement the <a class="reference internal" href="../mediactl/media-controller-intro.html#media-controller-intro"><span class="std std-ref">media API</span></a>
can expose pad-level image format configuration to applications. When
they do, applications can use the
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_G_FMT</span></a> and
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_S_FMT</span></a> ioctls. to
negotiate formats on a per-pad basis.</p>
<p>Applications are responsible for configuring coherent parameters on the
whole pipeline and making sure that connected pads have compatible
formats. The pipeline is checked for formats mismatch at
<a class="reference internal" href="vidioc-streamon.html#vidioc-streamon"><span class="std std-ref">VIDIOC_STREAMON</span></a> time, and an <code class="docutils literal notranslate"><span class="pre">EPIPE</span></code> error
code is then returned if the configuration is invalid.</p>
<p>Pad-level image format configuration support can be tested by calling
the <a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">ioctl VIDIOC_SUBDEV_G_FMT, VIDIOC_SUBDEV_S_FMT</span></a> ioctl on pad
0. If the driver returns an <code class="docutils literal notranslate"><span class="pre">EINVAL</span></code> error code pad-level format
configuration is not supported by the sub-device.</p>
<div class="section" id="format-negotiation">
<h3><span class="section-number">4.13.3.1. </span>Format Negotiation<a class="headerlink" href="#format-negotiation" title="Permalink to this headline">¶</a></h3>
<p>Acceptable formats on pads can (and usually do) depend on a number of
external parameters, such as formats on other pads, active links, or
even controls. Finding a combination of formats on all pads in a video
pipeline, acceptable to both application and driver, can’t rely on
formats enumeration only. A format negotiation mechanism is required.</p>
<p>Central to the format negotiation mechanism are the get/set format
operations. When called with the <code class="docutils literal notranslate"><span class="pre">which</span></code> argument set to
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">V4L2_SUBDEV_FORMAT_TRY</span></a>, the
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_G_FMT</span></a> and
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_S_FMT</span></a> ioctls operate on
a set of formats parameters that are not connected to the hardware
configuration. Modifying those ‘try’ formats leaves the device state
untouched (this applies to both the software state stored in the driver
and the hardware state stored in the device itself).</p>
<p>While not kept as part of the device state, try formats are stored in
the sub-device file handles. A
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_G_FMT</span></a> call will return
the last try format set <em>on the same sub-device file handle</em>. Several
applications querying the same sub-device at the same time will thus not
interact with each other.</p>
<p>To find out whether a particular format is supported by the device,
applications use the
<a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_S_FMT</span></a> ioctl. Drivers
verify and, if needed, change the requested <code class="docutils literal notranslate"><span class="pre">format</span></code> based on device
requirements and return the possibly modified value. Applications can
then choose to try a different format or accept the returned value and
continue.</p>
<p>Formats returned by the driver during a negotiation iteration are
guaranteed to be supported by the device. In particular, drivers
guarantee that a returned format will not be further changed if passed
to an <a class="reference internal" href="vidioc-subdev-g-fmt.html#vidioc-subdev-g-fmt"><span class="std std-ref">VIDIOC_SUBDEV_S_FMT</span></a> call as-is
(as long as external parameters, such as formats on other pads or links’
configuration are not changed).</p>
<p>Drivers automatically propagate formats inside sub-devices. When a try
or active format is set on a pad, corresponding formats on other pads of
the same sub-device can be modified by the driver. Drivers are free to
modify formats as required by the device. However, they should comply
with the following rules when possible:</p>
<ul class="simple">
<li><p>Formats should be propagated from sink pads to source pads. Modifying
a format on a source pad should not modify the format on any sink
pad.</p></li>
<li><p>Sub-devices that scale frames using variable scaling factors should
reset the scale factors to default values when sink pads formats are
modified. If the 1:1 scaling ratio is supported, this means that
source pads formats should be reset to the sink pads formats.</p></li>
</ul>
<p>Formats are not propagated across links, as that would involve
propagating them from one sub-device file handle to another.
Applications must then take care to configure both ends of every link
explicitly with compatible formats. Identical formats on the two ends of
a link are guaranteed to be compatible. Drivers are free to accept
different formats matching device requirements as being compatible.</p>
<p><a class="reference internal" href="#sample-pipeline-config"><span class="std std-ref">Sample Pipeline Configuration</span></a> shows a sample configuration sequence
for the pipeline described in <a class="reference internal" href="#pipeline-scaling"><span class="std std-ref">Image Format Negotiation on Pipelines</span></a> (table columns
list entity names and pad numbers).</p>
<span id="sample-pipeline-config"></span><table class="docutils align-default" id="id3">
<caption><span class="caption-text">Sample Pipeline Configuration</span><a class="headerlink" href="#id3" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Sensor/0</p>
<p>format</p>
</th>
<th class="head"><p>Frontend/0</p>
<p>format</p>
</th>
<th class="head"><p>Frontend/1</p>
<p>format</p>
</th>
<th class="head"><p>Scaler/0</p>
<p>format</p>
</th>
<th class="head"><p>Scaler/0</p>
<p>compose selection rectangle</p>
</th>
<th class="head"><p>Scaler/1</p>
<p>format</p>
</th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Initial state</p></td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
</tr>
<tr class="row-odd"><td><p>Configure frontend sink format</p></td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p><em>2048x1536</em></p>
<p><em>SGRBG8_1X8</em></p>
</td>
<td><p><em>2046x1534</em></p>
<p><em>SGRBG8_1X8</em></p>
</td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
<td><p>(default)</p></td>
</tr>
<tr class="row-even"><td><p>Configure scaler sink format</p></td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>2046x1534</p>
<p>SGRBG8_1X8</p>
</td>
<td><p><em>2046x1534</em></p>
<p><em>SGRBG8_1X8</em></p>
</td>
<td><p><em>0,0/2046x1534</em></p></td>
<td><p><em>2046x1534</em></p>
<p><em>SGRBG8_1X8</em></p>
</td>
</tr>
<tr class="row-odd"><td><p>Configure scaler sink compose selection</p></td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>2048x1536</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>2046x1534</p>
<p>SGRBG8_1X8</p>
</td>
<td><p>2046x1534</p>
<p>SGRBG8_1X8</p>
</td>
<td><p><em>0,0/1280x960</em></p></td>
<td><p><em>1280x960</em></p>
<p><em>SGRBG8_1X8</em></p>
</td>
</tr>
</tbody>
</table>
<ol class="arabic simple">
<li><p>Initial state. The sensor source pad format is set to its native 3MP
size and V4L2_MBUS_FMT_SGRBG8_1X8 media bus code. Formats on the
host frontend and scaler sink and source pads have the default
values, as well as the compose rectangle on the scaler’s sink pad.</p></li>
<li><p>The application configures the frontend sink pad format’s size to
2048x1536 and its media bus code to V4L2_MBUS_FMT_SGRBG_1X8. The
driver propagates the format to the frontend source pad.</p></li>
<li><p>The application configures the scaler sink pad format’s size to
2046x1534 and the media bus code to V4L2_MBUS_FMT_SGRBG_1X8 to
match the frontend source size and media bus code. The media bus code
on the sink pad is set to V4L2_MBUS_FMT_SGRBG_1X8. The driver
propagates the size to the compose selection rectangle on the
scaler’s sink pad, and the format to the scaler source pad.</p></li>
<li><p>The application configures the size of the compose selection
rectangle of the scaler’s sink pad 1280x960. The driver propagates
the size to the scaler’s source pad format.</p></li>
</ol>
<p>When satisfied with the try results, applications can set the active
formats by setting the <code class="docutils literal notranslate"><span class="pre">which</span></code> argument to
<code class="docutils literal notranslate"><span class="pre">V4L2_SUBDEV_FORMAT_ACTIVE</span></code>. Active formats are changed exactly as try
formats by drivers. To avoid modifying the hardware state during format
negotiation, applications should negotiate try formats first and then
modify the active settings using the try formats returned during the
last negotiation iteration. This guarantees that the active format will
be applied as-is by the driver without being modified.</p>
</div>
<div class="section" id="selections-cropping-scaling-and-composition">
<span id="v4l2-subdev-selections"></span><h3><span class="section-number">4.13.3.2. </span>Selections: cropping, scaling and composition<a class="headerlink" href="#selections-cropping-scaling-and-composition" title="Permalink to this headline">¶</a></h3>
<p>Many sub-devices support cropping frames on their input or output pads
(or possible even on both). Cropping is used to select the area of
interest in an image, typically on an image sensor or a video decoder.
It can also be used as part of digital zoom implementations to select
the area of the image that will be scaled up.</p>
<p>Crop settings are defined by a crop rectangle and represented in a
struct <a class="reference internal" href="dev-overlay.html#c.v4l2_rect" title="v4l2_rect"><code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_rect</span></code></a> by the coordinates of the top
left corner and the rectangle size. Both the coordinates and sizes are
expressed in pixels.</p>
<p>As for pad formats, drivers store try and active rectangles for the
selection targets <a class="reference internal" href="selections-common.html#v4l2-selections-common"><span class="std std-ref">Common selection definitions</span></a>.</p>
<p>On sink pads, cropping is applied relative to the current pad format.
The pad format represents the image size as received by the sub-device
from the previous block in the pipeline, and the crop rectangle
represents the sub-image that will be transmitted further inside the
sub-device for processing.</p>
<p>The scaling operation changes the size of the image by scaling it to new
dimensions. The scaling ratio isn’t specified explicitly, but is implied
from the original and scaled image sizes. Both sizes are represented by
struct <a class="reference internal" href="dev-overlay.html#c.v4l2_rect" title="v4l2_rect"><code class="xref c c-type docutils literal notranslate"><span class="pre">v4l2_rect</span></code></a>.</p>
<p>Scaling support is optional. When supported by a subdev, the crop
rectangle on the subdev’s sink pad is scaled to the size configured
using the
<a class="reference internal" href="vidioc-subdev-g-selection.html#vidioc-subdev-g-selection"><span class="std std-ref">VIDIOC_SUBDEV_S_SELECTION</span></a> IOCTL
using <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_TGT_COMPOSE</span></code> selection target on the same pad. If the
subdev supports scaling but not composing, the top and left values are
not used and must always be set to zero.</p>
<p>On source pads, cropping is similar to sink pads, with the exception
that the source size from which the cropping is performed, is the
COMPOSE rectangle on the sink pad. In both sink and source pads, the
crop rectangle must be entirely contained inside the source image size
for the crop operation.</p>
<p>The drivers should always use the closest possible rectangle the user
requests on all selection targets, unless specifically told otherwise.
<code class="docutils literal notranslate"><span class="pre">V4L2_SEL_FLAG_GE</span></code> and <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_FLAG_LE</span></code> flags may be used to round
the image size either up or down. <a class="reference internal" href="v4l2-selection-flags.html#v4l2-selection-flags"><span class="std std-ref">Selection flags</span></a></p>
</div>
<div class="section" id="types-of-selection-targets">
<h3><span class="section-number">4.13.3.3. </span>Types of selection targets<a class="headerlink" href="#types-of-selection-targets" title="Permalink to this headline">¶</a></h3>
<div class="section" id="actual-targets">
<h4><span class="section-number">4.13.3.3.1. </span>Actual targets<a class="headerlink" href="#actual-targets" title="Permalink to this headline">¶</a></h4>
<p>Actual targets (without a postfix) reflect the actual hardware
configuration at any point of time. There is a BOUNDS target
corresponding to every actual target.</p>
</div>
<div class="section" id="bounds-targets">
<h4><span class="section-number">4.13.3.3.2. </span>BOUNDS targets<a class="headerlink" href="#bounds-targets" title="Permalink to this headline">¶</a></h4>
<p>BOUNDS targets is the smallest rectangle that contains all valid actual
rectangles. It may not be possible to set the actual rectangle as large
as the BOUNDS rectangle, however. This may be because e.g. a sensor’s
pixel array is not rectangular but cross-shaped or round. The maximum
size may also be smaller than the BOUNDS rectangle.</p>
</div>
</div>
<div class="section" id="order-of-configuration-and-format-propagation">
<h3><span class="section-number">4.13.3.4. </span>Order of configuration and format propagation<a class="headerlink" href="#order-of-configuration-and-format-propagation" title="Permalink to this headline">¶</a></h3>
<p>Inside subdevs, the order of image processing steps will always be from
the sink pad towards the source pad. This is also reflected in the order
in which the configuration must be performed by the user: the changes
made will be propagated to any subsequent stages. If this behaviour is
not desired, the user must set <code class="docutils literal notranslate"><span class="pre">V4L2_SEL_FLAG_KEEP_CONFIG</span></code> flag. This
flag causes no propagation of the changes are allowed in any
circumstances. This may also cause the accessed rectangle to be adjusted
by the driver, depending on the properties of the underlying hardware.</p>
<p>The coordinates to a step always refer to the actual size of the
previous step. The exception to this rule is the sink compose
rectangle, which refers to the sink compose bounds rectangle — if it
is supported by the hardware.</p>
<ol class="arabic simple">
<li><p>Sink pad format. The user configures the sink pad format. This format
defines the parameters of the image the entity receives through the
pad for further processing.</p></li>
<li><p>Sink pad actual crop selection. The sink pad crop defines the crop
performed to the sink pad format.</p></li>
<li><p>Sink pad actual compose selection. The size of the sink pad compose
rectangle defines the scaling ratio compared to the size of the sink
pad crop rectangle. The location of the compose rectangle specifies
the location of the actual sink compose rectangle in the sink compose
bounds rectangle.</p></li>
<li><p>Source pad actual crop selection. Crop on the source pad defines crop
performed to the image in the sink compose bounds rectangle.</p></li>
<li><p>Source pad format. The source pad format defines the output pixel
format of the subdev, as well as the other parameters with the
exception of the image width and height. Width and height are defined
by the size of the source pad actual crop selection.</p></li>
</ol>
<p>Accessing any of the above rectangles not supported by the subdev will
return <code class="docutils literal notranslate"><span class="pre">EINVAL</span></code>. Any rectangle referring to a previous unsupported
rectangle coordinates will instead refer to the previous supported
rectangle. For example, if sink crop is not supported, the compose
selection will refer to the sink pad format dimensions instead.</p>
<div class="figure align-center" id="id4">
<img alt="subdev-image-processing-crop.svg" src="../../../_images/subdev-image-processing-crop.svg" /><p class="caption"><span class="caption-text"><strong>Figure 4.5. Image processing in subdevs: simple crop example</strong></span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</div>
<p>In the above example, the subdev supports cropping on its sink pad. To
configure it, the user sets the media bus format on the subdev’s sink
pad. Now the actual crop rectangle can be set on the sink pad — the
location and size of this rectangle reflect the location and size of a
rectangle to be cropped from the sink format. The size of the sink crop
rectangle will also be the size of the format of the subdev’s source
pad.</p>
<div class="figure align-center" id="id5">
<img alt="subdev-image-processing-scaling-multi-source.svg" src="../../../_images/subdev-image-processing-scaling-multi-source.svg" /><p class="caption"><span class="caption-text"><strong>Figure 4.6. Image processing in subdevs: scaling with multiple sources</strong></span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</div>
<p>In this example, the subdev is capable of first cropping, then scaling
and finally cropping for two source pads individually from the resulting
scaled image. The location of the scaled image in the cropped image is
ignored in sink compose target. Both of the locations of the source crop
rectangles refer to the sink scaling rectangle, independently cropping
an area at location specified by the source crop rectangle from it.</p>
<div class="figure align-center" id="id6">
<img alt="subdev-image-processing-full.svg" src="../../../_images/subdev-image-processing-full.svg" /><p class="caption"><span class="caption-text"><strong>Figure 4.7. Image processing in subdevs: scaling and composition with multiple sinks and sources</strong></span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</div>
<p>The subdev driver supports two sink pads and two source pads. The images
from both of the sink pads are individually cropped, then scaled and
further composed on the composition bounds rectangle. From that, two
independent streams are cropped and sent out of the subdev from the
source pads.</p>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="subdev-formats.html">4.13.3.4.1. Media Bus Formats</a></li>
</ul>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="subdev-formats.html" class="btn btn-neutral float-right" title="4.13.3.4.1. Media Bus Formats" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="dev-event.html" class="btn btn-neutral float-left" title="4.12. Event Interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The kernel development community.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>