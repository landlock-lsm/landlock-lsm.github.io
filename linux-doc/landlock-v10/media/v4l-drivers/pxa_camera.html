

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>25. PXA-Camera Host Driver &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="26. Qualcomm Camera Subsystem driver" href="qcom_camss.html" />
    <link rel="prev" title="24. The pvrusb2 driver" href="pvrusb2.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Linux Media Subsystem Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../media_uapi.html">Linux Media Infrastructure userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../media_kapi.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dvb-drivers/index.html">Linux Digital TV driver-specific documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Video4Linux (V4L)  driver-specific documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="fourcc.html">1. Guidelines for Video4Linux pixel format 4CCs</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html">2. Infrared remote control support in video4linux drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html#using-with-lircd">3. Using with lircd</a></li>
<li class="toctree-l3"><a class="reference internal" href="v4l-with-ir.html#using-without-lircd">4. Using without lircd</a></li>
<li class="toctree-l3"><a class="reference internal" href="tuners.html">5. Tuner drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="cardlist.html">6. Cards List</a></li>
<li class="toctree-l3"><a class="reference internal" href="bttv.html">7. The bttv driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cafe_ccic.html">8. The cafe_ccic driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpia2.html">9. The cpia2 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx18.html">10. The cx18 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx2341x.html">11. The cx2341x driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="cx88.html">12. The cx88 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="davinci-vpbe.html">13. The VPBE V4L2 driver design</a></li>
<li class="toctree-l3"><a class="reference internal" href="fimc.html">14. The Samsung S5P/EXYNOS4 FIMC driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx.html">15. i.MX Video Capture Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="imx7.html">16. i.MX7 Video Capture Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="ipu3.html">17. Intel Image Processing Unit 3 (IPU3) Imaging Unit (ImgU) driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="ivtv.html">18. The ivtv driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="max2175.html">19. Maxim Integrated MAX2175 RF to bits tuner driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="meye.html">20. Vaio Picturebook Motion Eye Camera Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="omap3isp.html">21. OMAP 3 Image Signal Processor (ISP) driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="omap4_camera.html">22. OMAP4 ISS Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="philips.html">23. Philips webcams (pwc driver)</a></li>
<li class="toctree-l3"><a class="reference internal" href="pvrusb2.html">24. The pvrusb2 driver</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">25. PXA-Camera Host Driver</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#constraints">25.1. Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#global-video-workflow">25.2. Global video workflow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dma-usage">25.3. DMA usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="qcom_camss.html">26. Qualcomm Camera Subsystem driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="radiotrack.html">27. The Radiotrack radio driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="rcar-fdp1.html">28. Renesas R-Car Fine Display Processor (FDP1) Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="saa7134.html">29. The saa7134 driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="sh_mobile_ceu_camera.html">30. Cropping and Scaling algorithm, used in the sh_mobile_ceu_camera driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si470x.html">31. The Silicon Labs Si470x FM Radio Receivers driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si4713.html">32. The Silicon Labs Si4713 FM Radio Transmitter Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="si476x.html">33. The SI476x Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="soc-camera.html">34. The Soc-Camera Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="uvcvideo.html">35. The Linux USB Video Class (UVC) driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="vimc.html">36. The Virtual Media Controller Driver (vimc)</a></li>
<li class="toctree-l3"><a class="reference internal" href="vivid.html">37. The Virtual Video Test Driver (vivid)</a></li>
<li class="toctree-l3"><a class="reference internal" href="zr364xx.html">38. Zoran 364xx based USB webcam module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../cec-drivers/index.html">CEC driver-specific documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Linux Media Subsystem Documentation</a> &raquo;</li>
        
          <li><a href="index.html">Video4Linux (V4L)  driver-specific documentation</a> &raquo;</li>
        
      <li>25. PXA-Camera Host Driver</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/media/v4l-drivers/pxa_camera.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="pxa-camera-host-driver">
<h1>25. PXA-Camera Host Driver<a class="headerlink" href="#pxa-camera-host-driver" title="Permalink to this headline">¶</a></h1>
<p>Author: Robert Jarzmik &lt;<a class="reference external" href="mailto:robert&#46;jarzmik&#37;&#52;&#48;free&#46;fr">robert<span>&#46;</span>jarzmik<span>&#64;</span>free<span>&#46;</span>fr</a>&gt;</p>
<div class="section" id="constraints">
<h2>25.1. Constraints<a class="headerlink" href="#constraints" title="Permalink to this headline">¶</a></h2>
<ol class="loweralpha simple">
<li>Image size for YUV422P format
All YUV422P images are enforced to have width x height % 16 = 0.
This is due to DMA constraints, which transfers only planes of 8 byte
multiples.</li>
</ol>
</div>
<div class="section" id="global-video-workflow">
<h2>25.2. Global video workflow<a class="headerlink" href="#global-video-workflow" title="Permalink to this headline">¶</a></h2>
<ol class="loweralpha">
<li><p class="first">QCI stopped
Initially, the QCI interface is stopped.
When a buffer is queued (pxa_videobuf_ops-&gt;buf_queue), the QCI starts.</p>
</li>
<li><p class="first">QCI started
More buffers can be queued while the QCI is started without halting the
capture.  The new buffers are “appended” at the tail of the DMA chain, and
smoothly captured one frame after the other.</p>
<p>Once a buffer is filled in the QCI interface, it is marked as “DONE” and
removed from the active buffers list. It can be then requeud or dequeued by
userland application.</p>
<p>Once the last buffer is filled in, the QCI interface stops.</p>
</li>
<li><p class="first">Capture global finite state machine schema</p>
</li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+----+                             +---+  +----+
| DQ |                             | Q |  | DQ |
|    v                             |   v  |    v
+-----------+                     +------------------------+
|   STOP    |                     | Wait for capture start |
+-----------+         Q           +------------------------+
+-&gt; | QCI: stop | ------------------&gt; | QCI: run               | &lt;------------+
|   | DMA: stop |                     | DMA: stop              |              |
|   +-----------+             +-----&gt; +------------------------+              |
|                            /                            |                   |
|                           /             +---+  +----+   |                   |
|capture list empty        /              | Q |  | DQ |   | QCI Irq EOF       |
|                         /               |   v  |    v   v                   |
|   +--------------------+             +----------------------+               |
|   | DMA hotlink missed |             |    Capture running   |               |
|   +--------------------+             +----------------------+               |
|   | QCI: run           |     +-----&gt; | QCI: run             | &lt;-+           |
|   | DMA: stop          |    /        | DMA: run             |   |           |
|   +--------------------+   /         +----------------------+   | Other     |
|     ^                     /DMA still            |               | channels  |
|     | capture list       /  running             | DMA Irq End   | not       |
|     | not empty         /                       |               | finished  |
|     |                  /                        v               | yet       |
|   +----------------------+           +----------------------+   |           |
|   |  Videobuf released   |           |  Channel completed   |   |           |
|   +----------------------+           +----------------------+   |           |
+-- | QCI: run             |           | QCI: run             | --+           |
| DMA: run             |           | DMA: run             |               |
+----------------------+           +----------------------+               |
        ^                      /           |                           |
        |          no overrun /            | overrun                   |
        |                    /             v                           |
+--------------------+         /   +----------------------+               |
|  Frame completed   |        /    |     Frame overran    |               |
+--------------------+ &lt;-----+     +----------------------+ restart frame |
| QCI: run           |             | QCI: stop            | --------------+
| DMA: run           |             | DMA: stop            |
+--------------------+             +----------------------+

Legend: - each box is a FSM state
        - each arrow is the condition to transition to another state
        - an arrow with a comment is a mandatory transition (no condition)
        - arrow &quot;Q&quot; means : a buffer was enqueued
        - arrow &quot;DQ&quot; means : a buffer was dequeued
        - &quot;QCI: stop&quot; means the QCI interface is not enabled
        - &quot;DMA: stop&quot; means all 3 DMA channels are stopped
        - &quot;DMA: run&quot; means at least 1 DMA channel is still running
</pre></div>
</div>
</div>
<div class="section" id="dma-usage">
<h2>25.3. DMA usage<a class="headerlink" href="#dma-usage" title="Permalink to this headline">¶</a></h2>
<ol class="loweralpha simple">
<li><dl class="first docutils">
<dt>DMA flow</dt>
<dd><ul class="first last">
<li>first buffer queued for capture
Once a first buffer is queued for capture, the QCI is started, but data
transfer is not started. On “End Of Frame” interrupt, the irq handler
starts the DMA chain.</li>
<li>capture of one videobuffer
The DMA chain starts transferring data into videobuffer RAM pages.
When all pages are transferred, the DMA irq is raised on “ENDINTR” status</li>
<li>finishing one videobuffer
The DMA irq handler marks the videobuffer as “done”, and removes it from
the active running queue
Meanwhile, the next videobuffer (if there is one), is transferred by DMA</li>
<li>finishing the last videobuffer
On the DMA irq of the last videobuffer, the QCI is stopped.</li>
</ul>
</dd>
</dl>
</li>
<li>DMA prepared buffer will have this structure</li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------------+-----+---------------+-----------------+
| desc-sg[0] | ... | desc-sg[last] | finisher/linker |
+------------+-----+---------------+-----------------+
</pre></div>
</div>
<p>This structure is pointed by dma-&gt;sg_cpu.
The descriptors are used as follows:</p>
<ul class="simple">
<li>desc-sg[i]: i-th descriptor, transferring the i-th sg
element to the video buffer scatter gather</li>
<li>finisher: has ddadr=DADDR_STOP, dcmd=ENDIRQEN</li>
<li>linker: has ddadr= desc-sg[0] of next video buffer, dcmd=0</li>
</ul>
<p>For the next schema, let’s assume d0=desc-sg[0] .. dN=desc-sg[N],
“f” stands for finisher and “l” for linker.
A typical running chain is :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Videobuffer 1         Videobuffer 2
+---------+----+---+  +----+----+----+---+
| d0 | .. | dN | l |  | d0 | .. | dN | f |
+---------+----+-|-+  ^----+----+----+---+
                 |    |
                 +----+
</pre></div>
</div>
<p>After the chaining is finished, the chain looks like :</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Videobuffer 1         Videobuffer 2         Videobuffer 3
+---------+----+---+  +----+----+----+---+  +----+----+----+---+
| d0 | .. | dN | l |  | d0 | .. | dN | l |  | d0 | .. | dN | f |
+---------+----+-|-+  ^----+----+----+-|-+  ^----+----+----+---+
                 |    |                |    |
                 +----+                +----+
                                      new_link
</pre></div>
</div>
<ol class="loweralpha simple" start="3">
<li>DMA hot chaining timeslice issue</li>
</ol>
<p>As DMA chaining is done while DMA _is_ running, the linking may be done
while the DMA jumps from one Videobuffer to another. On the schema, that
would be a problem if the following sequence is encountered :</p>
<ul class="simple">
<li>DMA chain is Videobuffer1 + Videobuffer2</li>
<li>pxa_videobuf_queue() is called to queue Videobuffer3</li>
<li>DMA controller finishes Videobuffer2, and DMA stops</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> =&gt;
    Videobuffer 1         Videobuffer 2
+---------+----+---+  +----+----+----+---+
| d0 | .. | dN | l |  | d0 | .. | dN | f |
+---------+----+-|-+  ^----+----+----+-^-+
                 |    |                |
                 +----+                +-- DMA DDADR loads DDADR_STOP
</pre></div>
</div>
<ul class="simple">
<li>pxa_dma_add_tail_buf() is called, the Videobuffer2 “finisher” is
replaced by a “linker” to Videobuffer3 (creation of new_link)</li>
<li>pxa_videobuf_queue() finishes</li>
<li>the DMA irq handler is called, which terminates Videobuffer2</li>
<li>Videobuffer3 capture is not scheduled on DMA chain (as it stopped !!!)</li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    Videobuffer 1         Videobuffer 2         Videobuffer 3
+---------+----+---+  +----+----+----+---+  +----+----+----+---+
| d0 | .. | dN | l |  | d0 | .. | dN | l |  | d0 | .. | dN | f |
+---------+----+-|-+  ^----+----+----+-|-+  ^----+----+----+---+
                 |    |                |    |
                 +----+                +----+
                                      new_link
                                     DMA DDADR still is DDADR_STOP
</pre></div>
</div>
<ul class="simple">
<li>pxa_camera_check_link_miss() is called
This checks if the DMA is finished and a buffer is still on the
pcdev-&gt;capture list. If that’s the case, the capture will be restarted,
and Videobuffer3 is scheduled on DMA chain.</li>
<li>the DMA irq handler finishes</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If DMA stops just after pxa_camera_check_link_miss() reads DDADR()
value, we have the guarantee that the DMA irq handler will be called back
when the DMA will finish the buffer, and pxa_camera_check_link_miss() will
be called again, to reschedule Videobuffer3.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="qcom_camss.html" class="btn btn-neutral float-right" title="26. Qualcomm Camera Subsystem driver" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="pvrusb2.html" class="btn btn-neutral float-left" title="24. The pvrusb2 driver" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>