

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Encrypted keys for the eCryptfs filesystem &mdash; The Linux Kernel 5.2.0+ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Key Request Service" href="request-key.html" />
    <link rel="prev" title="Kernel Key Retention Service" href="core.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../media/index.html">Linux Media Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Security Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../credentials.html">Credentials in Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../IMA-templates.html">IMA Template Management Mechanism</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Kernel Keys</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="core.html">Kernel Key Retention Service</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Encrypted keys for the eCryptfs filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="request-key.html">Key Request Service</a></li>
<li class="toctree-l3"><a class="reference internal" href="trusted-encrypted.html">Trusted and Encrypted Keys</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../LSM.html">Linux Security Module Development</a></li>
<li class="toctree-l2"><a class="reference internal" href="../SCTP.html">SCTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="../self-protection.html">Kernel Self-Protection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tpm/index.html">Trusted Platform Module documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../landlock/index.html">Landlock LSM: programmatic access control</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sh/index.html">SuperH Interfaces Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../x86/index.html">x86-specific Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/ext4/index.html">ext4 Data Structures and Algorithms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Security Documentation</a> &raquo;</li>
        
          <li><a href="index.html">Kernel Keys</a> &raquo;</li>
        
      <li>Encrypted keys for the eCryptfs filesystem</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/security/keys/ecryptfs.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="encrypted-keys-for-the-ecryptfs-filesystem">
<h1>Encrypted keys for the eCryptfs filesystem<a class="headerlink" href="#encrypted-keys-for-the-ecryptfs-filesystem" title="Permalink to this headline">¶</a></h1>
<p>ECryptfs is a stacked filesystem which transparently encrypts and decrypts each
file using a randomly generated File Encryption Key (FEK).</p>
<p>Each FEK is in turn encrypted with a File Encryption Key Encryption Key (FEKEK)
either in kernel space or in user space with a daemon called ‘ecryptfsd’.  In
the former case the operation is performed directly by the kernel CryptoAPI
using a key, the FEKEK, derived from a user prompted passphrase;  in the latter
the FEK is encrypted by ‘ecryptfsd’ with the help of external libraries in order
to support other mechanisms like public key cryptography, PKCS#11 and TPM based
operations.</p>
<p>The data structure defined by eCryptfs to contain information required for the
FEK decryption is called authentication token and, currently, can be stored in a
kernel key of the ‘user’ type, inserted in the user’s session specific keyring
by the userspace utility ‘mount.ecryptfs’ shipped with the package
‘ecryptfs-utils’.</p>
<p>The ‘encrypted’ key type has been extended with the introduction of the new
format ‘ecryptfs’ in order to be used in conjunction with the eCryptfs
filesystem.  Encrypted keys of the newly introduced format store an
authentication token in its payload with a FEKEK randomly generated by the
kernel and protected by the parent master key.</p>
<p>In order to avoid known-plaintext attacks, the datablob obtained through
commands ‘keyctl print’ or ‘keyctl pipe’ does not contain the overall
authentication token, which content is well known, but only the FEKEK in
encrypted form.</p>
<p>The eCryptfs filesystem may really benefit from using encrypted keys in that the
required key can be securely generated by an Administrator and provided at boot
time after the unsealing of a ‘trusted’ key in order to perform the mount in a
controlled environment.  Another advantage is that the key is not exposed to
threats of malicious software, because it is available in clear form only at
kernel level.</p>
<p>Usage:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>keyctl add encrypted name &quot;new ecryptfs key-type:master-key-name keylen&quot; ring
keyctl add encrypted name &quot;load hex_blob&quot; ring
keyctl update keyid &quot;update key-type:master-key-name&quot;
</pre></div>
</div>
<p>Where:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>name:= &#39;&lt;16 hexadecimal characters&gt;&#39;
key-type:= &#39;trusted&#39; | &#39;user&#39;
keylen:= 64
</pre></div>
</div>
<p>Example of encrypted key usage with the eCryptfs filesystem:</p>
<p>Create an encrypted key “1000100010001000” of length 64 bytes with format
‘ecryptfs’ and save it using a previously loaded user key “test”:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ keyctl add encrypted 1000100010001000 &quot;new ecryptfs user:test 64&quot; @u
19184530

$ keyctl print 19184530
ecryptfs user:test 64 490045d4bfe48c99f0d465fbbbb79e7500da954178e2de0697
dd85091f5450a0511219e9f7cd70dcd498038181466f78ac8d4c19504fcc72402bfc41c2
f253a41b7507ccaa4b2b03fff19a69d1cc0b16e71746473f023a95488b6edfd86f7fdd40
9d292e4bacded1258880122dd553a661

$ keyctl pipe 19184530 &gt; ecryptfs.blob
</pre></div>
</div>
<p>Mount an eCryptfs filesystem using the created encrypted key “1000100010001000”
into the ‘/secret’ directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ mount -i -t ecryptfs -oecryptfs_sig=1000100010001000,\
  ecryptfs_cipher=aes,ecryptfs_key_bytes=32 /secret /secret
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="request-key.html" class="btn btn-neutral float-right" title="Key Request Service" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core.html" class="btn btn-neutral float-left" title="Kernel Key Retention Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>